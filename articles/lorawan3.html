<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="rustdoc">
    <title>LoRaWAN on Apache NuttX OS</title>

    
    <!-- Begin scripts/articles/*-header.html: Article Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<meta property="og:title" 
    content="LoRaWAN on Apache NuttX OS" 
    data-rh="true">
<meta property="og:description" 
    content="Porting Semtech's LoRaWAN Stack to Apache NuttX OS... And testing it on PineDio Stack BL604 RISC-V Board"
    data-rh="true">
<meta property="og:image" 
    content="https://lupyuen.github.io/images/lorawan3-title.jpg">
<meta property="og:type" 
    content="article" data-rh="true">
<!-- End scripts/articles/*-header.html -->
<!-- Begin scripts/rustdoc-header.html: Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<link rel="alternate" type="application/rss+xml" title="RSS Feed for lupyuen" href="/rss.xml" />
<link rel="stylesheet" type="text/css" href="../normalize.css">
<link rel="stylesheet" type="text/css" href="../rustdoc.css" id="mainThemeStyle">
<link rel="stylesheet" type="text/css" href="../dark.css">
<link rel="stylesheet" type="text/css" href="../light.css" id="themeStyle">
<link rel="stylesheet" type="text/css" href="../prism.css">
<script src="../storage.js"></script><noscript>
<link rel="stylesheet" href="../noscript.css"></noscript>
<link rel="shortcut icon" href="../favicon.ico">
<style type="text/css">
    #crate-search {
        background-image: url("../down-arrow.svg");
    }
    a {
        color: #77d;
    }
</style>
<!-- End scripts/rustdoc-header.html -->


</head>
<body class="rustdoc">
    <!--[if lte IE 8]>
    <div class="warning">
        This old browser is unsupported and will most likely display funky
        things.
    </div>
    <![endif]-->

        <!-- Begin scripts/rustdoc-before.html: Pre-HTML for Custom Markdown files processed by rustdoc, like chip8.md -->

    <!-- Begin Theme Picker -->
    <div class="theme-picker" style="left: 0"><button id="theme-picker" aria-label="Pick another theme!"><img src="../brush.svg"
        width="18" alt="Pick another theme!"></button>
        <div id="theme-choices"></div>
    </div>
    <script src="../theme.js"></script>
    <script src="../prism.js"></script>
    <!-- Theme Picker -->

    <!-- End scripts/rustdoc-before.html -->
    

    <h1 class="title">LoRaWAN on Apache NuttX OS</h1>
    <nav id="TOC"><ul>
<li><a href="#small-steps">1 Small Steps</a><ul>
<li><a href="#lorawan-support">1.1 LoRaWAN Support</a><ul></ul></li>
<li><a href="#lora-sx1262-library">1.2 LoRa SX1262 Library</a><ul></ul></li>
<li><a href="#library-vs-driver">1.3 Library vs Driver</a><ul></ul></li></ul></li>
<li><a href="#device-eui-and-app-key">2 Device EUI and App Key</a><ul></ul></li>
<li><a href="#join-network">3 Join Network</a><ul></ul></li>
<li><a href="#nimble-porting-layer">4 NimBLE Porting Layer</a><ul></ul></li>
<li><a href="#gpio-interrupts">5 GPIO Interrupts</a><ul></ul></li>
<li><a href="#build-nimble">6 Build NimBLE</a><ul></ul></li>
<li><a href="#sx1262-busy">7 SX1262 Busy</a><ul></ul></li>
<li><a href="#event-loop">8 Event Loop</a><ul></ul></li>
<li><a href="#nonce">9 Nonce</a><ul></ul></li>
<li><a href="#random-number-generator">10 Random Number Generator</a><ul></ul></li>
<li><a href="#logging">11 Logging</a><ul></ul></li>
<li><a href="#message-size">12 Message Size</a><ul></ul></li>
<li><a href="#send-data">13 Send Data</a><ul></ul></li>
<li><a href="#whats-next">14 What‚Äôs Next</a><ul></ul></li>
<li><a href="#notes">15 Notes</a><ul></ul></li>
<li><a href="#appendix-gpio-issue">16 Appendix: GPIO Issue</a><ul></ul></li>
<li><a href="#appendix-callout-issue">17 Appendix: Callout Issue</a><ul></ul></li></ul></nav><p>üìù <em>7 Jan 2022</em></p>
<p><img src="https://lupyuen.github.io/images/lorawan3-title.jpg" alt="PineDio Stack BL604 RISC-V Board (left) talking LoRaWAN to RAKwireless WisGate LoRaWAN Gateway (right)" /></p>
<p><em>PineDio Stack BL604 RISC-V Board (left) talking LoRaWAN to RAKwireless WisGate LoRaWAN Gateway (right)</em></p>
<p>Last article we got <strong>LoRa</strong> (the long-range, low-bandwidth wireless network) running on <a href="https://lupyuen.github.io/articles/nuttx"><strong>Apache NuttX OS</strong></a>‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/sx1262"><strong>‚ÄúLoRa SX1262 on Apache NuttX OS‚Äù</strong></a></li>
</ul>
<p>Today we shall run <strong>LoRaWAN</strong> on NuttX OS!</p>
<p><em>Why would we need LoRaWAN?</em></p>
<p>LoRa will work perfectly fine for unsecured <strong>Point-to-Point Wireless Communication</strong>.</p>
<p>But if we need to <strong>relay data packets</strong> securely to a Local Area Network or to the internet, we need <strong>LoRaWAN</strong>.</p>
<p><a href="https://makezine.com/2021/05/24/go-long-with-lora-radio/">(More about LoRaWAN)</a></p>
<p>We shall test LoRaWAN on NuttX with Bouffalo Lab‚Äôs <a href="https://lupyuen.github.io/articles/pinecone"><strong>BL602 and BL604 RISC-V SoCs</strong></a>.</p>
<p>(It will probably run on <strong>ESP32</strong>, since we‚Äôre calling standard NuttX Interfaces)</p>
<p><img src="https://lupyuen.github.io/images/sx1262-library5.jpg" alt="Porting LoRaWAN to NuttX OS" /></p>
<h1 id="small-steps" class="section-header"><a href="#small-steps">1 Small Steps</a></h1>
<p>TODO</p>
<ul>
<li><a href="https://github.com/lupyuen/LoRaMac-node-nuttx"><strong>LoRaMac-node-nuttx</strong></a></li>
</ul>
<p><em>So today we‚Äôll build the NuttX Drivers for LoRa SX1262 and LoRaWAN?</em></p>
<p>Not quite. Implementing LoRa AND LoRaWAN is a complex endeavour.</p>
<p>Thus we break the implementation into small steps‚Ä¶</p>
<ul>
<li>
<p>Today we do the <strong>SX1262 Library</strong> (top right)</p>
</li>
<li>
<p>And we test with our <strong>LoRa App</strong> (top left)</p>
</li>
<li>
<p>In the next article we‚Äôll do the <strong>LoRaWAN Library</strong> and test with our <strong>LoRaWAN App</strong></p>
</li>
<li>
<p>Eventually we shall wrap the SX1262 and LoRaWAN Libraries as <strong>NuttX Drivers</strong></p>
<p>(Because that‚Äôs the proper design for NuttX)</p>
</li>
</ul>
<h2 id="lorawan-support" class="section-header"><a href="#lorawan-support">1.1 LoRaWAN Support</a></h2>
<p><em>Why is LoRaWAN so complex?</em></p>
<p>LoRaWAN works <strong>slightly differently across the world regions</strong>, to comply with Local Wireless Regulations: Radio Frequency, Maximum Airtime (Duty Cycle), <a href="https://lupyuen.github.io/articles/lorawan#appendix-lora-carrier-sensing">Listen Before Talk</a>, ‚Ä¶</p>
<p>Thus we should port <strong>Semtech‚Äôs LoRaWAN Stack</strong> to NuttX with <strong>minimal changes</strong>, in case of future updates. (Like for new regions)</p>
<p>This also means that we should port <strong>Semtech‚Äôs SX1262 Driver</strong> to NuttX as-is, because of the dependencies between the LoRaWAN Stack and the SX1262 Driver.</p>
<h2 id="lora-sx1262-library" class="section-header"><a href="#lora-sx1262-library">1.2 LoRa SX1262 Library</a></h2>
<p><em>Where did the LoRa SX1262 code come from?</em></p>
<p>Our LoRa SX1262 Library originated from <strong>Semtech‚Äôs Reference Implementation</strong> of SX1262 Driver (29 Mar 2021)‚Ä¶</p>
<ul>
<li><a href="https://github.com/Lora-net/LoRaMac-node/tree/master/src/radio/sx126x"><strong>LoRaMac-node/radio/sx126x</strong></a></li>
</ul>
<p>Which we ported to <strong>Linux</strong> and <strong>BL602 IoT SDK</strong>‚Ä¶</p>
<ul>
<li><a href="https://github.com/lupyuen/lora-sx1262/tree/lorawan"><strong>lupyuen/lora-sx1262 (lorawan branch)</strong></a></li>
</ul>
<p>And we‚Äôre porting now to <strong>NuttX</strong>.</p>
<p>(Because porting Linux code to NuttX is straightforward)</p>
<p><em>How did we create the LoRa SX1262 Library?</em></p>
<p>We followed the steps below to create <strong>‚Äúnuttx/libs/libsx1262‚Äù</strong> by cloning a NuttX Library‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/sx1262#appendix-create-a-nuttx-library"><strong>‚ÄúCreate a NuttX Library‚Äù</strong></a></li>
</ul>
<p>Then we replaced the ‚Äúlibsx1262‚Äù folder by a <strong>Git Submodule</strong> that contains our LoRa SX1262 code‚Ä¶ </p>
<div class="example-wrap"><pre class="language-bash"><code>cd nuttx/nuttx/libs
rm -r libsx1262
git rm -r libsx1262
git submodule add --branch nuttx https://github.com/lupyuen/lora-sx1262 libsx1262</code></pre></div>
<p>Note that we‚Äôre using the older <strong>‚Äúnuttx‚Äù</strong> branch of the ‚Äúlora_sx1262‚Äù repo, which <a href="https://lupyuen.github.io/articles/sx1262#appendix-previous-sx1262-library"><strong>doesn‚Äôt use GPIO Interface and NimBLE Porting Layer</strong></a>. (And doesn‚Äôt support LoRaWAN)</p>
<h2 id="library-vs-driver" class="section-header"><a href="#library-vs-driver">1.3 Library vs Driver</a></h2>
<p><em>NuttX Libraries vs Drivers‚Ä¶ What‚Äôs the difference?</em></p>
<p>Our LoRa SX1262 code is initially packaged as a <strong>NuttX Library</strong> (instead of NuttX Driver) because‚Ä¶</p>
<ul>
<li>
<p>NuttX Libraries are <strong>easier to code and troubleshoot</strong></p>
</li>
<li>
<p>NuttX Libraries may be called by <strong>NuttX Apps AND NuttX Drivers</strong></p>
<p>(So we can test our library with a NuttX App)</p>
</li>
</ul>
<p>Eventually our LoRa SX1262 code shall be packaged as a <strong>NuttX Driver</strong>‚Ä¶</p>
<ul>
<li>
<p>Our code shall run inside NuttX OS, which means‚Ä¶</p>
</li>
<li>
<p>Our driver needs to expose an <strong>ioctl()</strong> interface to NuttX Apps</p>
<p>(Which will be cumbersome to code)</p>
</li>
</ul>
<p>Check out the <strong>ioctl()</strong> interface for the existing SX1276 Driver in NuttX: <a href="https://github.com/apache/incubator-nuttx/blob/master/drivers/wireless/lpwan/sx127x/sx127x.c#L954-L1162"><strong>sx127x.c</strong></a></p>
<p><img src="https://lupyuen.github.io/images/spi2-plan2.jpg" alt="SPI Test Driver" /></p>
<p><em>But how will our library access the NuttX SPI Interface?</em></p>
<p>The NuttX SPI Interface is accessible by NuttX Drivers, but not NuttX Apps.</p>
<p>Thankfully in the previous article we have created an <strong>SPI Test Driver ‚Äú/dev/spitest0‚Äù</strong> that exposes the SPI Interface to NuttX Apps (pic above)‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/spi2"><strong>‚ÄúSPI on Apache NuttX OS‚Äù</strong></a></li>
</ul>
<p>For now we‚Äôll call this SPI Test Driver in our LoRa SX1262 Library.</p>
<p><img src="https://lupyuen.github.io/images/spi2-pinedio1.jpg" alt="Inside PineDio Stack BL604" /></p>
<h1 id="device-eui-and-app-key" class="section-header"><a href="#device-eui-and-app-key">2 Device EUI and App Key</a></h1>
<p>TODO</p>
<p>LoRa Frequency and Sync Word are OK ‚Ä¶ Let‚Äôs fix the Device EUI and Join EUI for #LoRaWAN on #NuttX OS</p>
<p>TODO55</p>
<p><img src="https://lupyuen.github.io/images/lorawan3-run2a.png" alt="" /></p>
<p><a href="https://gist.github.com/lupyuen/b91c1f88645eedb813cfffa2bdf7d7a0">(Run Log)</a></p>
<p>TODO59</p>
<p><img src="https://lupyuen.github.io/images/lorawan3-run1.png" alt="" /></p>
<p>#LoRaWAN gets its Device EUI, Join EUI and App Key from the Secure Element ‚Ä¶ But since #NuttX doesn‚Äôt have a Secure Element, we hardcode them in the ‚ÄúSoft‚Äù Secure Element</p>
<p>TODO61</p>
<p><img src="https://lupyuen.github.io/images/lorawan3-secure1.png" alt="" /></p>
<p><a href="https://github.com/lupyuen/LoRaMac-node-nuttx/blob/master/src/peripherals/soft-se/se-identity.h#L65-L79">(Source)</a></p>
<p>For #NuttX OS we hardcode the #LoRaWAN App Key ‚Ä¶ Into the ‚ÄúSoft‚Äù Secure Element</p>
<p>TODO60</p>
<p><img src="https://lupyuen.github.io/images/lorawan3-secure2a.png" alt="" /></p>
<p><a href="https://github.com/lupyuen/LoRaMac-node-nuttx/blob/master/src/peripherals/soft-se/se-identity.h#L100-L115">(Source)</a></p>
<h1 id="join-network" class="section-header"><a href="#join-network">3 Join Network</a></h1>
<p>TODO</p>
<p>Let‚Äôs connect Apache #NuttX OS to a #LoRaWAN Gateway ‚Ä¶ RAKwireless WisGate D4H with ChirpStack</p>
<p><img src="https://lupyuen.github.io/images/lorawan3-title.jpg" alt="PineDio Stack BL604 RISC-V Board (left) talking LoRaWAN to RAKwireless WisGate LoRaWAN Gateway (right)" /></p>
<p><a href="https://lupyuen.github.io/articles/wisgate">(Article)</a></p>
<p>#LoRaWAN Gateway receives the Join Request from #NuttX OS ‚Ä¶ And accepts the Join Request! üéâ</p>
<p>TODO43</p>
<p><img src="https://lupyuen.github.io/images/lorawan3-chirpstack.png" alt="" /></p>
<p><a href="https://gist.github.com/lupyuen/a8e834e7b4267345f01b6629fb7f5e33">(Run Log)</a></p>
<p>#NuttX OS doesn‚Äôt handle the Join Response from #LoRaWAN Gateway ‚Ä¶ Let‚Äôs fix this</p>
<p>TODO56</p>
<p><img src="https://lupyuen.github.io/images/lorawan3-run3.png" alt="" /></p>
<p><a href="https://gist.github.com/lupyuen/a8e834e7b4267345f01b6629fb7f5e33">(Run Log)</a></p>
<h1 id="nimble-porting-layer" class="section-header"><a href="#nimble-porting-layer">4 NimBLE Porting Layer</a></h1>
<p>TODO</p>
<p>Our #NuttX App was waiting for the #LoRaWAN Join Request to be transmitted before receiving the Join Response ‚Ä¶ But because we‚Äôre polling SX1262, we missed the Join Response ‚Ä¶ Let‚Äôs fix this with the multithreading functions from NimBLE Porting Layer</p>
<ul>
<li><a href="https://github.com/lupyuen/nimble-porting-nuttx"><strong>nimble-porting-nuttx</strong></a></li>
</ul>
<p>TODO57</p>
<p><img src="https://lupyuen.github.io/images/lorawan3-run4a.png" alt="" /></p>
<p><a href="https://gist.github.com/lupyuen/d3d9db37a40d7560fc211408db04a81b">(Log)</a></p>
<p>NimBLE Porting Layer is a portable library of Multithreading Functions ‚Ä¶ We‚Äôve used it for #LoRa on Linux and FreeRTOS ‚Ä¶ Now we call it from Apache #NuttX OS</p>
<h1 id="gpio-interrupts" class="section-header"><a href="#gpio-interrupts">5 GPIO Interrupts</a></h1>
<p>TODO</p>
<p>SX1262 will trigger a GPIO Interrupt on #NuttX OS when it receives a #LoRa Packet ‚Ä¶ We wait for the GPIO Interrupt to be Signalled in a Background Thread</p>
<p>TODO46</p>
<p><img src="https://lupyuen.github.io/images/lorawan3-gpio2.png" alt="" /></p>
<p><a href="https://github.com/lupyuen/lora-sx1262/blob/lorawan/src/sx126x-nuttx.c#L742-L778">(Source)</a></p>
<p>We handle GPIO Interrupts (SX1262 DIO1) in a #NuttX Background Thread ‚Ä¶ Awaiting the Signal for GPIO Interrupt</p>
<p>TODO47</p>
<p><img src="https://lupyuen.github.io/images/lorawan3-gpio3.png" alt="" /></p>
<p><a href="https://github.com/lupyuen/lora-sx1262/blob/lorawan/src/sx126x-nuttx.c#L835-L861">(Source)</a></p>
<p>Our #NuttX Background Thread handles the GPIO Interrupts (SX1262 DIO1) ‚Ä¶ By adding to the #LoRaWAN Event Queue</p>
<p>TODO48</p>
<p><img src="https://lupyuen.github.io/images/lorawan3-gpio4a.png" alt="" /></p>
<p><a href="https://github.com/lupyuen/lora-sx1262/blob/lorawan/src/sx126x-nuttx.c#L863-L892">(Source)</a></p>
<p>#LoRaWAN runs neater on Apache #NuttX OS ‚Ä¶ After implementing Timers and Multithreading with NimBLE Porting Layer ‚Ä¶ No more sleep()!</p>
<p><a href="https://gist.github.com/lupyuen/cad58115be4cabe8a8a49c0e498f1c95">(Log)</a></p>
<h1 id="build-nimble" class="section-header"><a href="#build-nimble">6 Build NimBLE</a></h1>
<p>TODO</p>
<p>To build NumBLE Porting Layer on #NuttX OS we need to enable: 1Ô∏è‚É£ POSIX Timers &amp; Message Queues 2Ô∏è‚É£ Clock Monotonic 3Ô∏è‚É£ Work Queues 4Ô∏è‚É£ SIGEV_THHREAD</p>
<ul>
<li><a href="https://github.com/lupyuen/nimble-porting-nuttx"><strong>nimble-porting-nuttx</strong></a></li>
</ul>
<p>TODO33</p>
<p><img src="https://lupyuen.github.io/images/lorawan3-config1.png" alt="" /></p>
<p>TODO14</p>
<p><img src="https://lupyuen.github.io/images/lorawan3-config4.png" alt="" /></p>
<h1 id="sx1262-busy" class="section-header"><a href="#sx1262-busy">7 SX1262 Busy</a></h1>
<p>TODO</p>
<p>Here‚Äôs how we check the SX1262 Busy Pin on #NuttX OS ‚Ä¶ By reading the GPIO Input</p>
<p>TODO49</p>
<p><img src="https://lupyuen.github.io/images/lorawan3-gpio1.png" alt="" /></p>
<p><a href="https://github.com/lupyuen/lora-sx1262/blob/lorawan/src/sx126x-nuttx.c#L184-L199">(Source)</a></p>
<h1 id="event-loop" class="section-header"><a href="#event-loop">8 Event Loop</a></h1>
<p>TODO</p>
<p>Here‚Äôs our #LoRaWAN Event Loop for #NuttX OS ‚Ä¶ Implemented with NimBLE Porting Library ‚Ä¶ No more polling!</p>
<p>TODO54</p>
<p><img src="https://lupyuen.github.io/images/lorawan3-npl1.png" alt="" /></p>
<p>TODO58</p>
<p><img src="https://lupyuen.github.io/images/lorawan3-run5a.png" alt="" /></p>
<h1 id="nonce" class="section-header"><a href="#nonce">9 Nonce</a></h1>
<p>TODO</p>
<p>Our #NuttX App resends the same Nonce to the #LoRaWAN Gateway ‚Ä¶ Which (silently) rejects the Join Request due to Duplicate Nonce ‚Ä¶ Let‚Äôs fix our Random Number Generator</p>
<p>TODO34</p>
<p><img src="https://lupyuen.github.io/images/lorawan3-chirpstack2a.png" alt="" /></p>
<p><a href="https://gist.github.com/lupyuen/b38434c3d27500444382bb4a066691e5">(Log)</a></p>
<p>#LoRaWAN gets the Nonce from the Secure Element‚Äôs Random Number Generator ‚Ä¶ Let‚Äôs simulate the Secure Element on Apache #NuttX OS</p>
<p>TODO51</p>
<p><img src="https://lupyuen.github.io/images/lorawan3-nonce2a.png" alt="" /></p>
<p><a href="https://github.com/lupyuen/LoRaMac-node-nuttx/blob/master/src/mac/LoRaMacCrypto.c#L980-L996">(Source)</a></p>
<p>Here‚Äôs how we generate #LoRaWAN Nonces on #NuttX OS ‚Ä¶ With Strong Random Numbers thanks to Entropy Pool</p>
<p>TODO53</p>
<p><img src="https://lupyuen.github.io/images/lorawan3-nonce6.png" alt="" /></p>
<p><a href="https://github.com/lupyuen/LoRaMac-node-nuttx/blob/master/src/nuttx.c#L136-L153">(Source)</a></p>
<p>Our #NuttX App now sends Random #LoRaWAN Nonces to the LoRaWAN Gateway ‚Ä¶ And are happily accepted by the gateway! üéâ</p>
<p>TODO36</p>
<p><img src="https://lupyuen.github.io/images/lorawan3-nonce7a.png" alt="" /></p>
<p><a href="https://gist.github.com/lupyuen/8f012856b9eb6b9a762160afd83df7f8">(Log)</a></p>
<h1 id="random-number-generator" class="section-header"><a href="#random-number-generator">10 Random Number Generator</a></h1>
<p>TODO</p>
<p>For #NuttX Random Number Generator, select the Entropy Pool ‚Ä¶ To generate Strong Random Numbers for our #LoRaWAN Nonce</p>
<p>TODO35</p>
<p><img src="https://lupyuen.github.io/images/lorawan3-nonce4a.png" alt="" /></p>
<p>We enable the Entropy Pool in #NuttX OS ‚Ä¶ To generate Strong Random Numbers for our #LoRaWAN Nonce</p>
<p>TODO52</p>
<p><img src="https://lupyuen.github.io/images/lorawan3-nonce3a.png" alt="" /></p>
<h1 id="logging" class="section-header"><a href="#logging">11 Logging</a></h1>
<p>TODO</p>
<p>Our #NuttX App was too busy to receive the #LoRaWAN Join Response ‚Ä¶ Let‚Äôs disable the logging</p>
<p>TODO62</p>
<p><img src="https://lupyuen.github.io/images/lorawan3-tx.png" alt="" /></p>
<p><a href="https://gist.github.com/lupyuen/8f012856b9eb6b9a762160afd83df7f8">(Log)</a></p>
<p>After disabling logging, our #NuttX App successfully joins the #LoRaWAN Network! üéâ Now we transmit some Data Packets over LoRaWAN</p>
<p>TODO63</p>
<p><img src="https://lupyuen.github.io/images/lorawan3-tx3.png" alt="" /></p>
<p><a href="https://gist.github.com/lupyuen/0d301216bbf937147778bb57ab0ccf89">(Log)</a></p>
<p>Our #LoRaWAN Gateway receives Data Packets from #NuttX OS! üéâ The Message Payload is empty ‚Ä¶ Let‚Äôs figure out why ü§î</p>
<p>TODO44</p>
<p><img src="https://lupyuen.github.io/images/lorawan3-chirpstack5.png" alt="" /></p>
<p><a href="https://gist.github.com/lupyuen/0d301216bbf937147778bb57ab0ccf89">(Log)</a></p>
<h1 id="message-size" class="section-header"><a href="#message-size">12 Message Size</a></h1>
<p>TODO</p>
<p>Our #NuttX App sent an empty #LoRaWAN Message because our message is too long for LoRaWAN Data Rate 2 (max 11 bytes) ‚Ä¶ Let‚Äôs increase the Data Rate to 3</p>
<p>TODO65</p>
<p><img src="https://lupyuen.github.io/images/lorawan3-tx4a.png" alt="" /></p>
<p><a href="https://gist.github.com/lupyuen/5fc07695a6c4bb48b5e4d10eb05ca9bf">(Log)</a></p>
<p>Here‚Äôs how we increase the #LoRaWAN Data Rate to 3 in our #NuttX App</p>
<p>TODO67</p>
<p><img src="https://lupyuen.github.io/images/lorawan3-tx5a.png" alt="" /></p>
<p><a href="https://github.com/lupyuen/lorawan_test/blob/main/lorawan_test_main.c#L57-L70">(Source)</a></p>
<p>#LoRaWAN Data Rate has been increased to 3 ‚Ä¶ Max Message Size is now 53 bytes for our #NuttX App</p>
<p>TODO37</p>
<p><img src="https://lupyuen.github.io/images/lorawan3-tx7a.png" alt="" /></p>
<p><a href="https://gist.github.com/lupyuen/83be5da091273bb39bad6e77cc91b68d">(Log)</a></p>
<p>#LoRaWAN Gateway now receives the correct Data Packet from our #NuttX App! üéâ</p>
<p>TODO45</p>
<p><img src="https://lupyuen.github.io/images/lorawan3-chirpstack6.png" alt="" /></p>
<p><a href="https://gist.github.com/lupyuen/83be5da091273bb39bad6e77cc91b68d">(Log)</a></p>
<h1 id="send-data" class="section-header"><a href="#send-data">13 Send Data</a></h1>
<p>TODO</p>
<p>Here‚Äôs how we send a #LoRaWAN Data Packet on #NuttX OS ‚Ä¶ And validate the Packet Size before sending</p>
<p>TODO68</p>
<p><img src="https://lupyuen.github.io/images/lorawan3-tx6.png" alt="" /></p>
<p><a href="https://github.com/lupyuen/lorawan_test/blob/main/lorawan_test_main.c#L311-L339">(Source)</a></p>
<p>#LoRaWAN tested OK on Apache #NuttX OS ‚Ä¶ From #PineDio Stack BL604 @ThePine64 to RAKwireless WisGate ‚Ä¶ And back! üéâ</p>
<ul>
<li><a href="https://github.com/lupyuen/LoRaMac-node-nuttx"><strong>LoRaMac-node-nuttx</strong></a></li>
</ul>
<h1 id="whats-next" class="section-header"><a href="#whats-next">14 What‚Äôs Next</a></h1>
<p>TODO</p>
<p>In our next article we‚Äôll move on to <strong>LoRaWAN!</strong></p>
<p>(Which will be super interesting because of multithreading)</p>
<p>We‚Äôll port Semtech‚Äôs <strong>Reference LoRaWAN Stack</strong> to NuttX‚Ä¶</p>
<ul>
<li><a href="https://github.com/lupyuen/LoRaMac-node-nuttx"><strong>lupyuen/LoRaMac-node-nuttx</strong></a></li>
</ul>
<p><em>We‚Äôre porting plenty of code to NuttX: LoRa, LoRaWAN and NimBLE Porting Layer. Do we expect any problems?</em></p>
<p>Yep we might have issues keeping our LoRaWAN Stack in sync with Semtech‚Äôs version.  <a href="https://lupyuen.github.io/articles/sx1262#notes">(But we shall minimise the changes)</a></p>
<p>Stay Tuned!</p>
<p>Many Thanks to my <a href="https://github.com/sponsors/lupyuen"><strong>GitHub Sponsors</strong></a> for supporting my work! This article wouldn‚Äôt have been possible without your support.</p>
<ul>
<li>
<p><a href="https://github.com/sponsors/lupyuen">Sponsor me a coffee</a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/book">Read ‚ÄúThe RISC-V BL602 / BL604 Book‚Äù</a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io">Check out my articles</a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/rss.xml">RSS Feed</a></p>
</li>
</ul>
<p><em>Got a question, comment or suggestion? Create an Issue or submit a Pull Request here‚Ä¶</em></p>
<p><a href="https://github.com/lupyuen/lupyuen.github.io/blob/master/src/lorawan3.md"><code>lupyuen.github.io/src/lorawan3.md</code></a></p>
<h1 id="notes" class="section-header"><a href="#notes">15 Notes</a></h1>
<ol>
<li>
<p>This article is the expanded version of <a href="https://twitter.com/MisterTechBlog/status/1473593455699841027">this Twitter Thread</a></p>
</li>
<li>
<p>We‚Äôre <strong>porting plenty of code</strong> to NuttX: LoRa, LoRaWAN and NimBLE Porting Layer. Do we expect any problems?</p>
<ul>
<li>
<p>If we implement LoRa and LoRaWAN as <strong>NuttX Drivers</strong>, we‚Äôll have to scrub the code to comply with the <a href="https://nuttx.apache.org/docs/latest/contributing/coding_style.html"><strong>NuttX Coding Conventions</strong></a>.</p>
<p>This makes it <strong>harder to update</strong> the LoRaWAN Driver when there are changes in the LoRaWAN Spec. (Like for a new LoRaWAN Region)</p>
<p><a href="https://lupyuen.github.io/articles/lorawan#appendix-lora-carrier-sensing">(Here‚Äôs an example)</a></p>
</li>
<li>
<p>Alternatively we may implement LoRa and LoRaWAN as <strong>External Libraries</strong>, similar to <a href="https://github.com/lupyuen/incubator-nuttx-apps/tree/master/wireless/bluetooth/nimble"><strong>NimBLE for NuttX</strong></a>.</p>
<p>(The <a href="https://github.com/lupyuen/incubator-nuttx-apps/blob/master/wireless/bluetooth/nimble/Makefile#L33"><strong>Makefile</strong></a> downloads the External Library during build)</p>
<p>But then we won‚Äôt get a proper NuttX Driver that exposes the ioctl() interface to NuttX Apps.</p>
</li>
</ul>
<p>Conundrum. Lemme know your thoughts!</p>
</li>
<li>
<p>How do other Embedded Operating Systems implement LoRaWAN?</p>
<ul>
<li>
<p><strong>Mynewt</strong> embeds a <a href="https://github.com/apache/mynewt-core/tree/master/net/lora/node"><strong>Partial Copy</strong></a> of Semtech‚Äôs LoRaWAN Stack into its source tree.</p>
</li>
<li>
<p><strong>Zephyr</strong> maintains a <a href="https://github.com/zephyrproject-rtos/loramac-node"><strong>Complete Fork</strong></a> of the entire LoRaWAN Repo by Semtech. Which gets embedded during the Zephyr build.</p>
</li>
</ul>
<p>The Zephyr approach is probably the best way to <strong>keep our LoRaWAN Stack in sync</strong> with Semtech‚Äôs.</p>
</li>
<li>
<p>We have already ported LoRaWAN to <strong>BL602 IoT SDK</strong> <a href="https://lupyuen.github.io/articles/lorawan">(see this)</a>, why are we porting again to NuttX?</p>
<p>Regrettably BL602 IoT SDK has been revamped (without warning) to the <strong>new ‚Äúhosal‚Äù HAL</strong> <a href="https://twitter.com/MisterTechBlog/status/1456259223323508748">(see this)</a>, and the LoRaWAN Stack will <strong>no longer work</strong> on the revamped BL602 IoT SDK.</p>
<p>For easier maintenance, we shall <strong>code our BL602 and BL604 projects with Apache NuttX OS</strong> instead.</p>
<p>(Which won‚Äôt get revamped overnight!)</p>
</li>
<li>
<p>Will NuttX become the official OS for PineDio Stack BL604 when it goes on sale?</p>
<p>It might! But first let‚Äôs get LoRaWAN (and ST7789) running on PineDio Stack.</p>
</li>
</ol>
<h1 id="appendix-gpio-issue" class="section-header"><a href="#appendix-gpio-issue">16 Appendix: GPIO Issue</a></h1>
<p>TODO</p>
<p>Switching a #NuttX GPIO Interrupt Pin to Trigger On Rising Edge ‚Ä¶ Crashes with an Assertion Failure ‚Ä¶ I‚Äôll submit a NuttX Issue, meanwhile I have disabled the assertion</p>
<p>TODO50</p>
<p><img src="https://lupyuen.github.io/images/lorawan3-int.png" alt="" /></p>
<p><a href="https://github.com/lupyuen/incubator-nuttx/blob/lorawan/drivers/ioexpander/gpio.c#L544-L547">(Source)</a></p>
<h1 id="appendix-callout-issue" class="section-header"><a href="#appendix-callout-issue">17 Appendix: Callout Issue</a></h1>
<p>TODO</p>
<p>NimBLE Porting Layer doesn‚Äôt work for multiple Callout Timers on #NuttX OS, unless we loop the thread ‚Ä¶ Will submit a Pull Request to Apache NimBLE üëç</p>
<p>TODO42</p>
<p><img src="https://lupyuen.github.io/images/lorawan3-callout.png" alt="" /></p>
<p><a href="https://github.com/lupyuen/nimble-porting-nuttx/blob/master/porting/npl/nuttx/src/os_callout.c#L35-L70">(Source)</a></p>
<p><img src="https://lupyuen.github.io/images/lorawan3-title2.jpg" alt="PineDio Stack BL604 RISC-V Board (left) talking LoRaWAN to RAKwireless WisGate LoRaWAN Gateway (right)" /></p>
<p>#LoRaWAN on #NuttX OS: Let‚Äôs stub out the functions for Non-Volatile Memory and Real Time Clock ‚Ä¶ And watch what happens üåã</p>
<p>TODO39</p>
<p><img src="https://lupyuen.github.io/images/lorawan3-build4a.png" alt="" /></p>
<p><a href="https://github.com/lupyuen/LoRaMac-node-nuttx/blob/master/src/nuttx.c">(Source)</a></p>
<p>#LoRaWAN builds OK on #NuttX OS! üéâ ‚Ä¶ Will it run? ü§î</p>
<p><a href="https://github.com/lupyuen/incubator-nuttx-apps/tree/lorawan">NuttX Apps</a></p>
<p><a href="https://github.com/lupyuen/incubator-nuttx/tree/lorawan">NuttX OS</a></p>

    
</body>
</html>