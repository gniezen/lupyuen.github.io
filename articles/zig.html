<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="rustdoc">
    <title>Zig on RISC-V BL602: Quick Peek with Apache NuttX RTOS</title>

    
    <!-- Begin scripts/articles/*-header.html: Article Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<meta property="og:title" 
    content="Zig on RISC-V BL602: Quick Peek with Apache NuttX RTOS" 
    data-rh="true">
<meta property="og:description" 
    content="How we run Zig on the BL602 RISC-V SoC... With Apache NuttX RTOS"
    data-rh="true">
<meta property="og:image" 
    content="https://lupyuen.github.io/images/zig-title.jpg">
<meta property="og:type" 
    content="article" data-rh="true">
<!-- End scripts/articles/*-header.html -->
<!-- Begin scripts/rustdoc-header.html: Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<link rel="alternate" type="application/rss+xml" title="RSS Feed for lupyuen" href="/rss.xml" />
<link rel="stylesheet" type="text/css" href="../normalize.css">
<link rel="stylesheet" type="text/css" href="../rustdoc.css" id="mainThemeStyle">
<link rel="stylesheet" type="text/css" href="../dark.css">
<link rel="stylesheet" type="text/css" href="../light.css" id="themeStyle">
<link rel="stylesheet" type="text/css" href="../prism.css">
<script src="../storage.js"></script><noscript>
<link rel="stylesheet" href="../noscript.css"></noscript>
<link rel="shortcut icon" href="../favicon.ico">
<style type="text/css">
    #crate-search {
        background-image: url("../down-arrow.svg");
    }
    a {
        color: #77d;
    }
</style>
<!-- End scripts/rustdoc-header.html -->


</head>
<body class="rustdoc">
    <!--[if lte IE 8]>
    <div class="warning">
        This old browser is unsupported and will most likely display funky
        things.
    </div>
    <![endif]-->

        <!-- Begin scripts/rustdoc-before.html: Pre-HTML for Custom Markdown files processed by rustdoc, like chip8.md -->

    <!-- Begin Theme Picker -->
    <div class="theme-picker" style="left: 0"><button id="theme-picker" aria-label="Pick another theme!"><img src="../brush.svg"
        width="18" alt="Pick another theme!"></button>
        <div id="theme-choices"></div>
    </div>
    <script src="../theme.js"></script>
    <script src="../prism.js"></script>
    <!-- Theme Picker -->

    <!-- End scripts/rustdoc-before.html -->
    

    <h1 class="title">Zig on RISC-V BL602: Quick Peek with Apache NuttX RTOS</h1>
    <nav id="TOC"><ul>
<li><a href="#zig-app">1 Zig App</a><ul>
<li><a href="#import-standard-library">1.1 Import Standard Library</a><ul></ul></li>
<li><a href="#import-printf">1.2 Import printf</a><ul></ul></li>
<li><a href="#main-function">1.3 Main Function</a><ul></ul></li></ul></li>
<li><a href="#enable-zig-app">2 Enable Zig App</a><ul></ul></li>
<li><a href="#build-fails-on-nuttx">3 Build Fails on NuttX</a><ul></ul></li>
<li><a href="#compile-zig-app">4 Compile Zig App</a><ul></ul></li>
<li><a href="#zig-target">5 Zig Target</a><ul></ul></li>
<li><a href="#floating-point-abi">6 Floating-Point ABI</a><ul></ul></li>
<li><a href="#patch-elf-header">7 Patch ELF Header</a><ul></ul></li>
<li><a href="#zig-runs-ok">8 Zig Runs OK!</a><ul></ul></li>
<li><a href="#why-zig">9 Why Zig?</a><ul></ul></li>
<li><a href="#whats-next">10 What‚Äôs Next</a><ul></ul></li>
<li><a href="#notes">11 Notes</a><ul></ul></li>
<li><a href="#appendix-zig-on-risc-v-bl602-with-apache-nuttx-rtos">12 Appendix: Zig on RISC-V BL602 with Apache NuttX RTOS</a><ul></ul></li>
<li><a href="#appendix-hello-app">13 Appendix: Hello App</a><ul></ul></li></ul></nav><p>üìù <em>7 Jun 2022</em></p>
<p><img src="https://lupyuen.github.io/images/zig-title.jpg" alt="Zig runs on BL602 with Apache NuttX RTOS" /></p>
<p><a href="https://ziglang.org"><strong>Zig</strong></a> is a general-purpose language for maintaining <strong>robust, optimal, and reusable software</strong>.</p>
<p><a href="https://lupyuen.github.io/articles/pinecone"><strong>BL602</strong></a> is a <strong>32-bit RISC-V SoC</strong> with WiFi and Bluetooth LE.</p>
<p>Let‚Äôs run <strong>Zig on BL602!</strong></p>
<p><em>We‚Äôre running Zig bare metal on BL602?</em></p>
<p>Not quite. We‚Äôll need more work to get Zig talking to <strong>BL602 Hardware</strong> and printing to the console.</p>
<p>Instead we‚Äôll run Zig on top of a <strong>Real-Time Operating System</strong> (RTOS): <a href="https://lupyuen.github.io/articles/nuttx"><strong>Apache NuttX</strong></a>.</p>
<p><em>Zig on BL602 should be a piece of cake right?</em></p>
<p>Well <strong>Zig on RISC-V</strong> is kinda newish, and might present interesting new challenges.</p>
<p>In a while I‚Äôll explain the strange hack I did to run <strong>Zig on BL602</strong>‚Ä¶</p>
<ul>
<li><a href="https://github.com/lupyuen/zig-bl602-nuttx"><strong>lupyuen/zig-bl602-nuttx</strong></a></li>
</ul>
<p>I‚Äôm totally new to Zig, please bear with me as I wade through the water and start swimming in Zig! üôè</p>
<p><img src="https://lupyuen.github.io/images/zig-code1a.png" alt="Zig App bundled with Apache NuttX RTOS" /></p>
<h1 id="zig-app"><a href="#zig-app">1 Zig App</a></h1>
<p>Below is the <strong>barebones Zig App</strong> that‚Äôs bundled with Apache NuttX RTOS. We‚Äôll run this on BL602: <a href="https://github.com/lupyuen/zig-bl602-nuttx/blob/main/hello_zig_main.zig">hello_zig_main.zig</a></p>
<div class="example-wrap"><pre class="language-zig"><code>//  Import the Zig Standard Library
const std = @import(&quot;std&quot;);

//  Import printf() from C
pub extern fn printf(
  _format: [*:0]const u8
) c_int;

//  Main Function
pub export fn hello_zig_main(
  _argc: c_int, 
  _argv: [*]const [*]const u8
) c_int {
  _ = _argc;
  _ = _argv;
  _ = printf(&quot;Hello, Zig!\n&quot;);
  return 0;
}</code></pre></div>
<p><a href="https://github.com/lupyuen/zig-bl602-nuttx#zig-app-for-nuttx">(We tweaked the code slightly)</a></p>
<p>The code above prints to the NuttX Console‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>Hello, Zig!</code></pre></div>
<p>Let‚Äôs dive into the Zig code.</p>
<p><img src="https://lupyuen.github.io/images/book-zig.jpg" alt="Zig on BL602" /></p>
<h2 id="import-standard-library"><a href="#import-standard-library">1.1 Import Standard Library</a></h2>
<p>We begin by importing the <a href="https://ziglang.org/documentation/master/#Zig-Standard-Library"><strong>Zig Standard Library</strong></a>‚Ä¶</p>
<div class="example-wrap"><pre class="language-zig"><code>//  Import the Zig Standard Library
const std = @import(&quot;std&quot;);</code></pre></div>
<p>Which has all kinds of <strong>Algos, Data Structures and Definitions</strong>.</p>
<p><a href="https://ziglang.org/documentation/master/std/">(More about the Zig Standard Library)</a></p>
<h2 id="import-printf"><a href="#import-printf">1.2 Import printf</a></h2>
<p>Next we cross into the grey zone between <strong>Zig and C</strong>‚Ä¶</p>
<div class="example-wrap"><pre class="language-zig"><code>//  Import printf() from C
pub extern fn printf(
  _format: [*:0]const u8
) c_int;</code></pre></div>
<p>Here we import the <strong><code>printf()</code></strong> function from the C Standard Library.</p>
<p>(Which is supported by NuttX because it‚Äôs <a href="https://nuttx.apache.org/docs/latest/introduction/inviolables.html#strict-posix-compliance"><strong>POSIX-Compliant</strong></a>)</p>
<p><em>What‚Äôs <code>[*:0]const u8</code>?</em></p>
<p>That‚Äôs how we declare <strong>C Strings</strong> in Zig‚Ä¶</p>
<div><table><thead><tr><th style="text-align: center"></th><th style="text-align: left"></th></tr></thead><tbody>
<tr><td style="text-align: center"><strong><code>[*:0]</code></strong></td><td style="text-align: left">Pointer to a Null-Terminated Array‚Ä¶</td></tr>
<tr><td style="text-align: center"><strong><code>const u8</code></strong></td><td style="text-align: left">Of Constant Unsigned Bytes</td></tr>
<tr><td style="text-align: center">¬†</td><td style="text-align: left">¬†</td></tr>
</tbody></table>
</div>
<p>Which is somewhat similar to ‚Äú<code>const char *</code>‚Äù in C, but more expressive.</p>
<p>Zig calls this a <a href="https://ziglang.org/documentation/master/#Sentinel-Terminated-Pointers"><strong>Sentinel-Terminated Pointer</strong></a>.</p>
<p>(That‚Äôs because it‚Äôs Terminated by Null, not because of ‚ÄúThe Matrix‚Äù)</p>
<p><em>Why is the return type <code>c_int</code>?</em></p>
<p>This says that <strong><code>printf()</code></strong> returns an <strong><code>int</code></strong> that‚Äôs compatible with C. <a href="https://ziglang.org/documentation/master/#Primitive-Types">(See this)</a></p>
<h2 id="main-function"><a href="#main-function">1.3 Main Function</a></h2>
<p>NuttX expects our Zig App to export a <strong>Main Function</strong> that follows the C Convention. So we so this in Zig‚Ä¶</p>
<div class="example-wrap"><pre class="language-zig"><code>//  Main Function
pub export fn hello_zig_main(
  _argc: c_int, 
  _argv: [*]const [*]const u8
) c_int {</code></pre></div>
<p><strong><code>argc</code></strong> and <strong><code>argv</code></strong> should look familiar, though <strong><code>argv</code></strong> looks complicated‚Ä¶</p>
<ul>
<li>
<p>‚Äú<strong><code>[*]const u8</code></strong>‚Äù is a Pointer to an Unknown Number of Constant Unsigned Bytes</p>
<p>(Like ‚Äú<code>const uint8_t *</code>‚Äù in C)</p>
</li>
<li>
<p>‚Äú<strong><code>[*]const [*]const u8</code></strong>‚Äù is a Pointer to an Unknown Number of the above Pointers</p>
<p>(Like ‚Äú<code>const uint8_t *[]</code>‚Äù in C)</p>
<p><a href="https://ziglang.org/documentation/master/#Pointers">(More about Zig Pointers)</a></p>
</li>
</ul>
<p>Inside the Main Function, we call <strong><code>printf()</code></strong> to print a string‚Ä¶</p>
<div class="example-wrap"><pre class="language-zig"><code>  _ = _argc;
  _ = _argv;
  _ = printf(&quot;Hello, Zig!\n&quot;);
  return 0;</code></pre></div>
<p><em>Why the ‚Äú<code>_ = something</code>‚Äù?</em></p>
<p>This tells the Zig Compiler that we‚Äôre not using the value of ‚Äú<code>something</code>‚Äù.</p>
<p>The Zig Compiler helpfully stops us if we forget to use a Variable (like <code>_argc</code>) or the Returned Value for a Function (like for <code>printf</code>).</p>
<p><em>Doesn‚Äôt Zig have its own printf?</em></p>
<p>Yep there‚Äôs indeed a <strong><code>print()</code></strong> function in Zig, and we ought to use it! <a href="https://ziglang.org/documentation/master/#Hello-World">(See this)</a></p>
<p>Eventually we‚Äôll fix our Zig App to call the <strong><code>print()</code></strong> function instead.</p>
<p><em>Did we forget something?</em></p>
<p>For simplicity we excluded the <strong>Variable Arguments</strong> for <strong><code>printf()</code></strong>.</p>
<p>Our declaration for <strong><code>printf()</code></strong> specifies only one parameter: the <strong>Format String</strong>. So it‚Äôs good for printing one unformatted string.</p>
<p><a href="https://ziglang.org/documentation/master/#Sentinel-Terminated-Pointers">(Here‚Äôs the full declaration)</a></p>
<h1 id="enable-zig-app"><a href="#enable-zig-app">2 Enable Zig App</a></h1>
<p>TODO</p>
<p>To enable the Zig App in NuttX‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>make menuconfig</code></pre></div>
<p>Select ‚ÄúApplication Configuration &gt; Examples &gt; Hello Zig Example‚Äù</p>
<p>Save the configuration and exit menuconfig.</p>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/zig-config1a.png" alt="" /></p>
<h1 id="build-fails-on-nuttx"><a href="#build-fails-on-nuttx">3 Build Fails on NuttX</a></h1>
<p>TODO</p>
<p>When we build NuttX‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>make</code></pre></div>
<p>We see this error‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>LD: nuttx
riscv64-unknown-elf-ld: nuttx/staging/libapps.a(builtin_list.c.home.user.nuttx.apps.builtin.o):(.rodata.g_builtins+0xbc): 
undefined reference to `hello_zig_main&#39;</code></pre></div>
<p><a href="https://gist.github.com/lupyuen/497c90b862aef48b57ff3124f2ea94d8">(Source)</a></p>
<p>Which looks similar to this issue‚Ä¶</p>
<p>https://github.com/apache/incubator-nuttx/issues/6219</p>
<p>This seems to be caused by the NuttX Build not calling the Zig Compiler.</p>
<p>But no worries! Let‚Äôs compile the Zig App ourselves and link into NuttX.</p>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/zig-build1a.png" alt="" /></p>
<h1 id="compile-zig-app"><a href="#compile-zig-app">4 Compile Zig App</a></h1>
<p>TODO</p>
<p>Here‚Äôs how we compile our Zig App for RISC-V BL602 and link it with NuttX‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>#  Download our modified Zig App for NuttX
git clone --recursive https://github.com/lupyuen/zig-bl602-nuttx
cd zig-bl602-nuttx

#  Compile the Zig App for BL602 (RV32IMACF with Hardware Floating-Point)
zig build-obj \
    -target riscv32-freestanding-none \
    -mcpu sifive_e76 \
    hello_zig_main.zig

#  Copy the compiled app to NuttX and overwrite `hello.o`
#  TODO: Change &quot;$HOME/nuttx&quot; to your NuttX Project Directory
cp hello_zig_main.o $HOME/nuttx/apps/examples/hello/*hello.o

#  Build NuttX to link the Zig Object from `hello.o`
make</code></pre></div>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/zig-build3a.png" alt="" /></p>
<h1 id="zig-target"><a href="#zig-target">5 Zig Target</a></h1>
<p>TODO</p>
<p><em>Why is the target <code>riscv32-freestanding-none</code>?</em></p>
<p>Zig Targets have the form <code>&lt;arch&gt;&lt;sub&gt;-&lt;os&gt;-&lt;abi&gt;</code>‚Ä¶</p>
<p><code>riscv32</code>: Because BL602 is a 32-bit RISC-V processor</p>
<p><code>freestanding</code>: Because embedded targets don‚Äôt need an OS</p>
<p><code>none</code>: Because embedded targets don‚Äôt specify the ABI</p>
<p><em>Why is the target CPU <code>sifive_e76</code>?</em></p>
<p>BL602 is designated as RV32IMACF‚Ä¶</p>
<div><table><thead><tr><th style="text-align: center">Designation</th><th style="text-align: left">Meaning</th></tr></thead><tbody>
<tr><td style="text-align: center"><strong><code>RV32I</code></strong></td><td style="text-align: left">32-bit RISC-V with Base Integer Instructions</td></tr>
<tr><td style="text-align: center"><strong><code>M</code></strong></td><td style="text-align: left">Integer Multiplication + Division</td></tr>
<tr><td style="text-align: center"><strong><code>A</code></strong></td><td style="text-align: left">Atomic Instructions</td></tr>
<tr><td style="text-align: center"><strong><code>C</code></strong></td><td style="text-align: left">Compressed Instructions</td></tr>
<tr><td style="text-align: center"><strong><code>F</code></strong></td><td style="text-align: left">Single-Precision Floating-Point</td></tr>
</tbody></table>
</div>
<p><a href="https://en.wikipedia.org/wiki/RISC-V#ISA_base_and_extensions">(Source)</a></p>
<p>Among all Zig Targets, only <code>sifive_e76</code> has the same designation‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>$ zig targets
...
&quot;sifive_e76&quot;: [ &quot;a&quot;, &quot;c&quot;, &quot;f&quot;, &quot;m&quot; ],</code></pre></div>
<p><a href="https://gist.github.com/lupyuen/09d64c79e12b30e5eebc7d0a9c3b20a4">(Source)</a></p>
<p>Thus we use <code>sifive_e76</code> as our CPU Target.</p>
<p>Alternatively we may use <code>baseline_rv32-d</code> as our CPU Target‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>#  Compile the Zig App for BL602 (RV32IMACF with Hardware Floating-Point)
zig build-obj \
    -target riscv32-freestanding-none \
    -mcpu=baseline_rv32-d \
    hello_zig_main.zig</code></pre></div>
<p>Because‚Ä¶</p>
<ul>
<li>
<p><code>baseline_rv32</code> means RV32IMACFD </p>
<p>(D for Double-Precision Floating-Point)</p>
</li>
<li>
<p><code>-d</code> means remove the Double-Precision Floating-Point (D)</p>
<p>(But keep the Single-Precision Floating-Point)</p>
</li>
</ul>
<p><a href="https://github.com/lupyuen/zig-bl602-nuttx/issues/1">(More about RISC-V Feature Flags. Thanks Matheus!)</a></p>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/zig-build4a.jpg" alt="" /></p>
<h1 id="floating-point-abi"><a href="#floating-point-abi">6 Floating-Point ABI</a></h1>
<p>TODO</p>
<p>When linking the Compiled Zig App with NuttX, we see this error‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>$ make
...
riscv64-unknown-elf-ld: nuttx/staging/libapps.a(hello_main.c.home.user.nuttx.apps.examples.hello.o): 
can&#39;t link soft-float modules with single-float modules</code></pre></div>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/zig-build2a.png" alt="" /></p>
<p>That‚Äôs because NuttX was compiled for (Single-Precision) <strong>Hardware Floating-Point</strong> ABI (Application Binary Interface)‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>#  Do this BEFORE overwriting hello.o by hello_zig_main.o.
#  &quot;*hello.o&quot; expands to something like &quot;hello_main.c.home.user.nuttx.apps.examples.hello.o&quot;
$ riscv64-unknown-elf-readelf -h -A $HOME/nuttx/apps/examples/hello/*hello.o
ELF Header:
  Magic:   7f 45 4c 46 01 01 01 00 00 00 00 00 00 00 00 00 
  Class:                             ELF32
  Data:                              2&#39;s complement, little endian
  Version:                           1 (current)
  OS/ABI:                            UNIX - System V
  ABI Version:                       0
  Type:                              REL (Relocatable file)
  Machine:                           RISC-V
  Version:                           0x1
  Entry point address:               0x0
  Start of program headers:          0 (bytes into file)
  Start of section headers:          4528 (bytes into file)
  Flags:                             0x3, RVC, single-float ABI
  Size of this header:               52 (bytes)
  Size of program headers:           0 (bytes)
  Number of program headers:         0
  Size of section headers:           40 (bytes)
  Number of section headers:         26
  Section header string table index: 25
Attribute Section: riscv
File Attributes
  Tag_RISCV_stack_align: 16-bytes
  Tag_RISCV_arch: &quot;rv32i2p0_m2p0_a2p0_f2p0_c2p0&quot;</code></pre></div>
<p><a href="https://gist.github.com/lupyuen/5c090dead49eb50751578f28c15cecd5">(Source)</a></p>
<p><a href="https://gist.github.com/lupyuen/288c980fdef75c334d32e669a921e623">(NuttX was compiled with the GCC Flags <code>-march=rv32imafc -mabi=ilp32f</code>)</a></p>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/zig-abi1a.png" alt="" /></p>
<p>Whereas Zig Compiler produces an Object File with <strong>Software Floating-Point</strong> ABI‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>$ riscv64-unknown-elf-readelf -h -A hello_zig_main.o
ELF Header:
  Magic:   7f 45 4c 46 01 01 01 00 00 00 00 00 00 00 00 00 
  Class:                             ELF32
  Data:                              2&#39;s complement, little endian
  Version:                           1 (current)
  OS/ABI:                            UNIX - System V
  ABI Version:                       0
  Type:                              REL (Relocatable file)
  Machine:                           RISC-V
  Version:                           0x1
  Entry point address:               0x0
  Start of program headers:          0 (bytes into file)
  Start of section headers:          11968 (bytes into file)
  Flags:                             0x1, RVC, soft-float ABI
  Size of this header:               52 (bytes)
  Size of program headers:           0 (bytes)
  Number of program headers:         0
  Size of section headers:           40 (bytes)
  Number of section headers:         24
  Section header string table index: 22
Attribute Section: riscv
File Attributes
  Tag_RISCV_stack_align: 16-bytes
  Tag_RISCV_arch: &quot;rv32i2p0_m2p0_a2p0_f2p0_c2p0&quot;</code></pre></div>
<p><a href="https://gist.github.com/lupyuen/f04386a0b94ed1fb42a94d671edb1ba7">(Source)</a></p>
<p>GCC won‚Äôt allow us to link object files with Software Floating-Point and Hardware Floating-Point ABIs!</p>
<p>TODO: Why did the Zig Compiler produce an Object File with Software Floating-Point ABI, when <code>sifive_e76</code> supports Hardware Floating-Point?</p>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/zig-abi2a.png" alt="" /></p>
<h1 id="patch-elf-header"><a href="#patch-elf-header">7 Patch ELF Header</a></h1>
<p>TODO</p>
<p>Zig Compiler generates an Object File with <strong>Software Floating-Point</strong> ABI (Application Binary Interface)‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>#  Dump the ABI for the compiled app
$ riscv64-unknown-elf-readelf -h -A hello_zig_main.o
...
Flags: 0x1, RVC, soft-float ABI</code></pre></div>
<p>This won‚Äôt link with NuttX because NuttX is compiled with Hardware Floating-Point ABI.</p>
<p>We fix this by modifying the ELF Header‚Ä¶</p>
<ul>
<li>
<p>Edit <code>hello_zig_main.o</code> in a Hex Editor</p>
<p><a href="https://marketplace.visualstudio.com/items?itemName=ms-vscode.hexeditor">(Like VSCode Hex Editor)</a></p>
</li>
<li>
<p>Change byte <code>0x24</code> (Flags) from <code>0x01</code> (Soft Float) to <code>0x03</code> (Hard Float)</p>
<p><a href="https://en.wikipedia.org/wiki/Executable_and_Linkable_Format#File_header">(See this)</a></p>
</li>
</ul>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/zig-hex2a.png" alt="" /></p>
<p>We verify that the Object File has been changed to <strong>Hardware Floating-Point</strong> ABI‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>#  Dump the ABI for the compiled app
$ riscv64-unknown-elf-readelf -h -A hello_zig_main.o
...
Flags: 0x3, RVC, single-float ABI</code></pre></div>
<p>This is now Hardware Floating-Point ABI and will link with NuttX.</p>
<p>Now we link the modified Object File with NuttX‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>#  Copy the compiled app to NuttX and overwrite `hello.o`
#  TODO: Change &quot;$HOME/nuttx&quot; to your NuttX Project Directory
cp hello_zig_main.o $HOME/nuttx/apps/examples/hello/*hello.o

#  Build NuttX to link the Zig Object from `hello.o`
make</code></pre></div>
<p>The NuttX Build should now succeed.</p>
<p>TODO: Find the right way to fix the Floating-Point ABI in the Zig Compiler</p>
<h1 id="zig-runs-ok"><a href="#zig-runs-ok">8 Zig Runs OK!</a></h1>
<p>TODO</p>
<p>The NuttX Build succeeds. Zig runs OK on NuttX BL602!</p>
<div class="example-wrap"><pre class="language-text"><code>NuttShell (NSH) NuttX-10.3.0-RC2

nsh&gt; hello_zig
Hello, Zig!</code></pre></div>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/zig-title.jpg" alt="Zig runs on BL602 with Apache NuttX RTOS" /></p>
<h1 id="why-zig"><a href="#why-zig">9 Why Zig?</a></h1>
<p>TODO</p>
<p><a href="https://kristoff.it/blog/maintain-it-with-zig">‚ÄúMaintain it With Zig‚Äù</a></p>
<p><a href="https://zig.news/kristoff/compile-a-c-c-project-with-zig-368j">‚ÄúCompile a C/C++ Project with Zig‚Äù</a></p>
<p><a href="https://www.reddit.com/r/Zig/comments/urifjd/how_serious_zig_about_replacing_c/?utm_medium=android_app&amp;utm_source=share">‚ÄúHow serious Zig about replacing C?‚Äù</a></p>
<p>Zig looks great for maintaining complex C projects</p>
<p>Today we‚Äôre running incredibly complex C projects on NuttX: LoRaWAN Library, LoRa SX1262 Library, NimBLE Porting Layer</p>
<p>And we can‚Äôt afford to make any code changes to the C code, in case the upstream code changes (e.g. new LoRaWAN Regions)</p>
<p>So best way to maintain and extend them is to compile with Zig</p>
<p>In future might be possible to build LoRaWAN IoT Apps in Zig</p>
<p>Why not rewrite in Rust? Because we will have trouble syncing future updates to the C code</p>
<h1 id="whats-next"><a href="#whats-next">10 What‚Äôs Next</a></h1>
<p>TODO</p>
<p>Many Thanks to my <a href="https://github.com/sponsors/lupyuen"><strong>GitHub Sponsors</strong></a> for supporting my work! This article wouldn‚Äôt have been possible without your support.</p>
<ul>
<li>
<p><a href="https://github.com/sponsors/lupyuen"><strong>Sponsor me a coffee</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/book"><strong>Read ‚ÄúThe RISC-V BL602 / BL604 Book‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io"><strong>Check out my articles</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/rss.xml"><strong>RSS Feed</strong></a></p>
</li>
</ul>
<p><em>Got a question, comment or suggestion? Create an Issue or submit a Pull Request here‚Ä¶</em></p>
<p><a href="https://github.com/lupyuen/lupyuen.github.io/blob/master/src/zig.md"><strong><code>lupyuen.github.io/src/zig.md</code></strong></a></p>
<h1 id="notes"><a href="#notes">11 Notes</a></h1>
<ol>
<li>This article is the expanded version of <a href="https://twitter.com/MisterTechBlog/status/1529261120124354560"><strong>this Twitter Thread</strong></a></li>
</ol>
<h1 id="appendix-zig-on-risc-v-bl602-with-apache-nuttx-rtos"><a href="#appendix-zig-on-risc-v-bl602-with-apache-nuttx-rtos">12 Appendix: Zig on RISC-V BL602 with Apache NuttX RTOS</a></h1>
<p>TODO</p>
<p>To build the Zig App for NuttX on BL602‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>#  Enable Zig App in NuttX menuconfig
make menuconfig

#  TODO: Select &quot;Application Configuration &gt; Examples &gt; Hello Zig Example&quot;
#  Save the configuration and exit menuconfig.

#  Build Nuttx
make

#  NuttX Build fails with Undefined Reference to `hello_zig_main`
#  That&#39;s OK, here&#39;s the fix...

#  Download our modified Zig App for NuttX
git clone --recursive https://github.com/lupyuen/zig-bl602-nuttx
cd zig-bl602-nuttx

#  Compile the Zig App for BL602 (RV32IMACF with Hardware Floating-Point)
zig build-obj \
    -target riscv32-freestanding-none \
    -mcpu sifive_e76 \
    hello_zig_main.zig

#  Dump the ABI for the compiled app
riscv64-unknown-elf-readelf -h -A hello_zig_main.o
#  Shows &quot;Flags: 0x1, RVC, soft-float ABI&quot;
#  Which is Software Floating-Point.
#  This won&#39;t link with NuttX because NuttX is compiled with Hardware Floating-Point

#  We change Software Floating-Point to Hardware Floating-Point...
#  Edit hello_zig_main.o in a Hex Editor, change byte 0x24 from 0x01 to 0x03
#  (See https://en.wikipedia.org/wiki/Executable_and_Linkable_Format#File_header)

#  Dump the ABI for the compiled app
riscv64-unknown-elf-readelf -h -A hello_zig_main.o
#  Shows &quot;Flags: 0x3, RVC, single-float ABI&quot;
#  Which is Hardware Floating-Point and will link with NuttX

#  Copy the compiled app to NuttX and overwrite `hello.o`
#  TODO: Change &quot;$HOME/nuttx&quot; to your NuttX Project Directory
cp hello_zig_main.o $HOME/nuttx/apps/examples/hello/*hello.o

#  Build NuttX to link the Zig Object from `hello.o`
make

#  NuttX build should now succeed</code></pre></div>
<p>Boot NuttX and enter this at the NuttX Shell‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>NuttShell (NSH) NuttX-10.3.0-RC2

nsh&gt; hello_zig
Hello, Zig!

nsh&gt; hello
Hello, Zig!</code></pre></div><h1 id="appendix-hello-app"><a href="#appendix-hello-app">13 Appendix: Hello App</a></h1>
<p>TODO</p>
<p>Remember that we overwrote <code>hello.o</code> with our Zig Compiled Object File.</p>
<p>NuttX Build will fail unless we provide the <code>hello_main</code> function‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>riscv64-unknown-elf-ld: nuttx/staging/libapps.a(builtin_list.c.home.user.nuttx.apps.builtin.o):(.rodata.g_builtins+0xcc): 
undefined reference to `hello_main&#39;</code></pre></div>
<p>That‚Äôs why we define <code>hello_main</code> in our Zig App‚Ä¶</p>
<div class="example-wrap"><pre class="language-zig"><code>pub export fn hello_main(
    _argc: c_int, 
    _argv: [*]const [*]const u8
) c_int {
    _ = _argc;
    _ = _argv;
    _ = printf(&quot;Hello, Zig!\n&quot;);
    return 0;
}</code></pre></div>
<p><a href="https://github.com/lupyuen/zig-bl602-nuttx/blob/main/hello_zig_main.zig">(Source)</a></p>
<p>Which means that the <code>hello</code> app will call our Zig Code too‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>NuttShell (NSH) NuttX-10.3.0-RC2

nsh&gt; hello
Hello, Zig!</code></pre></div>
    
</body>
</html>