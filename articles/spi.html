<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="rustdoc">
    <title>PineCone BL602 talks SPI too!</title>

    
    <!-- Begin scripts/articles/*-header.html: Article Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<meta property="og:title" 
    content="PineCone BL602 talks SPI too!" 
    data-rh="true">
<meta property="og:description" 
    content="PineCone BL602 RISC-V Board talks to BME280 Sensor over SPI... Let's find out how" 
    data-rh="true">
<meta property="og:image" 
    content="https://lupyuen.github.io/images/spi-title.jpg">
<meta property="og:type" 
    content="article" data-rh="true">
<!-- End scripts/articles/*-header.html -->
<!-- Begin scripts/rustdoc-header.html: Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<link rel="alternate" type="application/rss+xml" title="RSS Feed for lupyuen" href="/rss.xml" />
<link rel="stylesheet" type="text/css" href="../normalize.css">
<link rel="stylesheet" type="text/css" href="../rustdoc.css" id="mainThemeStyle">
<link rel="stylesheet" type="text/css" href="../dark.css">
<link rel="stylesheet" type="text/css" href="../light.css" id="themeStyle">
<link rel="stylesheet" type="text/css" href="../prism.css">
<script src="../storage.js"></script><noscript>
<link rel="stylesheet" href="../noscript.css"></noscript>
<link rel="shortcut icon" href="../favicon.ico">
<style type="text/css">
    #crate-search {
        background-image: url("../down-arrow.svg");
    }
    a {
        color: #77d;
    }
</style>
<!-- End scripts/rustdoc-header.html -->


</head>
<body class="rustdoc">
    <!--[if lte IE 8]>
    <div class="warning">
        This old browser is unsupported and will most likely display funky
        things.
    </div>
    <![endif]-->

        <!-- Begin scripts/rustdoc-before.html: Pre-HTML for Custom Markdown files processed by rustdoc, like chip8.md -->

    <!-- Begin Theme Picker -->
    <div class="theme-picker" style="left: 0"><button id="theme-picker" aria-label="Pick another theme!"><img src="../brush.svg"
        width="18" alt="Pick another theme!"></button>
        <div id="theme-choices"></div>
    </div>
    <script src="../theme.js"></script>
    <script src="../prism.js"></script>
    <!-- Theme Picker -->

    <!-- End scripts/rustdoc-before.html -->
    

    <h1 class="title">PineCone BL602 talks SPI too!</h1>
    <nav id="TOC"><ul>
<li><a href="#times-are-a-changin">1 Times Are a-Changin'</a><ul></ul></li>
<li><a href="#bl602-hardware-abstraction-layer-for-spi">2 BL602 Hardware Abstraction Layer for SPI</a><ul></ul></li>
<li><a href="#connect-bl602-to-bme280-spi-sensor">3 Connect BL602 to BME280 SPI Sensor</a><ul></ul></li>
<li><a href="#initialise-spi-port">4 Initialise SPI Port</a><ul></ul></li>
<li><a href="#transmit-spi-data">5 Transmit SPI Data</a><ul></ul></li>
<li><a href="#receive-spi-data">6 Receive SPI Data</a><ul></ul></li>
<li><a href="#show-the-results">7 Show the Results</a><ul></ul></li>
<li><a href="#build-and-run-the-firmware">8 Build and Run the Firmware</a><ul></ul></li>
<li><a href="#port-bl602-spi-hal-to-other-operating-systems">9 Port BL602 SPI HAL to other Operating Systems</a><ul></ul></li>
<li><a href="#whats-next">10 What's Next</a><ul></ul></li>
<li><a href="#appendix-test-bme280-with-bus-pirate">11 Appendix: Test BME280 with Bus Pirate</a><ul></ul></li>
<li><a href="#appendix-troubleshoot-bl602-spi-with-logic-analyser">12 Appendix: Troubleshoot BL602 SPI with Logic Analyser</a><ul></ul></li></ul></nav><p>üìù <em>10 Feb 2021</em></p>
<p>Here's the source code for BL602 accessing BME280 over SPI: <a href="https://github.com/lupyuen/bl_iot_sdk/blob/spi/customer_app/sdk_app_spi/sdk_app_spi/demo.c"><code>sdk_app_spi/demo.c</code></a></p>
<p>In this article we'll study the source code and look into these issues with BL602 SPI...</p>
<ol>
<li>
<p>The pins for <strong>Serial Data In</strong> and <strong>Serial Data Out</strong> seem to be flipped, when observed with a Logic Analyser. </p>
<p>This contradicts the BL602 Reference Manual.</p>
</li>
<li>
<p>To talk to BME280, we must configure BL602 for <strong>SPI Polarity 0, Phase 1</strong>.</p>
<p>Though the Logic Analyser shows that it looks like SPI Phase 0.</p>
</li>
<li>
<p>BL602's <strong>SPI Chip Select Pin</strong> doesn't work with BME280's SPI protocol.</p>
<p>We'll control the SPI Chip Select Pin ourselves.</p>
</li>
<li>
<p>Setting <strong>Serial Data Out to Pin 0</strong> will switch on the WiFi LED.</p>
<p>We'll switch to a different pin for Serial Data Out.</p>
</li>
</ol>
<p>Also we'll learn to <strong>troubleshoot BL602 SPI with a Logic Analyser</strong>.</p>
<p><img src="https://lupyuen.github.io/images/spi-title.jpg" alt="PineCone BL602 RISC-V Board connected to BME280 SPI Sensor" /></p>
<p><em>PineCone BL602 RISC-V Board connected to BME280 SPI Sensor</em></p>
<h1 id="times-are-a-changin" class="section-header"><a href="#times-are-a-changin">1 Times Are a-Changin'</a></h1>
<p>Humans evolve... So do the terms that we use!</p>
<p>This article will become obsolete quickly unless we adopt the <a href="https://www.oshwa.org/a-resolution-to-redefine-spi-signal-names"><strong>new names for SPI Pins</strong></a>...</p>
<ul>
<li>
<p>We'll say <strong>&quot;Serial Data In&quot;</strong> <em>(instead of &quot;MISO&quot;)</em></p>
</li>
<li>
<p>And we'll say <strong>&quot;Serial Data Out&quot;</strong> <em>(instead of &quot;MOSI&quot;)</em></p>
</li>
<li>
<p>We'll refer to BL602 as the <strong>&quot;SPI Controller&quot;</strong></p>
</li>
<li>
<p>And BME280 as the <strong>&quot;SPI Peripheral&quot;</strong></p>
</li>
</ul>
<p>Note that Serial Data In and Serial Data Out are flipped across the SPI Controller and the SPI Peripheral...</p>
<ul>
<li>
<p><strong>Serial Data In on BL602</strong> connects to <strong>Serial Data Out on BME280</strong></p>
</li>
<li>
<p>And <strong>Serial Data Out on BL602</strong> connects to <strong>Serial Data In on BME280</strong></p>
</li>
</ul>
<p>(Yep it works like the Transmit / Receive pins for a UART port)</p>
<h1 id="bl602-hardware-abstraction-layer-for-spi" class="section-header"><a href="#bl602-hardware-abstraction-layer-for-spi">2 BL602 Hardware Abstraction Layer for SPI</a></h1>
<p>TODO</p>
<h1 id="connect-bl602-to-bme280-spi-sensor" class="section-header"><a href="#connect-bl602-to-bme280-spi-sensor">3 Connect BL602 to BME280 SPI Sensor</a></h1>
<p>TODO</p>
<h1 id="initialise-spi-port" class="section-header"><a href="#initialise-spi-port">4 Initialise SPI Port</a></h1>
<p>TODO</p>
<p><a href="https://github.com/lupyuen/bl_iot_sdk/blob/spi/customer_app/sdk_app_spi/sdk_app_spi/demo.c#L45-L100"><code>sdk_app_spi/demo.c</code></a></p>
<pre><code class="language-c">/// Use SPI Port Number 0
#define SPI_PORT   0

/// Use GPIO 14 as SPI Chip Select Pin
#define SPI_CS_PIN 14

/// SPI Port
static spi_dev_t spi;

/// Init the SPI Port
static void test_spi_init(char *buf, int len, int argc, char **argv)
{
    //  Configure the SPI Port
    //  Note: The Chip Select Pin below (2) must NOT be the same as SPI_CS_PIN (14). 
    //  Because the SPI Pin Function will override the GPIO Pin Function!

    //  TODO: The pins for Serial Data In and Serial Data Out seem to be flipped,
    //  when observed with a Logic Analyser. This contradicts the 
    //  BL602 Reference Manual. Why ???

    //  TODO: We must set Polarity=0, Phase=1. Though the Logic Analyser shows
    //  that it looks like Phase=0. Why ???

    //  TODO: Setting Serial Data Out to Pin 0 will switch on the WiFi LED.
    //  Why ???

    int rc = spi_init(
        &amp;spi,        //  SPI Device
        SPI_PORT,    //  SPI Port
        0,           //  SPI Mode: 0 for Controller (formerly Master), 1 for Peripheral (formerly Slave)
        1,           //  SPI Polar Phase: 0 (CPOL=0, CPHA=0), 1 (CPOL=0, CPHA=1), 2 (CPOL=1, CPHA=0) or 3 (CPOL=1, CPHA=1)
        200 * 1000,  //  SPI Frequency (200 kHz)
        2,   //  Transmit DMA Channel
        3,   //  Receive DMA Channel
        3,   //  (Yellow) SPI Clock Pin 
        2,   //  (Unused) SPI Chip Select Pin (Unused because we control GPIO 14 ourselves as Chip Select Pin. This must NOT be set to 14, SPI will override our GPIO!)
        1,   //  (Green)  SPI Serial Data In Pin  (formerly MISO)
        4    //  (Blue)   SPI Serial Data Out Pin (formerly MOSI)
    );
    assert(rc == 0);

    //  Configure Chip Select pin as a GPIO Pin
    GLB_GPIO_Type pins[1];
    pins[0] = SPI_CS_PIN;
    BL_Err_Type rc2 = GLB_GPIO_Func_Init(GPIO_FUN_SWGPIO, pins, sizeof(pins) / sizeof(pins[0]));
    assert(rc2 == SUCCESS);

    //  Configure Chip Select pin as a GPIO Output Pin (instead of GPIO Input)
    rc = bl_gpio_enable_output(SPI_CS_PIN, 0, 0);
    assert(rc == 0);

    //  Set Chip Select pin to High, to deactivate BME280
    printf(&quot;Set CS pin %d to high\r\n&quot;, SPI_CS_PIN);
    rc = bl_gpio_output_set(SPI_CS_PIN, 1);
    assert(rc == 0);
}
</code></pre>
<h1 id="transmit-spi-data" class="section-header"><a href="#transmit-spi-data">5 Transmit SPI Data</a></h1>
<p>TODO</p>
<p><a href="https://github.com/lupyuen/bl_iot_sdk/blob/spi/customer_app/sdk_app_spi/sdk_app_spi/demo.c#L110-L156"><code>sdk_app_spi/demo.c</code></a></p>
<pre><code class="language-c">/// Start the SPI data transfer
static void test_spi_transfer(char *buf, int len, int argc, char **argv)
{
    //  Clear the buffers
    memset(&amp;tx_buf1, 0, sizeof(tx_buf1));
    memset(&amp;rx_buf1, 0, sizeof(rx_buf1));
    memset(&amp;tx_buf2, 0, sizeof(tx_buf2));
    memset(&amp;rx_buf2, 0, sizeof(rx_buf2));

    //  Prepare 2 SPI Transfers
    static spi_ioc_transfer_t transfers[2];
    memset(transfers, 0, sizeof(transfers));    

    //  First SPI Transfer: Transmit Register ID (0xD0) to BME280
    tx_buf1[0] = 0xd0;  //  Read BME280 Chip ID Register (0xD0). Read/Write Bit (High Bit) is 1 for Read.
    transfers[0].tx_buf = (uint32_t) tx_buf1;  //  Transmit Buffer (Register ID)
    transfers[0].rx_buf = (uint32_t) rx_buf1;  //  Receive Buffer
    transfers[0].len    = sizeof(tx_buf1);     //  How many bytes

    //  Second SPI Transfer: Receive Chip ID (0x60) from BME280
    tx_buf2[0] = 0xff;  //  Unused. Read/Write Bit (High Bit) is 1 for Read.
    transfers[1].tx_buf = (uint32_t) tx_buf2;  //  Transmit Buffer
    transfers[1].rx_buf = (uint32_t) rx_buf2;  //  Receive Buffer (Chip ID)
    transfers[1].len    = sizeof(tx_buf2);     //  How many bytes

    //  Set Chip Select pin to Low, to activate BME280
    printf(&quot;Set CS pin %d to low\r\n&quot;, SPI_CS_PIN);
    int rc = bl_gpio_output_set(SPI_CS_PIN, 0);
    assert(rc == 0);

    //  Execute the two SPI Transfers with the DMA Controller
    rc = hal_spi_transfer(
        &amp;spi,       //  SPI Device
        transfers,  //  SPI Transfers
        sizeof(transfers) / sizeof(transfers[0])  //  How many transfers (Number of requests, not bytes)
    );
    assert(rc == 0);

    //  DMA Controller will transmit and receive the SPI data in the background.
    //  hal_spi_transfer will wait for the two SPI Transfers to complete before returning.
    //  Now that we're done with the two SPI Transfers...

    //  Set Chip Select pin to High, to deactivate BME280
    rc = bl_gpio_output_set(SPI_CS_PIN, 1);
    assert(rc == 0);
    printf(&quot;Set CS pin %d to high\r\n&quot;, SPI_CS_PIN);
}
</code></pre>
<h1 id="receive-spi-data" class="section-header"><a href="#receive-spi-data">6 Receive SPI Data</a></h1>
<p>TODO</p>
<h1 id="show-the-results" class="section-header"><a href="#show-the-results">7 Show the Results</a></h1>
<p>TODO</p>
<p><a href="https://github.com/lupyuen/bl_iot_sdk/blob/spi/customer_app/sdk_app_spi/sdk_app_spi/demo.c#L158-L182"><code>sdk_app_spi/demo.c</code></a></p>
<pre><code class="language-c">/// Show the SPI data received and the interrupt counters
static void test_spi_result(char *buf, int len, int argc, char **argv)
{
    //  Show the received data
    printf(&quot;SPI Transfer #1: Received Data 0x%p:\r\n&quot;, rx_buf1);
    for (int i = 0; i &lt; sizeof(rx_buf1); i++) {
        printf(&quot;  %02x\r\n&quot;, rx_buf1[i]);
    }
    printf(&quot;SPI Transfer #2: Received Data 0x%p:\r\n&quot;, rx_buf2);
    for (int i = 0; i &lt; sizeof(rx_buf2); i++) {
        printf(&quot;  %02x\r\n&quot;, rx_buf2[i]);
    }

    //  Show the Interrupt Counters, Status and Error Codes defined in components/hal_drv/bl602_hal/hal_spi.c
    extern int g_tx_counter, g_rx_counter;
    extern uint32_t g_tx_status, g_tx_tc, g_tx_error, g_rx_status, g_rx_tc, g_rx_error;
    printf(&quot;Tx Interrupts: %d\r\n&quot;,   g_tx_counter);
    printf(&quot;Tx Status:     0x%x\r\n&quot;, g_tx_status);
    printf(&quot;Tx Term Count: 0x%x\r\n&quot;, g_tx_tc);
    printf(&quot;Tx Error:      0x%x\r\n&quot;, g_tx_error);
    printf(&quot;Rx Interrupts: %d\r\n&quot;,   g_rx_counter);
    printf(&quot;Rx Status:     0x%x\r\n&quot;, g_rx_status);
    printf(&quot;Rx Term Count: 0x%x\r\n&quot;, g_rx_tc);
    printf(&quot;Rx Error:      0x%x\r\n&quot;, g_rx_error);
}
</code></pre>
<h1 id="build-and-run-the-firmware" class="section-header"><a href="#build-and-run-the-firmware">8 Build and Run the Firmware</a></h1>
<p>TODO</p>
<pre><code class="language-text"># help
====Build-in Commands====
====Support 4 cmds once, seperate by ; ====
help                     : print this
p                        : print memory
m                        : modify memory
echo                     : echo for command
exit                     : close CLI
devname                  : print device name
sysver                   : system version
reboot                   : reboot system
poweroff                 : poweroff system
reset                    : system reset
time                     : system time
ota                      : system ota
ps                      : thread dump
ls                       : file list
hexdump                  : dump file
cat                      : cat file

====User Commands====
spi_init                 : Init SPI port
spi_transfer             : Transfer SPI data
spi_result               : Show SPI data received
blogset                  : blog pri set level
blogdump                 : blog info dump
bl_sys_time_now          : sys time now

# spi_init
port0 eventloop init = 42010b48
[HAL] [SPI] Init :
port=0, mode=0, polar_phase = 1, freq=200000, tx_dma_ch=2, rx_dma_ch=3, pin_clk=3, pin_cs=2, pin_mosi=1, pin_miso=4
set rwspeed = 200000
hal_gpio_init: cs:2, clk:3, mosi:1, miso: 4
hal_gpio_init: SPI controller mode
hal_spi_init.
Set CS pin 14 to high

# spi_transfer
Set CS pin 14 to low
hal_spi_transfr = 2
transfer xfer[0].len = 1
Tx DMA src=0x4200d1b8, dest=0x4000a288, size=1, si=1, di=0, i=1
Rx DMA src=0x4000a28c, dest=0x4200d1b0, size=1, si=0, di=1, i=1
recv all event group.
transfer xfer[1].len = 1
Tx DMA src=0x4200d1bc, dest=0x4000a288, size=1, si=1, di=0, i=1
Rx DMA src=0x4000a28c, dest=0x4200d1b4, size=1, si=0, di=1, i=1
recv all event group.
Set CS pin 14 to high

# spi_result
SPI Transfer #1: Received Data 0x0x4200d1b0:
  ff
SPI Transfer #2: Received Data 0x0x4200d1b4:
  60
Tx Interrupts: 2
Tx Status:     0x0
Tx Term Count: 0x0
Tx Error:      0x0
Rx Interrupts: 2
Rx Status:     0x0
Rx Term Count: 0x0
Rx Error:      0x0
</code></pre>
<h1 id="port-bl602-spi-hal-to-other-operating-systems" class="section-header"><a href="#port-bl602-spi-hal-to-other-operating-systems">9 Port BL602 SPI HAL to other Operating Systems</a></h1>
<p>TODO</p>
<h1 id="whats-next" class="section-header"><a href="#whats-next">10 What's Next</a></h1>
<p>TODO</p>
<ul>
<li>
<p><a href="https://github.com/sponsors/lupyuen">Sponsor me a coffee</a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io">Check out my articles</a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/rss.xml">RSS Feed</a></p>
</li>
</ul>
<p><em>Got a question, comment or suggestion? Create an Issue or submit a Pull Request here...</em></p>
<p><a href="https://github.com/lupyuen/lupyuen.github.io/blob/master/src/spi.md"><code>lupyuen.github.io/src/spi.md</code></a></p>
<h1 id="appendix-test-bme280-with-bus-pirate" class="section-header"><a href="#appendix-test-bme280-with-bus-pirate">11 Appendix: Test BME280 with Bus Pirate</a></h1>
<p>TODO</p>
<h1 id="appendix-troubleshoot-bl602-spi-with-logic-analyser" class="section-header"><a href="#appendix-troubleshoot-bl602-spi-with-logic-analyser">12 Appendix: Troubleshoot BL602 SPI with Logic Analyser</a></h1>
<p>TODO</p>

    
</body>
</html>