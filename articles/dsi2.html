<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="rustdoc">
    <title>NuttX RTOS for PinePhone: Display Driver in Zig</title>

    
    <!-- Begin scripts/articles/*-header.html: Article Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<meta property="og:title" 
    content="NuttX RTOS for PinePhone: Display Driver in Zig" 
    data-rh="true">
<meta property="og:description" 
    content="Let's build a PinePhone Display Driver in Zig... That will run on Apache NuttX RTOS"
    data-rh="true">
<meta name="description" 
    content="Let's build a PinePhone Display Driver in Zig... That will run on Apache NuttX RTOS">
<meta property="og:image" 
    content="https://lupyuen.github.io/images/dsi2-title.jpg">
<meta property="og:type" 
    content="article" data-rh="true">
<!-- End scripts/articles/*-header.html -->
<!-- Begin scripts/rustdoc-header.html: Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<link rel="alternate" type="application/rss+xml" title="RSS Feed for lupyuen" href="/rss.xml" />
<link rel="stylesheet" type="text/css" href="../normalize.css">
<link rel="stylesheet" type="text/css" href="../rustdoc.css" id="mainThemeStyle">
<link rel="stylesheet" type="text/css" href="../dark.css">
<link rel="stylesheet" type="text/css" href="../light.css" id="themeStyle">
<link rel="stylesheet" type="text/css" href="../prism.css">
<script src="../storage.js"></script><noscript>
<link rel="stylesheet" href="../noscript.css"></noscript>
<link rel="shortcut icon" href="../favicon.ico">
<style type="text/css">
    #crate-search {
        background-image: url("../down-arrow.svg");
    }
    a {
        color: #77d;
    }
</style>
<!-- End scripts/rustdoc-header.html -->


</head>
<body class="rustdoc">
    <!--[if lte IE 8]>
    <div class="warning">
        This old browser is unsupported and will most likely display funky
        things.
    </div>
    <![endif]-->

        <!-- Begin scripts/rustdoc-before.html: Pre-HTML for Custom Markdown files processed by rustdoc, like chip8.md -->

    <!-- Begin Theme Picker -->
    <div class="theme-picker" style="left: 0"><button id="theme-picker" aria-label="Pick another theme!"><img src="../brush.svg"
        width="18" alt="Pick another theme!"></button>
        <div id="theme-choices"></div>
    </div>
    <script src="../theme.js"></script>
    <script src="../prism.js"></script>
    <!-- Theme Picker -->

    <!-- End scripts/rustdoc-before.html -->
    

    <h1 class="title">NuttX RTOS for PinePhone: Display Driver in Zig</h1>
    <nav id="TOC"><ul>
<li><a href="#inside-pinephone">1 Inside PinePhone</a><ul></ul></li>
<li><a href="#send-commands-to-lcd-controller">2 Send Commands to LCD Controller</a><ul></ul></li>
<li><a href="#zig-on-pinephone">3 Zig on PinePhone</a><ul></ul></li>
<li><a href="#zig-driver-for-pinephone-mipi-dsi">4 Zig Driver for PinePhone MIPI DSI</a><ul></ul></li>
<li><a href="#compose-mipi-dsi-long-packet-in-zig">5 Compose MIPI DSI Long Packet in Zig</a><ul></ul></li>
<li><a href="#compose-mipi-dsi-short-packet-in-zig">6 Compose MIPI DSI Short Packet in Zig</a><ul></ul></li>
<li><a href="#compute-error-correction-code-in-zig">7 Compute Error Correction Code in Zig</a><ul></ul></li>
<li><a href="#compute-cyclic-redundancy-check-in-zig">8 Compute Cyclic Redundancy Check in Zig</a><ul></ul></li>
<li><a href="#test-pinephone-mipi-dsi-driver-with-qemu">9 Test PinePhone MIPI DSI Driver with QEMU</a><ul></ul></li>
<li><a href="#test-case-for-pinephone-mipi-dsi-driver">10 Test Case for PinePhone MIPI DSI Driver</a><ul></ul></li>
<li><a href="#initialise-st7703-lcd-controller-in-zig">11 Initialise ST7703 LCD Controller in Zig</a><ul></ul></li>
<li><a href="#test-zig-display-driver-for-pinephone">12 Test Zig Display Driver for PinePhone</a><ul></ul></li>
<li><a href="#whats-next">13 What‚Äôs Next</a><ul></ul></li></ul></nav><p>üìù <em>17 Oct 2022</em></p>
<p><img src="https://lupyuen.github.io/images/dsi2-title.jpg" alt="Apache NuttX RTOS rendering something on PinePhone‚Äôs LCD Display" /></p>
<p>In our last article we talked about <a href="https://wiki.pine64.org/index.php/PinePhone"><strong>Pine64 PinePhone</strong></a> (pic above) and its <a href="https://lupyuen.github.io/articles/dsi#xingbangda-xbd599-lcd-panel"><strong>LCD Display</strong></a>, connected via the (super complicated) <a href="https://lupyuen.github.io/articles/dsi#connector-for-mipi-dsi"><strong>MIPI Display Serial Interface</strong></a>‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/dsi"><strong>‚ÄúUnderstanding PinePhone‚Äôs Display (MIPI DSI)‚Äù</strong></a></li>
</ul>
<p>Today we shall create a <strong>PinePhone Display Driver in Zig</strong>‚Ä¶ That will run on our fresh new port of <a href="https://lupyuen.github.io/articles/uboot"><strong>Apache NuttX RTOS</strong></a> for PinePhone.</p>
<p><em>Why build the Display Driver in Zig? Instead of C?</em></p>
<p>Sadly some parts of PinePhone‚Äôs <a href="https://lupyuen.github.io/articles/dsi#sitronix-st7703-lcd-controller"><strong>ST7703 LCD Controller</strong></a> and <a href="https://lupyuen.github.io/articles/dsi#initialise-mipi-dsi"><strong>Allwinner A64 SoC</strong></a> are poorly documented. (Sigh)</p>
<p>Thus we‚Äôre building a <strong>Quick Prototype</strong> in Zig to be sure we‚Äôre setting the Hardware Registers correctly.</p>
<p>And while rushing through the reckless coding, it‚Äôs great to have Zig cover our backs and catch <a href="https://ziglang.org/documentation/master/#Undefined-Behavior"><strong>Common Runtime Problems</strong></a>.</p>
<p>Like Null Pointers, Underflow, Overflow, Array Out Of Bounds, ‚Ä¶</p>
<p><em>Will our final driver be in Zig or C?</em></p>
<p>Maybe Zig, maybe C?</p>
<p>It‚Äôs awfully nice to use Zig to simplify the complicated driver code. Zig‚Äôs <a href="https://ziglang.org/documentation/master/#Undefined-Behavior"><strong>Runtime Safety Checks</strong></a> are extremely helpful too.</p>
<p>But this driver goes into the <strong>NuttX RTOS Kernel</strong>. So most folks would expect the final driver to be delivered in C?</p>
<p>In any case, Zig and C look highly similar. Converting the Zig Driver to C should be straightforward.</p>
<p>(Minus the Runtime Safety Checks)</p>
<p>Zig or C? Lemme know what you think! üôè</p>
<p>Let‚Äôs continue the journey from our <strong>NuttX Porting Journal</strong>‚Ä¶</p>
<ul>
<li><a href="https://github.com/lupyuen/pinephone-nuttx"><strong>lupyuen/pinephone-nuttx</strong></a></li>
</ul>
<p><img src="https://lupyuen.github.io/images/dsi-title.jpg" alt="LCD Display on PinePhone Schematic (Page 2)" /></p>
<p><a href="https://files.pine64.org/doc/PinePhone/PinePhone%20v1.2b%20Released%20Schematic.pdf"><em>LCD Display on PinePhone Schematic (Page 2)</em></a></p>
<h1 id="inside-pinephone"><a href="#inside-pinephone">1 Inside PinePhone</a></h1>
<p><em>How is the LCD Display connected inside PinePhone?</em></p>
<p>Inside PinePhone is a <strong>XBD599 LCD Panel</strong> by Xingbangda‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/dsi#xingbangda-xbd599-lcd-panel"><strong>‚ÄúXingbangda XBD599 LCD Panel‚Äù</strong></a></li>
</ul>
<p>The LCD Display is connected to the <a href="https://linux-sunxi.org/A64"><strong>Allwinner A64 SoC</strong></a> via a <strong>MIPI Display Serial Interface (DSI)</strong>. (Pic above)</p>
<p><a href="https://en.wikipedia.org/wiki/MIPI_Alliance">(MIPI is the <strong>Mobile Industry Processor Interface Alliance</strong>)</a></p>
<p><em>What‚Äôs a MIPI Display Serial Interface?</em></p>
<p>Think of it as SPI, but supercharged with <strong>Multiple Data Lanes</strong>!</p>
<p>This pic below shows the MIPI DSI Connector that connects PinePhone‚Äôs <strong>Allwinner A64 SoC</strong> directly to the LCD Display‚Ä¶</p>
<ul>
<li>
<p><strong>CKN and CKP</strong> are the DSI Clock Lines</p>
<p>(Similar to SPI Clock)</p>
</li>
<li>
<p><strong>D0N and D0P</strong> for DSI Data Lane 0</p>
<p>(Similar to SPI MISO / MOSI)</p>
</li>
<li>
<p><strong>D1N and D1P</strong> for DSI Data Lane 1</p>
<p>(Yep DSI has more data lanes than SPI)</p>
</li>
<li>
<p><strong>D2N and D2P</strong> for DSI Data Lane 2</p>
</li>
<li>
<p><strong>D3N and D3P</strong> for DSI Data Lane 3</p>
<p>(MIPI DSI has 4 data lanes!)</p>
</li>
</ul>
<p><em>Why two connections per Data Lane?</em></p>
<p><strong>N</strong> means Negative, <strong>P</strong> means Positive.</p>
<p>MIPI DSI uses <a href="https://en.wikipedia.org/wiki/Differential_signalling"><strong>Differential Signalling</strong></a> for high-speed data transfers.</p>
<p>(Differential Signalling is also used in <a href="https://en.wikipedia.org/wiki/HDMI"><strong>HDMI</strong></a> and <a href="https://en.wikipedia.org/wiki/USB#Signaling"><strong>USB</strong></a>)</p>
<p><a href="https://en.wikipedia.org/wiki/Display_Serial_Interface">(More about Display Serial Interface)</a></p>
<p>Let‚Äôs look inside the XBD599 LCD Panel‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/dsi-connector.png" alt="MIPI DSI Connector on PinePhone Schematic (Page 11)" /></p>
<p><a href="https://files.pine64.org/doc/PinePhone/PinePhone%20v1.2b%20Released%20Schematic.pdf"><em>MIPI DSI Connector on PinePhone Schematic (Page 11)</em></a></p>
<h1 id="send-commands-to-lcd-controller"><a href="#send-commands-to-lcd-controller">2 Send Commands to LCD Controller</a></h1>
<p><em>How do we control PinePhone‚Äôs LCD Display?</em></p>
<p>The XBD599 LCD Panel has a <strong>Sitronix ST7703 LCD Controller</strong> inside‚Ä¶</p>
<ul>
<li><a href="https://files.pine64.org/doc/datasheet/pinephone/ST7703_DS_v01_20160128.pdf"><strong>Sitronix ST7703 LCD Controller Datasheet</strong></a></li>
</ul>
<p>Which means our PinePhone Display Driver shall <strong>send commands to the ST7703 LCD Controller</strong> over the MIPI Display Serial Interface.</p>
<p><em>What commands will our Display Driver send to ST7703?</em></p>
<p>At startup, our driver shall these 20 <strong>Initialisation Commands</strong> to the ST7703 LCD Controller‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/dsi#appendix-initialise-lcd-controller"><strong>‚ÄúInitialise LCD Controller‚Äù</strong></a></li>
</ul>
<p>TODO</p>
<div><table><thead><tr><th style="text-align: center">Byte</th><th style="text-align: left">Purpose</th></tr></thead><tbody>
<tr><td style="text-align: center">#1</td><td style="text-align: left"></td></tr>
<tr><td style="text-align: center"><code>0xB9</code></td><td style="text-align: left"><strong>SETEXTC</strong> (Page 131): <br> Enable USER Command</td></tr>
<tr><td style="text-align: center"><code>0xF1</code></td><td style="text-align: left">Enable User command</td></tr>
<tr><td style="text-align: center"><code>0x12</code></td><td style="text-align: left"><em>(Continued)</em></td></tr>
<tr><td style="text-align: center"><code>0x83</code></td><td style="text-align: left"><em>(Continued)</em></td></tr>
</tbody></table>
</div>
<p>TODO</p>
<div><table><thead><tr><th style="text-align: center">Byte</th><th style="text-align: left">Purpose</th></tr></thead><tbody>
<tr><td style="text-align: center">#16</td><td style="text-align: left"></td></tr>
<tr><td style="text-align: center"><code>0xE9</code></td><td style="text-align: left"><strong>SETGIP1</strong> (Page 163): <br> Set forward GIP timing</td></tr>
<tr><td style="text-align: center"><code>0x82</code></td><td style="text-align: left">SHR0, SHR1, CHR, CHR2 refer to Internal DE <br> <em>(REF_EN = 1)</em> <br> <em>(PANEL_SEL = 2)</em></td></tr>
<tr><td style="text-align: center"><code>0x10</code></td><td style="text-align: left">Starting position of GIP STV group 0 = 4102 HSYNC <br> <em>(SHR0 Bits 8-12 = <code>0x10</code>)</em></td></tr>
<tr><td style="text-align: center"><code>0x06</code></td><td style="text-align: left"><em>(SHR0 Bits 0-7  = <code>0x06</code>)</em></td></tr>
<tr><td style="text-align: center"><code>0x05</code></td><td style="text-align: left">Starting position of GIP STV group 1 = 1442 HSYNC <br> <em>(SHR1 Bits 8-12 = <code>0x05</code>)</em></td></tr>
<tr><td style="text-align: center"><code>0xA2</code></td><td style="text-align: left"><em>(SHR1 Bits 0-7  = <code>0xA2</code>)</em></td></tr>
<tr><td style="text-align: center"><code>0x0A</code></td><td style="text-align: left">Distance of STV rising edge and HYSNC  = 10*2  Fosc <br> <em>(SPON  Bits 0-7 = <code>0x0A</code>)</em></td></tr>
<tr><td style="text-align: center"><code>0xA5</code></td><td style="text-align: left">Distance of STV falling edge and HYSNC = 165*2 Fosc <br> <em>(SPOFF Bits 0-7 = <code>0xA5</code>)</em></td></tr>
<tr><td style="text-align: center"><code>0x12</code></td><td style="text-align: left">STV0_1 distance with STV0_0 = 1 HSYNC <br> <em>(SHR0_1 = 1)</em> <br> STV0_2 distance with STV0_0 = 2 HSYNC <br> <em>(SHR0_2 = 2)</em></td></tr>
<tr><td style="text-align: center"><code>0x31</code></td><td style="text-align: left">STV0_3 distance with STV0_0 = 3 HSYNC <br> <em>(SHR0_3 = 3)</em> <br> STV1_1 distance with STV1_0 = 1 HSYNC <br> <em>(SHR1_1 = 1)</em></td></tr>
<tr><td style="text-align: center"><code>0x23</code></td><td style="text-align: left">STV1_2 distance with STV1_0 = 2 HSYNC <br> <em>(SHR1_2 = 2)</em> <br> STV1_3 distance with STV1_0 = 3 HSYNC <br> <em>(SHR1_3 = 3)</em></td></tr>
<tr><td style="text-align: center"><code>0x37</code></td><td style="text-align: left">STV signal high pulse width = 3 HSYNC <br> <em>(SHP = 3)</em> <br> Total number of STV signal = 7 <br> <em>(SCP = 7)</em></td></tr>
<tr><td style="text-align: center"><code>0x83</code></td><td style="text-align: left">Starting position of GIP CKV group 0 <br> <em>(CKV0_0)</em> = 131 HSYNC <br> <em>(CHR = <code>0x83</code>)</em></td></tr>
<tr><td style="text-align: center"><code>0x04</code></td><td style="text-align: left">Distance of CKV rising edge and HYSNC  = 4*2   Fosc <br> <em>(CON  Bits 0-7 = <code>0x04</code>)</em></td></tr>
<tr><td style="text-align: center"><code>0xBC</code></td><td style="text-align: left">Distance of CKV falling edge and HYSNC = 188*2 Fosc <br> <em>(COFF Bits 0-7 = <code>0xBC</code>)</em></td></tr>
<tr><td style="text-align: center"><code>0x27</code></td><td style="text-align: left">CKV signal high pulse width = 2 HSYNC <br> <em>(CHP = 2)</em> <br> Total period cycle of CKV signal = 7 HSYNC <br> <em>(CCP = 7)</em></td></tr>
<tr><td style="text-align: center"><code>0x38</code></td><td style="text-align: left">Extra gate counter at blanking area: Gate number = 56 <br> <em>(USER_GIP_GATE = <code>0x38</code>)</em></td></tr>
<tr><td style="text-align: center"><code>0x0C</code></td><td style="text-align: left">Left side GIP output pad signal = ??? <br> <em>(CGTS_L Bits 16-21 = <code>0x0C</code>)</em></td></tr>
<tr><td style="text-align: center"><code>0x00</code></td><td style="text-align: left"><em>(CGTS_L Bits  8-15 = <code>0x00</code>)</em></td></tr>
<tr><td style="text-align: center"><code>0x03</code></td><td style="text-align: left"><em>(CGTS_L Bits  0-7  = <code>0x03</code>)</em></td></tr>
<tr><td style="text-align: center"><code>0x00</code></td><td style="text-align: left">Normal polarity of Left side GIP output pad signal <br> <em>(CGTS_INV_L Bits 16-21 = <code>0x00</code>)</em></td></tr>
<tr><td style="text-align: center"><code>0x00</code></td><td style="text-align: left"><em>(CGTS_INV_L Bits  8-15 = <code>0x00</code>)</em></td></tr>
<tr><td style="text-align: center"><code>0x00</code></td><td style="text-align: left"><em>(CGTS_INV_L Bits  0-7  = <code>0x00</code>)</em></td></tr>
<tr><td style="text-align: center"><code>0x0C</code></td><td style="text-align: left">Right side GIP output pad signal = ??? <br> <em>(CGTS_R Bits 16-21 = <code>0x0C</code>)</em></td></tr>
<tr><td style="text-align: center"><code>0x00</code></td><td style="text-align: left"><em>(CGTS_R Bits  8-15 = <code>0x00</code>)</em></td></tr>
<tr><td style="text-align: center"><code>0x03</code></td><td style="text-align: left"><em>(CGTS_R Bits  0-7  = <code>0x03</code>)</em></td></tr>
<tr><td style="text-align: center"><code>0x00</code></td><td style="text-align: left">Normal polarity of Right side GIP output pad signal <br> <em>(CGTS_INV_R Bits 16-21 = <code>0x00</code>)</em></td></tr>
<tr><td style="text-align: center"><code>0x00</code></td><td style="text-align: left"><em>(CGTS_INV_R Bits  8-15 = <code>0x00</code>)</em></td></tr>
<tr><td style="text-align: center"><code>0x00</code></td><td style="text-align: left"><em>(CGTS_INV_R Bits  0-7  = <code>0x00</code>)</em></td></tr>
<tr><td style="text-align: center"><code>0x75</code></td><td style="text-align: left">Left side GIP output pad signal = ??? <br> <em>(COS1_L = 7)</em> <br> Left side GIP output pad signal = ??? <br> <em>(COS2_L = 5)</em></td></tr>
<tr><td style="text-align: center"><code>0x75</code></td><td style="text-align: left">Left side GIP output pad signal = ??? <br> <em>(COS3_L = 7)</em> <br> <em>(COS4_L = 5)</em></td></tr>
<tr><td style="text-align: center"><code>0x31</code></td><td style="text-align: left">Left side GIP output pad signal = ??? <br> <em>(COS5_L = 3)</em> <br> <em>(COS6_L = 1)</em></td></tr>
<tr><td style="text-align: center"><code>0x88</code></td><td style="text-align: left">Reserved <em>(Parameter 32)</em></td></tr>
<tr><td style="text-align: center"><code>0x88</code></td><td style="text-align: left">Reserved <em>(Parameter 33)</em></td></tr>
<tr><td style="text-align: center"><code>0x88</code></td><td style="text-align: left">Reserved <em>(Parameter 34)</em></td></tr>
<tr><td style="text-align: center"><code>0x88</code></td><td style="text-align: left">Reserved <em>(Parameter 35)</em></td></tr>
<tr><td style="text-align: center"><code>0x88</code></td><td style="text-align: left">Reserved <em>(Parameter 36)</em></td></tr>
<tr><td style="text-align: center"><code>0x88</code></td><td style="text-align: left">Left side GIP output pad signal  = ??? <br> <em>(COS17_L = 8)</em> <br> Left side GIP output pad signal  = ??? <br> <em>(COS18_L = 8)</em></td></tr>
<tr><td style="text-align: center"><code>0x13</code></td><td style="text-align: left">Left side GIP output pad signal  = ??? <br> <em>(COS19_L = 1)</em> <br> Left side GIP output pad signal  = ??? <br> <em>(COS20_L = 3)</em></td></tr>
<tr><td style="text-align: center"><code>0x88</code></td><td style="text-align: left">Left side GIP output pad signal  = ??? <br> <em>(COS21_L = 8)</em> <br> Left side GIP output pad signal  = ??? <br> <em>(COS22_L = 8)</em></td></tr>
<tr><td style="text-align: center"><code>0x64</code></td><td style="text-align: left">Right side GIP output pad signal = ??? <br> <em>(COS1_R  = 6)</em> <br> Right side GIP output pad signal = ??? <br> <em>(COS2_R  = 4)</em></td></tr>
<tr><td style="text-align: center"><code>0x64</code></td><td style="text-align: left">Right side GIP output pad signal = ??? <br> <em>(COS3_R  = 6)</em> <br> Right side GIP output pad signal = ??? <br> <em>(COS4_R  = 4)</em></td></tr>
<tr><td style="text-align: center"><code>0x20</code></td><td style="text-align: left">Right side GIP output pad signal = ??? <br> <em>(COS5_R  = 2)</em> <br> Right side GIP output pad signal = ??? <br> <em>(COS6_R  = 0)</em></td></tr>
<tr><td style="text-align: center"><code>0x88</code></td><td style="text-align: left">Reserved <em>(Parameter 43)</em></td></tr>
<tr><td style="text-align: center"><code>0x88</code></td><td style="text-align: left">Reserved <em>(Parameter 44)</em></td></tr>
<tr><td style="text-align: center"><code>0x88</code></td><td style="text-align: left">Reserved <em>(Parameter 45)</em></td></tr>
<tr><td style="text-align: center"><code>0x88</code></td><td style="text-align: left">Reserved <em>(Parameter 46)</em></td></tr>
<tr><td style="text-align: center"><code>0x88</code></td><td style="text-align: left">Reserved <em>(Parameter 47)</em></td></tr>
<tr><td style="text-align: center"><code>0x88</code></td><td style="text-align: left">Right side GIP output pad signal = ??? <br> <em>(COS17_R = 8)</em> <br> Right side GIP output pad signal = ??? <br> <em>(COS18_R = 8)</em></td></tr>
<tr><td style="text-align: center"><code>0x02</code></td><td style="text-align: left">Right side GIP output pad signal = ??? <br> <em>(COS19_R = 0)</em> <br> Right side GIP output pad signal = ??? <br> <em>(COS20_R = 2)</em></td></tr>
<tr><td style="text-align: center"><code>0x88</code></td><td style="text-align: left">Right side GIP output pad signal = ??? <br> <em>(COS21_R = 8)</em> <br> Right side GIP output pad signal = ??? <br> <em>(COS22_R = 8)</em></td></tr>
<tr><td style="text-align: center"><code>0x00</code></td><td style="text-align: left"><em>(TCON_OPT = <code>0x00</code>)</em></td></tr>
<tr><td style="text-align: center"><code>0x00</code></td><td style="text-align: left"><em>(GIP_OPT Bits 16-22 = <code>0x00</code>)</em></td></tr>
<tr><td style="text-align: center"><code>0x00</code></td><td style="text-align: left"><em>(GIP_OPT Bits  8-15 = <code>0x00</code>)</em></td></tr>
<tr><td style="text-align: center"><code>0x00</code></td><td style="text-align: left"><em>(GIP_OPT Bits  0-7  = <code>0x00</code>)</em></td></tr>
<tr><td style="text-align: center"><code>0x00</code></td><td style="text-align: left">Starting position of GIP CKV group 1 <br> <em>(CKV1_0)</em> = 0 HSYNC <br> <em>(CHR2 = <code>0x00</code>)</em></td></tr>
<tr><td style="text-align: center"><code>0x00</code></td><td style="text-align: left">Distance of CKV1 rising edge and HYSNC  = 0*2 Fosc <br> <em>(CON2  Bits 0-7 = <code>0x00</code>)</em></td></tr>
<tr><td style="text-align: center"><code>0x00</code></td><td style="text-align: left">Distance of CKV1 falling edge and HYSNC = 0*2 Fosc <br> <em>(COFF2 Bits 0-7 = <code>0x00</code>)</em></td></tr>
<tr><td style="text-align: center"><code>0x00</code></td><td style="text-align: left">CKV1 signal high pulse width = 0 HSYNC <br> <em>(CHP2 = 0)</em> <br> Total period cycle of CKV1 signal = 0 HSYNC <br> <em>(CCP2 = 0)</em></td></tr>
<tr><td style="text-align: center"><code>0x00</code></td><td style="text-align: left"><em>(CKS Bits 16-21 = <code>0x00</code>)</em></td></tr>
<tr><td style="text-align: center"><code>0x00</code></td><td style="text-align: left"><em>(CKS Bits  8-15 = <code>0x00</code>)</em></td></tr>
<tr><td style="text-align: center"><code>0x00</code></td><td style="text-align: left"><em>(CKS Bits  0-7  = <code>0x00</code>)</em></td></tr>
<tr><td style="text-align: center"><code>0x00</code></td><td style="text-align: left"><em>(COFF Bits 8-9 = 0)</em> <br> <em>(CON Bits 8-9 = 0)</em> <br> <em>(SPOFF Bits 8-9 = 0)</em> <br> <em>(SPON Bits 8-9 = 0)</em></td></tr>
<tr><td style="text-align: center"><code>0x00</code></td><td style="text-align: left"><em>(COFF2 Bits 8-9 = 0)</em> <br> <em>(CON2 Bits 8-9 = 0)</em></td></tr>
</tbody></table>
</div><h1 id="zig-on-pinephone"><a href="#zig-on-pinephone">3 Zig on PinePhone</a></h1>
<p>TODO</p>
<p><code>make --trace</code> shows these GCC Compiler Options when building Nuttx for PinePhone‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>aarch64-none-elf-gcc
  -c
  -fno-common
  -Wall
  -Wstrict-prototypes
  -Wshadow
  -Wundef
  -Werror
  -Os
  -fno-strict-aliasing
  -fomit-frame-pointer
  -g
  -march=armv8-a
  -mtune=cortex-a53
  -isystem &quot;/Users/Luppy/PinePhone/nuttx/nuttx/include&quot;
  -D__NuttX__ 
  -pipe
  -I &quot;/Users/Luppy/PinePhone/nuttx/apps/include&quot;
  -Dmain=hello_main  hello_main.c
  -o  hello_main.c.Users.Luppy.PinePhone.nuttx.apps.examples.hello.o</code></pre></div>
<p>Let‚Äôs run this Zig App: <a href="https://github.com/lupyuen/pinephone-nuttx/blob/main/display.zig">display.zig</a></p>
<p>Enable the Null Example App: make menuconfig, select ‚ÄúApplication Configuration‚Äù &gt; ‚ÄúExamples‚Äù &gt; ‚ÄúNull Example‚Äù</p>
<p>Compile the Zig App (based on the above GCC Compiler Options)‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>zig build-obj \
  -target aarch64-freestanding-none \
  -mcpu cortex_a53 \
  -isystem &quot;$HOME/nuttx/nuttx/include&quot; \
  -I &quot;$HOME/nuttx/apps/include&quot; \
  display.zig

cp display.o \
  $HOME/nuttx/apps/examples/null/*null.o

cd $HOME/nuttx/nuttx
make</code></pre></div>
<p>Run the Zig App‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>nsh&gt; null
HELLO ZIG ON PINEPHONE!</code></pre></div><h1 id="zig-driver-for-pinephone-mipi-dsi"><a href="#zig-driver-for-pinephone-mipi-dsi">4 Zig Driver for PinePhone MIPI DSI</a></h1>
<p>TODO</p>
<p>With Zig, we create a Quick Prototype of the NuttX Driver for MIPI DSI: <a href="https://github.com/lupyuen/pinephone-nuttx/blob/main/display.zig">display.zig</a></p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/blob/main/display.zig#L62-L167">display.zig</a></p>
<p>This MIPI DSI Interface is compatible with Zephyr MIPI DSI‚Ä¶</p>
<ul>
<li><a href="https://github.com/zephyrproject-rtos/zephyr/blob/main/include/zephyr/drivers/mipi_dsi.h">zephyr/drivers/mipi_dsi.h</a></li>
</ul>
<p><em>Why Zig for the MIPI DSI Driver?</em></p>
<p>We‚Äôre doing Quick Prototyping, so it‚Äôs great to have Zig catch any Runtime Problems caused by our Bad Coding. (Underflow / Overflow / Array Out Of Bounds)</p>
<p>And yet Zig is so similar to C that we can test the Zig Driver with the rest of the C code.</p>
<p>Also <code>comptime</code> Compile-Time Expressions in Zig will be helpful when we initialise the ST7703 LCD Controller. <a href="https://lupyuen.github.io/articles/dsi#initialise-lcd-controller">(See this)</a></p>
<h1 id="compose-mipi-dsi-long-packet-in-zig"><a href="#compose-mipi-dsi-long-packet-in-zig">5 Compose MIPI DSI Long Packet in Zig</a></h1>
<p>TODO</p>
<p>To initialise PinePhone‚Äôs ST7703 LCD Controller, our PinePhone Display Driver for NuttX shall send MIPI DSI Long Packets to ST7703‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/dsi#long-packet-for-mipi-dsi">‚ÄúLong Packet for MIPI DSI‚Äù</a></li>
</ul>
<p>This is how our Zig Driver composes a MIPI DSI Long Packet‚Ä¶</p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/blob/main/display.zig#L140-L204">display.zig</a></p>
<h1 id="compose-mipi-dsi-short-packet-in-zig"><a href="#compose-mipi-dsi-short-packet-in-zig">6 Compose MIPI DSI Short Packet in Zig</a></h1>
<p>TODO</p>
<p>For 1 or 2 bytes of data, our PinePhone Display Driver shall send MIPI DSI Short Packets (instead of Long Packets)‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/dsi#appendix-short-packet-for-mipi-dsi">‚ÄúShort Packet for MIPI DSI‚Äù</a></li>
</ul>
<p>This is how our Zig Driver composes a MIPI DSI Short Packet‚Ä¶</p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/blob/main/display.zig#L206-L261">display.zig</a></p>
<h1 id="compute-error-correction-code-in-zig"><a href="#compute-error-correction-code-in-zig">7 Compute Error Correction Code in Zig</a></h1>
<p>TODO</p>
<p>In our PinePhone Display Driver for NuttX, this is how we compute the Error Correction Code for a MIPI DSI Packet‚Ä¶</p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/blob/main/display.zig#L263-L304">display.zig</a></p>
<p>The Error Correction Code is the last byte of the 4-byte Packet Header for Long Packets and Short Packets.</p>
<h1 id="compute-cyclic-redundancy-check-in-zig"><a href="#compute-cyclic-redundancy-check-in-zig">8 Compute Cyclic Redundancy Check in Zig</a></h1>
<p>TODO</p>
<p>This is how our PinePhone Display Driver computes the 16-bit Cyclic Redundancy Check (CCITT) in Zig‚Ä¶</p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/blob/main/display.zig#L306-L366">display.zig</a></p>
<p>The Cyclic Redundancy Check is the 2-byte Packet Footer for Long Packets.</p>
<h1 id="test-pinephone-mipi-dsi-driver-with-qemu"><a href="#test-pinephone-mipi-dsi-driver-with-qemu">9 Test PinePhone MIPI DSI Driver with QEMU</a></h1>
<p>TODO</p>
<p>The above Zig Code for composing Long Packets and Short Packets was tested in QEMU for Arm64 with GIC Version 2‚Ä¶</p>
<p><a href="https://github.com/lupyuen/incubator-nuttx/tree/gicv2">lupyuen/incubator-nuttx/tree/gicv2</a></p>
<p>Here‚Äôs the NuttX Test Log for QEMU Arm64‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>NuttShell (NSH) NuttX-11.0.0-RC2
nsh&gt; uname -a
NuttX 11.0.0-RC2 c938291 Oct  7 2022 16:54:31 arm64 qemu-a53

nsh&gt; null
HELLO ZIG ON PINEPHONE!
Testing Compose Short Packet (Without Parameter)...
composeShortPacket: channel=0, cmd=0x5, len=1
Result:
05 11 00 36 
Testing Compose Short Packet (With Parameter)...
composeShortPacket: channel=0, cmd=0x15, len=2
Result:
15 bc 4e 35 
Testing Compose Long Packet...
composeLongPacket: channel=0, cmd=0x39, len=64
Result:
39 40 00 25 e9 82 10 06 
05 a2 0a a5 12 31 23 37 
83 04 bc 27 38 0c 00 03 
00 00 00 0c 00 03 00 00 
00 75 75 31 88 88 88 88 
88 88 13 88 64 64 20 88 
88 88 88 88 88 02 88 00 
00 00 00 00 00 00 00 00 
00 00 00 00 65 03 </code></pre></div><h1 id="test-case-for-pinephone-mipi-dsi-driver"><a href="#test-case-for-pinephone-mipi-dsi-driver">10 Test Case for PinePhone MIPI DSI Driver</a></h1>
<p>TODO</p>
<p>This is how we write a Test Case for the PinePhone MIPI DSI Driver on NuttX‚Ä¶</p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/blob/main/display.zig#L593-L639">display.zig</a></p>
<p>The above Test Case shows this output on QEMU Arm64‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>Testing Compose Long Packet...
composeLongPacket: channel=0, cmd=0x39, len=64
Result:
39 40 00 25 e9 82 10 06 
05 a2 0a a5 12 31 23 37 
83 04 bc 27 38 0c 00 03 
00 00 00 0c 00 03 00 00 
00 75 75 31 88 88 88 88 
88 88 13 88 64 64 20 88 
88 88 88 88 88 02 88 00 
00 00 00 00 00 00 00 00 
00 00 00 00 65 03 </code></pre></div><h1 id="initialise-st7703-lcd-controller-in-zig"><a href="#initialise-st7703-lcd-controller-in-zig">11 Initialise ST7703 LCD Controller in Zig</a></h1>
<p>TODO</p>
<p>PinePhone‚Äôs ST7703 LCD Controller needs to be initialised with these 20 Commands‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/dsi#initialise-lcd-controller">‚ÄúInitialise LCD Controller‚Äù</a></li>
</ul>
<p>This is how we send the 20 Commands with our NuttX Driver in Zig, as DCS Short Writes and DCS Long Writes‚Ä¶</p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/blob/main/display.zig#L62-L429">display.zig</a></p>
<p>To send a command, <code>writeDcs</code> executes a DCS Short Write or DCS Long Write, depending on the length of the command‚Ä¶</p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/blob/main/display.zig#L431-L453">display.zig</a></p>
<h1 id="test-zig-display-driver-for-pinephone"><a href="#test-zig-display-driver-for-pinephone">12 Test Zig Display Driver for PinePhone</a></h1>
<p>TODO</p>
<p>Our NuttX Zig Display Driver powers on the PinePhone Display and works exactly like the C Driver! üéâ</p>
<p><img src="https://lupyuen.github.io/images/dsi2-title.jpg" alt="Apache NuttX RTOS on PinePhone" /></p>
<p><em>Can our driver render graphics on PinePhone Display?</em></p>
<p>Our PinePhone Display Driver isn‚Äôt complete. It handles MIPI DSI (for initialising ST7703) but doesn‚Äôt support Allwinner A64‚Äôs Display Engine (DE) and Timing Controller (TCON), which are needed for rendering graphics.</p>
<p>We‚Äôll implement DE and TCON next.</p>
<h1 id="whats-next"><a href="#whats-next">13 What‚Äôs Next</a></h1>
<p>TODO</p>
<p>There‚Äôs plenty to be done for NuttX on PinePhone, please lemme know if you would like to join me üôè</p>
<p>Check out the other articles on <strong>NuttX RTOS for PinePhone</strong>‚Ä¶</p>
<ul>
<li>
<p><a href="https://lupyuen.github.io/articles/arm"><strong>‚ÄúApache NuttX RTOS on Arm Cortex-A53: How it might run on PinePhone‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/uboot"><strong>‚ÄúPinePhone boots Apache NuttX RTOS‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/interrupt"><strong>‚ÄúNuttX RTOS for PinePhone: Fixing the Interrupts‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/serial"><strong>‚ÄúNuttX RTOS for PinePhone: UART Driver‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/dsi"><strong>‚ÄúUnderstanding PinePhone‚Äôs Display (MIPI DSI)‚Äù</strong></a></p>
</li>
</ul>
<p>Many Thanks to my <a href="https://github.com/sponsors/lupyuen"><strong>GitHub Sponsors</strong></a> for supporting my work! This article wouldn‚Äôt have been possible without your support.</p>
<ul>
<li>
<p><a href="https://github.com/sponsors/lupyuen"><strong>Sponsor me a coffee</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/book"><strong>My Current Project: ‚ÄúThe RISC-V BL602 Book‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io"><strong>Check out my articles</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/rss.xml"><strong>RSS Feed</strong></a></p>
</li>
</ul>
<p><em>Got a question, comment or suggestion? Create an Issue or submit a Pull Request here‚Ä¶</em></p>
<p><a href="https://github.com/lupyuen/lupyuen.github.io/blob/master/src/dsi2.md"><strong>lupyuen.github.io/src/dsi2.md</strong></a></p>

    
</body>
</html>