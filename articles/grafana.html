<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="rustdoc">
    <title>Grafana Data Source for The Things Network</title>

    
    <!-- Begin scripts/articles/*-header.html: Article Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<meta property="og:title" 
    content="Grafana Data Source for The Things Network" 
    data-rh="true">
<meta property="og:description" 
    content="How we visualise Sensor Data from The Things Network... With a Custom MQTT Data Source in Grafana"
    data-rh="true">
<meta property="og:image" 
    content="https://lupyuen.github.io/images/grafana-title.jpg">
<meta property="og:type" 
    content="article" data-rh="true">
<!-- End scripts/articles/*-header.html -->
<!-- Begin scripts/rustdoc-header.html: Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<link rel="alternate" type="application/rss+xml" title="RSS Feed for lupyuen" href="/rss.xml" />
<link rel="stylesheet" type="text/css" href="../normalize.css">
<link rel="stylesheet" type="text/css" href="../rustdoc.css" id="mainThemeStyle">
<link rel="stylesheet" type="text/css" href="../dark.css">
<link rel="stylesheet" type="text/css" href="../light.css" id="themeStyle">
<link rel="stylesheet" type="text/css" href="../prism.css">
<script src="../storage.js"></script><noscript>
<link rel="stylesheet" href="../noscript.css"></noscript>
<link rel="shortcut icon" href="../favicon.ico">
<style type="text/css">
    #crate-search {
        background-image: url("../down-arrow.svg");
    }
    a {
        color: #77d;
    }
</style>
<!-- End scripts/rustdoc-header.html -->


</head>
<body class="rustdoc">
    <!--[if lte IE 8]>
    <div class="warning">
        This old browser is unsupported and will most likely display funky
        things.
    </div>
    <![endif]-->

        <!-- Begin scripts/rustdoc-before.html: Pre-HTML for Custom Markdown files processed by rustdoc, like chip8.md -->

    <!-- Begin Theme Picker -->
    <div class="theme-picker" style="left: 0"><button id="theme-picker" aria-label="Pick another theme!"><img src="../brush.svg"
        width="18" alt="Pick another theme!"></button>
        <div id="theme-choices"></div>
    </div>
    <script src="../theme.js"></script>
    <script src="../prism.js"></script>
    <!-- Theme Picker -->

    <!-- End scripts/rustdoc-before.html -->
    

    <h1 class="title">Grafana Data Source for The Things Network</h1>
    <nav id="TOC"><ul>
<li><a href="#configure-the-things-network-mqtt">1 Configure The Things Network MQTT</a><ul>
<li><a href="#test-the-things-network-mqtt">1.1 Test The Things Network MQTT</a><ul></ul></li></ul></li>
<li><a href="#configure-grafana-data-source">2 Configure Grafana Data Source</a><ul></ul></li>
<li><a href="#grafana-dashboard">3 Grafana Dashboard</a><ul>
<li><a href="#view-raw-data">3.1 View Raw Data</a><ul></ul></li>
<li><a href="#filter-data">3.2 Filter Data</a><ul></ul></li></ul></li>
<li><a href="#cbor-concise-binary-object-representation">4 CBOR: Concise Binary Object Representation</a><ul>
<li><a href="#decode-cbor-in-go">4.1 Decode CBOR in Go</a><ul></ul></li></ul></li>
<li><a href="#mqtt-integration">5 MQTT Integration</a><ul>
<li><a href="#subscribe-to-mqtt">5.1 Subscribe to MQTT</a><ul></ul></li>
<li><a href="#receive-mqtt-messages">5.2 Receive MQTT Messages</a><ul></ul></li></ul></li>
<li><a href="#transform-mqtt-messages">6 Transform MQTT Messages</a><ul>
<li><a href="#decode-payload">6.1 Decode Payload</a><ul></ul></li>
<li><a href="#convert-type">6.2 Convert Type</a><ul></ul></li></ul></li>
<li><a href="#troubleshooting">7 Troubleshooting</a><ul></ul></li>
<li><a href="#store-data-with-prometheus">8 Store Data with Prometheus</a><ul></ul></li>
<li><a href="#whats-next">9 What‚Äôs Next</a><ul></ul></li>
<li><a href="#notes">10 Notes</a><ul></ul></li>
<li><a href="#appendix-install-grafana-and-data-source">11 Appendix: Install Grafana and Data Source</a><ul>
<li><a href="#install-grafana">11.1 Install Grafana</a><ul></ul></li>
<li><a href="#build-data-source">11.2 Build Data Source</a><ul></ul></li>
<li><a href="#enable-data-source">11.3 Enable Data Source</a><ul></ul></li></ul></li>
<li><a href="#appendix-install-build-tools-for-macos">12 Appendix: Install Build Tools for macOS</a><ul></ul></li></ul></nav><p>üìù <em>30 Sep 2021</em></p>
<p><a href="https://lupyuen.github.io/articles/ttn"><strong>The Things Network</strong></a> is a public global <strong>wireless network for IoT devices</strong>‚Ä¶</p>
<p>(And it‚Äôs free for fair use!)</p>
<p><a href="https://grafana.com/oss/grafana/"><strong>Grafana</strong></a> is a open source tool for <strong>visualising all kinds of real-time data</strong>‚Ä¶</p>
<p>(Works on Linux, macOS and Windows)</p>
<p><em>Can we connect Grafana to The Things Network‚Ä¶</em></p>
<p><em>And instantly visualise the Sensor Data from our IoT Devices?</em></p>
<p><img src="https://lupyuen.github.io/images/grafana-flow.jpg" alt="Visualising The Things Network Sensor Data with Grafana" /></p>
<p>Today we shall experiment with a custom <strong>MQTT Data Source</strong> for Grafana that will stream real-time Sensor Data from The Things Network.</p>
<p><em>Wait‚Ä¶ We‚Äôre streaming the Sensor Data without storing it?</em></p>
<p>Yep this <strong>streaming setup for Grafana</strong> requires fewer components because it doesn‚Äôt store the data.</p>
<p>But it has limitations, which we‚Äôll discuss shortly.</p>
<p>(This is work-in-progress, some spot may get rough. And please pardon my ghastly GoLang üôè)</p>
<p><img src="https://lupyuen.github.io/images/grafana-title.jpg" alt="Grafana visualising Sensor Data from The Things Network" /></p>
<p><em>Grafana visualising Sensor Data from The Things Network</em></p>
<h1 id="configure-the-things-network-mqtt" class="section-header"><a href="#configure-the-things-network-mqtt">1 Configure The Things Network MQTT</a></h1>
<p>Previously we have <strong>configured our IoT Device</strong> in The Things Network‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/ttn"><strong>‚ÄúThe Things Network on PineDio Stack BL604 RISC-V Board‚Äù</strong></a></li>
</ul>
<p>Now we <strong>enable the MQTT Server</strong> in The Things Network by clicking‚Ä¶</p>
<ul>
<li><strong>Applications</strong> ‚Üí <em>(Your Application)</em> ‚Üí <strong>Integrations</strong> ‚Üí <strong>MQTT</strong></li>
</ul>
<p><img src="https://lupyuen.github.io/images/grafana-ttn.png" alt="Configure The Things Network MQTT Server" /></p>
<p>Click <strong>‚ÄúGenerate New API Key‚Äù</strong> and copy the values for‚Ä¶</p>
<ul>
<li>
<p><strong>Public Address</strong></p>
<p>(We won‚Äôt be using the Public TLS Address since our Data Source doesn‚Äôt support TLS)</p>
</li>
<li>
<p><strong>Username</strong></p>
</li>
<li>
<p><strong>Password</strong></p>
<p>(This is the only time we can see the password. Don‚Äôt forget to copy it!)</p>
</li>
</ul>
<p>We‚Äôll use the values in the next chapter.</p>
<h2 id="test-the-things-network-mqtt" class="section-header"><a href="#test-the-things-network-mqtt">1.1 Test The Things Network MQTT</a></h2>
<p>To <strong>test the MQTT Server</strong> at The Things Network, enter this command‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code># Change au1.cloud.thethings.network to our MQTT Public Address
# Change luppy-application@ttn to our MQTT Username
mosquitto_sub -h au1.cloud.thethings.network -t &quot;#&quot; -u &quot;luppy-application@ttn&quot; -P &quot;YOUR_API_KEY&quot; -d</code></pre></div>
<p>MQTT JSON Messages will appear whenever our IoT Device joins the network or transmits data.</p>
<p><a href="https://github.com/lupyuen/the-things-network-datasource#mqtt-log">(See sample MQTT Log)</a></p>
<p><a href="https://www.thethingsindustries.com/docs/integrations/mqtt/">(More about The Things Network MQTT)</a></p>
<h1 id="configure-grafana-data-source" class="section-header"><a href="#configure-grafana-data-source">2 Configure Grafana Data Source</a></h1>
<p>Let‚Äôs <strong>add and configure</strong> our Grafana Data Source for The Things Network‚Ä¶</p>
<ul>
<li><a href="https://github.com/lupyuen/the-things-network-datasource"><strong>lupyuen/the-things-network-datasource</strong></a></li>
</ul>
<p>Follow these instructions to <strong>install Grafana and the Data Source</strong> for The Things Network‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/grafana#appendix-install-grafana-and-data-source"><strong>‚ÄúInstall Grafana and Data Source‚Äù</strong></a></li>
</ul>
<p>In Grafana, click the left menu bar‚Ä¶</p>
<ul>
<li><strong>Configuration</strong> ‚Üí <strong>Data Sources</strong></li>
</ul>
<p>Click <strong>‚ÄúAdd Data Source‚Äù</strong></p>
<p><img src="https://lupyuen.github.io/images/grafana-datasource4.png" alt="Add Data Source" /></p>
<p>Look for <strong>‚ÄúThe Things Network‚Äù</strong> and click <strong>‚ÄúSelect‚Äù</strong></p>
<p><img src="https://lupyuen.github.io/images/grafana-datasource2.png" alt="Data Source for The Things Network" /></p>
<p>Fill in the values copied from our <strong>MQTT Server at The Things Network</strong>‚Ä¶</p>
<ul>
<li>
<p><strong>Name</strong>: Use the default</p>
</li>
<li>
<p><strong>Host</strong>: Public Address of our MQTT Server</p>
</li>
<li>
<p><strong>Port</strong>: 1883</p>
</li>
<li>
<p><strong>Username</strong>: Username for our MQTT Server</p>
</li>
<li>
<p><strong>Password</strong>: Password for our MQTT Server</p>
</li>
</ul>
<p><img src="https://lupyuen.github.io/images/grafana-config.png" alt="Configuring the Grafana Data Source for The Things Network" /></p>
<p>Click <strong>‚ÄúSave &amp; Test‚Äù</strong></p>
<p>We should see the message <strong>‚ÄúMQTT Connected‚Äù</strong>‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/grafana-config2.png" alt="MQTT Connected" /></p>
<h1 id="grafana-dashboard" class="section-header"><a href="#grafana-dashboard">3 Grafana Dashboard</a></h1>
<p>Let‚Äôs <strong>render the Sensor Data</strong> from The Things Network in Grafana!</p>
<p>Click <strong>‚ÄúAdd Panel‚Äù</strong> (top right)</p>
<p>Click <strong>‚ÄúAdd An Empty Panel‚Äù</strong></p>
<p><img src="https://lupyuen.github.io/images/grafana-dashboard3.png" alt="Add Panel" /></p>
<p>Set the <strong>Data Source</strong> to <strong>‚ÄúThe Things Network‚Äù</strong></p>
<p>Set the <strong>Topic</strong> to <strong>‚Äúall‚Äù</strong></p>
<p><img src="https://lupyuen.github.io/images/grafana-dashboard7.png" alt="Set Data Source and Topic" /></p>
<p>Click <strong>‚ÄúApply‚Äù</strong> (top right)</p>
<p>Our Sensor Data appears on the Grafana Dashboard!</p>
<p><img src="https://lupyuen.github.io/images/grafana-dashboard6.png" alt="The Things Network Dashboard" /></p>
<h2 id="view-raw-data" class="section-header"><a href="#view-raw-data">3.1 View Raw Data</a></h2>
<p>To see the <strong>Raw Sensor Data</strong> as a table‚Ä¶</p>
<p>Click <strong>‚ÄúPanel Title‚Äù</strong> and <strong>‚ÄúEdit‚Äù</strong></p>
<p>Click <strong>‚ÄúTable View‚Äù</strong></p>
<p><img src="https://lupyuen.github.io/images/grafana-dashboard4.png" alt="Table View" /></p>
<h2 id="filter-data" class="section-header"><a href="#filter-data">3.2 Filter Data</a></h2>
<p>To <strong>filter the Sensor Data</strong> that will be rendered in the dashboard‚Ä¶</p>
<p>Click the <strong>‚ÄúTransform‚Äù</strong> Tab</p>
<p>Select <strong>‚ÄúFilter Data By Values‚Äù</strong></p>
<p>Set the Conditions and click <strong>‚ÄúApply‚Äù</strong></p>
<p><img src="https://lupyuen.github.io/images/grafana-dashboard8.png" alt="Filter Data" /></p>
<p>The above filter matches the <strong>Device ID</strong> with the Regular Expression‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>eui-70b3.*</code></pre></div>
<p>Which means that only Device IDs starting with <strong>‚Äúeui-70b3‚Äù</strong> will be rendered.</p>
<h1 id="cbor-concise-binary-object-representation" class="section-header"><a href="#cbor-concise-binary-object-representation">4 CBOR: Concise Binary Object Representation</a></h1>
<p><em>The Sensor Data we‚Äôve seen earlier‚Ä¶ Was it encoded as JSON?</em></p>
<p>Not quite. If we encode the Sensor Data as <strong>JSON</strong>‚Ä¶</p>
<div class="example-wrap"><pre class="language-json"><code>{ 
  &quot;t&quot;: 1234, 
  &quot;l&quot;: 2345 
}</code></pre></div>
<p>We‚Äôll need <strong>19 bytes</strong> to transmit the Sensor Data.</p>
<p>Which might be <strong>too much</strong> for The Things Network.</p>
<p><em>What are the message limits for The Things Network?</em></p>
<p>The Things Network is <strong>Free for Fair Use</strong>, with limits on the <strong>size of messages</strong> and <strong>how often</strong> we may send them.</p>
<p>If we expect to send 10 messages per hour, our message payload size should not exceed <strong>12 bytes</strong>.</p>
<p>Thus our message payload is <strong>too small for JSON!</strong> We‚Äôll encode with CBOR instead.</p>
<p><a href="https://lupyuen.github.io/articles/ttn#fair-use-of-the-things-network">(More about The Things Network limits)</a></p>
<p><em>What is CBOR?</em></p>
<p><a href="https://en.wikipedia.org/wiki/CBOR"><strong>Concise Binary Object Representation (CBOR)</strong></a> works like a binary, compressed form of JSON‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/grafana-cbor4.jpg" alt="Sensor Data encoded as CBOR" /></p>
<p>TODO</p>
<p><a href="http://cbor.me/">(Source)</a></p>
<h2 id="decode-cbor-in-go" class="section-header"><a href="#decode-cbor-in-go">4.1 Decode CBOR in Go</a></h2>
<p>TODO</p>
<div class="example-wrap"><pre class="language-go"><code>import &quot;github.com/fxamacker/cbor/v2&quot;

//  Encoded CBOR payload for { &quot;t&quot;: 1234, &quot;l&quot;: 2345 }
payload := []byte{0xa2, 0x61, 0x74, 0x19, 0x04, 0xd2, 0x61, 0x6c, 0x19, 0x09, 0x29}

//  Decode CBOR payload to a map of String -&gt; interface{}
var body map[string]interface{}
err := cbor.Unmarshal(payload, &amp;body)

//  Shows: map[l:2345 t:1234]
if err == nil {
  fmt.Printf(&quot;%v\n&quot;, body)
}</code></pre></div>
<p><img src="https://lupyuen.github.io/images/grafana-cbor2.png" alt="" /></p>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/grafana-payload.jpg" alt="" /></p>
<h1 id="mqtt-integration" class="section-header"><a href="#mqtt-integration">5 MQTT Integration</a></h1>
<p>Let‚Äôs look at the <strong>Go Source Code</strong> for our Data Source‚Ä¶</p>
<ul>
<li><a href="https://github.com/lupyuen/the-things-network-datasource"><strong>lupyuen/the-things-network-datasource</strong></a></li>
</ul>
<p>Our Data Source is based on the <strong>MQTT Data Source for Grafana</strong>‚Ä¶</p>
<ul>
<li><a href="https://github.com/grafana/mqtt-datasource"><strong>grafana/mqtt-datasource</strong></a></li>
</ul>
<h2 id="subscribe-to-mqtt" class="section-header"><a href="#subscribe-to-mqtt">5.1 Subscribe to MQTT</a></h2>
<p>Here‚Äôs how our Data Source <strong>subscribes to MQTT Topics</strong>: <a href="https://github.com/lupyuen/the-things-network-datasource/blob/main/pkg/mqtt/client.go#L150-L165">pkg/mqtt/client.go</a></p>
<div class="example-wrap"><pre class="language-go"><code>//  Name of our default topic
//  TODO: Support other topics
const defaultTopicName = &quot;all&quot;

//  We will subscribe to all MQTT topics
//  TODO: Support other topics
const defaultTopicMQTT = &quot;#&quot;

//  Subscribe to the topic.
//  We assume that the Topic Name is &quot;all&quot;.
func (c *Client) Subscribe(t string) {
  //  If Topic Name already exists, quit
  if _, ok := c.topics.Load(t); ok {
    return
  }

  //  Create the topic: &quot;all&quot;
  topic := Topic{
    path: t,
  }
  c.topics.Store(&amp;topic)

  //  Subscribe to all MQTT Topics: &quot;#&quot;. TODO: Support other topics.
  //  Previously: c.client.Subscribe(t, 0, c.HandleMessage)
  c.client.Subscribe(defaultTopicMQTT, 0, c.HandleMessage)
}</code></pre></div>
<p>Sorry this code looks wonky‚Ä¶</p>
<p>(Because I haven‚Äôt decided which topics we should support)</p>
<ol>
<li>
<p>We subscribe to <strong>all MQTT Topics</strong>: ‚Äú#‚Äù</p>
<p>This means we will receive MQTT Messages for <strong>all our devices</strong>.</p>
<p>Also we will receive <strong>all types of messages</strong>, including the ‚ÄúJoin Network‚Äù messages.</p>
</li>
<li>
<p>However ‚Äú#‚Äù is <strong>not a valid Topic Name</strong> in our Grafana Data Source.  (Not sure why it fails)</p>
<p>Hence we use <strong>‚Äúall‚Äù</strong> as the substitute Topic Name for the ‚Äú#‚Äù MQTT Topic.</p>
</li>
</ol>
<h2 id="receive-mqtt-messages" class="section-header"><a href="#receive-mqtt-messages">5.2 Receive MQTT Messages</a></h2>
<p><strong>Incoming MQTT Messages</strong> are handled by this function: <a href="https://github.com/lupyuen/the-things-network-datasource/blob/main/pkg/mqtt/client.go#L96-L148">pkg/mqtt/client.go</a></p>
<div class="example-wrap"><pre class="language-go"><code>//  Handle incoming MQTT messages
func (c *Client) HandleMessage(_ paho.Client, msg paho.Message) {
  //  Assume that the topic is &quot;all&quot;. TODO: Support other topics.
  //  Previously: topic, ok := c.topics.Load(msg.Topic())
  topic, ok := c.topics.Load(defaultTopicName)
  if !ok {  //  Topic not found, quit
    return
  }

  //  Compose message
  message := Message{
    Timestamp: time.Now(),
    Value:     string(msg.Payload()),
  }</code></pre></div>
<p>We begin by <strong>composing a Message</strong> object that will be processed later.</p>
<p>Sorry again for this horrible hack: We reject messages without a <strong>valid CBOR Base64 Payload</strong>‚Ä¶</p>
<div class="example-wrap"><pre class="language-go"><code>  //  TODO: Fix this hack to reject messages without a valid CBOR Base64 Payload.
  //  CBOR Payloads must begin with a CBOR Map: 0xA1 or 0xA2 or 0xA3 or ...
  //  So the Base64 Encoding must begin with &quot;o&quot; or &quot;p&quot; or &quot;q&quot; or ...
  //  We stop at 0xB1 (Base64 &quot;s&quot;) because we assume LoRaWAN Payloads will be under 50 bytes.
  //  Join Messages don&#39;t have a payload and will also be rejected.
  const frm_payload = &quot;\&quot;frm_payload\&quot;:\&quot;&quot;
  if !strings.Contains(message.Value, frm_payload+&quot;o&quot;) &amp;&amp;
    !strings.Contains(message.Value, frm_payload+&quot;p&quot;) &amp;&amp;
    !strings.Contains(message.Value, frm_payload+&quot;q&quot;) &amp;&amp;
    !strings.Contains(message.Value, frm_payload+&quot;r&quot;) &amp;&amp;
    !strings.Contains(message.Value, frm_payload+&quot;s&quot;) {
    log.DefaultLogger.Debug(fmt.Sprintf(&quot;Missing or invalid payload: %s&quot;, message.Value))
    return
  }</code></pre></div>
<p>Next we <strong>store the Message</strong> object (keeping the most recent 1,000 messages)‚Ä¶</p>
<div class="example-wrap"><pre class="language-go"><code>  //  Store message for query
  topic.messages = append(topic.messages, message)

  //  Limit the size of the retained messages
  if len(topic.messages) &gt; 1000 {
    topic.messages = topic.messages[1:]
  }

  //  Update the topic messages
  c.topics.Store(topic)</code></pre></div>
<p>Then we <strong>stream the message</strong> to a channel‚Ä¶</p>
<div class="example-wrap"><pre class="language-go"><code>  //  Stream message to topic &quot;all&quot;. TODO: Support other topics.
  //  Previously: streamMessage := StreamMessage{Topic: msg.Topic(), Value: string(msg.Payload())}
  streamMessage := StreamMessage{Topic: defaultTopicName, Value: string(msg.Payload())}
  select {
  case c.stream &lt;- streamMessage:
  default:
    //  Don&#39;t block if nothing is reading from the channel
  }
}</code></pre></div>
<p>What happens next? Read on and find out‚Ä¶</p>
<h1 id="transform-mqtt-messages" class="section-header"><a href="#transform-mqtt-messages">6 Transform MQTT Messages</a></h1>
<p>TODO</p>
<p>From <a href="https://github.com/lupyuen/the-things-network-datasource/blob/main/pkg/plugin/message.go#L19-L44">pkg/plugin/message.go</a></p>
<div class="example-wrap"><pre class="language-go"><code>func ToFrame(topic string, messages []mqtt.Message) *data.Frame {
  count := len(messages)
  if count &gt; 0 {
    first := messages[0].Value
    if strings.HasPrefix(first, &quot;{&quot;) {
      return jsonMessagesToFrame(topic, messages)
    }
  }

  // Fall through to expecting values
  timeField := data.NewFieldFromFieldType(data.FieldTypeTime, count)
  timeField.Name = &quot;Time&quot;
  valueField := data.NewFieldFromFieldType(data.FieldTypeFloat64, count)
  valueField.Name = &quot;Value&quot;

  for idx, m := range messages {
    if value, err := strconv.ParseFloat(m.Value, 64); err == nil {
      timeField.Set(idx, m.Timestamp)
      valueField.Set(idx, value)
    }
  }

  return data.NewFrame(topic, timeField, valueField)
}</code></pre></div>
<p>From <a href="https://github.com/lupyuen/the-things-network-datasource/blob/main/pkg/plugin/message.go#L46-L129">pkg/plugin/message.go</a></p>
<div class="example-wrap"><pre class="language-go"><code>//  Transform the array of MQTT Messages (JSON encoded) into a Grafana Data Frame.
//  See sample messages: https://github.com/lupyuen/the-things-network-datasource#mqtt-log
func jsonMessagesToFrame(topic string, messages []mqtt.Message) *data.Frame {
  //  Quit if no messages to transform
  count := len(messages)
  if count == 0 {
    return nil
  }

  //  Transform the first message
  msg := messages[0]

  //  Decode the CBOR payload
  body, err := decodeCborPayload(msg.Value)
  if err != nil {
    return set_error(data.NewFrame(topic), err)
  }

  //  Construct the Timestamp field
  timeField := data.NewFieldFromFieldType(data.FieldTypeTime, count)
  timeField.Name = &quot;Time&quot;
  timeField.SetConcrete(0, msg.Timestamp)

  //  Create a field for each key and set the first value
  keys := make([]string, 0, len(body))
  fields := make(map[string]*data.Field, len(body))

  //  Compose the fields for the first row of the Data Frame
  for key, val := range body {
    //  Get the Data Frame Type for the field
    typ := get_type(val)

    //  Create the field for the first row
    field := data.NewFieldFromFieldType(typ, count)
    field.Name = key
    field.SetConcrete(0, val)
    fields[key] = field
    keys = append(keys, key)
  }
  sort.Strings(keys) // keys stable field order.

  //  Transform the messages after the first one
  for row, m := range messages {
    //  Skip the first message
    if row == 0 {
      continue
    }

    //  Decode the CBOR payload
    body, err := decodeCborPayload(m.Value)
    if err != nil {
      log.DefaultLogger.Debug(fmt.Sprintf(&quot;jsonMessagesToFrame: Decode error %s&quot;, err.Error()))
      continue
    }

    //  Set the Timestamp for the transformed row
    timeField.SetConcrete(row, m.Timestamp)

    //  Set the fields for the transformed row
    for key, val := range body {
      field, ok := fields[key]
      if ok {
        field.SetConcrete(row, val)
      }
    }
  }

  //  Construct the Data Frame
  frame := data.NewFrame(topic, timeField)

  //  Append the fields to the Data Frame
  for _, key := range keys {
    frame.Fields = append(frame.Fields, fields[key])
  }
  return frame
}</code></pre></div>
<p>From <a href="https://github.com/lupyuen/the-things-network-datasource/blob/main/pkg/plugin/message.go#L231-L239">pkg/plugin/message.go</a></p>
<div class="example-wrap"><pre class="language-go"><code>//  Return the Data Frame set to the given error
func set_error(frame *data.Frame, err error) *data.Frame {
  frame.AppendNotices(data.Notice{
    Severity: data.NoticeSeverityError,
    Text:     err.Error(),
  })
  log.DefaultLogger.Debug(err.Error())
  return frame
}</code></pre></div><h2 id="decode-payload" class="section-header"><a href="#decode-payload">6.1 Decode Payload</a></h2>
<p>TODO</p>
<p>From <a href="https://github.com/lupyuen/the-things-network-datasource/blob/main/pkg/plugin/message.go#L131-L190">pkg/plugin/message.go</a></p>
<div class="example-wrap"><pre class="language-go"><code>//  Decode the CBOR payload in the JSON message.
//  See sample messages: https://github.com/lupyuen/the-things-network-datasource#mqtt-log
func decodeCborPayload(msg string) (map[string]interface{}, error) {
  //  Deserialise the message doc to a map of String -&gt; interface{}
  var doc map[string]interface{}
  err := json.Unmarshal([]byte(msg), &amp;doc)
  if err != nil {
    return nil, err
  }

  //  Get the Uplink Message
  uplink_message, ok := doc[&quot;uplink_message&quot;].(map[string]interface{})
  if !ok {
    return nil, errors.New(&quot;uplink_message missing&quot;)
  }

  //  Get the Payload
  frm_payload, ok := uplink_message[&quot;frm_payload&quot;].(string)
  if !ok {
    return nil, errors.New(&quot;frm_payload missing&quot;)
  }

  //  Base64 decode the Payload
  payload, err := base64.StdEncoding.DecodeString(frm_payload)
  if err != nil {
    return nil, err
  }

  //  Decode CBOR payload to a map of String -&gt; interface{}
  var body map[string]interface{}
  err = cbor.Unmarshal(payload, &amp;body)
  if err != nil {
    return nil, err
  }

  //  Add the Device ID to the body: end_device_ids -&gt; device_id
  end_device_ids, ok := doc[&quot;end_device_ids&quot;].(map[string]interface{})
  if ok {
    device_id, ok := end_device_ids[&quot;device_id&quot;].(string)
    if ok {
      body[&quot;device_id&quot;] = device_id
    }
  }
  return body, nil
}</code></pre></div><h2 id="convert-type" class="section-header"><a href="#convert-type">6.2 Convert Type</a></h2>
<p>TODO</p>
<p>From <a href="https://github.com/lupyuen/the-things-network-datasource/blob/main/pkg/plugin/message.go#L192-L229">pkg/plugin/message.go</a></p>
<div class="example-wrap"><pre class="language-go"><code>//  Return the Data Frame Type for the CBOR decoded value
func get_type(val interface{}) data.FieldType {
  //  Based on https://github.com/fxamacker/cbor/blob/master/decode.go#L43-L53
  switch v := val.(type) {
  //  CBOR booleans decode to bool.
  case bool:
    return data.FieldTypeBool

  //  CBOR positive integers decode to uint64.
  case uint64:
    return data.FieldTypeNullableUint64

  //  CBOR negative integers decode to int64 (big.Int if value overflows).
  case int64:
    return data.FieldTypeInt64

  //  CBOR floating points decode to float64.
  case float64:
    return data.FieldTypeNullableFloat64

  //  CBOR text strings decode to string.
  case string:
    return data.FieldTypeNullableString

  //  CBOR times (tag 0 and 1) decode to time.Time.
  case time.Time:
    return data.FieldTypeNullableTime

  //  TODO: CBOR byte strings decode to []byte.
  //  TODO: CBOR arrays decode to []interface{}.
  //  TODO: CBOR maps decode to map[interface{}]interface{}.
  //  TODO: CBOR null and undefined values decode to nil.
  //  TODO: CBOR bignums (tag 2 and 3) decode to big.Int.
  default:
    log.DefaultLogger.Debug(fmt.Sprintf(&quot;Unknown type %T for %v&quot;, v, val))
    return data.FieldTypeUnknown
  }
}</code></pre></div>
<p><img src="https://lupyuen.github.io/images/grafana-code.png" alt="" /></p>
<p>TODO4</p>
<p><img src="https://lupyuen.github.io/images/grafana-code2.png" alt="" /></p>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/grafana-test.png" alt="" /></p>
<h1 id="troubleshooting" class="section-header"><a href="#troubleshooting">7 Troubleshooting</a></h1>
<p>TODO</p>
<p>To <strong>enable Debug Logs</strong>, edit‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code># For Linux:
/usr/share/grafana/conf/defaults.ini

# For macOS:
/usr/local/etc/grafana/grafana.ini

# For Windows:
C:\Program Files\GrafanaLabs\grafana\conf\defaults.ini</code></pre></div>
<p>And set‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>[log]
level = debug</code></pre></div>
<p>In case of problems, check the <strong>Grafana Log</strong> at‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code># For Linux:
/var/log/grafana/grafana.log

# For macOS:
/usr/local/var/log/grafana/grafana.log

# For Windows:
C:\Program Files\GrafanaLabs\grafana\data\log\grafana.log</code></pre></div>
<p><a href="https://github.com/lupyuen/the-things-network-datasource#grafana-log">(See sample Grafana Log)</a></p>
<h1 id="store-data-with-prometheus" class="section-header"><a href="#store-data-with-prometheus">8 Store Data with Prometheus</a></h1>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/grafana-flow2.jpg" alt="" /></p>
<h1 id="whats-next" class="section-header"><a href="#whats-next">9 What‚Äôs Next</a></h1>
<p>TODO</p>
<p>PineDio Stack BL604</p>
<ul>
<li>
<p><a href="https://github.com/sponsors/lupyuen">Sponsor me a coffee</a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/book">Read ‚ÄúThe RISC-V BL602 / BL604 Book‚Äù</a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io">Check out my articles</a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/rss.xml">RSS Feed</a></p>
</li>
</ul>
<p><em>Got a question, comment or suggestion? Create an Issue or submit a Pull Request here‚Ä¶</em></p>
<p><a href="https://github.com/lupyuen/lupyuen.github.io/blob/master/src/grafana.md"><code>lupyuen.github.io/src/grafana.md</code></a></p>
<h1 id="notes" class="section-header"><a href="#notes">10 Notes</a></h1>
<ol>
<li>This article is the expanded version of <a href="https://twitter.com/MisterTechBlog/status/1440459917828050946">this Twitter Thread</a></li>
</ol>
<h1 id="appendix-install-grafana-and-data-source" class="section-header"><a href="#appendix-install-grafana-and-data-source">11 Appendix: Install Grafana and Data Source</a></h1>
<p>Here are the steps to install Grafana and our Data Source for The Things Network.</p>
<h2 id="install-grafana" class="section-header"><a href="#install-grafana">11.1 Install Grafana</a></h2>
<ol>
<li>
<p>Browse to <a href="https://grafana.com/oss/grafana/"><strong>grafana.com/oss/grafana</strong></a></p>
<p>Click <strong>‚ÄúGet Grafana ‚Üí Self-Managed ‚Üí Download Grafana‚Äù</strong></p>
</li>
<li>
<p>For <strong>‚ÄúEdition‚Äù</strong> select <strong>‚ÄúOSS‚Äù</strong></p>
</li>
<li>
<p>Click Linux, macOS, Windows, Arm or Docker</p>
<p>(Grafana for Linux works on WSL too)</p>
</li>
<li>
<p>Follow the instructions to download and install Grafana</p>
</li>
<li>
<p>For Linux and macOS: Start the Grafana Server</p>
<div class="example-wrap"><pre class="language-bash"><code># For Ubuntu and WSL
sudo service grafana-server restart
sudo service grafana-server status

# For macOS
brew services start grafana</code></pre></div></li>
<li>
<p>To test Grafana, browse to </p>
<p><strong><code>http://localhost:3000</code></strong></p>
<p><strong>Username:</strong> admin</p>
<p><strong>Password:</strong> admin</p>
</li>
</ol>
<h2 id="build-data-source" class="section-header"><a href="#build-data-source">11.2 Build Data Source</a></h2>
<p>(Note: Our Data Source uses the Grafana Live Streaming API, please use Grafana version 8.0 or later)</p>
<ol>
<li>
<p>For Windows: Grant <strong><code>Full Control</code></strong> permission to the <strong><code>Users</code></strong> group for the Grafana Plugins Folder‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>C:\Program Files\GrafanaLabs\grafana\data\plugins</code></pre></div>
<p><img src="https://lupyuen.github.io/images/grafana-permission.png" alt="Permissions for plugins folder" /></p>
</li>
<li>
<p><strong>Download the Data Source</strong> into the Grafana Plugins Folder‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>#  For Linux: Need &quot;sudo&quot; to access this folder
cd /var/lib/grafana/plugins

#  For macOS: 
cd /usr/local/var/lib/grafana/plugins

#  For Windows: Need to grant &quot;Full Control&quot; permission to &quot;Users&quot; group for this folder
cd C:\Program Files\GrafanaLabs\grafana\data\plugins

#  Download source files for The Things Network Data Source
git clone --recursive https://github.com/lupyuen/the-things-network-datasource</code></pre></div></li>
<li>
<p>Install the <strong>Build Tools</strong>‚Ä¶</p>
<p><a href="https://github.com/grafana/mqtt-datasource/issues/15#issuecomment-894477802"><strong>Build Tools for Linux (Ubuntu)</strong></a></p>
<p><a href="https://lupyuen.github.io/articles/grafana#appendix-install-build-tools-for-macos"><strong>Build Tools for macOS</strong></a></p>
<p><a href="https://github.com/grafana/mqtt-datasource/issues/15#issuecomment-894534196"><strong>Build Tools for Windows</strong></a></p>
<p><a href="https://grafana.com/tutorials/build-a-streaming-data-source-plugin/">(More details here)</a></p>
</li>
<li>
<p><strong>Build the Data Source</strong>‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>#  Install the dependencies
cd the-things-network-datasource
yarn install

#  Build the Data Source (React + Go)
yarn build

#  If &quot;mage&quot; is not found, set the PATH
export PATH=$PATH:$GOPATH/bin</code></pre></div>
<p><a href="https://github.com/lupyuen/the-things-network-datasource#build-log">(See the Build Log)</a></p>
</li>
<li>
<p>If ‚Äú<code>yarn build</code>‚Äù fails on Windows, edit <code>package.json</code> and replace ‚Äú<code>rm -rf</code>‚Äù by ‚Äú<code>rimraf</code>‚Äù</p>
</li>
<li>
<p><strong>Restart the Grafana Service</strong> for the Data Source to load</p>
<div class="example-wrap"><pre class="language-bash"><code># For Ubuntu and WSL:
sudo service grafana-server restart
sudo service grafana-server status

# For macOS:
brew services restart grafana

# For Windows: Run this as Administrator
net stop grafana
net start grafana</code></pre></div></li>
</ol>
<h2 id="enable-data-source" class="section-header"><a href="#enable-data-source">11.3 Enable Data Source</a></h2>
<ol>
<li>
<p>Edit the <strong>Grafana Configuration File</strong>‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code># For Linux:
/usr/share/grafana/conf/defaults.ini

# For macOS:
/usr/local/etc/grafana/grafana.ini

# For Windows:
C:\Program Files\GrafanaLabs\grafana\conf\defaults.ini</code></pre></div></li>
<li>
<p>To <strong>enable our Data Source</strong>, set‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>[plugins]
allow_loading_unsigned_plugins = the-things-network-datasource</code></pre></div></li>
<li>
<p>To <strong>enable Debug Logs</strong>, set‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>[log]
level = debug</code></pre></div></li>
<li>
<p><strong>Restart the Grafana Service</strong> for the Data Source to load</p>
<div class="example-wrap"><pre class="language-bash"><code># For Ubuntu and WSL:
sudo service grafana-server restart
sudo service grafana-server status

# For macOS:
brew services restart grafana

# For Windows: Run this as Administrator
net stop grafana
net start grafana</code></pre></div></li>
<li>
<p>In case of problems, check the <strong>Grafana Log</strong> at‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code># For Linux:
/var/log/grafana/grafana.log

# For macOS:
/usr/local/var/log/grafana/grafana.log

# For Windows:
C:\Program Files\GrafanaLabs\grafana\data\log\grafana.log</code></pre></div>
<p><a href="https://github.com/lupyuen/the-things-network-datasource#grafana-log">(See sample Grafana Log)</a></p>
</li>
</ol>
<h1 id="appendix-install-build-tools-for-macos" class="section-header"><a href="#appendix-install-build-tools-for-macos">12 Appendix: Install Build Tools for macOS</a></h1>
<p>To install the tools for building our Grafana Data Source on macOS‚Ä¶</p>
<ol>
<li>
<p>Install <strong>Node.js v14</strong> or later‚Ä¶</p>
<p><a href="https://nodejs.org"><strong><code>nodejs.org</code></strong></a></p>
</li>
<li>
<p>Install <strong>Yarn</strong>‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>npm install -g yarn</code></pre></div></li>
<li>
<p>Install <strong>Go</strong>‚Ä¶</p>
<p><a href="https://golang.org"><strong><code>golang.org</code></strong></a></p>
</li>
<li>
<p>Install <strong>Mage</strong>‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>go get -u -d github.com/magefile/mage
pushd $GOPATH/src/github.com/magefile/mage
go run bootstrap.go
export PATH=$PATH:$GOPATH/bin
mage -version
popd</code></pre></div></li>
</ol>

    
</body>
</html>