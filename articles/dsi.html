<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="rustdoc">
    <title>Understanding PinePhone&#39;s Display (MIPI DSI)</title>

    
    <!-- Begin scripts/articles/*-header.html: Article Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<meta property="og:title" 
    content="Understanding PinePhone's Display (MIPI DSI)" 
    data-rh="true">
<meta property="og:description" 
    content="How does Pine64 PinePhone control its LCD Display over MIPI Digital Serial Interface? Let's find out!"
    data-rh="true">
<meta name="description" 
    content="How does Pine64 PinePhone control its LCD Display over MIPI Digital Serial Interface? Let's find out!">
<meta property="og:image" 
    content="https://lupyuen.github.io/images/dsi-title.jpg">
<meta property="og:type" 
    content="article" data-rh="true">
<!-- End scripts/articles/*-header.html -->
<!-- Begin scripts/rustdoc-header.html: Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<link rel="alternate" type="application/rss+xml" title="RSS Feed for lupyuen" href="/rss.xml" />
<link rel="stylesheet" type="text/css" href="../normalize.css">
<link rel="stylesheet" type="text/css" href="../rustdoc.css" id="mainThemeStyle">
<link rel="stylesheet" type="text/css" href="../dark.css">
<link rel="stylesheet" type="text/css" href="../light.css" id="themeStyle">
<link rel="stylesheet" type="text/css" href="../prism.css">
<script src="../storage.js"></script><noscript>
<link rel="stylesheet" href="../noscript.css"></noscript>
<link rel="shortcut icon" href="../favicon.ico">
<style type="text/css">
    #crate-search {
        background-image: url("../down-arrow.svg");
    }
    a {
        color: #77d;
    }
</style>
<!-- End scripts/rustdoc-header.html -->


</head>
<body class="rustdoc">
    <!--[if lte IE 8]>
    <div class="warning">
        This old browser is unsupported and will most likely display funky
        things.
    </div>
    <![endif]-->

        <!-- Begin scripts/rustdoc-before.html: Pre-HTML for Custom Markdown files processed by rustdoc, like chip8.md -->

    <!-- Begin Theme Picker -->
    <div class="theme-picker" style="left: 0"><button id="theme-picker" aria-label="Pick another theme!"><img src="../brush.svg"
        width="18" alt="Pick another theme!"></button>
        <div id="theme-choices"></div>
    </div>
    <script src="../theme.js"></script>
    <script src="../prism.js"></script>
    <!-- Theme Picker -->

    <!-- End scripts/rustdoc-before.html -->
    

    <h1 class="title">Understanding PinePhone&#39;s Display (MIPI DSI)</h1>
    <nav id="TOC"><ul>
<li><a href="#from-pinetime-to-pinephone">1 From PineTime To PinePhone</a><ul></ul></li>
<li><a href="#pinephone-schematic">2 PinePhone Schematic</a><ul></ul></li>
<li><a href="#connector-for-mipi-dsi">3 Connector for MIPI DSI</a><ul></ul></li>
<li><a href="#xingbangda-xbd599-lcd-panel">4 Xingbangda XBD599 LCD Panel</a><ul></ul></li>
<li><a href="#sitronix-st7703-lcd-controller">5 Sitronix ST7703 LCD Controller</a><ul></ul></li>
<li><a href="#initialise-lcd-controller">6 Initialise LCD Controller</a><ul></ul></li>
<li><a href="#registers-for-mipi-dsi">7 Registers for MIPI DSI</a><ul></ul></li>
<li><a href="#data-types-for-mipi-dsi">8 Data Types for MIPI DSI</a><ul></ul></li>
<li><a href="#video-mode-for-mipi-dsi">9 Video Mode for MIPI DSI</a><ul></ul></li>
<li><a href="#transmit-over-mipi-dsi">10 Transmit over MIPI DSI</a><ul></ul></li>
<li><a href="#todo">11 TODO</a><ul></ul></li>
<li><a href="#whats-next">12 What‚Äôs Next</a><ul></ul></li></ul></nav><p>üìù <em>7 Oct 2022</em></p>
<p><img src="https://lupyuen.github.io/images/dsi-title.jpg" alt="PinePhone‚Äôs LCD Display in the PinePhone Block Diagram" /></p>
<p>How does <a href="https://wiki.pine64.org/index.php/PinePhone"><strong>Pine64 PinePhone</strong></a> control its <strong>LCD Display</strong>?</p>
<p>Let‚Äôs uncover all the secrets about PinePhone‚Äôs mysterious LCD Display and its <strong>MIPI Digital Serial Interface</strong>!</p>
<ul>
<li>
<p>What‚Äôs a MIPI Digital Serial Interface (DSI)</p>
</li>
<li>
<p>What‚Äôs inside PinePhone‚Äôs LCD Display</p>
</li>
<li>
<p>How it‚Äôs similar to PineTime‚Äôs ST7789 Display Controller</p>
</li>
<li>
<p>One lane for Commands, but 4 lanes for Data!</p>
</li>
<li>
<p>Implications of a RAM-less Display Controller</p>
</li>
<li>
<p>What is PinePhone‚Äôs Timing Controller (TCON)</p>
</li>
</ul>
<p><em>Why are we doing this?</em></p>
<p>We‚Äôre now porting <a href="https://lupyuen.github.io/articles/uboot"><strong>Apache NuttX RTOS</strong></a> to PinePhone.</p>
<p>But it will look awfully dull until we <strong>render something</strong> on PinePhone‚Äôs LCD Display!</p>
<p>That‚Äôs why we‚Äôre probing the internals of PinePhone to create a <strong>NuttX Display Driver</strong>.</p>
<p>We‚Äôll come back to this. Let‚Äôs continue the journey from our <strong>NuttX Porting Journal</strong>‚Ä¶</p>
<ul>
<li><a href="https://github.com/lupyuen/pinephone-nuttx"><strong>lupyuen/pinephone-nuttx</strong></a></li>
</ul>
<p><img src="https://lupyuen.github.io/images/dsi-pinetime.jpg" alt="PineTime Smartwatch" /></p>
<p><em>PineTime Smartwatch with ST7789 Display Controller</em></p>
<h1 id="from-pinetime-to-pinephone"><a href="#from-pinetime-to-pinephone">1 From PineTime To PinePhone</a></h1>
<p><em>Why PineTime Smartwatch? Is it really similar to PinePhone‚Äôs Display?</em></p>
<p>Sounds unbelievable, but PineTime‚Äôs <strong>ST7789 Display Controller</strong> has plenty in common with PinePhone‚Äôs Display!</p>
<p>(Think of PinePhone as a Super-Sized PineTime)</p>
<p>In this article we shall explain PinePhone‚Äôs Display by <strong>comparing it with PineTime</strong>.</p>
<p>A quick recap of <strong>PineTime‚Äôs ST7789 Display</strong>‚Ä¶</p>
<ul>
<li>
<p>PineTime talks to its display over SPI (single data lane)‚Ä¶</p>
<p><a href="https://lupyuen.github.io/articles/st7789#connect-st7789-display"><strong>‚ÄúConnect ST7789 Display‚Äù</strong></a></p>
<p>(We‚Äôll soon see that PinePhone talks to its display over 4 data lanes)</p>
</li>
<li>
<p>PineTime uses an extra pin to indicate whether it‚Äôs sending Commands or Data</p>
<p><a href="https://lupyuen.github.io/articles/st7789#st7789-data--command-pin"><strong>‚ÄúST7789 Data / Command Pin‚Äù</strong></a></p>
<p>(PinePhone won‚Äôt need this)</p>
</li>
<li>
<p>At startup, PineTime sends a bunch of Commands to initialise the display‚Ä¶</p>
<p><a href="https://lupyuen.github.io/pinetime-rust-mynewt/articles/mcuboot#initialise-the-display"><strong>‚ÄúInitialise The Display‚Äù</strong></a></p>
<p>(PinePhone will send similar Commands)</p>
</li>
<li>
<p>PineTime renders a rectangular chunk of the display at a time‚Ä¶</p>
<p><a href="https://lupyuen.github.io/pinetime-rust-mynewt/articles/mcuboot#draw-a-line"><strong>‚ÄúDraw A Line‚Äù</strong></a></p>
<p>(PinePhone will refresh its entire display continously)</p>
</li>
</ul>
<p>If we‚Äôre not familiar with PineTime‚Äôs ST7789 Display, please read the docs above!</p>
<p><em>We‚Äôve read the docs, please move on!</em></p>
<p>OK great! To understand how PinePhone‚Äôs Display differs from PineTime, we begin with the schematic‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/dsi-title.jpg" alt="LCD Display on PinePhone Schematic (Page 2)" /></p>
<p><a href="https://files.pine64.org/doc/PinePhone/PinePhone%20v1.2b%20Released%20Schematic.pdf"><em>LCD Display on PinePhone Schematic (Page 2)</em></a></p>
<h1 id="pinephone-schematic"><a href="#pinephone-schematic">2 PinePhone Schematic</a></h1>
<p>Let‚Äôs turn to Page 2 of the <strong>PinePhone Schematic</strong> to understand how PinePhone‚Äôs Display is connected‚Ä¶</p>
<ul>
<li><a href="https://files.pine64.org/doc/PinePhone/PinePhone%20v1.2b%20Released%20Schematic.pdf"><strong>PinePhone Schematic</strong></a></li>
</ul>
<p>From the pic above, we see that the LCD Display is connected to the Allwinner A64 SoC via a <strong>MIPI Digital Serial Interface (DSI)</strong>.</p>
<p><a href="https://en.wikipedia.org/wiki/MIPI_Alliance">(MIPI is the <strong>Mobile Industry Processor Interface Alliance</strong>)</a></p>
<p><em>What‚Äôs a MIPI Digital Serial Interface?</em></p>
<p>Think of it as SPI, but supercharged with <strong>Multiple Data Lanes</strong>!</p>
<p>The (dull) technical details of DSI are covered here‚Ä¶</p>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Display_Serial_Interface"><strong>Display Serial Interface (DSI)</strong></a></li>
</ul>
<p>But if we‚Äôre seeking a gentler intro to DSI, please follow me to the next section!</p>
<p><img src="https://lupyuen.github.io/images/dsi-connector.png" alt="MIPI DSI Connector on PinePhone Schematic (Page 11)" /></p>
<p><a href="https://files.pine64.org/doc/PinePhone/PinePhone%20v1.2b%20Released%20Schematic.pdf"><em>MIPI DSI Connector on PinePhone Schematic (Page 11)</em></a></p>
<h1 id="connector-for-mipi-dsi"><a href="#connector-for-mipi-dsi">3 Connector for MIPI DSI</a></h1>
<p><em>How shall we learn about MIPI DSI?</em></p>
<p>We‚Äôll learn plenty about MIPI DSI (Display Serial Interface)‚Ä¶ Just by looking at <strong>PinePhone‚Äôs Connector for the LCD Display</strong>!</p>
<p>Flip to Page 11 of the <a href="https://files.pine64.org/doc/PinePhone/PinePhone%20v1.2b%20Released%20Schematic.pdf"><strong>PinePhone Schematic</strong></a> and we‚Äôll see the <strong>MIPI DSI Connector</strong>. (Pic above)</p>
<p>The MIPI DSI Connector connects PinePhone‚Äôs <strong>Allwinner A64 SoC</strong> directly to the LCD Display. In the pic above we see these connections‚Ä¶</p>
<ul>
<li>
<p><strong>CKN and CKP</strong> are the DSI Clock Lines</p>
<p>(Similar to SPI Clock)</p>
</li>
<li>
<p><strong>D0P and D0N</strong> for DSI Data Lane 0</p>
<p>(Similar to SPI MISO / MOSI)</p>
</li>
<li>
<p><strong>D1P and D1P</strong> for DSI Data Line 1</p>
<p>(Yep DSI has more data lanes than SPI)</p>
</li>
<li>
<p><strong>D2P and D2P</strong> for DSI Data Line 2</p>
</li>
<li>
<p><strong>D3P and D3P</strong> for DSI Data Line 3</p>
<p>(DSI has 4 data lanes!)</p>
</li>
</ul>
<p><em>Why the N and P?</em></p>
<p>Because P=NP‚Ä¶ Kidding!</p>
<p><strong>N</strong> means Negative, <strong>P</strong> means Positive.</p>
<p>This means that DSI uses <a href="https://en.wikipedia.org/wiki/Differential_signalling"><strong>Differential Signalling</strong></a> for high-speed data transfers. (4.5 Gbps per lane)</p>
<p>(Differential Signalling is also used in <a href="https://en.wikipedia.org/wiki/HDMI"><strong>HDMI</strong></a> and <a href="https://en.wikipedia.org/wiki/USB#Signaling"><strong>USB</strong></a>)</p>
<p>Let‚Äôs dig deeper into MIPI DSI‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/dsi-lcd.png" alt="Xingbangda XBD599 in PinePhone‚Äôs Linux Device Tree" /></p>
<p><a href="https://lupyuen.github.io/articles/pio#mipi-dsi-interface"><em>Xingbangda XBD599 in PinePhone‚Äôs Linux Device Tree</em></a></p>
<h1 id="xingbangda-xbd599-lcd-panel"><a href="#xingbangda-xbd599-lcd-panel">4 Xingbangda XBD599 LCD Panel</a></h1>
<p><em>What‚Äôs connected to this MIPI DSI Connector?</em></p>
<p>The <a href="https://lupyuen.github.io/articles/pio#appendix-pinephone-device-tree"><strong>Linux Device Tree</strong></a> describes everything about PinePhone Hardware in a single text file. Let‚Äôs snoop around the Device Tree!</p>
<p>First we follow these steps to dump PinePhone‚Äôs Linux Device Tree in text format‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/pio#appendix-pinephone-device-tree"><strong>‚ÄúPinePhone Device Tree‚Äù</strong></a></li>
</ul>
<p>Then we search for <strong>MIPI DSI</strong> in the Device Tree‚Ä¶</p>
<ul>
<li><a href="https://github.com/lupyuen/pinephone-nuttx/blob/main/sun50i-a64-pinephone-1.2.dts"><strong>PinePhone Device Tree: sun50i-a64-pinephone-1.2.dts</strong></a></li>
</ul>
<p>From the pic above we see that PinePhone‚Äôs MIPI DSI Connector is connected to <a href="https://patchwork.kernel.org/project/dri-devel/patch/20200311163329.221840-4-icenowy@aosc.io/"><strong>Xingbangda XBD599</strong></a>.</p>
<p>This is a 5.99-inch 720x1440 MIPI DSI IPS LCD Panel.</p>
<p>But what‚Äôs super interesting is that Xingbangda XBD599 has a <strong>Sitronix ST7703 LCD Controller</strong> inside!</p>
<ul>
<li><a href="https://files.pine64.org/doc/datasheet/pinephone/ST7703_DS_v01_20160128.pdf"><strong>Sitronix ST7703 LCD Controller Datasheet</strong></a></li>
</ul>
<p>Let‚Äôs probe deeper‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/dsi-sitronix2.png" alt="PineTime (ST7789) vs PinePhone (ST7703)" /></p>
<p><a href="https://www.sitronix.com.tw/en/products/aiot-device-ddi/"><em>PineTime (ST7789) vs PinePhone (ST7703)</em></a></p>
<h1 id="sitronix-st7703-lcd-controller"><a href="#sitronix-st7703-lcd-controller">5 Sitronix ST7703 LCD Controller</a></h1>
<p><em>Sitronix ST7703 sounds familiar?</em></p>
<p>Yep Sitronix makes the LCD Controllers for BOTH PineTime and PinePhone!</p>
<p>In fact they‚Äôre from the <a href="https://www.sitronix.com.tw/en/products/aiot-device-ddi/"><strong>same family</strong></a> of LCD Controllers. (ST7789 vs ST7703)</p>
<p>Just that PineTime uses an SPI Interface while PinePhone uses a <strong>MIPI DSI Interface</strong>. (Pic above)</p>
<p>The resolutions are different too. PinePhone has a <strong>huge display</strong> with more colours‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/dsi-sitronix1.png" alt="PineTime (ST7789) vs PinePhone (ST7703)" /></p>
<p><a href="https://www.sitronix.com.tw/en/products/aiot-device-ddi/">(Source)</a></p>
<p>Which means that PinePhone‚Äôs LCD Controller is <strong>RAM-less</strong>‚Ä¶</p>
<p>It <strong>doesn‚Äôt have any RAM</strong> inside to remember the pixels. (Unlike PineTime)</p>
<p><em>What‚Äôs the implication of a RAM-less display?</em></p>
<p>Because PinePhone‚Äôs LCD Controller doesn‚Äôt have any RAM inside to remember the pixels drawn‚Ä¶</p>
<p>PinePhone‚Äôs A64 SoC will <strong>pump a constant stream of pixels</strong> to refresh the display.</p>
<p>(Yep PinePhone is way more complicated than PineTime!)</p>
<p>This pixel pumping is done by A64‚Äôs <a href="https://lupyuen.github.io/articles/pio#lcd-controller-tcon0"><strong>Timing Controller (TCON0)</strong></a>. We‚Äôll come back to this.</p>
<h1 id="initialise-lcd-controller"><a href="#initialise-lcd-controller">6 Initialise LCD Controller</a></h1>
<p><em>What happens inside PinePhone‚Äôs ST7703 LCD Controller?</em></p>
<p>Let‚Äôs figure out by looking at the initialisation of PinePhone‚Äôs ST7703 LCD Controller.</p>
<p>Xingbangda has provided a list of <a href="https://github.com/torvalds/linux/blob/master/drivers/gpu/drm/panel/panel-sitronix-st7703.c#L174-L333"><strong>Initialisation Commands</strong></a> that we should send to the LCD Controller at startup‚Ä¶</p>
<div><table><thead><tr><th style="text-align: center">Byte</th><th style="text-align: left">Purpose</th></tr></thead><tbody>
<tr><td style="text-align: center"><code>B9</code></td><td style="text-align: left"><strong>SETEXTC:</strong> Enable USER Command (Page 131)</td></tr>
<tr><td style="text-align: center"><code>F1</code></td><td style="text-align: left">- Enable USER Command</td></tr>
<tr><td style="text-align: center"><code>12</code></td><td style="text-align: left">- (Continued)</td></tr>
<tr><td style="text-align: center"><code>83</code></td><td style="text-align: left">- (Continued)</td></tr>
<tr><td style="text-align: center"><code>BA</code></td><td style="text-align: left"><strong>SETMIPI:</strong> Set MIPI Registers (Page 144)</td></tr>
<tr><td style="text-align: center"><code>33</code></td><td style="text-align: left">- Virtual Channel (0), Number of Lanes (4)</td></tr>
<tr><td style="text-align: center"><code>81</code></td><td style="text-align: left">- LDO Voltage, Terminal Resistance</td></tr>
<tr><td style="text-align: center"><code>05</code></td><td style="text-align: left">- MIPI Low High Speed driving ability</td></tr>
<tr><td style="text-align: center"><code>F9</code></td><td style="text-align: left">- TXCLK speed in DSI LP mode</td></tr>
<tr><td style="text-align: center"><code>0E</code></td><td style="text-align: left">- Minimum HFP number</td></tr>
<tr><td style="text-align: center"><code>0E</code></td><td style="text-align: left">- Minimum HBP number</td></tr>
<tr><td style="text-align: center">‚Ä¶</td><td style="text-align: left"><a href="https://github.com/torvalds/linux/blob/master/drivers/gpu/drm/panel/panel-sitronix-st7703.c#L174-L333">(And many more commands, see this list)</a></td></tr>
</tbody></table>
</div>
<p>The above commands are documented in the ST7703 Datasheet‚Ä¶</p>
<ul>
<li><a href="https://files.pine64.org/doc/datasheet/pinephone/ST7703_DS_v01_20160128.pdf"><strong>Sitronix ST7703 LCD Controller Datasheet</strong></a></li>
</ul>
<p><em>How shall we send the Init Commands to ST7703?</em></p>
<p>TODO</p>
<p>xbd599_init_sequence</p>
<ul>
<li>Calls dsi_dcs_write_seq</li>
<li>Calls mipi_dsi_dcs_write</li>
</ul>
<p>sun6i_dsi_dcs_write_long: <a href="https://github.com/torvalds/linux/blob/master/drivers/gpu/drm/sun4i/sun6i_mipi_dsi.c#L882-L921">sun6i_mipi_dsi.c</a></p>
<ul>
<li>Calls sun6i_dsi_start(dsi, DSI_START_LPTX);</li>
<li>sun6i_dsi_inst_wait_for_completion</li>
</ul>
<p>sun6i_dsi_start: <a href="https://github.com/torvalds/linux/blob/master/drivers/gpu/drm/sun4i/sun6i_mipi_dsi.c#L670-L714">sun6i_mipi_dsi.c</a></p>
<p><a href="https://github.com/torvalds/linux/blob/master/drivers/gpu/drm/panel/panel-sitronix-st7703.c#L350-L356">panel-sitronix-st7703.c</a></p>
<div class="example-wrap"><pre class="language-c"><code>static const struct st7703_panel_desc xbd599_desc = {
	.mode = &amp;xbd599_mode,
	.lanes = 4,
	.mode_flags = MIPI_DSI_MODE_VIDEO | MIPI_DSI_MODE_VIDEO_SYNC_PULSE,
	.format = MIPI_DSI_FMT_RGB888,
	.init_sequence = xbd599_init_sequence,
};</code></pre></div><h1 id="registers-for-mipi-dsi"><a href="#registers-for-mipi-dsi">7 Registers for MIPI DSI</a></h1>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/dsi-registers2.png" alt="TODO" /></p>
<h1 id="data-types-for-mipi-dsi"><a href="#data-types-for-mipi-dsi">8 Data Types for MIPI DSI</a></h1>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/dsi-datatype.png" alt="TODO" /></p>
<h1 id="video-mode-for-mipi-dsi"><a href="#video-mode-for-mipi-dsi">9 Video Mode for MIPI DSI</a></h1>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/dsi-modes.png" alt="TODO" /></p>
<h1 id="transmit-over-mipi-dsi"><a href="#transmit-over-mipi-dsi">10 Transmit over MIPI DSI</a></h1>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/dsi-tx.png" alt="TODO" /></p>
<h1 id="todo"><a href="#todo">11 TODO</a></h1>
<p>SPI Interface (SCL, SDA, DCX, ‚Ä¶)</p>
<p>OR</p>
<p>DSI Interface (CKN, CKP, D0P, D0N, ‚Ä¶)</p>
<p>-&gt; Command Decoder</p>
<p>Suggests that DSI is just a wrapper over the old ST77xx commands</p>
<blockquote>
<p>DSI-compliant peripherals support either of two basic modes of operation: Command Mode and Video Mode. Which mode is used depends on the architecture and capabilities of the peripheral. The ST7703 only support Video mode. </p>
</blockquote>
<blockquote>
<p>Video Mode refers to operation in which transfers from the host processor to the peripheral take the form of a real-time pixel stream. In normal operation, the driver IC relies on the host processor to provide image data at sufficient bandwidth to avoid flicker or other visible artifacts in the displayed image. Video information should only be transmitted using High Speed Mode. </p>
</blockquote>
<p>Lane 0 is special: Bus Turnaround</p>
<p>Page 19</p>
<div class="example-wrap"><pre class="language-text"><code>Lane Pair HOST(Master)/ Driver IC(Slave)
Clock Lane
- Unidirectional Lane
- Clock Only
- Escape mode (ULPS only)
Data Lane 0
- Bi-directional Lane
- Forward High Speed
- Bi-directional Escape Mode
- Bi-directional LPDT
Data Lane 1
Data Lane 2
Data Lane 3
- Unidirectional Lane
- Forward High Speed
- Escape mode (ULPS only)
- NO LPDT
Table 5.2: MIPI Interface Configuration</code></pre></div>
<p>Low-Power Data Transmission (LPDT)</p>
<p>Ultra Low Power State (ULPS)</p>
<div class="example-wrap"><pre class="language-text"><code>Escape Command Command Type Entry Command Pattern
(First BitÔÉ†Last Bit Transmitted)
Low Power Data Transmission 
Mode 
1110 0001
Ultra-Low Power mode 
Mode 
0001 1110
Remote Application Reset 
Trigger 
0110 0010
Tearing Effect 
Trigger 
0101 1101
Acknowledge 
Trigger 
0010 0001
Table 5.5: Escape Mode Commands</code></pre></div>
<p>Page 32</p>
<blockquote>
<p>short packets format include an 8-bit Data ID followed by zero to seven bytes and an 8-bit ECC</p>
</blockquote>
<blockquote>
<p>Long packets can be from 6 to 65,541 bytes in length. </p>
</blockquote>
<div class="example-wrap"><pre class="language-text"><code>SOT: Start of Transmission
DI(Data ID): 8-bit Contain Virtual Channel Identifier and Data Type.
Data 0 and Data 1: Packet Data (8+8bit)
ECC(Error Correction Code): The Error Correction Code allows single-bit errors to be corrected and
2-bit errors to be detected in the Packet Header.
Figure 5.23: Structure of the short packet</code></pre></div><div class="example-wrap"><pre class="language-text"><code>DI (Data ID)ÔºöContain Virtual Channel Identifier and Data Type.
WC (Word Count)Ôºö8+8 bits The receiver use WC to define packet end.
ECC (Error Correction Code)ÔºöThe Error Correction Code allows single-bit errors to be corrected and
2-bit errors to be detected in the Packet Header.
PF(Packet Footer)ÔºöMean 16-bit Checksum.
Figure 5.24: Structure of the long packet</code></pre></div>
<p>No ram buffer</p>
<p>Need constant refresh</p>
<p>Tcon</p>
<p>NuttX Driver
ST7789 is closest</p>
<p><a href="https://github.com/lupyuen/incubator-nuttx/blob/master/drivers/lcd/st7789.c">st7789.c</a></p>
<p>Init the display first</p>
<p>Maybe the display will light up (backlight)</p>
<p>Then try to draw some pixels</p>
<p>TCON might be harder</p>
<p><a href="https://www.reddit.com/user/immibis/">u/immibis</a></p>
<blockquote>
<p>I had a go. I was able to instruct the MIPI DSI to run commands (by copying from Linux) but I wasn‚Äôt able to receive a response from the screen. Chat reckons that simply doesn‚Äôt work. I get the impression what‚Äôs in Linux might be just a translated version of the BSP SDK and nobody really knows how it works.</p>
</blockquote>
<blockquote>
<p>I ordered a Pine A64 and official touchscreen. Same chip (maybe not the same screen) and should be less fiddly to debug with an oscilloscope.</p>
</blockquote>
<blockquote>
<p>MIPI DSI registers are partially documented in the sun6i (whichever chip that is) user manual. I got this hint because the Linux driver files are called sun6i even though the chip is actually sun8i.</p>
</blockquote>
<blockquote>
<p>To actually display pixels on the screen you also need to program DE and TCON. I saw something somewhere about a test pattern that might be able to bypass this, and a framebuffer mode that bypasses the mixing IIRC.</p>
</blockquote>
<p><a href="https://www.reddit.com/r/PINE64official/comments/xjzack/comment/ipd6fsy/?utm_source=share&amp;utm_medium=web2x&amp;context=3">(Source)</a></p>
<p><a href="https://github.com/zephyrproject-rtos/zephyr-testing/blob/main/tests/drivers/mipi_dsi/api/src/main.c">Zephyr Driver for MIPI DSI</a></p>
<p>A64 MIPI DSI Driver: <a href="https://github.com/torvalds/linux/blob/master/drivers/gpu/drm/sun4i/sun6i_mipi_dsi.c">sun6i_mipi_dsi.c</a></p>
<p>sun6i_dsi_dcs_write_short: <a href="https://github.com/torvalds/linux/blob/master/drivers/gpu/drm/sun4i/sun6i_mipi_dsi.c#L869-L880">sun6i_mipi_dsi.c</a></p>
<ul>
<li>Calls sun6i_dsi_start(dsi, DSI_START_LPTX);</li>
</ul>
<p>sun6i_dsi_dcs_write_long: <a href="https://github.com/torvalds/linux/blob/master/drivers/gpu/drm/sun4i/sun6i_mipi_dsi.c#L882-L921">sun6i_mipi_dsi.c</a></p>
<ul>
<li>Calls sun6i_dsi_start(dsi, DSI_START_LPTX);</li>
<li>sun6i_dsi_inst_wait_for_completion</li>
</ul>
<p>sun6i_dsi_dcs_read: <a href="https://github.com/torvalds/linux/blob/master/drivers/gpu/drm/sun4i/sun6i_mipi_dsi.c#L923-L960">sun6i_mipi_dsi.c</a></p>
<p>sun6i_dsi_transfer: <a href="https://github.com/torvalds/linux/blob/master/drivers/gpu/drm/sun4i/sun6i_mipi_dsi.c#L996-L1034">sun6i_mipi_dsi.c</a></p>
<p>sun6i_dsi_start: <a href="https://github.com/torvalds/linux/blob/master/drivers/gpu/drm/sun4i/sun6i_mipi_dsi.c#L670-L714">sun6i_mipi_dsi.c</a></p>
<p>sun6i_dsi_encoder_enable: <a href="https://github.com/torvalds/linux/blob/master/drivers/gpu/drm/sun4i/sun6i_mipi_dsi.c#L716-L795">sun6i_mipi_dsi.c</a></p>
<p>Calls D-PHY:</p>
<ul>
<li>phy_init</li>
<li>phy_mipi_dphy_get_default_config</li>
<li>phy_set_mode</li>
<li>phy_configure</li>
<li>phy_power_on</li>
</ul>
<p>A64 MIPI D-PHY Driver: <a href="https://github.com/torvalds/linux/blob/master/drivers/phy/allwinner/phy-sun6i-mipi-dphy.c">phy-sun6i-mipi-dphy.c</a></p>
<p>sun6i_dphy_tx_power_on: <a href="https://github.com/torvalds/linux/blob/master/drivers/phy/allwinner/phy-sun6i-mipi-dphy.c#L154-L243">phy-sun6i-mipi-dphy.c</a></p>
<p>sun6i_dphy_rx_power_on: <a href="https://github.com/torvalds/linux/blob/master/drivers/phy/allwinner/phy-sun6i-mipi-dphy.c#L245-L341">phy-sun6i-mipi-dphy.c</a></p>
<p>sun6i_dphy_power_on: <a href="https://github.com/torvalds/linux/blob/master/drivers/phy/allwinner/phy-sun6i-mipi-dphy.c#L343-L355">phy-sun6i-mipi-dphy.c</a></p>
<blockquote>
<p>several important registers used by the driver aren‚Äôt documented (the command registers) but the basic format is shown in the driver source code</p>
</blockquote>
<p><a href="https://github.com/torvalds/linux/blob/master/drivers/gpu/drm/sun4i/sun6i_mipi_dsi.c#L1233">sun6i_mipi_dsi.c</a></p>
<div class="example-wrap"><pre class="language-c"><code>MODULE_DESCRIPTION(&quot;Allwinner A31 DSI Driver&quot;);</code></pre></div>
<p><a href="https://github.com/torvalds/linux/blob/master/drivers/gpu/drm/sun4i/sun6i_mipi_dsi.c#L1215-L1219">sun6i_mipi_dsi.c</a></p>
<div class="example-wrap"><pre class="language-c"><code>static const struct of_device_id sun6i_dsi_of_table[] = {
	{ .compatible = &quot;allwinner,sun6i-a31-mipi-dsi&quot; },
	{ .compatible = &quot;allwinner,sun50i-a64-mipi-dsi&quot; },
	{ }
};</code></pre></div>
<ul>
<li><a href="https://linux-sunxi.org/A31">A31</a></li>
<li><a href="https://github.com/allwinner-zh/documents/raw/master/A31/A31_Datasheet_v1.5_20150510.pdf">A31 Datasheet</a></li>
<li><a href="https://github.com/allwinner-zh/documents/raw/master/A31/A31_User_Manual_v1.3_20150510.pdf">A31 User Manual</a></li>
</ul>
<p>The <strong>MIPI DSI Registers</strong> are not documented in the A64 User Manual. However they seem to be documented in the <strong>Allwinner A31 User Manual</strong>‚Ä¶</p>
<ul>
<li>
<p><a href="https://github.com/allwinner-zh/documents/raw/master/A31/A31_User_Manual_v1.3_20150510.pdf"><strong>Allwinner A31 User Manual</strong></a></p>
<p>(Section 7.6: ‚ÄúMIPI DSI‚Äù, Page 836)</p>
</li>
</ul>
<div class="example-wrap"><pre class="language-text"><code>7.6.4.30. DSI_CMD_TX_REG
Page 856
DSI_CMD_TX_REG 
0x300+N*0x04
(N=0~63) 
DSI LP TX Package Register</code></pre></div>
<blockquote>
<p>That‚Äôs probably the one, but the module is running a little instruction set and the manual conspicuously omits any description of the instructions or even the registers where you put the instructions.</p>
</blockquote>
<p>Packet Header: 32-bits</p>
<p>sun6i_dsi_dcs_build_pkt_hdr: <a href="https://github.com/torvalds/linux/blob/master/drivers/gpu/drm/sun4i/sun6i_mipi_dsi.c#L850-L867">sun6i_mipi_dsi.c</a></p>
<p>Data Type = MIPI_DSI_DCS_LONG_WRITE</p>
<p><a href="https://github.com/torvalds/linux/blob/master/include/video/mipi_display.h#L47">mipi_display.h</a></p>
<div class="example-wrap"><pre class="language-c"><code>	MIPI_DSI_DCS_LONG_WRITE				= 0x39,</code></pre></div><h1 id="whats-next"><a href="#whats-next">12 What‚Äôs Next</a></h1>
<p>TODO</p>
<p>And eventually we shall build NuttX Drivers for PinePhone‚Äôs <a href="https://lupyuen.github.io/articles/pio#lcd-controller-tcon0"><strong>LCD Display</strong></a> and <a href="https://lupyuen.github.io/articles/pio#touch-panel"><strong>Touch Panel</strong></a>!</p>
<p>There‚Äôs plenty to be done for NuttX on PinePhone, please lemme know if you would like to join me üôè</p>
<p>Check out the other articles on <strong>NuttX RTOS for PinePhone</strong>‚Ä¶</p>
<ul>
<li>
<p><a href="https://lupyuen.github.io/articles/arm"><strong>‚ÄúApache NuttX RTOS on Arm Cortex-A53: How it might run on PinePhone‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/uboot"><strong>‚ÄúPinePhone boots Apache NuttX RTOS‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/interrupt"><strong>‚ÄúNuttX RTOS for PinePhone: Fixing the Interrupts‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/serial"><strong>‚ÄúNuttX RTOS for PinePhone: UART Driver‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/pio"><strong>‚ÄúNuttX RTOS for PinePhone: Blinking the LEDs‚Äù</strong></a></p>
</li>
</ul>
<p>Many Thanks to my <a href="https://github.com/sponsors/lupyuen"><strong>GitHub Sponsors</strong></a> for supporting my work! This article wouldn‚Äôt have been possible without your support.</p>
<ul>
<li>
<p><a href="https://github.com/sponsors/lupyuen"><strong>Sponsor me a coffee</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/book"><strong>My Current Project: ‚ÄúThe RISC-V BL602 Book‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io"><strong>Check out my articles</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/rss.xml"><strong>RSS Feed</strong></a></p>
</li>
</ul>
<p><em>Got a question, comment or suggestion? Create an Issue or submit a Pull Request here‚Ä¶</em></p>
<p><a href="https://github.com/lupyuen/lupyuen.github.io/blob/master/src/dsi.md"><strong>lupyuen.github.io/src/dsi.md</strong></a></p>

    
</body>
</html>