<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="rustdoc">
    <title>Build a LoRaWAN Network with RAKwireless WisGate Developer Gateway</title>

    
    <!-- Begin scripts/articles/*-header.html: Article Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<meta property="og:title" 
    content="Build a LoRaWAN Network with RAKwireless WisGate Developer Gateway" 
    data-rh="true">
<meta property="og:description" 
    content="How we set up our own LoRaWAN Network with RAKwireless RAK7248 WisGate Developer D4H Gateway... And test it with RAKwireless WisBlock in Arduino"
    data-rh="true">
<meta property="og:image" 
    content="https://lupyuen.github.io/images/wisgate-title.jpg">
<meta property="og:type" 
    content="article" data-rh="true">
<!-- End scripts/articles/*-header.html -->
<!-- Begin scripts/rustdoc-header.html: Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<link rel="alternate" type="application/rss+xml" title="RSS Feed for lupyuen" href="/rss.xml" />
<link rel="stylesheet" type="text/css" href="../normalize.css">
<link rel="stylesheet" type="text/css" href="../rustdoc.css" id="mainThemeStyle">
<link rel="stylesheet" type="text/css" href="../dark.css">
<link rel="stylesheet" type="text/css" href="../light.css" id="themeStyle">
<link rel="stylesheet" type="text/css" href="../prism.css">
<script src="../storage.js"></script><noscript>
<link rel="stylesheet" href="../noscript.css"></noscript>
<link rel="shortcut icon" href="../favicon.ico">
<style type="text/css">
    #crate-search {
        background-image: url("../down-arrow.svg");
    }
    a {
        color: #77d;
    }
</style>
<!-- End scripts/rustdoc-header.html -->


</head>
<body class="rustdoc">
    <!--[if lte IE 8]>
    <div class="warning">
        This old browser is unsupported and will most likely display funky
        things.
    </div>
    <![endif]-->

        <!-- Begin scripts/rustdoc-before.html: Pre-HTML for Custom Markdown files processed by rustdoc, like chip8.md -->

    <!-- Begin Theme Picker -->
    <div class="theme-picker" style="left: 0"><button id="theme-picker" aria-label="Pick another theme!"><img src="../brush.svg"
        width="18" alt="Pick another theme!"></button>
        <div id="theme-choices"></div>
    </div>
    <script src="../theme.js"></script>
    <script src="../prism.js"></script>
    <!-- Theme Picker -->

    <!-- End scripts/rustdoc-before.html -->
    

    <h1 class="title">Build a LoRaWAN Network with RAKwireless WisGate Developer Gateway</h1>
    <nav id="TOC"><ul>
<li><a href="#wisgate-d4h-hardware">1 WisGate D4H Hardware</a><ul></ul></li>
<li><a href="#chirpstack-lorawan-stack">2 ChirpStack LoRaWAN Stack</a><ul></ul></li>
<li><a href="#lorawan-application">3 LoRaWAN Application</a><ul></ul></li>
<li><a href="#lorawan-arduino-client">4 LoRaWAN Arduino Client</a><ul>
<li><a href="#initialise-lorawan-client">4.1 Initialise LoRaWAN Client</a><ul></ul></li>
<li><a href="#join-lorawan-network">4.2 Join LoRaWAN Network</a><ul></ul></li>
<li><a href="#send-lorawan-packet">4.3 Send LoRaWAN Packet</a><ul></ul></li></ul></li>
<li><a href="#output-log">5 Output Log</a><ul></ul></li>
<li><a href="#view-received-lorawan-packets">6 View Received LoRaWAN Packets</a><ul></ul></li>
<li><a href="#troubleshoot-lorawan">7 Troubleshoot LoRaWAN</a><ul></ul></li>
<li><a href="#visualise-lorawan-with-software-defined-radio">8 Visualise LoRaWAN with Software Defined Radio</a><ul></ul></li>
<li><a href="#lorawan-join-request">9 LoRaWAN Join Request</a><ul></ul></li>
<li><a href="#lorawan-message-integrity-code">10 LoRaWAN Message Integrity Code</a><ul></ul></li>
<li><a href="#lorawan-nonce">11 LoRaWAN Nonce</a><ul></ul></li>
<li><a href="#log-transmitted-packets">12 Log Transmitted Packets</a><ul></ul></li>
<li><a href="#whats-next">13 What's Next</a><ul></ul></li>
<li><a href="#notes">14 Notes</a><ul></ul></li></ul></nav><p>üìù <em>3 May 2021</em></p>
<p>While testing a new LoRaWAN gadget (<a href="https://lupyuen.github.io/articles/lora2">PineCone BL602</a>), I bought a LoRaWAN Gateway from RAKwireless: <a href="https://docs.rakwireless.com/Product-Categories/WisGate/RAK7248/Datasheet/"><strong>RAK7248 WisGate Developer D4H Gateway</strong></a>.</p>
<p>Here's what I learnt about <strong>settting up a LoRaWAN Network</strong> with WisGate Developer D4H... And testing it with the <strong>RAKwireless WisBlock dev kit in Arduino</strong>.</p>
<p><img src="https://lupyuen.github.io/images/wisgate-title.jpg" alt="RAKwireless RAK7248 WisGate Developer D4H LoRaWAN Gateway" /></p>
<p><em>RAKwireless RAK7248 WisGate Developer D4H LoRaWAN Gateway</em></p>
<h1 id="wisgate-d4h-hardware" class="section-header"><a href="#wisgate-d4h-hardware">1 WisGate D4H Hardware</a></h1>
<p>WisGate D4H is essentially a <strong>Raspberry Pi 4 + LoRa Network Concentrator (Semtech SX1302)</strong> in a sturdy IP30 box.</p>
<p>It exposes the same ports and connectors as a Raspberry Pi 4: <strong>Ethernet port, USB 2 and 3 ports, USB-C power, microSD Card.</strong></p>
<p>But the <strong>HDMI and GPIO ports</strong> are no longer accessible. (We control the box over HTTP and SSH)</p>
<p><img src="https://lupyuen.github.io/images/wisgate-hw.jpg" alt="RAKwireless RAK7248 WisGate Developer D4H LoRaWAN Gateway" /></p>
<p>2 new connectors have been added...</p>
<ol>
<li>
<p><strong>LoRa Antenna</strong> (left)</p>
</li>
<li>
<p><strong>GPS Antenna</strong> (right)</p>
</li>
</ol>
<p>(The two connectors are slightly different, so we won't connect the wrong antenna)</p>
<p>The GPS Antenna will be used when we connect WisGate to The Things Network (the worldwide free-access LoRaWAN network).</p>
<p>WisGate D4H is shipped with the open-source <strong>ChirpStack LoRaWAN stack</strong>, preinstalled in the microSD card. </p>
<p>(Yep please don't peel off the sticky tape and insert your own microSD card)</p>
<p><img src="https://lupyuen.github.io/images/wisgate-hw2.jpg" alt="microSD Slot on WisGate D4H" /></p>
<p><em>microSD Slot on WisGate D4H</em></p>
<h1 id="chirpstack-lorawan-stack" class="section-header"><a href="#chirpstack-lorawan-stack">2 ChirpStack LoRaWAN Stack</a></h1>
<p>Connect the <strong>LoRa Antenna and GPS Antenna</strong> to WisGate before powering on. (To prevent damage to the RF modules)</p>
<p>Follow the instructions here to start the WisGate box and to connect to the preinstalled ChirpStack LoRaWAN stack...</p>
<ul>
<li><a href="https://docs.rakwireless.com/Product-Categories/WisGate/RAK7244C/Quickstart/"><strong>&quot;RAK7244C Quick Start Guide&quot;</strong></a></li>
</ul>
<p>(RAK7244C is quite similar to our RAK7248 gateway)</p>
<p>I connected an Ethernet cable to WisGate and used SSH to configure the WiFi and LAN settings (via <code>sudo gateway-config</code>).</p>
<p>Here's the <strong>ChirpStack web admin</strong> page that we will see...</p>
<p><img src="https://lupyuen.github.io/images/wisgate-chirpstack.png" alt="ChirpStack web admin on WisGate" /></p>
<p>(Nope I'm nowhere near Jervois Road)</p>
<p>In the left bar, click <strong><code>Gateways</code></strong> to see our pre-configured LoRaWAN Gateway...</p>
<p><img src="https://lupyuen.github.io/images/wisgate-chirpstack2.png" alt="ChirpStack web admin on WisGate" /></p>
<p>Click <strong><code>rak-gateway</code></strong> to see the Gateway Details...</p>
<p><img src="https://lupyuen.github.io/images/wisgate-chirpstack3.png" alt="ChirpStack web admin on WisGate" /></p>
<p>This shows that my WisGate gateway receives <strong>1,200 LoRaWAN Packets a day</strong> from unknown LoRaWAN Devices nearby.</p>
<p>WisGate won't do anything with the received LoRaWAN Packets since it's not configured to process packets with mysterious origins.</p>
<p>(But we may click <strong><code>Live LoRaWAN Frames</code></strong> at top right to see the encrypted contents of the received LoRaWAN Packets)</p>
<h1 id="lorawan-application" class="section-header"><a href="#lorawan-application">3 LoRaWAN Application</a></h1>
<p>When we allow a LoRaWAN Device to talk to our LoRaWAN Gateway, we need to set 2 things in the device...</p>
<ol>
<li>
<p><strong>Device EUI</strong>: An 64-bit number that uniquely identifies our LoRaWAN Device</p>
</li>
<li>
<p><strong>Application Key</strong>: A 128-bit secret key that will authenticate that specific LoRaWAN Device</p>
</li>
</ol>
<p>Here's how we get the Device EUI and Application Key from ChirpStack...</p>
<p>Click <strong><code>Applications</code></strong> then <strong><code>app</code></strong>...</p>
<p><img src="https://lupyuen.github.io/images/wisgate-app.png" alt="ChirpStack Application" /></p>
<p>Take note of the second <strong>Device EUI</strong> (for the OTAA Device Profile)...</p>
<p><img src="https://lupyuen.github.io/images/wisgate-app2.png" alt="ChirpStack Application" /></p>
<p>(EUI sounds like we stepped on something unpleasant... But it actually means <a href="https://lora-developers.semtech.com/library/tech-papers-and-guides/the-book/deveui/"><strong>Extended Unique Identifier</strong></a>)</p>
<p>We shall set this Device EUI in our Arduino program in a while...</p>
<pre><code class="language-c">uint8_t nodeDeviceEUI[8] = { 0x4b, 0xc1, 0x5e, 0xe7, 0x37, 0x7b, 0xb1, 0x5b };
</code></pre>
<p>Click <strong><code>device_ptaa_class_a</code></strong> because we'll be doing <strong>Over-The-Air Activation (OTAA)</strong> for our Arduino device</p>
<p><img src="https://lupyuen.github.io/images/wisgate-app3.png" alt="ChirpStack Application" /></p>
<p>Click <strong><code>Keys (OTAA)</code></strong></p>
<p>Under <code>Application Key</code>, click the circular arrow to generate a random key.</p>
<p>Take note of the generated <strong>Application Key</strong>, we shall set this in our Arduino program...</p>
<pre><code class="language-c">uint8_t nodeAppKey[16] = { 0xaa, 0xff, 0xad, 0x5c, 0x7e, 0x87, 0xf6, 0x4d, 0xe3, 0xf0, 0x87, 0x32, 0xfc, 0x1d, 0xd2, 0x5d };
</code></pre>
<p>Click <strong><code>Set Device-Keys</code></strong></p>
<p>We're all set to connect our Arduino LoRaWAN Device to WisGate!</p>
<h1 id="lorawan-arduino-client" class="section-header"><a href="#lorawan-arduino-client">4 LoRaWAN Arduino Client</a></h1>
<p>I tested WisGate with an Arduino LoRaWAN Device: <a href="https://docs.rakwireless.com/Product-Categories/WisBlock/RAK4631/Overview/"><strong>RAKwireless RAK4631 WisBlock</strong></a>, based on Nordic nRF52840 with Semtech SX1262...</p>
<p><img src="https://lupyuen.github.io/images/wisblock-title.jpg" alt="RAKwireless RAK4631 WisBlock LPWAN Module mounted on WisBlock Base Board" /></p>
<p><em>RAKwireless RAK4631 WisBlock LPWAN Module mounted on WisBlock Base Board</em></p>
<p>The Arduino source code is here...</p>
<ul>
<li>
<p><a href="https://github.com/lupyuen/wisblock-lorawan"><code>github.com/lupyuen/wisblock-lorawan</code></a></p>
</li>
<li>
<p><a href="https://youtu.be/xdyi6XCo8Z8"><strong>Watch the demo video on YouTube</strong></a></p>
</li>
</ul>
<p>Note that the program requires the <a href="https://github.com/beegee-tokyo/SX126x-Arduino"><strong><code>SX126x-Arduino</code></strong></a> Library version <strong>2.0.0 or later</strong>. </p>
<p>With PlatformIO, we set the <code>SX126x-Arduino</code> version in <a href="https://github.com/lupyuen/wisblock-lorawan/blob/master/platformio.ini"><code>platformio.ini</code></a> like so...</p>
<pre><code class="language-text">lib_deps = beegee-tokyo/SX126x-Arduino@^2.0.0
</code></pre>
<p>The Arduino program in this article is based on the RAKwireless LoRaWAN sample <a href="https://github.com/RAKWireless/WisBlock/blob/master/examples/RAK4630/communications/LoRa/LoRaWAN/LoRaWAN_OTAA_ABP/LoRaWAN_OTAA_ABP.ino"><code>LoRaWAN_OTAA_ABP.ino</code></a></p>
<p><a href="https://github.com/RAKWireless/WisBlock/tree/master/examples/RAK4630/communications/LoRa/LoRaWAN">(More about LoRaWAN on WisBlock RAK4631)</a></p>
<h2 id="initialise-lorawan-client" class="section-header"><a href="#initialise-lorawan-client">4.1 Initialise LoRaWAN Client</a></h2>
<p>TODO</p>
<p><a href="https://github.com/lupyuen/wisblock-lorawan/blob/master/src/main.cpp#L38-L58"><code>From main.cpp</code></a></p>
<pre><code class="language-c">//  TODO: Set this to your LoRaWAN Region
LoRaMacRegion_t g_CurrentRegion = LORAMAC_REGION_AS923;
</code></pre>
<p>TODO</p>
<pre><code class="language-c">//  Set to true to select Over-The-Air Activation 
//  (OTAA), false for Activation By Personalisation (ABP)
bool doOTAA = true;
</code></pre>
<p>TODO</p>
<pre><code class="language-c">//  TODO: (For OTAA Only) Set the OTAA keys. KEYS ARE MSB !!!!

//  Device EUI: Copy from ChirpStack: 
//  Applications -&gt; app -&gt; Device EUI
uint8_t nodeDeviceEUI[8] = { 0x4b, 0xc1, 0x5e, 0xe7, 0x37, 0x7b, 0xb1, 0x5b };

//  App EUI: Not needed for ChirpStack, 
//  set to default 0000000000000000
uint8_t nodeAppEUI[8] = { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 };

//  App Key: Copy from ChirpStack: 
//  Applications -&gt; app -&gt; Devices -&gt; 
//  device_otaa_class_a -&gt; Keys (OTAA) -&gt; 
//  Application Key
uint8_t nodeAppKey[16] = { 0xaa, 0xff, 0xad, 0x5c, 0x7e, 0x87, 0xf6, 0x4d, 0xe3, 0xf0, 0x87, 0x32, 0xfc, 0x1d, 0xd2, 0x5d };
</code></pre>
<p>TODO</p>
<pre><code class="language-c">//  TODO: (For ABP Only) Set the ABP keys
uint32_t nodeDevAddr = 0x260116F8;
uint8_t nodeNwsKey[16] = { 0x7E, 0xAC, 0xE2, 0x55, 0xB8, 0xA5, 0xE2, 0x69, 0x91, 0x51, 0x96, 0x06, 0x47, 0x56, 0x9D, 0x23 };
uint8_t nodeAppsKey[16] = { 0xFB, 0xAC, 0xB6, 0x47, 0xF3, 0x58, 0x45, 0xC7, 0x50, 0x7D, 0xBF, 0x16, 0x8B, 0xA8, 0xC1, 0x7C };
</code></pre>
<p>TODO</p>
<p><a href="https://github.com/lupyuen/wisblock-lorawan/blob/master/src/main.cpp#L110-L213"><code>From main.cpp</code></a></p>
<pre><code class="language-c">// At startup, we join the LoRaWAN network, in either OTAA or ABP mode
void setup() {
  ...
  // Initialize LoRa chip.
  lora_rak4630_init();

  // Omitted: Initialize Serial for debug output
  ...
  
  // Create a timer to send data to server periodically
  uint32_t err_code err_code = timers_init();
  if (err_code != 0) { return; }
</code></pre>
<p>TODO</p>
<pre><code class="language-c">  // Setup the EUIs and Keys
  if (doOTAA) {
    // Set the keys for OTAA
    lmh_setDevEui(nodeDeviceEUI);
    lmh_setAppEui(nodeAppEUI);
    lmh_setAppKey(nodeAppKey);
  } else {
    // Omitted: Set the keys for ABP
    ...
  }
</code></pre>
<p>TODO</p>
<pre><code class="language-c">  // Initialize LoRaWaN
  err_code = lmh_init(  //  lmh_init now takes 3 parameters instead of 5
    &amp;g_lora_callbacks,  //  Callbacks 
    g_lora_param_init,  //  Functions
    doOTAA,             //  Set to true for OTAA
    g_CurrentClass,     //  Class 
    g_CurrentRegion     //  Region
  );
  if (err_code != 0) { return; }
</code></pre>
<p>TODO</p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
  <span class="comment">// Start Join procedure</span>
  <span class="ident">lmh_join</span>();
}</pre></div>
<p>TODO</p>
<p><a href="https://github.com/lupyuen/wisblock-lorawan/blob/master/src/main.cpp#L87-L97"><code>From main.cpp</code></a></p>
<pre><code class="language-c">//  Structure containing LoRaWan callback functions, 
//  needed for lmh_init()
static lmh_callback_t g_lora_callbacks = {
    BoardGetBatteryLevel, 
    BoardGetUniqueId, 
    BoardGetRandomSeed,
    lorawan_rx_handler, 
    lorawan_has_joined_handler, 
    lorawan_confirm_class_handler, 
    lorawan_join_failed_handler
};
</code></pre>
<p>TODO</p>
<p><a href="https://github.com/lupyuen/wisblock-lorawan/blob/master/src/main.cpp#L215-L220"><code>From main.cpp</code></a></p>
<pre><code class="language-c">//  Nothing here for now
void loop() {
  //  Put your application tasks here, like reading of sensors,
  //  Controlling actuators and/or other functions. 
}
</code></pre>
<h2 id="join-lorawan-network" class="section-header"><a href="#join-lorawan-network">4.2 Join LoRaWAN Network</a></h2>
<p>TODO</p>
<p><a href="https://github.com/lupyuen/wisblock-lorawan/blob/master/src/main.cpp#L222-L236"><code>From main.cpp</code></a></p>
<pre><code class="language-c">//  LoRa function for handling HasJoined event
void lorawan_has_joined_handler(void) {
  //  When we have joined the LoRaWAN network, 
  //  start a 20-second timer
  lmh_error_status ret = lmh_class_request(g_CurrentClass);
  if (ret == LMH_SUCCESS) {
    delay(1000);
    TimerSetValue(&amp;appTimer, LORAWAN_APP_INTERVAL);
    TimerStart(&amp;appTimer);
  }
}
</code></pre>
<p>TODO</p>
<p><a href="https://github.com/lupyuen/wisblock-lorawan/blob/master/src/main.cpp#L238-L246"><code>From main.cpp</code></a></p>
<pre><code class="language-c">//  LoRa function for handling OTAA join failed
static void lorawan_join_failed_handler(void) {
  //  If we can't join the LoRaWAN network, show the error
  Serial.println(&quot;OTAA join failed!&quot;);
}
</code></pre>
<p>In case you're curious: WisBlock transmits this LoRaWAN Packet to WisGate when requesting to join the LoRaWAN network...</p>
<p><img src="https://lupyuen.github.io/images/wisgate-join.png" alt="Join LoRaWAN Network Request" /></p>
<h2 id="send-lorawan-packet" class="section-header"><a href="#send-lorawan-packet">4.3 Send LoRaWAN Packet</a></h2>
<p>TODO</p>
<p><a href="https://github.com/lupyuen/wisblock-lorawan/blob/master/src/main.cpp#L269-L300"><code>From main.cpp</code></a></p>
<pre><code class="language-c">//  This is called when the 20-second timer expires. 
//  We send a LoRaWAN Packet.
void send_lora_frame(void) {
  if (lmh_join_status_get() != LMH_SET) {
    //  Not joined, try again later
    return;
  }

  uint32_t i = 0;
  memset(m_lora_app_data.buffer, 0, LORAWAN_APP_DATA_BUFF_SIZE);
  m_lora_app_data.port = gAppPort;
  m_lora_app_data.buffer[i++] = 'H';
  m_lora_app_data.buffer[i++] = 'e';
  m_lora_app_data.buffer[i++] = 'l';
  m_lora_app_data.buffer[i++] = 'l';
  m_lora_app_data.buffer[i++] = 'o';
  m_lora_app_data.buffer[i++] = '!';
  m_lora_app_data.buffsize = i;

  lmh_error_status error = lmh_send(
    &amp;m_lora_app_data, 
    g_CurrentConfirm
  );
  if (error == LMH_SUCCESS) { count++; } 
  else { count_fail++; }
}
</code></pre>
<p>TODO</p>
<p><a href="https://github.com/lupyuen/wisblock-lorawan/blob/master/src/main.cpp#L302-L311"><code>From main.cpp</code></a></p>
<pre><code class="language-c">//  Function for handling timerout event
void tx_lora_periodic_handler(void) {
  //  When the 20-second timer has expired, 
  //  send a LoRaWAN Packet and restart the timer
  TimerSetValue(&amp;appTimer, LORAWAN_APP_INTERVAL);
  TimerStart(&amp;appTimer);
  send_lora_frame();
}
</code></pre>
<p>TODO</p>
<p><a href="https://github.com/lupyuen/wisblock-lorawan/blob/master/src/main.cpp#L313-L321"><code>From main.cpp</code></a></p>
<pre><code class="language-c">//  Initialise the timer
uint32_t timers_init(void) {
  TimerInit(&amp;appTimer, tx_lora_periodic_handler);
  return 0;
}
</code></pre>
<p><a href="https://github.com/lupyuen/wisblock-lorawan/blob/master/src/main.cpp#L259-L267"><code>From main.cpp</code></a></p>
<pre><code class="language-c">//  Callback Function that is called when we have joined the LoRaWAN network with a LoRaWAN Class
void lorawan_confirm_class_handler(DeviceClass_t Class) {
  //  Informs the server that switch has occurred ASAP
  m_lora_app_data.buffsize = 0;
  m_lora_app_data.port = gAppPort;
  lmh_send(&amp;m_lora_app_data, g_CurrentConfirm);
}
</code></pre>
<p>TODO</p>
<p><a href="https://github.com/lupyuen/wisblock-lorawan/blob/master/src/main.cpp#L248-L257"><code>From main.cpp</code></a></p>
<pre><code class="language-c">//  Function for handling LoRaWan received data from Gateway
void lorawan_rx_handler(lmh_app_data_t *app_data) {
  //  When we receive a LoRaWAN Packet from the 
  //  LoRaWAN Gateway, display it
  Serial.printf(&quot;LoRa Packet received on port %d, size:%d, rssi:%d, snr:%d, data:%s\n&quot;,
    app_data-&gt;port, app_data-&gt;buffsize, app_data-&gt;rssi, app_data-&gt;snr, app_data-&gt;buffer);
}
</code></pre>
<h1 id="output-log" class="section-header"><a href="#output-log">5 Output Log</a></h1>
<p>TODO</p>
<p>From <a href="https://github.com/lupyuen/wisblock-lorawan/blob/master/README.md#output-log"><code>wisblock-lorawan</code></a></p>
<pre><code class="language-text">&lt;LMH&gt; OTAA 
DevEui=4B-C1-5E-E7-37-7B-B1-5B
DevAdd=00000000
AppEui=00-00-00-00-00-00-00-00
AppKey=AA-FF-AD-5C-7E-87-F6-4D-E3-F0-87-32-FC-1D-D2-5D
SX126xSetTxParams: power=0, rampTime=4
SX126xSetPaConfig: paDutyCycle=4, hpMax=7, deviceSel=0, paLut=1 
SX126xSetTxParams: power=13, rampTime=2
SX126xSetPaConfig: paDutyCycle=4, hpMax=7, deviceSel=0, paLut=1 
&lt;LMH&gt; Selected subband 1
Joining LoRaWAN network...
SX126xSetTxParams: power=13, rampTime=2
SX126xSetPaConfig: paDutyCycle=4, hpMax=7, deviceSel=0, paLut=1 
RadioSend: size=23, channel=1, datarate=2, txpower=0, maxeirp=16, antennagain=2
00 00 00 00 00 00 00 00 00 5b b1 7b 37 e7 5e c1 4b 0d 42 dd b9 22 aa 
&lt;LM&gt; OnRadioTxDone
&lt;LM&gt; OnRadioTxDone =&gt; RX Windows #1 5002 #2 6002
&lt;LM&gt; OnRadioTxDone =&gt; TX was Join Request
&lt;LM&gt; OnRadioRxDone
&lt;LM&gt; OnRadioRxDone =&gt; FRAME_TYPE_JOIN_ACCEPT
OTAA Mode, Network Joined!
</code></pre>
<p>TODO</p>
<pre><code class="language-text">Sending frame now...
SX126xSetTxParams: power=13, rampTime=2
SX126xSetPaConfig: paDutyCycle=4, hpMax=7, deviceSel=0, paLut=1 
RadioSend: size=19, channel=0, datarate=2, txpower=0, maxeirp=16, antennagain=2
40 3c 59 7a 00 80 00 00 02 17 77 31 fd 99 86 8f 4f cc ef 
lmh_send ok count 1
&lt;LM&gt; OnRadioTxDone
&lt;LM&gt; OnRadioTxDone =&gt; RX Windows #1 1002 #2 2002
&lt;RADIO&gt; RadioIrqProcess =&gt; IRQ_RX_TX_TIMEOUT
&lt;LM&gt; OnRadioRxTimeout
</code></pre>
<p>TODO</p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
<span class="ident">Sending</span> <span class="ident">frame</span> <span class="ident">now</span>...
<span class="ident">SX126xSetTxParams</span>: <span class="ident">power</span><span class="op">=</span><span class="number">13</span>, <span class="ident">rampTime</span><span class="op">=</span><span class="number">2</span>
<span class="ident">SX126xSetPaConfig</span>: <span class="ident">paDutyCycle</span><span class="op">=</span><span class="number">4</span>, <span class="ident">hpMax</span><span class="op">=</span><span class="number">7</span>, <span class="ident">deviceSel</span><span class="op">=</span><span class="number">0</span>, <span class="ident">paLut</span><span class="op">=</span><span class="number">1</span> 
<span class="ident">RadioSend</span>: <span class="ident">size</span><span class="op">=</span><span class="number">19</span>, <span class="ident">channel</span><span class="op">=</span><span class="number">5</span>, <span class="ident">datarate</span><span class="op">=</span><span class="number">2</span>, <span class="ident">txpower</span><span class="op">=</span><span class="number">0</span>, <span class="ident">maxeirp</span><span class="op">=</span><span class="number">16</span>, <span class="ident">antennagain</span><span class="op">=</span><span class="number">2</span>
<span class="number">40</span> <span class="number">3c</span> <span class="number">59</span> <span class="number">7a</span> <span class="number">00</span> <span class="number">80</span> <span class="number">01</span> <span class="number">00</span> <span class="number">02</span> <span class="number">0b</span> <span class="number">1f</span> <span class="number">7e</span> <span class="number">4d</span> <span class="ident">e1</span> <span class="number">94</span> <span class="ident">c9</span> <span class="number">16</span> <span class="ident">fa</span> <span class="ident">ea</span> 
<span class="ident">lmh_send</span> <span class="ident">ok</span> <span class="ident">count</span> <span class="number">2</span>
<span class="op">&lt;</span><span class="ident">LM</span><span class="op">&gt;</span> <span class="ident">OnRadioTxDone</span>
<span class="op">&lt;</span><span class="ident">LM</span><span class="op">&gt;</span> <span class="ident">OnRadioTxDone</span> <span class="op">=</span><span class="op">&gt;</span> <span class="ident">RX</span> <span class="ident">Windows</span> #<span class="number">1</span> <span class="number">1002</span> #<span class="number">2</span> <span class="number">2002</span>
<span class="op">&lt;</span><span class="ident">RADIO</span><span class="op">&gt;</span> <span class="ident">RadioIrqProcess</span> <span class="op">=</span><span class="op">&gt;</span> <span class="ident">IRQ_RX_TX_TIMEOUT</span>
<span class="op">&lt;</span><span class="ident">LM</span><span class="op">&gt;</span> <span class="ident">OnRadioRxTimeout</span></pre></div>
<h1 id="view-received-lorawan-packets" class="section-header"><a href="#view-received-lorawan-packets">6 View Received LoRaWAN Packets</a></h1>
<p>TODO</p>
<h1 id="troubleshoot-lorawan" class="section-header"><a href="#troubleshoot-lorawan">7 Troubleshoot LoRaWAN</a></h1>
<p>TODO</p>
<h1 id="visualise-lorawan-with-software-defined-radio" class="section-header"><a href="#visualise-lorawan-with-software-defined-radio">8 Visualise LoRaWAN with Software Defined Radio</a></h1>
<p>TODO</p>
<p><a href="https://youtu.be/xdyi6XCo8Z8"><strong>Watch the video on YouTube</strong></a></p>
<h1 id="lorawan-join-request" class="section-header"><a href="#lorawan-join-request">9 LoRaWAN Join Request</a></h1>
<p>TODO</p>
<h1 id="lorawan-message-integrity-code" class="section-header"><a href="#lorawan-message-integrity-code">10 LoRaWAN Message Integrity Code</a></h1>
<p>TODO</p>
<p>To search for Message Integrity Code errors in LoRaWAN Packets received by WisGate, SSH to WisGate and search for...</p>
<pre><code class="language-bash"># grep MIC /var/log/syslog

Apr 28 04:02:05 rak-gateway 
chirpstack-application-server[568]: 
time=&quot;2021-04-28T04:02:05+01:00&quot; 
level=error 
msg=&quot;invalid MIC&quot; 
dev_eui=4bc15ee7377bb15b 
type=DATA_UP_MIC

Apr 28 04:02:05 rak-gateway 
chirpstack-network-server[1378]: 
time=&quot;2021-04-28T04:02:05+01:00&quot; 
level=error 
msg=&quot;uplink: processing uplink frame error&quot;
ctx_id=0ccd1478-3b79-4ded-9e26-a28e4c143edc 
error=&quot;get device-session error: invalid MIC&quot;
</code></pre>
<h1 id="lorawan-nonce" class="section-header"><a href="#lorawan-nonce">11 LoRaWAN Nonce</a></h1>
<p>TODO</p>
<p>The error above occurs when we replay a repeated Join Network Request to our LoRaWAN Gateway (with same Nonce, same Message Integrity Code).</p>
<p>This replay also logs a Nonce Error in WisGate...</p>
<pre><code class="language-bash"># grep nonce /var/log/syslog

Apr 28 04:02:41 rak-gateway chirpstack-application-server[568]:
time=&quot;2021-04-28T04:02:41+01:00&quot; 
level=error 
msg=&quot;validate dev-nonce error&quot; 
dev_eui=4bc15ee7377bb15b 
type=OTAA

Apr 28 04:02:41 rak-gateway chirpstack-network-server[1378]:
time=&quot;2021-04-28T04:02:41+01:00&quot; 
level=error 
msg=&quot;uplink: processing uplink frame error&quot; ctx_id=01ae296e-8ce1-449a-83cc-fb0771059d89 
error=&quot;validate dev-nonce error: object already exists&quot;
</code></pre>
<p>Because the Nonce should not be reused.</p>
<p><a href="https://lora-alliance.org/resource_hub/lorawan-is-secure-but-implementation-matters/">&quot;LoRaWAN¬Æ Is Secure (but Implementation Matters)&quot;</a></p>
<h1 id="log-transmitted-packets" class="section-header"><a href="#log-transmitted-packets">12 Log Transmitted Packets</a></h1>
<p>To log transmitted packets, modify</p>
<p><code>.pio/libdeps/wiscore_rak4631/SX126x-Arduino/src/mac/LoRaMac.cpp</code></p>
<pre><code class="language-c">LoRaMacStatus_t SendFrameOnChannel(uint8_t channel)
{
    TxConfigParams_t txConfig;
    int8_t txPower = 0;

    txConfig.Channel = channel;
    txConfig.Datarate = LoRaMacParams.ChannelsDatarate;
    txConfig.TxPower = LoRaMacParams.ChannelsTxPower;
    txConfig.MaxEirp = LoRaMacParams.MaxEirp;
    txConfig.AntennaGain = LoRaMacParams.AntennaGain;
    txConfig.PktLen = LoRaMacBufferPktLen;

    // If we are connecting to a single channel gateway we use always the same predefined channel and datarate
    if (singleChannelGateway)
    {
        txConfig.Channel = singleChannelSelected;
        txConfig.Datarate = singleChannelDatarate;
    }

    RegionTxConfig(LoRaMacRegion, &amp;txConfig, &amp;txPower, &amp;TxTimeOnAir);

    MlmeConfirm.Status = LORAMAC_EVENT_INFO_STATUS_ERROR;
    McpsConfirm.Status = LORAMAC_EVENT_INFO_STATUS_ERROR;
    McpsConfirm.Datarate = LoRaMacParams.ChannelsDatarate;
    McpsConfirm.TxPower = txPower;

    // Store the time on air
    McpsConfirm.TxTimeOnAir = TxTimeOnAir;
    MlmeConfirm.TxTimeOnAir = TxTimeOnAir;

    // Starts the MAC layer status check timer
    TimerSetValue(&amp;MacStateCheckTimer, MAC_STATE_CHECK_TIMEOUT);
    TimerStart(&amp;MacStateCheckTimer);

    if (IsLoRaMacNetworkJoined != JOIN_OK)
    {
        JoinRequestTrials++;
    }

    //////////////// INSERT THIS CODE

    // To replay a Join Network Request...
    // if (LoRaMacBuffer[0] == 0) {
    // 	static uint8_t replay[] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x5b, 0xb1, 0x7b, 0x37, 0xe7, 0x5e, 0xc1, 0x4b, 0x67, 0xaa, 0xbb, 0x07, 0x70, 0x7d};
    // 	memcpy(LoRaMacBuffer, replay, LoRaMacBufferPktLen);
    // }

    // To dump transmitted packets...
    printf(&quot;RadioSend: size=%d, channel=%d, datarate=%d, txpower=%d, maxeirp=%d, antennagain=%d\r\n&quot;, (int) LoRaMacBufferPktLen, (int) txConfig.Channel, (int) txConfig.Datarate, (int) txConfig.TxPower, (int) txConfig.MaxEirp, (int) txConfig.AntennaGain);
    for (int i = 0; i &lt; LoRaMacBufferPktLen; i++) {
        printf(&quot;%02x &quot;, LoRaMacBuffer[i]);
    }
    printf(&quot;\r\n&quot;);
    
    //////////////// END OF INSERTION

    // Send now
    Radio.Send(LoRaMacBuffer, LoRaMacBufferPktLen);

    LoRaMacState |= LORAMAC_TX_RUNNING;

    return LORAMAC_STATUS_OK;
}
</code></pre>
<h1 id="whats-next" class="section-header"><a href="#whats-next">13 What's Next</a></h1>
<p>TODO</p>
<ul>
<li>
<p><a href="https://github.com/sponsors/lupyuen">Sponsor me a coffee</a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/book">Read &quot;The RISC-V BL602 Book&quot;</a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io">Check out my articles</a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/rss.xml">RSS Feed</a></p>
</li>
</ul>
<p><em>Got a question, comment or suggestion? Create an Issue or submit a Pull Request here...</em></p>
<p><a href="https://github.com/lupyuen/lupyuen.github.io/blob/master/src/wisgate.md"><code>lupyuen.github.io/src/wisgate.md</code></a></p>
<h1 id="notes" class="section-header"><a href="#notes">14 Notes</a></h1>
<ol>
<li>This article is the expanded version of <a href="https://twitter.com/MisterTechBlog/status/1379926160377851910">this Twitter Thread</a></li>
</ol>

    
</body>
</html>