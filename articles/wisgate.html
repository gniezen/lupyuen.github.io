<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="rustdoc">
    <title>Build a LoRaWAN Network with RAKwireless WisGate Developer Gateway</title>

    
    <!-- Begin scripts/articles/*-header.html: Article Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<meta property="og:title" 
    content="Build a LoRaWAN Network with RAKwireless WisGate Developer Gateway" 
    data-rh="true">
<meta property="og:description" 
    content="How we set up our own LoRaWAN Network with RAKwireless RAK7248 WisGate Developer D4H Gateway... And test it with RAKwireless WisBlock in Arduino"
    data-rh="true">
<meta property="og:image" 
    content="https://lupyuen.github.io/images/wisgate-title.jpg">
<meta property="og:type" 
    content="article" data-rh="true">
<!-- End scripts/articles/*-header.html -->
<!-- Begin scripts/rustdoc-header.html: Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<link rel="alternate" type="application/rss+xml" title="RSS Feed for lupyuen" href="/rss.xml" />
<link rel="stylesheet" type="text/css" href="../normalize.css">
<link rel="stylesheet" type="text/css" href="../rustdoc.css" id="mainThemeStyle">
<link rel="stylesheet" type="text/css" href="../dark.css">
<link rel="stylesheet" type="text/css" href="../light.css" id="themeStyle">
<link rel="stylesheet" type="text/css" href="../prism.css">
<script src="../storage.js"></script><noscript>
<link rel="stylesheet" href="../noscript.css"></noscript>
<link rel="shortcut icon" href="../favicon.ico">
<style type="text/css">
    #crate-search {
        background-image: url("../down-arrow.svg");
    }
    a {
        color: #77d;
    }
</style>
<!-- End scripts/rustdoc-header.html -->


</head>
<body class="rustdoc">
    <!--[if lte IE 8]>
    <div class="warning">
        This old browser is unsupported and will most likely display funky
        things.
    </div>
    <![endif]-->

        <!-- Begin scripts/rustdoc-before.html: Pre-HTML for Custom Markdown files processed by rustdoc, like chip8.md -->

    <!-- Begin Theme Picker -->
    <div class="theme-picker" style="left: 0"><button id="theme-picker" aria-label="Pick another theme!"><img src="../brush.svg"
        width="18" alt="Pick another theme!"></button>
        <div id="theme-choices"></div>
    </div>
    <script src="../theme.js"></script>
    <script src="../prism.js"></script>
    <!-- Theme Picker -->

    <!-- End scripts/rustdoc-before.html -->
    

    <h1 class="title">Build a LoRaWAN Network with RAKwireless WisGate Developer Gateway</h1>
    <nav id="TOC"><ul>
<li><a href="#wisgate-d4h-hardware">1 WisGate D4H Hardware</a><ul></ul></li>
<li><a href="#chirpstack-lorawan-stack">2 ChirpStack LoRaWAN Stack</a><ul></ul></li>
<li><a href="#lorawan-application">3 LoRaWAN Application</a><ul></ul></li>
<li><a href="#lorawan-arduino-client">4 LoRaWAN Arduino Client</a><ul></ul></li>
<li><a href="#join-lorawan-network-from-arduino">5 Join LoRaWAN Network from Arduino</a><ul></ul></li>
<li><a href="#send-lorawan-packets-from-arduino">6 Send LoRaWAN Packets from Arduino</a><ul></ul></li>
<li><a href="#output-log">7 Output Log</a><ul></ul></li>
<li><a href="#view-received-lorawan-packets">8 View Received LoRaWAN Packets</a><ul></ul></li>
<li><a href="#troubleshoot-lorawan">9 Troubleshoot LoRaWAN</a><ul></ul></li>
<li><a href="#visualise-lorawan-with-software-defined-radio">10 Visualise LoRaWAN with Software Defined Radio</a><ul></ul></li>
<li><a href="#lorawan-join-request">11 LoRaWAN Join Request</a><ul></ul></li>
<li><a href="#lorawan-message-integrity-code">12 LoRaWAN Message Integrity Code</a><ul></ul></li>
<li><a href="#lorawan-nonce">13 LoRaWAN Nonce</a><ul></ul></li>
<li><a href="#log-transmitted-packets">14 Log Transmitted Packets</a><ul></ul></li>
<li><a href="#whats-next">15 What's Next</a><ul></ul></li>
<li><a href="#notes">16 Notes</a><ul></ul></li></ul></nav><p>üìù <em>3 May 2021</em></p>
<p>While testing a new LoRaWAN gadget (<a href="https://lupyuen.github.io/articles/lora2">PineCone BL602</a>), I bought a LoRaWAN Gateway from RAKwireless: <a href="https://docs.rakwireless.com/Product-Categories/WisGate/RAK7248/Datasheet/"><strong>RAK7248 WisGate Developer D4H Gateway</strong></a>.</p>
<p>Here's what I learnt about settting up a LoRaWAN Network with WisGate Developer D4H... And testing it with the RAKwireless WisBlock dev kit.</p>
<p><img src="https://lupyuen.github.io/images/wisgate-title.jpg" alt="RAKwireless RAK7248 WisGate Developer D4H LoRaWAN Gateway" /></p>
<p><em>RAKwireless RAK7248 WisGate Developer D4H LoRaWAN Gateway</em></p>
<h1 id="wisgate-d4h-hardware" class="section-header"><a href="#wisgate-d4h-hardware">1 WisGate D4H Hardware</a></h1>
<p>WisGate D4H is essentially a Raspberry Pi 4 + LoRa Network Concentrator in a sturdy IP30 box.</p>
<p>It exposes the same ports and connectors as a Raspberry Pi 4: Ethernet port, USB 2 and 3 ports, USB-C power, microSD Card.</p>
<p>But the HDMI and GPIO ports are no longer accessible. (We control the box over HTTP and SSH)</p>
<p><img src="https://lupyuen.github.io/images/wisgate-hw.jpg" alt="RAKwireless RAK7248 WisGate Developer D4H LoRaWAN Gateway" /></p>
<p>2 new connectors have been added...</p>
<ol>
<li>
<p><strong>LoRa Antenna</strong> (left)</p>
</li>
<li>
<p><strong>GPS Antenna</strong> (right)</p>
</li>
</ol>
<p>(The two connectors are slightly different, so we won't connect the wrong antenna)</p>
<p>The GPS Antenna will be used when we connect WisGate to The Things Network (the worldwide free-access LoRaWAN network).</p>
<p>WisGate D4H is shipped with the open-source ChirpStack LoRaWAN stack, preinstalled in the microSD card. </p>
<p>(Yep please don't peel off the sticky tape and insert your own microSD card)</p>
<p><img src="https://lupyuen.github.io/images/wisgate-hw2.jpg" alt="microSD Slot on WisGate D4H" /></p>
<p><em>microSD Slot on WisGate D4H</em></p>
<h1 id="chirpstack-lorawan-stack" class="section-header"><a href="#chirpstack-lorawan-stack">2 ChirpStack LoRaWAN Stack</a></h1>
<p>Connect the LoRa Antenna to GPS Antenna to WisGate before powering on. (To prevent damage to the RF modules)</p>
<p>Follow the instructions here to start the WisGate box and to connect to the preinstalled ChirpStack LoRaWAN stack...</p>
<ul>
<li><a href="https://docs.rakwireless.com/Product-Categories/WisGate/RAK7244C/Quickstart/"><strong>&quot;RAK7244C Quick Start Guide&quot;</strong></a></li>
</ul>
<p>(RAK7244C is quite similar to our RAK7248 gateway)</p>
<p>I connected an Ethernet cable to WisGate and used SSH to configure the WiFi and LAN settings (via <code>sudo gateway-config</code>).</p>
<p>Here's the ChirpStack web admin page that we will see...</p>
<p><img src="https://lupyuen.github.io/images/wisgate-chirpstack.png" alt="ChirpStack web admin on WisGate" /></p>
<p>(Nope I'm nowhere near Jervois Road)</p>
<p>In the left bar, click <strong><code>Gateways</code></strong> to see our pre-configured LoRaWAN Gateway...</p>
<p><img src="https://lupyuen.github.io/images/wisgate-chirpstack2.png" alt="ChirpStack web admin on WisGate" /></p>
<p>Click <strong><code>rak-gateway</code></strong> to see the Gateway Details...</p>
<p><img src="https://lupyuen.github.io/images/wisgate-chirpstack3.png" alt="ChirpStack web admin on WisGate" /></p>
<p>This shows that my WisGate gateway receives <strong>1,200 LoRaWAN Packets a day</strong> from unknown LoRaWAN Devices nearby.</p>
<p>WisGate won't do anything with the received LoRaWAN Packets since it's not configured to process packets with mysterious origins.</p>
<p>(But we may click <strong><code>Live LoRaWAN Frames</code></strong> at top right to see the encrypted contents of the received LoRaWAN Packets)</p>
<h1 id="lorawan-application" class="section-header"><a href="#lorawan-application">3 LoRaWAN Application</a></h1>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/wisblock-title.jpg" alt="RAKwireless RAK4630 WisBlock LPWAN Module mounted on WisBlock Base Board" /></p>
<p><em>RAKwireless RAK4630 WisBlock LPWAN Module mounted on WisBlock Base Board</em></p>
<h1 id="lorawan-arduino-client" class="section-header"><a href="#lorawan-arduino-client">4 LoRaWAN Arduino Client</a></h1>
<p>TODO</p>
<p>Source code...</p>
<p><a href="https://github.com/lupyuen/wisblock-lorawan"><code>github.com/lupyuen/wisblock-lorawan</code></a></p>
<p>Arduino LoRaWAN client for <a href="https://docs.rakwireless.com/Product-Categories/WisBlock/Quickstart/">RAKwireless WisBlock RAK4630</a>.</p>
<p>See...</p>
<p><a href="https://github.com/RAKWireless/WisBlock/tree/master/examples/RAK4630/communications/LoRa/LoRaWAN">LoRaWAN Examples for WisBlock RAK4630</a></p>
<p>Based on...</p>
<p><a href="https://github.com/RAKWireless/WisBlock/blob/master/examples/RAK4630/communications/LoRa/LoRaWAN/LoRaWAN_OTAA_ABP/LoRaWAN_OTAA_ABP.ino"><code>LoRaWAN_OTAA_ABP.ino</code></a></p>
<p>Note: This program needs SX126x-Arduino Library version 2.0.0 or later. </p>
<p>In <a href="https://github.com/lupyuen/wisblock-lorawan/blob/master/platformio.ini"><code>platformio.ini</code></a> set...</p>
<pre><code class="language-text">lib_deps = beegee-tokyo/SX126x-Arduino@^2.0.0
</code></pre>
<h1 id="join-lorawan-network-from-arduino" class="section-header"><a href="#join-lorawan-network-from-arduino">5 Join LoRaWAN Network from Arduino</a></h1>
<p>TODO</p>
<p><a href="https://youtu.be/xdyi6XCo8Z8"><strong>Watch the video on YouTube</strong></a></p>
<h1 id="send-lorawan-packets-from-arduino" class="section-header"><a href="#send-lorawan-packets-from-arduino">6 Send LoRaWAN Packets from Arduino</a></h1>
<p>TODO</p>
<h1 id="output-log" class="section-header"><a href="#output-log">7 Output Log</a></h1>
<p>TODO</p>
<p>From <a href="https://github.com/lupyuen/wisblock-lorawan/blob/master/README.md#output-log"><code>wisblock-lorawan</code></a></p>
<pre><code class="language-text">&gt; Executing task: platformio device monitor &lt;

--- Available filters and text transformations: colorize, debug, default, direct, hexlify, log2file, nocontrol, printable, send_on_enter, time
--- More details at http://bit.ly/pio-monitor-filters
--- Miniterm on /dev/cu.usbmodem14201  9600,8,N,1 ---
--- Quit: Ctrl+C | Menu: Ctrl+T | Help: Ctrl+T followed by Ctrl+H ---
=====================================
Welcome to RAK4630 LoRaWan!!!
Type: OTAA
Region: AS923
=====================================
&lt;LMH&gt; OTAA 
DevEui=4B-C1-5E-E7-37-7B-B1-5B
DevAdd=00000000
AppEui=00-00-00-00-00-00-00-00
AppKey=AA-FF-AD-5C-7E-87-F6-4D-E3-F0-87-32-FC-1D-D2-5D
SX126xSetTxParams: power=0, rampTime=4
SX126xSetPaConfig: paDutyCycle=4, hpMax=7, deviceSel=0, paLut=1 
SX126xSetTxParams: power=13, rampTime=2
SX126xSetPaConfig: paDutyCycle=4, hpMax=7, deviceSel=0, paLut=1 
&lt;LMH&gt; Selected subband 1
Joining LoRaWAN network...
SX126xSetTxParams: power=13, rampTime=2
SX126xSetPaConfig: paDutyCycle=4, hpMax=7, deviceSel=0, paLut=1 
RadioSend: size=23, channel=1, datarate=2, txpower=0, maxeirp=16, antennagain=2
00 00 00 00 00 00 00 00 00 5b b1 7b 37 e7 5e c1 4b 0d 42 dd b9 22 aa 
&lt;LM&gt; OnRadioTxDone
&lt;LM&gt; OnRadioTxDone =&gt; RX Windows #1 5002 #2 6002
&lt;LM&gt; OnRadioTxDone =&gt; TX was Join Request
&lt;LM&gt; OnRadioRxDone
&lt;LM&gt; OnRadioRxDone =&gt; FRAME_TYPE_JOIN_ACCEPT
OTAA Mode, Network Joined!
Sending frame now...
SX126xSetTxParams: power=13, rampTime=2
SX126xSetPaConfig: paDutyCycle=4, hpMax=7, deviceSel=0, paLut=1 
RadioSend: size=19, channel=0, datarate=2, txpower=0, maxeirp=16, antennagain=2
40 3c 59 7a 00 80 00 00 02 17 77 31 fd 99 86 8f 4f cc ef 
lmh_send ok count 1
&lt;LM&gt; OnRadioTxDone
&lt;LM&gt; OnRadioTxDone =&gt; RX Windows #1 1002 #2 2002
&lt;RADIO&gt; RadioIrqProcess =&gt; IRQ_RX_TX_TIMEOUT
&lt;LM&gt; OnRadioRxTimeout
Sending frame now...
SX126xSetTxParams: power=13, rampTime=2
SX126xSetPaConfig: paDutyCycle=4, hpMax=7, deviceSel=0, paLut=1 
RadioSend: size=19, channel=5, datarate=2, txpower=0, maxeirp=16, antennagain=2
40 3c 59 7a 00 80 01 00 02 0b 1f 7e 4d e1 94 c9 16 fa ea 
lmh_send ok count 2
&lt;LM&gt; OnRadioTxDone
&lt;LM&gt; OnRadioTxDone =&gt; RX Windows #1 1002 #2 2002
&lt;RADIO&gt; RadioIrqProcess =&gt; IRQ_RX_TX_TIMEOUT
&lt;LM&gt; OnRadioRxTimeout
Sending frame now...
SX126xSetTxParams: power=13, rampTime=2
SX126xSetPaConfig: paDutyCycle=4, hpMax=7, deviceSel=0, paLut=1 
RadioSend: size=19, channel=5, datarate=2, txpower=0, maxeirp=16, antennagain=2
40 3c 59 7a 00 80 02 00 02 96 be 8d c8 67 36 1b 89 81 3b 
lmh_send ok count 3
&lt;LM&gt; OnRadioTxDone
&lt;LM&gt; OnRadioTxDone =&gt; RX Windows #1 1002 #2 2002
&lt;RADIO&gt; RadioIrqProcess =&gt; IRQ_RX_TX_TIMEOUT
&lt;LM&gt; OnRadioRxTimeout
</code></pre>
<h1 id="view-received-lorawan-packets" class="section-header"><a href="#view-received-lorawan-packets">8 View Received LoRaWAN Packets</a></h1>
<p>TODO</p>
<h1 id="troubleshoot-lorawan" class="section-header"><a href="#troubleshoot-lorawan">9 Troubleshoot LoRaWAN</a></h1>
<p>TODO</p>
<h1 id="visualise-lorawan-with-software-defined-radio" class="section-header"><a href="#visualise-lorawan-with-software-defined-radio">10 Visualise LoRaWAN with Software Defined Radio</a></h1>
<p>TODO</p>
<p><a href="https://youtu.be/xdyi6XCo8Z8"><strong>Watch the video on YouTube</strong></a></p>
<h1 id="lorawan-join-request" class="section-header"><a href="#lorawan-join-request">11 LoRaWAN Join Request</a></h1>
<p>TODO</p>
<h1 id="lorawan-message-integrity-code" class="section-header"><a href="#lorawan-message-integrity-code">12 LoRaWAN Message Integrity Code</a></h1>
<p>TODO</p>
<p>To search for Message Integrity Code errors in LoRaWAN Packets received by WisGate, SSH to WisGate and search for...</p>
<pre><code class="language-bash"># grep MIC /var/log/syslog

Apr 28 04:02:05 rak-gateway 
chirpstack-application-server[568]: 
time=&quot;2021-04-28T04:02:05+01:00&quot; 
level=error 
msg=&quot;invalid MIC&quot; 
dev_eui=4bc15ee7377bb15b 
type=DATA_UP_MIC

Apr 28 04:02:05 rak-gateway 
chirpstack-network-server[1378]: 
time=&quot;2021-04-28T04:02:05+01:00&quot; 
level=error 
msg=&quot;uplink: processing uplink frame error&quot;
ctx_id=0ccd1478-3b79-4ded-9e26-a28e4c143edc 
error=&quot;get device-session error: invalid MIC&quot;
</code></pre>
<h1 id="lorawan-nonce" class="section-header"><a href="#lorawan-nonce">13 LoRaWAN Nonce</a></h1>
<p>TODO</p>
<p>The error above occurs when we replay a repeated Join Network Request to our LoRaWAN Gateway (with same Nonce, same Message Integrity Code).</p>
<p>This replay also logs a Nonce Error in WisGate...</p>
<pre><code class="language-bash"># grep nonce /var/log/syslog

Apr 28 04:02:41 rak-gateway chirpstack-application-server[568]:
time=&quot;2021-04-28T04:02:41+01:00&quot; 
level=error 
msg=&quot;validate dev-nonce error&quot; 
dev_eui=4bc15ee7377bb15b 
type=OTAA

Apr 28 04:02:41 rak-gateway chirpstack-network-server[1378]:
time=&quot;2021-04-28T04:02:41+01:00&quot; 
level=error 
msg=&quot;uplink: processing uplink frame error&quot; ctx_id=01ae296e-8ce1-449a-83cc-fb0771059d89 
error=&quot;validate dev-nonce error: object already exists&quot;
</code></pre>
<p>Because the Nonce should not be reused.</p>
<p><a href="https://lora-alliance.org/resource_hub/lorawan-is-secure-but-implementation-matters/">&quot;LoRaWAN¬Æ Is Secure (but Implementation Matters)&quot;</a></p>
<h1 id="log-transmitted-packets" class="section-header"><a href="#log-transmitted-packets">14 Log Transmitted Packets</a></h1>
<p>To log transmitted packets, modify</p>
<p><code>.pio/libdeps/wiscore_rak4631/SX126x-Arduino/src/mac/LoRaMac.cpp</code></p>
<pre><code class="language-c">LoRaMacStatus_t SendFrameOnChannel(uint8_t channel)
{
    TxConfigParams_t txConfig;
    int8_t txPower = 0;

    txConfig.Channel = channel;
    txConfig.Datarate = LoRaMacParams.ChannelsDatarate;
    txConfig.TxPower = LoRaMacParams.ChannelsTxPower;
    txConfig.MaxEirp = LoRaMacParams.MaxEirp;
    txConfig.AntennaGain = LoRaMacParams.AntennaGain;
    txConfig.PktLen = LoRaMacBufferPktLen;

    // If we are connecting to a single channel gateway we use always the same predefined channel and datarate
    if (singleChannelGateway)
    {
        txConfig.Channel = singleChannelSelected;
        txConfig.Datarate = singleChannelDatarate;
    }

    RegionTxConfig(LoRaMacRegion, &amp;txConfig, &amp;txPower, &amp;TxTimeOnAir);

    MlmeConfirm.Status = LORAMAC_EVENT_INFO_STATUS_ERROR;
    McpsConfirm.Status = LORAMAC_EVENT_INFO_STATUS_ERROR;
    McpsConfirm.Datarate = LoRaMacParams.ChannelsDatarate;
    McpsConfirm.TxPower = txPower;

    // Store the time on air
    McpsConfirm.TxTimeOnAir = TxTimeOnAir;
    MlmeConfirm.TxTimeOnAir = TxTimeOnAir;

    // Starts the MAC layer status check timer
    TimerSetValue(&amp;MacStateCheckTimer, MAC_STATE_CHECK_TIMEOUT);
    TimerStart(&amp;MacStateCheckTimer);

    if (IsLoRaMacNetworkJoined != JOIN_OK)
    {
        JoinRequestTrials++;
    }

    //////////////// INSERT THIS CODE

    // To replay a Join Network Request...
    // if (LoRaMacBuffer[0] == 0) {
    // 	static uint8_t replay[] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x5b, 0xb1, 0x7b, 0x37, 0xe7, 0x5e, 0xc1, 0x4b, 0x67, 0xaa, 0xbb, 0x07, 0x70, 0x7d};
    // 	memcpy(LoRaMacBuffer, replay, LoRaMacBufferPktLen);
    // }

    // To dump transmitted packets...
    printf(&quot;RadioSend: size=%d, channel=%d, datarate=%d, txpower=%d, maxeirp=%d, antennagain=%d\r\n&quot;, (int) LoRaMacBufferPktLen, (int) txConfig.Channel, (int) txConfig.Datarate, (int) txConfig.TxPower, (int) txConfig.MaxEirp, (int) txConfig.AntennaGain);
    for (int i = 0; i &lt; LoRaMacBufferPktLen; i++) {
        printf(&quot;%02x &quot;, LoRaMacBuffer[i]);
    }
    printf(&quot;\r\n&quot;);
    
    //////////////// END OF INSERTION

    // Send now
    Radio.Send(LoRaMacBuffer, LoRaMacBufferPktLen);

    LoRaMacState |= LORAMAC_TX_RUNNING;

    return LORAMAC_STATUS_OK;
}
</code></pre>
<h1 id="whats-next" class="section-header"><a href="#whats-next">15 What's Next</a></h1>
<p>TODO</p>
<ul>
<li>
<p><a href="https://github.com/sponsors/lupyuen">Sponsor me a coffee</a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/book">Read &quot;The RISC-V BL602 Book&quot;</a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io">Check out my articles</a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/rss.xml">RSS Feed</a></p>
</li>
</ul>
<p><em>Got a question, comment or suggestion? Create an Issue or submit a Pull Request here...</em></p>
<p><a href="https://github.com/lupyuen/lupyuen.github.io/blob/master/src/wisgate.md"><code>lupyuen.github.io/src/wisgate.md</code></a></p>
<h1 id="notes" class="section-header"><a href="#notes">16 Notes</a></h1>
<ol>
<li>This article is the expanded version of <a href="https://twitter.com/MisterTechBlog/status/1379926160377851910">this Twitter Thread</a></li>
</ol>

    
</body>
</html>