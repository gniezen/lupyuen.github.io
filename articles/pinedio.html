<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="rustdoc">
    <title>PineDio Stack BL604 RISC-V Board: Testing The Prototype</title>

    
    <!-- Begin scripts/articles/*-header.html: Article Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<meta property="og:title" 
    content="PineDio Stack BL604 RISC-V Board: Testing The Prototype" 
    data-rh="true">
<meta property="og:description" 
    content="What's it like to create Open Source Software for brand new prototype hardware? Read on to find out!"
    data-rh="true">
<meta property="og:image" 
    content="https://lupyuen.github.io/images/pinedio-title.jpg">
<meta property="og:type" 
    content="article" data-rh="true">
<!-- End scripts/articles/*-header.html -->
<!-- Begin scripts/rustdoc-header.html: Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<link rel="alternate" type="application/rss+xml" title="RSS Feed for lupyuen" href="/rss.xml" />
<link rel="stylesheet" type="text/css" href="../normalize.css">
<link rel="stylesheet" type="text/css" href="../rustdoc.css" id="mainThemeStyle">
<link rel="stylesheet" type="text/css" href="../dark.css">
<link rel="stylesheet" type="text/css" href="../light.css" id="themeStyle">
<link rel="stylesheet" type="text/css" href="../prism.css">
<script src="../storage.js"></script><noscript>
<link rel="stylesheet" href="../noscript.css"></noscript>
<link rel="shortcut icon" href="../favicon.ico">
<style type="text/css">
    #crate-search {
        background-image: url("../down-arrow.svg");
    }
    a {
        color: #77d;
    }
</style>
<!-- End scripts/rustdoc-header.html -->


</head>
<body class="rustdoc">
    <!--[if lte IE 8]>
    <div class="warning">
        This old browser is unsupported and will most likely display funky
        things.
    </div>
    <![endif]-->

        <!-- Begin scripts/rustdoc-before.html: Pre-HTML for Custom Markdown files processed by rustdoc, like chip8.md -->

    <!-- Begin Theme Picker -->
    <div class="theme-picker" style="left: 0"><button id="theme-picker" aria-label="Pick another theme!"><img src="../brush.svg"
        width="18" alt="Pick another theme!"></button>
        <div id="theme-choices"></div>
    </div>
    <script src="../theme.js"></script>
    <script src="../prism.js"></script>
    <!-- Theme Picker -->

    <!-- End scripts/rustdoc-before.html -->
    

    <h1 class="title">PineDio Stack BL604 RISC-V Board: Testing The Prototype</h1>
    <nav id="TOC"><ul>
<li><a href="#connect-the-display">1 Connect The Display</a><ul></ul></li>
<li><a href="#bl604-blinky">2 BL604 Blinky</a><ul></ul></li>
<li><a href="#flashing-firmware-to-bl604">3 Flashing Firmware To BL604</a><ul></ul></li>
<li><a href="#bl604-spi">4 BL604 SPI</a><ul></ul></li>
<li><a href="#logic-analyser">5 Logic Analyser</a><ul></ul></li>
<li><a href="#st7789-display">6 ST7789 Display</a><ul></ul></li>
<li><a href="#9-bit-spi">7 9-Bit SPI?</a><ul></ul></li>
<li><a href="#arduino-gfx-ported-to-bl604">8 Arduino GFX Ported To BL604</a><ul></ul></li>
<li><a href="#whats-next">9 What‚Äôs Next</a><ul></ul></li>
<li><a href="#notes">10 Notes</a><ul></ul></li></ul></nav><p>üìù <em>3 Sep 2021</em></p>
<p><em>What‚Äôs it like to create <strong>Open Source Software</strong> (and firmware) for brand new <strong>Prototype Hardware</strong>?</em></p>
<p><em>What interesting challenges will we encounter?</em></p>
<p>Find out how we create new firmware to test (and improve) Pine64‚Äôs newest and hottest prototype: <strong>PineDio Stack BL604 RISC-V Board!</strong></p>
<blockquote>
<p>‚ö†Ô∏è <em><strong>Obligatory Disclaimer:</strong> Features included in The Prototype are not complete, and will most certainly undergo changes before becoming available for public consumption. (Burp) They are described here for testing, exploration, education and entertainment purposes only. The Prototype shall NOT be used in production gadgets. (Like toasters, microwave ovens, and most definitely not, pressure cookers)</em></p>
</blockquote>
<p>The kind (and super cool) folks at Pine64 told me that I would be receiving a fun new gadget that‚Äôs‚Ä¶</p>
<ol>
<li>
<p>Based on <a href="https://github.com/bouffalolab/bl_docs/tree/main/BL602_DS/en"><strong>BL604 RISC-V + WiFi + Bluetooth LE SoC</strong></a>, which is the upsized sibling of <a href="https://lupyuen.github.io/articles/pinecone"><strong>Bouffalo Lab‚Äôs BL602 SoC</strong></a>.</p>
<p>(BL604 has 32 GPIOs vs BL602‚Äôs 16 GPIOs. So it‚Äôs like comparing millipedes and centipedes, I guess)</p>
</li>
<li>
<p>And BL604 is supposed to be <strong>100% compatible with BL602</strong></p>
<p>(Is it really 100% compatible? We‚Äôll find out in a while!)</p>
</li>
<li>
<p>Has an <strong>ST7789 SPI Display</strong></p>
<p>(Imagine the possibilities)</p>
</li>
<li>
<p>Has an onboard <strong>LoRa SX1262 Transceiver</strong> for low-power, long-range, low-bandwidth networking</p>
<p>(Wow!)</p>
</li>
<li>
<p>Plus <strong>SPI Flash, Battery Charging Chip, Motion Sensor</strong> (optional) and <strong>Heart Rate Sensor</strong> (optional)!</p>
</li>
</ol>
<p>After some shipping delays at Shenzhen (due to flooding or pandemic?) I received something totally unexpected‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/pinedio-solar.jpg" alt="Solar Panel?" /></p>
<p><strong>A Solar Panel!</strong></p>
<p>(Yeah Singapore is super sunny‚Ä¶ Is this mockery? ü§î)</p>
<p>But a Solar Panel with a <strong>JTAG Cable</strong>? That‚Äôs highly unusual. </p>
<p>Opening the gadget reveals the hidden treasure inside: <strong>PineDio Stack BL604 Board!</strong></p>
<p><img src="https://lupyuen.github.io/images/pinedio-inside.jpg" alt="Inside the Solar Panel: PineDio Stack BL604 Board" /></p>
<p>That‚Äôs typical of <strong>Prototype Hardware</strong> fresh from the factory: No docs, no fancy packaging, no branding either.</p>
<p>(Ground Plane is also missing, which we‚Äôll fix before FCC Certification)</p>
<p>We shall explore PineDio Stack ourselves‚Ä¶ And <strong>document all our findings</strong> for the sake of the Open Source Community!</p>
<p><img src="https://lupyuen.github.io/images/pinedio-title.jpg" alt="PineDio Stack BL604 Board" /></p>
<h1 id="connect-the-display" class="section-header"><a href="#connect-the-display">1 Connect The Display</a></h1>
<p><em>What‚Äôs on the underside of PineDio Stack?</em></p>
<p>Unscrewing the board (from the glue sticks?) reveals the <strong>LCD Display Connector</strong> on the underside of the board‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/pinedio-back.jpg" alt="PineDio Stack Underside" /></p>
<p>The connector matches this familiar <strong>ST7789 SPI Display</strong> that was shipped with PineDio Stack‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/pinedio-display3.jpg" alt="ST7789 SPI Display" /></p>
<p>So we snapped the ST7789 Display to the board‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/pinedio-display4.jpg" alt="ST7789 Display connected to PineDio Stack" /></p>
<p>And we get an unusual contraption: A <strong>Solar Panel with LCD Display inside</strong>!</p>
<p><img src="https://lupyuen.github.io/images/pinedio-display5.jpg" alt="Solar Panel with an LCD Display inside" /></p>
<p>We‚Äôre ready to test our firmware on PineDio Stack!</p>
<h1 id="bl604-blinky" class="section-header"><a href="#bl604-blinky">2 BL604 Blinky</a></h1>
<p><em>What‚Äôs the first thing that we run on a brand new prototype board?</em></p>
<p><strong>Blinky Firmware</strong> of course! (Yep the firmware that blinks the LED)</p>
<pre><code class="language-c">/// PineDio Stack LCD Backlight is connected on GPIO 21
#define LED_GPIO 21

/// Blink the LED
void blinky(char *buf, int len, int argc, char **argv) {
  //  Show a message on the serial console
  puts(&quot;Hello from Blinky!&quot;);

  //  Configure the LED GPIO for output (instead of input)
  int rc = bl_gpio_enable_output(
    LED_GPIO,  //  GPIO pin number
    0,         //  No GPIO pullup
    0          //  No GPIO pulldown
  );
  assert(rc == 0);  //  Halt on error

  //  Blink the LED 5 times
  for (int i = 0; i &lt; 10; i++) {

    //  Toggle the LED GPIO between 0 (on) and 1 (off)
    rc = bl_gpio_output_set(  //  Set the GPIO output (from BL602 GPIO HAL)
      LED_GPIO,               //  GPIO pin number
      i % 2                   //  0 for low, 1 for high
    );
    assert(rc == 0);  //  Halt on error

    //  Sleep 1 second
    time_delay(                 //  Sleep by number of ticks (from NimBLE Porting Layer)
      time_ms_to_ticks32(1000)  //  Convert 1,000 milliseconds to ticks (from NimBLE Porting Layer)
    );
  }
  //  Return to the command-line interface
}
</code></pre>
<p><a href="https://github.com/lupyuen/bl_iot_sdk/blob/3wire/customer_app/pinedio_blinky/pinedio_blinky/demo.c">(Source)</a></p>
<p>This BL604 Blinky code is <strong>100% identical</strong> to the <a href="https://github.com/lupyuen/bl_iot_sdk/blob/master/customer_app/sdk_app_blinky/sdk_app_blinky/demo.c">BL602 version of Blinky</a>. Except for the GPIO Pin Number‚Ä¶</p>
<pre><code class="language-c">/// PineDio Stack LCD Backlight is connected on GPIO 21
#define LED_GPIO 21
</code></pre>
<p>(We‚Äôre blinking the Backlight of the ST7789 Display)</p>
<p>We <strong>build the BL604 Blinky Firmware</strong> the exact same way as BL602‚Ä¶</p>
<pre><code class="language-bash">#  Download the 3wire branch of lupyuen's bl_iot_sdk
git clone --recursive --branch 3wire https://github.com/lupyuen/bl_iot_sdk
cd customer_app/pinedio_blinky

#  Build for BL602 (Should this be BL604?)
export CONFIG_CHIP_NAME=BL602

#  Where BL602 / BL604 IoT SDK is located
export BL60X_SDK_PATH=$PWD/../..

#  Build the firmware: build_out/pinedio_blinky.bin
make
</code></pre>
<p><a href="https://github.com/lupyuen/bl_iot_sdk/blob/3wire/customer_app/pinedio_blinky/run.sh">(Source)</a></p>
<p>Let‚Äôs flash the firmware to the board!</p>
<h1 id="flashing-firmware-to-bl604" class="section-header"><a href="#flashing-firmware-to-bl604">3 Flashing Firmware To BL604</a></h1>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/pinedio-zoom.jpg" alt="" /></p>
<p>Remove the battery</p>
<p>Missing jumper, No reset button</p>
<ul>
<li><a href="https://youtu.be/vdRqhQ08uxU"><strong>Watch the Demo Video on YouTube</strong></a></li>
</ul>
<p>Display is OK</p>
<h1 id="bl604-spi" class="section-header"><a href="#bl604-spi">4 BL604 SPI</a></h1>
<p>TODO</p>
<p>Backward compatible, Spi quirks</p>
<h1 id="logic-analyser" class="section-header"><a href="#logic-analyser">5 Logic Analyser</a></h1>
<p><em>Always have a Logic Analyser ready when testing Prototype Hardware!</em></p>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/pinedio-gpio.jpg" alt="" /></p>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/pinedio-logic.jpg" alt="" /></p>
<p>TODO11</p>
<p><img src="https://lupyuen.github.io/images/pinedio-logic2.jpg" alt="" /></p>
<h1 id="st7789-display" class="section-header"><a href="#st7789-display">6 ST7789 Display</a></h1>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/pinedio-display2.jpg" alt="" /></p>
<h1 id="9-bit-spi" class="section-header"><a href="#9-bit-spi">7 9-Bit SPI?</a></h1>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/st7789-4wire.jpg" alt="" /></p>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/st7789-3wire.jpg" alt="" /></p>
<h1 id="arduino-gfx-ported-to-bl604" class="section-header"><a href="#arduino-gfx-ported-to-bl604">8 Arduino GFX Ported To BL604</a></h1>
<p>TODO</p>
<p>Let‚Äôs port @moononournation‚Äôs awesome 9-bit-banging GFX Library to #BL604 ‚Ä¶ And compare the SPI Output with a Logic Analyser</p>
<ul>
<li><a href="https://github.com/moononournation/Arduino_GFX"><strong><code>moononournation / Arduino_GFX</code></strong></a></li>
</ul>
<p>Bl602 book, Created from scratch with few official docs, But lots of experimentation and reading the SDK code</p>
<h1 id="whats-next" class="section-header"><a href="#whats-next">9 What‚Äôs Next</a></h1>
<p>TODO</p>
<p>Volunteers Needed!</p>
<p>And soon we shall test all this on <a href="https://www.pine64.org/2021/08/15/introducing-the-pinenote/"><strong>PineDio Stack BL604 with LoRa SX1262</strong></a>‚Ä¶ As we explore whether it‚Äôs feasible to teach Embedded Programming for BL602 and BL604.</p>
<p>Many Thanks to my <a href="https://github.com/sponsors/lupyuen"><strong>GitHub Sponsors</strong></a> for supporting my work! This article wouldn‚Äôt have been possible without your support.</p>
<ul>
<li>
<p><a href="https://github.com/sponsors/lupyuen">Sponsor me a coffee</a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/book">Read ‚ÄúThe RISC-V BL602 Book‚Äù</a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io">Check out my articles</a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/rss.xml">RSS Feed</a></p>
</li>
</ul>
<p><em>Got a question, comment or suggestion? Create an Issue or submit a Pull Request here‚Ä¶</em></p>
<p><a href="https://github.com/lupyuen/lupyuen.github.io/blob/master/src/pinedio.md"><code>lupyuen.github.io/src/pinedio.md</code></a></p>
<h1 id="notes" class="section-header"><a href="#notes">10 Notes</a></h1>
<ol>
<li>This article is the expanded version of <a href="https://twitter.com/MisterTechBlog/status/1429273222780887041">this Twitter Thread</a></li>
</ol>
<p><img src="https://lupyuen.github.io/images/pinedio-box.jpg" alt="" /></p>

    
</body>
</html>