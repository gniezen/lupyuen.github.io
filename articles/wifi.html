<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="rustdoc">
    <title>Reverse Engineering WiFi on RISC-V BL602</title>

    
    <!-- Begin scripts/articles/*-header.html: Article Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<meta property="og:title" 
    content="Reverse Engineering WiFi on RISC-V BL602" 
    data-rh="true">
<meta property="og:description" 
    content="What happens inside the WiFi Driver on RISC-V BL602... And how we found the incomplete source code for the driver"
    data-rh="true">
<meta property="og:image" 
    content="https://lupyuen.github.io/images/wifi-title.jpg">
<meta property="og:type" 
    content="article" data-rh="true">
<!-- End scripts/articles/*-header.html -->
<!-- Begin scripts/rustdoc-header.html: Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<link rel="alternate" type="application/rss+xml" title="RSS Feed for lupyuen" href="/rss.xml" />
<link rel="stylesheet" type="text/css" href="../normalize.css">
<link rel="stylesheet" type="text/css" href="../rustdoc.css" id="mainThemeStyle">
<link rel="stylesheet" type="text/css" href="../dark.css">
<link rel="stylesheet" type="text/css" href="../light.css" id="themeStyle">
<link rel="stylesheet" type="text/css" href="../prism.css">
<script src="../storage.js"></script><noscript>
<link rel="stylesheet" href="../noscript.css"></noscript>
<link rel="shortcut icon" href="../favicon.ico">
<style type="text/css">
    #crate-search {
        background-image: url("../down-arrow.svg");
    }
    a {
        color: #77d;
    }
</style>
<!-- End scripts/rustdoc-header.html -->


</head>
<body class="rustdoc">
    <!--[if lte IE 8]>
    <div class="warning">
        This old browser is unsupported and will most likely display funky
        things.
    </div>
    <![endif]-->

        <!-- Begin scripts/rustdoc-before.html: Pre-HTML for Custom Markdown files processed by rustdoc, like chip8.md -->

    <!-- Begin Theme Picker -->
    <div class="theme-picker" style="left: 0"><button id="theme-picker" aria-label="Pick another theme!"><img src="../brush.svg"
        width="18" alt="Pick another theme!"></button>
        <div id="theme-choices"></div>
    </div>
    <script src="../theme.js"></script>
    <script src="../prism.js"></script>
    <!-- Theme Picker -->

    <!-- End scripts/rustdoc-before.html -->
    

    <h1 class="title">Reverse Engineering WiFi on RISC-V BL602</h1>
    <nav id="TOC"><ul>
<li><a href="#bl602-wifi-demo-firmware">1 BL602 WiFi Demo Firmware</a><ul></ul></li>
<li><a href="#connect-to-wifi-access-point">2 Connect to WiFi Access Point</a><ul></ul></li>
<li><a href="#wifi-background-task">3 WiFi Background Task</a><ul></ul></li>
<li><a href="#decompiled-wifi-demo-firmware">4 Decompiled WiFi Demo Firmware</a><ul></ul></li>
<li><a href="#ceva-rivierawaves">5 CEVA RivieraWaves</a><ul></ul></li>
<li><a href="#upper-medium-access-control-layer">6 Upper Medium Access Control Layer</a><ul></ul></li>
<li><a href="#lower-medium-access-control-layer">7 Lower Medium Access Control Layer</a><ul></ul></li>
<li><a href="#wifi-phy-layer">8 WiFi PHY Layer</a><ul></ul></li>
<li><a href="#wifi-supplicant">9 WiFi Supplicant</a><ul></ul></li>
<li><a href="#quantitative-analysis">10 Quantitative Analysis</a><ul></ul></li>
<li><a href="#other-components">11 Other Components</a><ul></ul></li>
<li><a href="#github-search-is-our-best-friend">12 GitHub Search Is Our Best Friend!</a><ul></ul></li>
<li><a href="#whats-next">13 What‚Äôs Next</a><ul></ul></li>
<li><a href="#notes">14 Notes</a><ul></ul></li></ul></nav><p>üìù <em>9 Jul 2021</em></p>
<p><em>What happens inside the WiFi Driver on RISC-V BL602 SoC‚Ä¶ And how we found the (incomplete) source code for the driver</em></p>
<p>Why reverse engineer the WiFi Driver?</p>
<p>TODO: Education, replacement, auditing, troubleshooting. <a href="https://twitter.com/Yu_Wei_Wu/status/1406940637773979655?s=19">See this non-BL602 example</a></p>
<p><img src="https://lupyuen.github.io/images/wifi-title.jpg" alt="Quantitative Analysis of Decompiled BL602 WiFi Firmware" /></p>
<h1 id="bl602-wifi-demo-firmware" class="section-header"><a href="#bl602-wifi-demo-firmware">1 BL602 WiFi Demo Firmware</a></h1>
<p>We start with the source code of the <strong>BL602 WiFi Demo Firmware</strong> from the BL602 IoT SDK: <a href="https://github.com/lupyuen/bl_iot_sdk/blob/master/customer_app/bl602_demo_wifi"><strong><code>bl602_demo_wifi</code></strong></a></p>
<p>TODO</p>
<p>From <a href="https://github.com/lupyuen/bl_iot_sdk/blob/master/customer_app/bl602_demo_wifi/bl602_demo_wifi/main.c#L819-L866"><code>main.c</code></a></p>
<pre><code class="language-c">//  Called at startup to init drivers and run event loop
static void aos_loop_proc(void *pvParameters) {
  ...
  //  Register Callback Function for WiFi Events
  aos_register_event_filter(
    EV_WIFI,              //  Event Type
    event_cb_wifi_event,  //  Event Callback Function
    NULL);                //  Event Callback Argument

  //  Start WiFi Networking Stack
  cmd_stack_wifi(NULL, 0, 0, NULL);

  //  Run event loop
  aos_loop_run();
}
</code></pre>
<p>TODO</p>
<p>From <a href="https://github.com/lupyuen/bl_iot_sdk/blob/master/customer_app/bl602_demo_wifi/bl602_demo_wifi/main.c#L729-L747"><code>main.c</code></a></p>
<pre><code class="language-c">//  Start WiFi Networking Stack
static void cmd_stack_wifi(char *buf, int len, int argc, char **argv) {
  static uint8_t stack_wifi_init  = 0;
  if (1 == stack_wifi_init) { return; }  //  Already started
  stack_wifi_init = 1;

  //  Start Wi-Fi Firmware Task
  hal_wifi_start_firmware_task();

  //  Post an event to start Wi-Fi Networking
  aos_post_event(
    EV_WIFI,                 //  Event Type
    CODE_WIFI_ON_INIT_DONE,  //  Event Code
    0);                      //  Event Argument
}
</code></pre>
<p>TODO</p>
<p>From <a href="https://github.com/lupyuen/bl_iot_sdk/blob/master/customer_app/bl602_demo_wifi/bl602_demo_wifi/main.c#L374-L512"><code>main.c</code></a></p>
<pre><code class="language-c">//  Callback Function for WiFi Events
static void event_cb_wifi_event(input_event_t *event, void *private_data) {
    static char *ssid;
    static char *password;

    switch (event-&gt;code) {
        case CODE_WIFI_ON_INIT_DONE:
        {
            printf(&quot;[APP] [EVT] INIT DONE %lld\r\n&quot;, aos_now_ms());
            wifi_mgmr_start_background(&amp;conf);
        }
        break;
        case CODE_WIFI_ON_MGMR_DONE:
        {
            printf(&quot;[APP] [EVT] MGMR DONE %lld, now %lums\r\n&quot;, aos_now_ms(), bl_timer_now_us()/1000);
            _connect_wifi();
        }
        break;
        case CODE_WIFI_ON_MGMR_DENOISE:
        {
            printf(&quot;[APP] [EVT] Microwave Denoise is ON %lld\r\n&quot;, aos_now_ms());
        }
        break;
        case CODE_WIFI_ON_SCAN_DONE:
        {
            printf(&quot;[APP] [EVT] SCAN Done %lld\r\n&quot;, aos_now_ms());
            wifi_mgmr_cli_scanlist();
        }
        break;
        case CODE_WIFI_ON_SCAN_DONE_ONJOIN:
        {
            printf(&quot;[APP] [EVT] SCAN On Join %lld\r\n&quot;, aos_now_ms());
        }
        break;
        case CODE_WIFI_ON_DISCONNECT:
        {
            printf(&quot;[APP] [EVT] disconnect %lld, Reason: %s\r\n&quot;,
                aos_now_ms(),
                wifi_mgmr_status_code_str(event-&gt;value)
            );
        }
        break;
        case CODE_WIFI_ON_CONNECTING:
        {
            printf(&quot;[APP] [EVT] Connecting %lld\r\n&quot;, aos_now_ms());
        }
        break;
        case CODE_WIFI_CMD_RECONNECT:
        {
            printf(&quot;[APP] [EVT] Reconnect %lld\r\n&quot;, aos_now_ms());
        }
        break;
        case CODE_WIFI_ON_CONNECTED:
        {
            printf(&quot;[APP] [EVT] connected %lld\r\n&quot;, aos_now_ms());
        }
        break;
        case CODE_WIFI_ON_PRE_GOT_IP:
        {
            printf(&quot;[APP] [EVT] connected %lld\r\n&quot;, aos_now_ms());
        }
        break;
        case CODE_WIFI_ON_GOT_IP:
        {
            printf(&quot;[APP] [EVT] GOT IP %lld\r\n&quot;, aos_now_ms());
            printf(&quot;[SYS] Memory left is %d Bytes\r\n&quot;, xPortGetFreeHeapSize());
        }
        break;
        case CODE_WIFI_ON_EMERGENCY_MAC:
        {
            printf(&quot;[APP] [EVT] EMERGENCY MAC %lld\r\n&quot;, aos_now_ms());
            hal_reboot();//one way of handling emergency is reboot. Maybe we should also consider solutions
        }
        break;
        case CODE_WIFI_ON_PROV_SSID:
        {
            printf(&quot;[APP] [EVT] [PROV] [SSID] %lld: %s\r\n&quot;,
                    aos_now_ms(),
                    event-&gt;value ? (const char*)event-&gt;value : &quot;UNKNOWN&quot;
            );
            if (ssid) {
                vPortFree(ssid);
                ssid = NULL;
            }
            ssid = (char*)event-&gt;value;
        }
        break;
        case CODE_WIFI_ON_PROV_BSSID:
        {
            printf(&quot;[APP] [EVT] [PROV] [BSSID] %lld: %s\r\n&quot;,
                    aos_now_ms(),
                    event-&gt;value ? (const char*)event-&gt;value : &quot;UNKNOWN&quot;
            );
            if (event-&gt;value) {
                vPortFree((void*)event-&gt;value);
            }
        }
        break;
        case CODE_WIFI_ON_PROV_PASSWD:
        {
            printf(&quot;[APP] [EVT] [PROV] [PASSWD] %lld: %s\r\n&quot;, aos_now_ms(),
                    event-&gt;value ? (const char*)event-&gt;value : &quot;UNKNOWN&quot;
            );
            if (password) {
                vPortFree(password);
                password = NULL;
            }
            password = (char*)event-&gt;value;
        }
        break;
        case CODE_WIFI_ON_PROV_CONNECT:
        {
            printf(&quot;[APP] [EVT] [PROV] [CONNECT] %lld\r\n&quot;, aos_now_ms());
            printf(&quot;connecting to %s:%s...\r\n&quot;, ssid, password);
            wifi_sta_connect(ssid, password);
        }
        break;
        case CODE_WIFI_ON_PROV_DISCONNECT:
        {
            printf(&quot;[APP] [EVT] [PROV] [DISCONNECT] %lld\r\n&quot;, aos_now_ms());
        }
        break;
        case CODE_WIFI_ON_AP_STA_ADD:
        {
            printf(&quot;[APP] [EVT] [AP] [ADD] %lld, sta idx is %lu\r\n&quot;, aos_now_ms(), (uint32_t)event-&gt;value);
        }
        break;
        case CODE_WIFI_ON_AP_STA_DEL:
        {
            printf(&quot;[APP] [EVT] [AP] [DEL] %lld, sta idx is %lu\r\n&quot;, aos_now_ms(), (uint32_t)event-&gt;value);
        }
        break;
        default:
        {
            printf(&quot;[APP] [EVT] Unknown code %u, %lld\r\n&quot;, event-&gt;code, aos_now_ms());
            /*nothing*/
        }
    }
}
</code></pre>
<p>TODO</p>
<pre><code class="language-text"># wifi_sta_connect YOUR_WIFI_SSID YOUR_WIFI_PASSWORD
</code></pre>
<p>TODO</p>
<p>From <a href="https://github.com/lupyuen/bl_iot_sdk/blob/master/customer_app/bl602_demo_wifi/bl602_demo_wifi/main.c#L366-L372"><code>main.c</code></a></p>
<pre><code class="language-c">//  Connect to WiFi Access Point
static void wifi_sta_connect(char *ssid, char *password) {

  //  Enable WiFi Client
  wifi_interface_t wifi_interface
    = wifi_mgmr_sta_enable();

  //  Connect to WiFi Access Point
  wifi_mgmr_sta_connect(
    wifi_interface,  //  WiFi Interface
    ssid,            //  SSID
    password,        //  Password
    NULL,            //  PMK
    NULL,            //  MAC Address
    0,               //  Band
    0);              //  Frequency
}
</code></pre>
<p>TODO</p>
<p>From <a href="https://github.com/lupyuen/bl_iot_sdk/blob/master/customer_app/bl602_demo_wifi/bl602_demo_wifi/main.c#L704-L727"><code>main.c</code></a></p>
<pre><code class="language-c">//  Send a HTTP GET Request with LWIP
static void cmd_httpc_test(char *buf, int len, int argc, char **argv) {
  static httpc_connection_t settings;
  static httpc_state_t *req;
  if (req) { return; }  //  Request already running

  //  Init the LWIP HTTP Settings
  memset(&amp;settings, 0, sizeof(settings));
  settings.use_proxy = 0;
  settings.result_fn = cb_httpc_result;
  settings.headers_done_fn = cb_httpc_headers_done_fn;

  //  Send a HTTP GET Request with LWIP
  httpc_get_file_dns(
    &quot;nf.cr.dandanman.com&quot;,  //  Host
    80,                     //  Port
    &quot;/ddm/ContentResource/music/204.mp3&quot;,  //  URI
    &amp;settings,              //  Settings
    cb_altcp_recv_fn,       //  Callback Function
    &amp;req,                   //  Callback Argument
    &amp;req);                  //  Request
}
</code></pre>
<p><a href="https://pine64.github.io/bl602-docs/Examples/demo_wifi/wifi.html">Demo Firmware Documentation</a></p>
<h1 id="connect-to-wifi-access-point" class="section-header"><a href="#connect-to-wifi-access-point">2 Connect to WiFi Access Point</a></h1>
<p>TODO</p>
<h1 id="wifi-background-task" class="section-header"><a href="#wifi-background-task">3 WiFi Background Task</a></h1>
<p>TODO</p>
<h1 id="decompiled-wifi-demo-firmware" class="section-header"><a href="#decompiled-wifi-demo-firmware">4 Decompiled WiFi Demo Firmware</a></h1>
<p>TODO</p>
<p><a href="https://github.com/BraveHeartFLOSSDev"><code>BraveHeartFLOSSDev</code></a> did an excellent job decompiling into C (with Ghidra) the BL602 WiFi Demo Firmware‚Ä¶</p>
<ul>
<li><a href="https://github.com/BraveHeartFLOSSDev/bl602nutcracker1"><strong>BraveHeartFLOSSDev/bl602nutcracker1</strong></a></li>
</ul>
<p><a href="https://github.com/lupyuen/bl602nutcracker1">(We‚Äôll refer to this forked version)</a></p>
<h1 id="ceva-rivierawaves" class="section-header"><a href="#ceva-rivierawaves">5 CEVA RivieraWaves</a></h1>
<p>TODO</p>
<h1 id="upper-medium-access-control-layer" class="section-header"><a href="#upper-medium-access-control-layer">6 Upper Medium Access Control Layer</a></h1>
<p>TODO</p>
<h1 id="lower-medium-access-control-layer" class="section-header"><a href="#lower-medium-access-control-layer">7 Lower Medium Access Control Layer</a></h1>
<p>TODO</p>
<h1 id="wifi-phy-layer" class="section-header"><a href="#wifi-phy-layer">8 WiFi PHY Layer</a></h1>
<p>TODO</p>
<h1 id="wifi-supplicant" class="section-header"><a href="#wifi-supplicant">9 WiFi Supplicant</a></h1>
<p>TODO</p>
<p>Rockchip RK3399</p>
<h1 id="quantitative-analysis" class="section-header"><a href="#quantitative-analysis">10 Quantitative Analysis</a></h1>
<p>TODO</p>
<ul>
<li>
<p><a href="https://docs.google.com/spreadsheets/d/1C_XmkH-ZSXz9-V2HsYBv7K1KRx3RF3-zsoJRLh1GwxI/edit?usp=sharing">Google Sheets</a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/bl602nutcracker1/blob/main/bl602_demo_wifi.ods">LibreOffice / OpenOffice Format</a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/bl602nutcracker1/blob/main/bl602_demo_wifi.xlsx">Excel Format</a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/bl602nutcracker1/blob/main/bl602_demo_wifi.csv">CSV Format (without analysis)</a></p>
</li>
</ul>
<p><img src="https://lupyuen.github.io/images/wifi-title.jpg" alt="Quantitative Analysis of Decompiled BL602 WiFi Firmware" /></p>
<h1 id="other-components" class="section-header"><a href="#other-components">11 Other Components</a></h1>
<p>TODO</p>
<p>BL602 HAL, BL602 Standard Driver, LWIP, MbedTLS, FreeRTOS, AliOS, AWS MQTT, AWS IoT</p>
<h1 id="github-search-is-our-best-friend" class="section-header"><a href="#github-search-is-our-best-friend">12 GitHub Search Is Our Best Friend!</a></h1>
<p>TODO</p>
<h1 id="whats-next" class="section-header"><a href="#whats-next">13 What‚Äôs Next</a></h1>
<p>TODO</p>
<ul>
<li>
<p><a href="https://github.com/sponsors/lupyuen">Sponsor me a coffee</a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/book">Read ‚ÄúThe RISC-V BL602 Book‚Äù</a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io">Check out my articles</a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/rss.xml">RSS Feed</a></p>
</li>
</ul>
<p><em>Got a question, comment or suggestion? Create an Issue or submit a Pull Request here‚Ä¶</em></p>
<p><a href="https://github.com/lupyuen/lupyuen.github.io/blob/master/src/wifi.md"><code>lupyuen.github.io/src/wifi.md</code></a></p>
<h1 id="notes" class="section-header"><a href="#notes">14 Notes</a></h1>
<ol>
<li>This article is the expanded version of <a href="https://twitter.com/MisterTechBlog/status/1407971263088193540">this Twitter Thread</a></li>
</ol>

    
</body>
</html>