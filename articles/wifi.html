<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="rustdoc">
    <title>Reverse Engineering WiFi on RISC-V BL602</title>

    
    <!-- Begin scripts/articles/*-header.html: Article Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<meta property="og:title" 
    content="Reverse Engineering WiFi on RISC-V BL602" 
    data-rh="true">
<meta property="og:description" 
    content="What happens inside the WiFi Driver on RISC-V BL602... And how we found the incomplete source code for the driver"
    data-rh="true">
<meta property="og:image" 
    content="https://lupyuen.github.io/images/wifi-title.jpg">
<meta property="og:type" 
    content="article" data-rh="true">
<!-- End scripts/articles/*-header.html -->
<!-- Begin scripts/rustdoc-header.html: Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<link rel="alternate" type="application/rss+xml" title="RSS Feed for lupyuen" href="/rss.xml" />
<link rel="stylesheet" type="text/css" href="../normalize.css">
<link rel="stylesheet" type="text/css" href="../rustdoc.css" id="mainThemeStyle">
<link rel="stylesheet" type="text/css" href="../dark.css">
<link rel="stylesheet" type="text/css" href="../light.css" id="themeStyle">
<link rel="stylesheet" type="text/css" href="../prism.css">
<script src="../storage.js"></script><noscript>
<link rel="stylesheet" href="../noscript.css"></noscript>
<link rel="shortcut icon" href="../favicon.ico">
<style type="text/css">
    #crate-search {
        background-image: url("../down-arrow.svg");
    }
    a {
        color: #77d;
    }
</style>
<!-- End scripts/rustdoc-header.html -->


</head>
<body class="rustdoc">
    <!--[if lte IE 8]>
    <div class="warning">
        This old browser is unsupported and will most likely display funky
        things.
    </div>
    <![endif]-->

        <!-- Begin scripts/rustdoc-before.html: Pre-HTML for Custom Markdown files processed by rustdoc, like chip8.md -->

    <!-- Begin Theme Picker -->
    <div class="theme-picker" style="left: 0"><button id="theme-picker" aria-label="Pick another theme!"><img src="../brush.svg"
        width="18" alt="Pick another theme!"></button>
        <div id="theme-choices"></div>
    </div>
    <script src="../theme.js"></script>
    <script src="../prism.js"></script>
    <!-- Theme Picker -->

    <!-- End scripts/rustdoc-before.html -->
    

    <h1 class="title">Reverse Engineering WiFi on RISC-V BL602</h1>
    <nav id="TOC"><ul>
<li><a href="#bl602-wifi-demo-firmware">1 BL602 WiFi Demo Firmware</a><ul>
<li><a href="#register-wifi-event-handler">1.1 Register WiFi Event Handler</a><ul></ul></li>
<li><a href="#start-wifi-firmware-task">1.2 Start WiFi Firmware Task</a><ul></ul></li>
<li><a href="#start-wifi-manager-task">1.3 Start WiFi Manager Task</a><ul></ul></li>
<li><a href="#connect-to-wifi-network">1.4 Connect to WiFi Network</a><ul></ul></li>
<li><a href="#send-http-request">1.5 Send HTTP Request</a><ul></ul></li></ul></li>
<li><a href="#connect-to-wifi-access-point">2 Connect to WiFi Access Point</a><ul>
<li><a href="#send-request-to-wifi-manager-task">2.1 Send request to WiFi Manager Task</a><ul></ul></li>
<li><a href="#wifi-manager-state-machine">2.2 WiFi Manager State Machine</a><ul></ul></li>
<li><a href="#send-request-to-lmac">2.3 Send request to LMAC</a><ul></ul></li>
<li><a href="#trigger-lmac-interrupt">2.4 Trigger LMAC Interrupt</a><ul></ul></li></ul></li>
<li><a href="#decompiled-wifi-demo-firmware">3 Decompiled WiFi Demo Firmware</a><ul>
<li><a href="#linking-to-decompiled-code">3.1 Linking to decompiled code</a><ul></ul></li></ul></li>
<li><a href="#wifi-firmware-task">4 WiFi Firmware Task</a><ul></ul></li>
<li><a href="#ceva-rivierawaves">5 CEVA RivieraWaves</a><ul></ul></li>
<li><a href="#upper-medium-access-control-layer">6 Upper Medium Access Control Layer</a><ul></ul></li>
<li><a href="#lower-medium-access-control-layer">7 Lower Medium Access Control Layer</a><ul></ul></li>
<li><a href="#wifi-phy-layer">8 WiFi PHY Layer</a><ul>
<li><a href="#wifi-rtl">8.1 WiFi RTL</a><ul></ul></li></ul></li>
<li><a href="#wifi-supplicant">9 WiFi Supplicant</a><ul></ul></li>
<li><a href="#quantitative-analysis">10 Quantitative Analysis</a><ul></ul></li>
<li><a href="#other-components">11 Other Components</a><ul></ul></li>
<li><a href="#github-search-is-our-best-friend">12 GitHub Search Is Our Best Friend!</a><ul></ul></li>
<li><a href="#whats-next">13 What‚Äôs Next</a><ul></ul></li>
<li><a href="#notes">14 Notes</a><ul></ul></li></ul></nav><p>üìù <em>9 Jul 2021</em></p>
<p><em>What happens inside the WiFi Driver on RISC-V BL602 SoC‚Ä¶ And how we found the (incomplete) source code for the driver</em></p>
<p>Why reverse engineer the WiFi Driver?</p>
<p>TODO: Education, replacement, auditing, troubleshooting. <a href="https://twitter.com/Yu_Wei_Wu/status/1406940637773979655?s=19">See this non-BL602 example</a></p>
<p><img src="https://lupyuen.github.io/images/wifi-title.jpg" alt="Quantitative Analysis of Decompiled BL602 WiFi Firmware" /></p>
<h1 id="bl602-wifi-demo-firmware" class="section-header"><a href="#bl602-wifi-demo-firmware">1 BL602 WiFi Demo Firmware</a></h1>
<p>Let‚Äôs study the source code of the <strong>BL602 WiFi Demo Firmware</strong> from the BL602 IoT SDK: <a href="https://github.com/lupyuen/bl_iot_sdk/blob/master/customer_app/bl602_demo_wifi"><strong><code>bl602_demo_wifi</code></strong></a></p>
<p>In the demo firmware we shall‚Ä¶</p>
<ol>
<li>
<p>Register the <strong>WiFi Event Handler</strong> that will handle WiFi Events</p>
</li>
<li>
<p>Start the <strong>WiFi Firmware Task</strong> that will control the BL602 WiFi Firmware</p>
</li>
<li>
<p>Start the <strong>WiFi Manager Task</strong> that will manage WiFi Connections</p>
</li>
<li>
<p>Connect to a <strong>WiFi Access Point</strong></p>
</li>
<li>
<p>Send a <strong>HTTP Request</strong></p>
</li>
</ol>
<h2 id="register-wifi-event-handler" class="section-header"><a href="#register-wifi-event-handler">1.1 Register WiFi Event Handler</a></h2>
<p>When the firmware starts, we register a <strong>Callback Function that will handle WiFi Events</strong>: <a href="https://github.com/lupyuen/bl_iot_sdk/blob/master/customer_app/bl602_demo_wifi/bl602_demo_wifi/main.c#L819-L866"><code>main.c</code></a></p>
<pre><code class="language-c">//  Called at startup to init drivers and run event loop
static void aos_loop_proc(void *pvParameters) {
  //  Omitted: Init the drivers
  ...
  //  Register Callback Function for WiFi Events
  aos_register_event_filter(
    EV_WIFI,              //  Event Type
    event_cb_wifi_event,  //  Event Callback Function
    NULL);                //  Event Callback Argument

  //  Start WiFi Networking Stack
  cmd_stack_wifi(NULL, 0, 0, NULL);

  //  Run event loop
  aos_loop_run();
}
</code></pre>
<p>(We‚Äôll see <code>event_cb_wifi_event</code> in a while)</p>
<p>This startup code calls <strong><code>cmd_stack_wifi</code></strong> to start the WiFi Networking Stack.</p>
<p>Let‚Äôs look inside‚Ä¶</p>
<h2 id="start-wifi-firmware-task" class="section-header"><a href="#start-wifi-firmware-task">1.2 Start WiFi Firmware Task</a></h2>
<p>In <strong><code>cmd_stack_wifi</code></strong> we start the <strong>WiFi Firmware Task</strong> like so: <a href="https://github.com/lupyuen/bl_iot_sdk/blob/master/customer_app/bl602_demo_wifi/bl602_demo_wifi/main.c#L729-L747"><code>main.c</code></a></p>
<pre><code class="language-c">//  Start WiFi Networking Stack
static void cmd_stack_wifi(char *buf, int len, int argc, char **argv) {
  //  Check whether WiFi Networking is already started
  static uint8_t stack_wifi_init  = 0;
  if (1 == stack_wifi_init) { return; }  //  Already started
  stack_wifi_init = 1;

  //  Start WiFi Firmware Task (FreeRTOS)
  hal_wifi_start_firmware_task();

  //  Post a WiFi Event to start WiFi Manager Task
  aos_post_event(
    EV_WIFI,                 //  Event Type
    CODE_WIFI_ON_INIT_DONE,  //  Event Code
    0);                      //  Event Argument
}
</code></pre>
<p>(We‚Äôll cover <code>hal_wifi_start_firmware_task</code> later in this article)</p>
<p>After starting the task, we post the WiFi Event <code>CODE_WIFI_ON_INIT_DONE</code> to <strong>start the WiFi Manager Task</strong>.</p>
<p>Let‚Äôs look inside the WiFi Event Handler‚Ä¶</p>
<h2 id="start-wifi-manager-task" class="section-header"><a href="#start-wifi-manager-task">1.3 Start WiFi Manager Task</a></h2>
<p>Here‚Äôs how we handle <strong>WiFi Events</strong>: <a href="https://github.com/lupyuen/bl_iot_sdk/blob/master/customer_app/bl602_demo_wifi/bl602_demo_wifi/main.c#L374-L512"><code>main.c</code></a></p>
<pre><code class="language-c">//  Callback Function for WiFi Events
static void event_cb_wifi_event(input_event_t *event, void *private_data) {

  //  Handle the WiFi Event
  switch (event-&gt;code) {

    //  Posted by cmd_stack_wifi to start Wi-Fi Manager Task
    case CODE_WIFI_ON_INIT_DONE:

      //  Start the WiFi Manager Task (FreeRTOS)
      wifi_mgmr_start_background(&amp;conf);
      break;

    //  Omitted: Handle other WiFi Events
</code></pre>
<p>When we receive the WiFi Event <code>CODE_WIFI_ON_INIT_DONE</code>, we start the <strong>WiFi Manager Task</strong> (in FreeRTOS) by calling <code>wifi_mgmr_start_background</code>.</p>
<p><code>wifi_mgmr_start_background</code> comes from the BL602 WiFi Driver. <a href="https://github.com/lupyuen/bl_iot_sdk/blob/master/components/bl602/bl602_wifidrv/bl60x_wifi_driver/wifi_mgmr.c#L1406-L1415">(See the source code)</a></p>
<h2 id="connect-to-wifi-network" class="section-header"><a href="#connect-to-wifi-network">1.4 Connect to WiFi Network</a></h2>
<p>Now that we have started both WiFi Background Tasks (WiFi Firmware Task and WiFi Manager Task), let‚Äôs connect to a WiFi Network!</p>
<p>The demo firmware lets us enter this command to <strong>connect to a WiFi Access Point</strong>‚Ä¶</p>
<pre><code class="language-text"># wifi_sta_connect YOUR_WIFI_SSID YOUR_WIFI_PASSWORD
</code></pre>
<p>Here‚Äôs how the <strong><code>wifi_sta_connect</code></strong> command is implemented: <a href="https://github.com/lupyuen/bl_iot_sdk/blob/master/customer_app/bl602_demo_wifi/bl602_demo_wifi/main.c#L366-L372"><code>main.c</code></a></p>
<pre><code class="language-c">//  Connect to WiFi Access Point
static void wifi_sta_connect(char *ssid, char *password) {

  //  Enable WiFi Client
  wifi_interface_t wifi_interface
    = wifi_mgmr_sta_enable();

  //  Connect to WiFi Access Point
  wifi_mgmr_sta_connect(
    wifi_interface,  //  WiFi Interface
    ssid,            //  SSID
    password,        //  Password
    NULL,            //  PMK
    NULL,            //  MAC Address
    0,               //  Band
    0);              //  Frequency
}
</code></pre>
<p>We call <a href="https://github.com/lupyuen/bl_iot_sdk/blob/master/components/bl602/bl602_wifidrv/bl60x_wifi_driver/wifi_mgmr_ext.c#L202-L217"><strong><code>wifi_mgmr_sta_enable</code></strong></a> from the BL602 WiFi Driver to <strong>enable the WiFi Client</strong>.</p>
<p>(‚ÄúSTA‚Äù refers to ‚ÄúWiFi Station‚Äù, which means WiFi Client)</p>
<p>Then we call <a href="https://github.com/lupyuen/bl_iot_sdk/blob/master/components/bl602/bl602_wifidrv/bl60x_wifi_driver/wifi_mgmr_ext.c#L302-L307"><strong><code>wifi_mgmr_sta_connect</code></strong></a> (also from the BL602 WiFi Driver) to <strong>connect to the WiFi Access Point</strong>.</p>
<p>(We‚Äôll study the internals of <code>wifi_mgmr_sta_connect</code> in the next chapter)</p>
<h2 id="send-http-request" class="section-header"><a href="#send-http-request">1.5 Send HTTP Request</a></h2>
<p>Now we enter this command to <strong>send a HTTP Request</strong> over WiFi‚Ä¶</p>
<pre><code class="language-text"># httpc
</code></pre>
<p>Here‚Äôs the implementation of the <strong><code>httpc</code></strong> command: <a href="https://github.com/lupyuen/bl_iot_sdk/blob/master/customer_app/bl602_demo_wifi/bl602_demo_wifi/main.c#L704-L727"><code>main.c</code></a></p>
<pre><code class="language-c">//  Send a HTTP GET Request with LWIP
static void cmd_httpc_test(char *buf, int len, int argc, char **argv) {
  //  Check whether a HTTP Request is already running
  static httpc_connection_t settings;
  static httpc_state_t *req;
  if (req) { return; }  //  Request already running

  //  Init the LWIP HTTP Settings
  memset(&amp;settings, 0, sizeof(settings));
  settings.use_proxy = 0;
  settings.result_fn = cb_httpc_result;
  settings.headers_done_fn = cb_httpc_headers_done_fn;

  //  Send a HTTP GET Request with LWIP
  httpc_get_file_dns(
    &quot;nf.cr.dandanman.com&quot;,  //  Host
    80,                     //  Port
    &quot;/ddm/ContentResource/music/204.mp3&quot;,  //  URI
    &amp;settings,              //  Settings
    cb_altcp_recv_fn,       //  Callback Function
    &amp;req,                   //  Callback Argument
    &amp;req);                  //  Request
}
</code></pre>
<p>On BL602 we use <a href="https://www.nongnu.org/lwip/2_1_x/index.html"><strong>LWIP, the Lightweight IP Stack</strong></a> to do IP, UDP, TCP and HTTP Networking.</p>
<p><a href="https://www.nongnu.org/lwip/2_1_x/group__httpc.html#gabd4ef2259885a93090733235cc0fa8d6"><code>httpc_get_file_dns</code> is documented here</a></p>
<p>For more details on the BL602 WiFi Demo Firmware, check out the docs‚Ä¶</p>
<ul>
<li><a href="https://pine64.github.io/bl602-docs/Examples/demo_wifi/wifi.html"><strong>BL602 WiFi Demo Firmware Docs</strong></a></li>
</ul>
<p>Let‚Äôs reverse engineer the BL602 WiFi Demo Firmware‚Ä¶ And learn what happens inside!</p>
<p><img src="https://lupyuen.github.io/images/wifi-connect.png" alt="Connecting to WiFi Access Point" /></p>
<h1 id="connect-to-wifi-access-point" class="section-header"><a href="#connect-to-wifi-access-point">2 Connect to WiFi Access Point</a></h1>
<p><em>What really happens when BL602 connects to a WiFi Access Point?</em></p>
<p>To understand how BL602 connects to a WiFi Access Point, let‚Äôs read the <strong>Source Code from the BL602 WiFi Driver</strong>.</p>
<h2 id="send-request-to-wifi-manager-task" class="section-header"><a href="#send-request-to-wifi-manager-task">2.1 Send request to WiFi Manager Task</a></h2>
<p>Earlier we called <strong><code>wifi_mgmr_sta_connect</code></strong> to connect to the WiFi Access Point.</p>
<p>Here‚Äôs what happens inside: <a href="https://github.com/lupyuen/bl_iot_sdk/blob/master/components/bl602/bl602_wifidrv/bl60x_wifi_driver/wifi_mgmr_ext.c#L302-L307"><code>wifi_mgmr_ext.c</code></a></p>
<pre><code class="language-c">//  Connect to WiFi Access Point
int wifi_mgmr_sta_connect(wifi_interface_t *wifi_interface, char *ssid, char *psk, char *pmk, uint8_t *mac, uint8_t band, uint16_t freq) {
  //  Set WiFi SSID and PSK
  wifi_mgmr_sta_ssid_set(ssid);
  wifi_mgmr_sta_psk_set(psk);

  //  Connect to WiFi Access Point
  return wifi_mgmr_api_connect(ssid, psk, pmk, mac, band, freq);
}
</code></pre>
<p>We set the WiFi SSID and PSK. Then we call <code>wifi_mgmr_api_connect</code> to connect to the access point.</p>
<p><strong><code>wifi_mgmr_api_connect</code></strong> does this: <a href="https://github.com/lupyuen/bl_iot_sdk/blob/master/components/bl602/bl602_wifidrv/bl60x_wifi_driver/wifi_mgmr_api.c#L40-L84"><code>wifi_mgmr_api.c</code></a></p>
<pre><code class="language-c">//  Connect to WiFi Access Point
int wifi_mgmr_api_connect(char *ssid, char *psk, char *pmk, uint8_t *mac, uint8_t band, uint16_t freq) {
  //  Omitted: Copy PSK, PMK, MAC Address, Band and Frequency
  ...
  //  Send Connect Request to WiFi Manager Task
  wifi_mgmr_event_notify(msg);
  return 0;
}
</code></pre>
<p><img src="https://lupyuen.github.io/images/wifi-connect2.png" alt="wifi_mgmr_api_connect" /></p>
<p>Here we call <code>wifi_mgmr_event_notify</code> to <strong>send the Connect Request</strong> to the WiFi Manager Task.</p>
<p><strong><code>wifi_mgmr_event_notify</code></strong> is defined in <a href="https://github.com/lupyuen/bl_iot_sdk/blob/master/components/bl602/bl602_wifidrv/bl60x_wifi_driver/wifi_mgmr.c#L1332-L1343"><code>wifi_mgmr.c</code></a> ‚Ä¶</p>
<pre><code class="language-c">//  Send request to WiFi Manager Task
int wifi_mgmr_event_notify(wifi_mgmr_msg_t *msg) {
  //  Omitted: Wait for WiFi Manager to start
  ...
  //  Send request to WiFi Manager via Message Queue
  if (os_mq_send(
    &amp;(wifiMgmr.mq),  //  Message Queue
    msg,             //  Request Message
    msg-&gt;len)) {     //  Message Length
    //  Failed to send request
    return -1;
  }
  return 0;
}
</code></pre>
<p><em>How does <code>os_mq_send</code> send the request to the WiFi Manager Task?</em></p>
<p><strong><code>os_mq_send</code></strong> calls FreeRTOS to deliver the Request Message to <strong>WiFi Manager‚Äôs Message Queue</strong>: <a href="https://github.com/lupyuen/bl_iot_sdk/blob/master/components/bl602/bl602_wifidrv/bl60x_wifi_driver/os_hal.h#L174"><code>os_hal.h</code></a></p>
<pre><code class="language-c">#define os_mq_send(mq, msg, len) \
    (xMessageBufferSend(mq, msg, len, portMAX_DELAY) &gt; 0 ? 0 : 1)
</code></pre>
<p><img src="https://lupyuen.github.io/images/wifi-connect3.png" alt="wifi_mgmr_event_notify" /></p>
<h2 id="wifi-manager-state-machine" class="section-header"><a href="#wifi-manager-state-machine">2.2 WiFi Manager State Machine</a></h2>
<p>The WiFi Manager runs a <strong>State Machine</strong> in its Background Task (FreeRTOS) to manage the state of each WiFi Connection.</p>
<p><em>What happens when WiFi Manager receives our request to connect to a WiFi Access Point?</em></p>
<p>From <a href="https://github.com/lupyuen/bl_iot_sdk/blob/master/components/bl602/bl602_wifidrv/bl60x_wifi_driver/wifi_mgmr.c#L702-L745"><code>wifi_mgmr.c</code></a> ‚Ä¶</p>
<pre><code class="language-c">static void stateIdleAction_connect( void *oldStateData, struct event *event,
      void *newStateData )
{
    wifi_mgmr_msg_t *msg;
    wifi_mgmr_profile_msg_t *profile_msg;

    msg = event-&gt;data;
    profile_msg = (wifi_mgmr_profile_msg_t*)msg-&gt;data;
    profile_msg-&gt;ssid_tail[0] = '\0';
    profile_msg-&gt;psk_tail[0] = '\0';
    os_printf(DEBUG_HEADER &quot;Action Connect\r\n&quot;);
    os_printf(&quot;           ssid %s\r\n&quot;, profile_msg-&gt;ssid);
    os_printf(&quot;           ssid len %u\r\n&quot;, (unsigned int)profile_msg-&gt;ssid_len);
    os_printf(&quot;           psk %s\r\n&quot;, profile_msg-&gt;psk);
    os_printf(&quot;           psk len %u\r\n&quot;, (unsigned int)profile_msg-&gt;psk_len);
    os_printf(&quot;           pmk %s\r\n&quot;, profile_msg-&gt;pmk);
    os_printf(&quot;           pmk len %u\r\n&quot;, (unsigned int)profile_msg-&gt;pmk_len);
    os_printf(&quot;           channel band %d\r\n&quot;, (uint8_t)profile_msg-&gt;band);
    os_printf(&quot;           channel freq %d\r\n&quot;, (uint16_t)profile_msg-&gt;freq);
    os_printf(&quot;           mac %02X:%02X:%02X:%02X:%02X:%02X\r\n&quot;,
            profile_msg-&gt;mac[5],
            profile_msg-&gt;mac[4],
            profile_msg-&gt;mac[3],
            profile_msg-&gt;mac[2],
            profile_msg-&gt;mac[1],
            profile_msg-&gt;mac[0]
    );
    os_printf(&quot;           dhcp status: %s\r\n&quot;, profile_msg-&gt;dhcp_use ? &quot;true&quot; : &quot;false&quot;);
    wifi_mgmr_profile_add(&amp;wifiMgmr, profile_msg, -1);

    os_printf(DEBUG_HEADER &quot;State Action ###%s### ---&gt;&gt;&gt; ###%s###\r\n&quot;,
            (char*)oldStateData,
            (char*)newStateData
    );

    //TODO Other security support
    bl_main_connect((const uint8_t *)profile_msg-&gt;ssid, profile_msg-&gt;ssid_len,
            (const uint8_t *)profile_msg-&gt;psk, profile_msg-&gt;psk_len,
            (const uint8_t *)profile_msg-&gt;pmk, profile_msg-&gt;pmk_len,
            (const uint8_t *)profile_msg-&gt;mac,
            (const uint8_t)profile_msg-&gt;band,
            (const uint16_t)profile_msg-&gt;freq
    );
}
</code></pre>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/wifi-connect4.png" alt="stateIdleAction_connect" /></p>
<p>TODO</p>
<p>From <a href="https://github.com/lupyuen/bl_iot_sdk/blob/master/components/bl602/bl602_wifidrv/bl60x_wifi_driver/bl_main.c#L189-L216"><code>bl_main.c</code></a></p>
<pre><code class="language-c">int bl_main_connect(const uint8_t* ssid, int ssid_len, const uint8_t *psk, int psk_len, const uint8_t *pmk, int pmk_len, const uint8_t *mac, const uint8_t band, const uint16_t freq)
{
    struct cfg80211_connect_params sme;

    memset(&amp;sme, 0, sizeof(struct cfg80211_connect_params));
    sme.crypto.n_ciphers_pairwise = 0;
    sme.ssid_len = ssid_len;
    sme.ssid = ssid;
    sme.auth_type = NL80211_AUTHTYPE_AUTOMATIC;
    sme.key = psk;
    sme.key_len = psk_len;
    sme.pmk = pmk;
    sme.pmk_len = pmk_len;

    if (mac){
        sme.bssid = mac;
    }

    if (freq &gt; 0) {
        sme.channel.center_freq = freq;
        sme.channel.band = band;
        sme.channel.flags = 0;
    }

    bl_cfg80211_connect(&amp;wifi_hw, &amp;sme);

    return 0;
}
</code></pre>
<p>TODO</p>
<p>From <a href="https://github.com/lupyuen/bl_iot_sdk/blob/master/components/bl602/bl602_wifidrv/bl60x_wifi_driver/bl_main.c#L539-L571"><code>bl_main.c</code></a></p>
<pre><code class="language-c">int bl_cfg80211_connect(struct bl_hw *bl_hw, struct cfg80211_connect_params *sme)
{
    struct sm_connect_cfm sm_connect_cfm;
    int error = 0;

    RWNX_DBG(RWNX_FN_ENTRY_STR);

    /* Forward the information to the LMAC */
    error = bl_send_sm_connect_req(bl_hw, sme, &amp;sm_connect_cfm);
    if (error) {
        return error;
    }

    // Check the status
    switch (sm_connect_cfm.status)
    {
        case CO_OK:
            error = 0;
            break;
        case CO_BUSY:
            error = -EINPROGRESS;
            break;
        case CO_OP_IN_PROGRESS:
            error = -EALREADY;
            break;
        default:
            error = -EIO;
            break;
    }
    RWNX_DBG(RWNX_FN_LEAVE_STR);

    return error;
}
</code></pre>
<h2 id="send-request-to-lmac" class="section-header"><a href="#send-request-to-lmac">2.3 Send request to LMAC</a></h2>
<p>TODO</p>
<p>From <a href="https://github.com/lupyuen/bl_iot_sdk/blob/master/components/bl602/bl602_wifidrv/bl60x_wifi_driver/bl_msg_tx.c#L722-L804"><code>bl_msg_tx.c</code></a></p>
<pre><code class="language-c">int bl_send_sm_connect_req(struct bl_hw *bl_hw, struct cfg80211_connect_params *sme, struct sm_connect_cfm *cfm)
{
    struct sm_connect_req *req;
    int i;
    u32_l flags = 0;

    RWNX_DBG(RWNX_FN_ENTRY_STR);

    /* Build the SM_CONNECT_REQ message */
    req = bl_msg_zalloc(SM_CONNECT_REQ, TASK_SM, DRV_TASK_ID,
                                   sizeof(struct sm_connect_req));
    if (!req)
        return -ENOMEM;

    /* Set parameters for the SM_CONNECT_REQ message */
    if (sme-&gt;crypto.n_ciphers_pairwise &amp;&amp;
        ((sme-&gt;crypto.ciphers_pairwise[0] == WLAN_CIPHER_SUITE_WEP40) ||
         (sme-&gt;crypto.ciphers_pairwise[0] == WLAN_CIPHER_SUITE_TKIP) ||
         (sme-&gt;crypto.ciphers_pairwise[0] == WLAN_CIPHER_SUITE_WEP104)))
        flags |= DISABLE_HT;

    if (sme-&gt;crypto.control_port)
        flags |= CONTROL_PORT_HOST;

    if (sme-&gt;crypto.control_port_no_encrypt)
        flags |= CONTROL_PORT_NO_ENC;

    if (use_pairwise_key(&amp;sme-&gt;crypto))
        flags |= WPA_WPA2_IN_USE;

    if (sme-&gt;mfp == NL80211_MFP_REQUIRED)
        flags |= MFP_IN_USE;

    if (sme-&gt;crypto.control_port_ethertype)
        req-&gt;ctrl_port_ethertype = sme-&gt;crypto.control_port_ethertype;
    else
        req-&gt;ctrl_port_ethertype = ETH_P_PAE;

    if (sme-&gt;bssid &amp;&amp; !MAC_ADDR_CMP(sme-&gt;bssid, mac_addr_bcst.array) &amp;&amp; !MAC_ADDR_CMP(sme-&gt;bssid, mac_addr_zero.array)) {
        for (i=0;i&lt;ETH_ALEN;i++)
            req-&gt;bssid.array[i] = sme-&gt;bssid[i];
    }
    else
        req-&gt;bssid = mac_addr_bcst;
    req-&gt;vif_idx = bl_hw-&gt;vif_index_sta;
    if (sme-&gt;channel.center_freq) {
        req-&gt;chan.band = sme-&gt;channel.band;
        req-&gt;chan.freq = sme-&gt;channel.center_freq;
        req-&gt;chan.flags = passive_scan_flag(sme-&gt;channel.flags);
    } else {
        req-&gt;chan.freq = (u16_l)-1;
    }
    for (i = 0; i &lt; sme-&gt;ssid_len; i++)
        req-&gt;ssid.array[i] = sme-&gt;ssid[i];
    req-&gt;ssid.length = sme-&gt;ssid_len;
    req-&gt;flags = flags;
    if (WARN_ON(sme-&gt;ie_len &gt; sizeof(req-&gt;ie_buf)))
        return -EINVAL;
    if (sme-&gt;ie_len)
        memcpy(req-&gt;ie_buf, sme-&gt;ie, sme-&gt;ie_len);
    req-&gt;ie_len = sme-&gt;ie_len;
    req-&gt;listen_interval = bl_mod_params.listen_itv;
    req-&gt;dont_wait_bcmc = !bl_mod_params.listen_bcmc;

    /* Set auth_type */
    if (sme-&gt;auth_type == NL80211_AUTHTYPE_AUTOMATIC)
        req-&gt;auth_type = NL80211_AUTHTYPE_OPEN_SYSTEM;
    else
        req-&gt;auth_type = sme-&gt;auth_type;

    /* Set UAPSD queues */
    req-&gt;uapsd_queues = bl_mod_params.uapsd_queues;
    req-&gt;is_supplicant_enabled = 1;
    if (sme-&gt;key_len) {
        memcpy(req-&gt;phrase, sme-&gt;key, sme-&gt;key_len);
    }
    if (sme-&gt;pmk_len) {
        memcpy(req-&gt;phrase_pmk, sme-&gt;pmk, sme-&gt;pmk_len);
    }

    /* Send the SM_CONNECT_REQ message to LMAC FW */
    return bl_send_msg(bl_hw, req, 1, SM_CONNECT_CFM, cfm);
}
</code></pre>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/wifi-connect5.png" alt="bl_send_sm_connect_req" /></p>
<p>TODO</p>
<p>From <a href="https://github.com/lupyuen/bl_iot_sdk/blob/master/components/bl602/bl602_wifidrv/bl60x_wifi_driver/bl_msg_tx.c#L315-L371"><code>bl_msg_tx.c</code></a></p>
<pre><code class="language-c">static int bl_send_msg(struct bl_hw *bl_hw, const void *msg_params,
                         int reqcfm, lmac_msg_id_t reqid, void *cfm)
{
    struct lmac_msg *msg;
    struct bl_cmd *cmd;
    bool nonblock;
    int ret;

    RWNX_DBG(RWNX_FN_ENTRY_STR);

    msg = container_of((void *)msg_params, struct lmac_msg, param);

    if (!test_bit(RWNX_DEV_STARTED, &amp;bl_hw-&gt;drv_flags) &amp;&amp;
        reqid != MM_RESET_CFM &amp;&amp; reqid != MM_VERSION_CFM &amp;&amp;
        reqid != MM_START_CFM &amp;&amp; reqid != MM_SET_IDLE_CFM &amp;&amp;
        reqid != ME_CONFIG_CFM &amp;&amp; reqid != MM_SET_PS_MODE_CFM &amp;&amp;
        reqid != ME_CHAN_CONFIG_CFM) {
        os_printf(&quot;%s: bypassing (RWNX_DEV_RESTARTING set) 0x%02x\n&quot;, __func__, reqid);
        os_free(msg);
        RWNX_DBG(RWNX_FN_LEAVE_STR);
        return -EBUSY;
    } else if (!bl_hw-&gt;ipc_env) {
        os_printf(&quot;%s: bypassing (restart must have failed)\r\n&quot;, __func__);
        os_free(msg);
        RWNX_DBG(RWNX_FN_LEAVE_STR);
        return -EBUSY;
    }

    nonblock = is_non_blocking_msg(msg-&gt;id);

    cmd = os_malloc(sizeof(struct bl_cmd));
    if (NULL == cmd) {
        os_free(msg);
        os_printf(&quot;%s: failed to allocate mem for cmd, size is %d\r\n&quot;, __func__, sizeof(struct bl_cmd));
        return -ENOMEM;
    }
    memset(cmd, 0, sizeof(struct bl_cmd));
    cmd-&gt;result  = EINTR;
    cmd-&gt;id      = msg-&gt;id;
    cmd-&gt;reqid   = reqid;
    cmd-&gt;a2e_msg = msg;
    cmd-&gt;e2a_msg = cfm;
    if (nonblock)
        cmd-&gt;flags = RWNX_CMD_FLAG_NONBLOCK;
    if (reqcfm)
        cmd-&gt;flags |= RWNX_CMD_FLAG_REQ_CFM;
    ret = bl_hw-&gt;cmd_mgr.queue(&amp;bl_hw-&gt;cmd_mgr, cmd);

    if (!nonblock) {
        os_free(cmd);
    } else {
        ret = cmd-&gt;result;
    }

    RWNX_DBG(RWNX_FN_LEAVE_STR);
    return ret;
}
</code></pre>
<p><img src="https://lupyuen.github.io/images/wifi-connect6.png" alt="bl_send_msg" /></p>
<p>TODO</p>
<p>From <a href="https://github.com/lupyuen/bl_iot_sdk/blob/master/components/bl602/bl602_wifidrv/bl60x_wifi_driver/ipc_host.c#L139-L171"><code>ipc_host.c</code></a></p>
<pre><code class="language-c">int ipc_host_msg_push(struct ipc_host_env_tag *env, void *msg_buf, uint16_t len)
{
    int i;
    uint32_t *src, *dst;

    REG_SW_SET_PROFILING(env-&gt;pthis, SW_PROF_IPC_MSGPUSH);

    ASSERT_ERR(!env-&gt;msga2e_hostid);
    ASSERT_ERR(round_up(len, 4) &lt;= sizeof(env-&gt;shared-&gt;msg_a2e_buf.msg));

    // Copy the message into the IPC MSG buffer
#if 1
    src = (uint32_t*)((struct bl_cmd *)msg_buf)-&gt;a2e_msg;
#else
    src = (uint32_t*) msg_buf;
#endif
    dst = (uint32_t*)&amp;(env-&gt;shared-&gt;msg_a2e_buf.msg);

    // Copy the message in the IPC queue
    for (i=0; i&lt;len; i+=4)
    {
        *dst++ = *src++;
    }

    env-&gt;msga2e_hostid = msg_buf;

    // Trigger the irq to send the message to EMB
    ipc_app2emb_trigger_set(IPC_IRQ_A2E_MSG);

    REG_SW_CLEAR_PROFILING(env-&gt;pthis, SW_PROF_IPC_MSGPUSH);

    return 0;
}
</code></pre>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/wifi-connect9.png" alt="ipc_host_msg_push" /></p>
<h2 id="trigger-lmac-interrupt" class="section-header"><a href="#trigger-lmac-interrupt">2.4 Trigger LMAC Interrupt</a></h2>
<p>TODO9</p>
<p>From <a href="https://github.com/lupyuen/bl_iot_sdk/blob/master/components/bl602/bl602_wifidrv/bl60x_wifi_driver/reg_ipc_app.h#L41-L69"><code>reg_ipc_app.h</code></a></p>
<pre><code class="language-c">#define REG_WIFI_REG_BASE         0x44000000
#define REG_IPC_APP_DECODING_MASK 0x0000007F

/**
 * @brief APP2EMB_TRIGGER register definition
 * &lt;pre&gt;
 *   Bits           Field Name   Reset Value
 *  -----   ------------------   -----------
 *  31:00      APP2EMB_TRIGGER   0x0
 * &lt;/pre&gt;
 */
#define IPC_APP2EMB_TRIGGER_ADDR   0x12000000
#define IPC_APP2EMB_TRIGGER_OFFSET 0x00000000
#define IPC_APP2EMB_TRIGGER_INDEX  0x00000000
#define IPC_APP2EMB_TRIGGER_RESET  0x00000000

#ifndef __INLINE
#define __INLINE inline
#endif

static __INLINE u32 ipc_app2emb_trigger_get()
{
    return REG_IPC_APP_RD(REG_WIFI_REG_BASE, IPC_APP2EMB_TRIGGER_INDEX);
}

static __INLINE void ipc_app2emb_trigger_set(u32 value)
{
    REG_IPC_APP_WR(REG_WIFI_REG_BASE, IPC_APP2EMB_TRIGGER_INDEX, value);
}
</code></pre>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/wifi-connect8.png" alt="ipc_app2emb_trigger_set" /></p>
<p>TODO8</p>
<p><img src="https://lupyuen.github.io/images/wifi-connect7.png" alt="" /></p>
<p>TODO7</p>
<h1 id="decompiled-wifi-demo-firmware" class="section-header"><a href="#decompiled-wifi-demo-firmware">3 Decompiled WiFi Demo Firmware</a></h1>
<p><em>Are we really Reverse Engineering the BL602 WiFi Driver?</em></p>
<p>Not quite. So far we‚Äôve been reading the published source code for the BL602 WiFi Driver.</p>
<p>TODO</p>
<p><a href="https://github.com/BraveHeartFLOSSDev"><code>BraveHeartFLOSSDev</code></a> did an excellent job decompiling into C (with Ghidra) the BL602 WiFi Demo Firmware‚Ä¶</p>
<ul>
<li><a href="https://github.com/BraveHeartFLOSSDev/bl602nutcracker1"><strong>BraveHeartFLOSSDev/bl602nutcracker1</strong></a></li>
</ul>
<p><a href="https://github.com/lupyuen/bl602nutcracker1">(We‚Äôll use this fork)</a></p>
<h2 id="linking-to-decompiled-code" class="section-header"><a href="#linking-to-decompiled-code">3.1 Linking to decompiled code</a></h2>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/wifi-assert.png" alt="" /></p>
<p>TODO</p>
<h1 id="wifi-firmware-task" class="section-header"><a href="#wifi-firmware-task">4 WiFi Firmware Task</a></h1>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/wifi-task.png" alt="" /></p>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/wifi-task2.png" alt="" /></p>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/wifi-task3.png" alt="" /></p>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/wifi-task4.png" alt="" /></p>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/wifi-task5.png" alt="" /></p>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/wifi-task6.png" alt="" /></p>
<p>TODO</p>
<h1 id="ceva-rivierawaves" class="section-header"><a href="#ceva-rivierawaves">5 CEVA RivieraWaves</a></h1>
<p>TODO</p>
<ul>
<li><a href="https://github.com/mclown/AliOS-Things/tree/master/platform/mcu/bk7231u/beken/ip"><strong>mclown/AliOS-Things</strong></a></li>
</ul>
<p><a href="https://github.com/lupyuen/AliOS-Things/tree/master/platform/mcu/bk7231u/beken/ip">(We‚Äôll use this fork)</a></p>
<p><img src="https://lupyuen.github.io/images/wifi-rivierawaves.png" alt="" /></p>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/wifi-ceva.png" alt="" /></p>
<p><a href="https://csimarket.com/stocks/markets_glance.php?code=CEVA#:%7E:text=Included%20among%20our%20licensees%20are,%2C%20RDA%2C%20Renesas%2C%20Rockchip%2C">(Source)</a></p>
<h1 id="upper-medium-access-control-layer" class="section-header"><a href="#upper-medium-access-control-layer">6 Upper Medium Access Control Layer</a></h1>
<p>TODO</p>
<h1 id="lower-medium-access-control-layer" class="section-header"><a href="#lower-medium-access-control-layer">7 Lower Medium Access Control Layer</a></h1>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/wifi-lmac.jpg" alt="" /></p>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/wifi-lmac2.jpg" alt="" /></p>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/wifi-lmac3.jpg" alt="" /></p>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/wifi-beken.jpg" alt="" /></p>
<p><a href="http://www.bekencorp.com/en/goods/detail/cid/13.html">(Source)</a></p>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/wifi-beken2.png" alt="" /></p>
<p>TODO</p>
<h1 id="wifi-phy-layer" class="section-header"><a href="#wifi-phy-layer">8 WiFi PHY Layer</a></h1>
<p>TODO</p>
<ul>
<li><a href="https://github.com/jixinintelligence/bl602-604"><strong>jixinintelligence/bl602-604</strong></a></li>
</ul>
<p><a href="https://github.com/lupyuen/bl602-604">(We‚Äôll use this fork)</a></p>
<p><img src="https://lupyuen.github.io/images/wifi-phy.png" alt="" /></p>
<p>TODO</p>
<h2 id="wifi-rtl" class="section-header"><a href="#wifi-rtl">8.1 WiFi RTL</a></h2>
<p>TODO</p>
<p>According to <a href="https://twitter.com/madushan1000/status/1409392882612637696"><strong>madushan1000 on Twitter</strong></a>‚Ä¶</p>
<ul>
<li>
<p><a href="https://github.com/fengmaoqiao/my_logic_code"><strong>fengmaoqiao/my_logic_code</strong></a></p>
</li>
<li>
<p><a href="https://github.com/fengmaoqiao/workplace"><strong>fengmaoqiao/workplace</strong></a></p>
</li>
</ul>
<h1 id="wifi-supplicant" class="section-header"><a href="#wifi-supplicant">9 WiFi Supplicant</a></h1>
<p>TODO: Rockchip RK3399</p>
<ul>
<li><a href="https://github.com/karthirockz/rk3399-kernel/tree/main/drivers/net/wireless/rockchip_wlan/mvl88w8977/mlan/esa"><strong>karthirockz/rk3399-kernel</strong></a></li>
</ul>
<p><a href="https://github.com/lupyuen/rk3399-kernel/tree/main/drivers/net/wireless/rockchip_wlan/mvl88w8977/mlan/esa">(We‚Äôll use this fork)</a></p>
<p><img src="https://lupyuen.github.io/images/wifi-rockchip.jpg" alt="" /></p>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/wifi-supplicant.png" alt="" /></p>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/wifi-supplicant2.png" alt="" /></p>
<p>TODO</p>
<h1 id="quantitative-analysis" class="section-header"><a href="#quantitative-analysis">10 Quantitative Analysis</a></h1>
<p>TODO</p>
<ul>
<li>
<p><a href="https://docs.google.com/spreadsheets/d/1C_XmkH-ZSXz9-V2HsYBv7K1KRx3RF3-zsoJRLh1GwxI/edit?usp=sharing">Google Sheets</a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/bl602nutcracker1/blob/main/bl602_demo_wifi.ods">LibreOffice / OpenOffice Format</a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/bl602nutcracker1/blob/main/bl602_demo_wifi.xlsx">Excel Format</a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/bl602nutcracker1/blob/main/bl602_demo_wifi.csv">CSV Format (without analysis)</a></p>
</li>
</ul>
<p><img src="https://lupyuen.github.io/images/wifi-quantify.png" alt="" /></p>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/wifi-quantify2.png" alt="" /></p>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/wifi-quantify3.png" alt="" /></p>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/wifi-quantify4.png" alt="" /></p>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/wifi-title.jpg" alt="Quantitative Analysis of Decompiled BL602 WiFi Firmware" /></p>
<h1 id="other-components" class="section-header"><a href="#other-components">11 Other Components</a></h1>
<p>TODO: BL602 HAL, BL602 Standard Driver, LWIP, MbedTLS, FreeRTOS, AliOS, AWS MQTT, AWS IoT</p>
<h1 id="github-search-is-our-best-friend" class="section-header"><a href="#github-search-is-our-best-friend">12 GitHub Search Is Our Best Friend!</a></h1>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/wifi-schedule.png" alt="" /></p>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/wifi-schedule2.png" alt="" /></p>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/wifi-schedule3.png" alt="" /></p>
<p>TODO</p>
<h1 id="whats-next" class="section-header"><a href="#whats-next">13 What‚Äôs Next</a></h1>
<p>TODO</p>
<ul>
<li>
<p><a href="https://github.com/sponsors/lupyuen">Sponsor me a coffee</a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/book">Read ‚ÄúThe RISC-V BL602 Book‚Äù</a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io">Check out my articles</a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/rss.xml">RSS Feed</a></p>
</li>
</ul>
<p><em>Got a question, comment or suggestion? Create an Issue or submit a Pull Request here‚Ä¶</em></p>
<p><a href="https://github.com/lupyuen/lupyuen.github.io/blob/master/src/wifi.md"><code>lupyuen.github.io/src/wifi.md</code></a></p>
<h1 id="notes" class="section-header"><a href="#notes">14 Notes</a></h1>
<ol>
<li>This article is the expanded version of <a href="https://twitter.com/MisterTechBlog/status/1407971263088193540">this Twitter Thread</a></li>
</ol>

    
</body>
</html>