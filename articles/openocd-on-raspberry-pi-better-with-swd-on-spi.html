<!doctype html>
<html lang="en">

<head>
  <script src="//archive.org/includes/analytics.js?v=cf34f82" type="text/javascript"></script>
  <script
    type="text/javascript">window.addEventListener('DOMContentLoaded', function () { var v = archive_analytics.values; v.service = 'wb'; v.server_name = 'wwwb-app39.us.archive.org'; v.server_ms = 263; archive_analytics.send_pageview({}); });</script>
  <script type="text/javascript" src="/_static/js/playback.bundle.js?v=bQvHU8mx" charset="utf-8"></script>
  <script type="text/javascript" src="/_static/js/wombat.js?v=cRqOKCOw" charset="utf-8"></script>
  <script type="text/javascript">
    __wm.init("https://web.archive.org/web");
    __wm.wombat("https://medium.com/@ly.lee/openocd-on-raspberry-pi-better-with-swd-on-spi-7dea9caeb590", "20200117210221", "https://web.archive.org/", "web", "/_static/",
      "1579294941");
  </script>
  <link rel="stylesheet" type="text/css" href="/_static/css/banner-styles.css?v=bsmaklHF" />
  <link rel="stylesheet" type="text/css" href="/_static/css/iconochive.css?v=qtvMKcIJ" />
  <!-- End Wayback Rewrite JS Include -->
  <script>!function (c, f) { var t, o, i, e = [], r = { passive: !0, capture: !0 }, n = new Date, a = "pointerup", u = "pointercancel"; function p(n, e) { t || (t = e, o = n, i = new Date, w(f), s()) } function s() { 0 <= o && o < i - n && (e.forEach(function (n) { n(o, t) }), e = []) } function l(n) { if (n.cancelable) { var e = (1e12 < n.timeStamp ? new Date : performance.now()) - n.timeStamp; "pointerdown" == n.type ? function (n, e) { function t() { p(n, e), i() } function o() { i() } function i() { f(a, t, r), f(u, o, r) } c(a, t, r), c(u, o, r) }(e, n) : p(e, n) } } function w(e) { ["click", "mousedown", "keydown", "touchstart", "pointerdown"].forEach(function (n) { e(n, l, r) }) } w(c), self.perfMetrics = self.perfMetrics || {}, self.perfMetrics.onFirstInputDelay = function (n) { e.push(n), s() } }(addEventListener, removeEventListener)</script>
  <title data-rh="true">OpenOCD on Raspberry Pi: Better with SWD on SPI - Lup Yuen Lee 李立源 - Medium</title>
  <meta data-rh="true" charset="utf-8" />
  <meta data-rh="true" name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1" />
  <meta data-rh="true" name="theme-color" content="#000000" />
  <meta data-rh="true" name="twitter:app:name:iphone" content="Medium" />
  <meta data-rh="true" name="twitter:app:id:iphone" content="828256236" />
  <meta data-rh="true" property="al:ios:app_name" content="Medium" />
  <meta data-rh="true" property="al:ios:app_store_id" content="828256236" />
  <meta data-rh="true" property="al:android:package" content="com.medium.reader" />
  <meta data-rh="true" property="fb:app_id" content="542599432471018" />
  <meta data-rh="true" property="og:site_name" content="Medium" />
  <meta data-rh="true" property="og:type" content="article" />
  <meta data-rh="true" property="article:published_time" content="2020-01-17T20:47:26.370Z" />
  <meta data-rh="true" name="title"
    content="OpenOCD on Raspberry Pi: Better with SWD on SPI - Lup Yuen Lee 李立源 - Medium" />
  <meta data-rh="true" property="og:title" content="OpenOCD on Raspberry Pi: Better with SWD on SPI" />
  <meta data-rh="true" property="twitter:title" content="OpenOCD on Raspberry Pi: Better with SWD on SPI" />
  <meta data-rh="true" name="twitter:site" content="@Medium" />
  <meta data-rh="true" name="twitter:app:url:iphone" content="medium://p/7dea9caeb590" />
  <meta data-rh="true" property="al:android:url" content="medium://p/7dea9caeb590" />
  <meta data-rh="true" property="al:ios:url" content="medium://p/7dea9caeb590" />
  <meta data-rh="true" property="al:android:app_name" content="Medium" />
  <meta data-rh="true" name="description"
    content="The setup that we see above… Debugging nRF52 with a Raspberry Pi running VSCode and OpenOCD… Was impossible just a week ago! OpenOCD connects to nRF52 for flashing and debugging by running Arm’s SWD…" />
  <meta data-rh="true" property="og:description" content="Sneaky tricks to align stray bits into proper bytes" />
  <meta data-rh="true" property="twitter:description" content="Sneaky tricks to align stray bits into proper bytes" />
  <meta data-rh="true" property="og:url"
    content="https://web.archive.org/web/20200117210221/https://medium.com/@ly.lee/openocd-on-raspberry-pi-better-with-swd-on-spi-7dea9caeb590" />
  <meta data-rh="true" property="al:web:url"
    content="https://medium.com/@ly.lee/openocd-on-raspberry-pi-better-with-swd-on-spi-7dea9caeb590" />
  <meta data-rh="true" property="og:image"
    content="https://web.archive.org/web/20200117210221im_/https://miro.medium.com/max/1200/1*I26BDuv0_N07S2JD_PZYWA.jpeg" />
  <meta data-rh="true" name="twitter:image:src"
    content="https://miro.medium.com/max/1200/1*I26BDuv0_N07S2JD_PZYWA.jpeg" />
  <meta data-rh="true" name="twitter:card" content="summary_large_image" />
  <meta data-rh="true" property="article:author" content="https://medium.com/@ly.lee" />
  <meta data-rh="true" name="twitter:creator" content="@MisterTechBlog" />
  <meta data-rh="true" name="author" content="Lup Yuen Lee 李立源" />
  <meta data-rh="true" name="robots" content="index,follow" />
  <meta data-rh="true" name="referrer" content="unsafe-url" />
  <meta data-rh="true" name="twitter:label1" value="Reading time" />
  <meta data-rh="true" name="twitter:data1" value="12 min read" />
  <meta data-rh="true" name="parsely-post-id" content="7dea9caeb590" />
  <link data-rh="true" rel="search" type="application/opensearchdescription+xml" title="Medium"
    href="/web/20200117210221/https://medium.com/osd.xml" />
  <link data-rh="true" rel="apple-touch-icon" sizes="152x152"
    href="https://web.archive.org/web/20200117210221im_/https://cdn-images-1.medium.com/fit/c/152/152/1*8I-HPL0bfoIzGied-dzOvA.png" />
  <link data-rh="true" rel="apple-touch-icon" sizes="120x120"
    href="https://web.archive.org/web/20200117210221im_/https://cdn-images-1.medium.com/fit/c/120/120/1*8I-HPL0bfoIzGied-dzOvA.png" />
  <link data-rh="true" rel="apple-touch-icon" sizes="76x76"
    href="https://web.archive.org/web/20200117210221im_/https://cdn-images-1.medium.com/fit/c/76/76/1*8I-HPL0bfoIzGied-dzOvA.png" />
  <link data-rh="true" rel="apple-touch-icon" sizes="60x60"
    href="https://web.archive.org/web/20200117210221im_/https://cdn-images-1.medium.com/fit/c/60/60/1*8I-HPL0bfoIzGied-dzOvA.png" />
  <link data-rh="true" rel="mask-icon"
    href="https://web.archive.org/web/20200117210221im_/https://cdn-static-1.medium.com/_/fp/icons/monogram-mask.KPLCSFEZviQN0jQ7veN2RQ.svg"
    color="#171717" />
  <link data-rh="true" rel="icon"
    href="https://web.archive.org/web/20200117210221im_/https://cdn-static-1.medium.com/_/fp/icons/favicon-rebrand-medium.3Y6xpZ-0FSdWDnPM3hSBIA.ico" />
  <link data-rh="true" id="glyph_link" rel="stylesheet" type="text/css"
    href="https://web.archive.org/web/20200117210221cs_/https://glyph.medium.com/css/e/sr/latin/e/ssr/latin/e/ssb/latin/m2.css" />
  <link data-rh="true" rel="author" href="https://medium.com/@ly.lee" />
  <link data-rh="true" rel="canonical"
    href="https://web.archive.org/web/20200117210221/https://medium.com/@ly.lee/openocd-on-raspberry-pi-better-with-swd-on-spi-7dea9caeb590" />
  <link data-rh="true" rel="alternate"
    href="https://web.archive.org/web/20200117210221/android-app://com.medium.reader/https/medium.com/p/7dea9caeb590" />
  <script data-rh="true"
    type="application/ld+json">{"@context":"https:\u002F\u002Fweb.archive.org\u002Fweb\u002F20200117210221\u002Fhttp:\u002F\u002Fschema.org","@type":"NewsArticle","image":["https:\u002F\u002Fweb.archive.org\u002Fweb\u002F20200117210221\u002Fhttps:\u002F\u002Fmiro.medium.com\u002Fmax\u002F1200\u002F1*I26BDuv0_N07S2JD_PZYWA.jpeg"],"url":"https:\u002F\u002Fweb.archive.org\u002Fweb\u002F20200117210221\u002Fhttps:\u002F\u002Fmedium.com\u002F@ly.lee\u002Fopenocd-on-raspberry-pi-better-with-swd-on-spi-7dea9caeb590","dateCreated":"2020-01-17T20:28:51.976Z","datePublished":"2020-01-17T20:28:51.976Z","dateModified":"2020-01-17T20:47:26.957Z","headline":"OpenOCD on Raspberry Pi: Better with SWD on SPI","name":"OpenOCD on Raspberry Pi: Better with SWD on SPI","description":"The setup that we see above… Debugging nRF52 with a Raspberry Pi running VSCode and OpenOCD… Was impossible just a week ago! OpenOCD connects to nRF52 for flashing and debugging by running Arm’s SWD…","identifier":"7dea9caeb590","keywords":["Lite:true","Tag:Raspberry Pi","Tag:Spi","Tag:Nrf52","Tag:Openocd","Tag:Internet of Things","Elevated:false","LockedPostSource:LOCKED_POST_SOURCE_NONE","LayerCake:0"],"author":{"@type":"Person","name":"Lup Yuen Lee 李立源","url":"https:\u002F\u002Fweb.archive.org\u002Fweb\u002F20200117210221\u002Fhttps:\u002F\u002Fmedium.com\u002F@ly.lee"},"creator":["Lup Yuen Lee 李立源"],"publisher":{"@type":"Organization","name":"Medium","url":"https:\u002F\u002Fweb.archive.org\u002Fweb\u002F20200117210221\u002Fhttps:\u002F\u002Fmedium.com\u002F","logo":{"@type":"ImageObject","width":308,"height":60,"url":"https:\u002F\u002Fweb.archive.org\u002Fweb\u002F20200117210221\u002Fhttps:\u002F\u002Fmiro.medium.com\u002Fmax\u002F616\u002F1*OMF3fSqH8t4xBJ9-6oZDZw.png"}},"mainEntityOfPage":"https:\u002F\u002Fweb.archive.org\u002Fweb\u002F20200117210221\u002Fhttps:\u002F\u002Fmedium.com\u002F@ly.lee\u002Fopenocd-on-raspberry-pi-better-with-swd-on-spi-7dea9caeb590"}</script>
  <script data-rh="true">(function (i, s, o, g, r, a, m) {
        i['GoogleAnalyticsObject'] = r; i[r] = i[r] || function () {
          (i[r].q = i[r].q || []).push(arguments)
        }, i[r].l = 1 * new Date(); a = s.createElement(o),
          m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; m.parentNode.insertBefore(a, m)
      })(window, document, 'script', 'https://web.archive.org/web/20200117210221/https://www.google-analytics.com/analytics.js', 'ga');
    ga('create', 'UA-24232453-2', 'auto');
    ga('send', 'pageview');</script>
  <link rel="preload" href="https://web.archive.org/web/20200117210221/https://cdn.optimizely.com/js/16180790160.js"
    as="script">

    <!-- Begin scripts/rustdoc-header.html: Header for Custom Markdown files processed by rustdoc, like chip8.md -->
  <link rel="alternate" type="application/rss+xml" title="RSS Feed for lupyuen" href="/rss.xml" />
  <link rel="stylesheet" type="text/css" href="../normalize.css">
  <link rel="stylesheet" type="text/css" href="../rustdoc.css" id="mainThemeStyle">
  <link rel="stylesheet" type="text/css" href="../dark.css">
  <link rel="stylesheet" type="text/css" href="../light.css" id="themeStyle">
  <link rel="stylesheet" type="text/css" href="../prism.css">
  <script src="../storage.js"></script><noscript>
  <link rel="stylesheet" href="../noscript.css"></noscript>
  <link rel="shortcut icon" href="../favicon.ico">
  <style type="text/css">
      #crate-search {
          background-image: url("../down-arrow.svg");
      }
      a {
          color: #77d;
      }
  </style>
  <!-- End scripts/rustdoc-header.html -->

</head>

<body>
  <div id="root">
    <div class="a b c">
      <div class="d e f g h i j k"></div>
      <script>document.domain = document.domain;</script>
      <script>window.PARSELY = window.PARSELY || { autotrack: false }</script>
      <div class="ch al r ci am"></div>
      <article>
        <section class="cj ck cl cm ak cn ce n co"></section><span class="r"></span>
        <div>
          <div class="cp u cq cr cs ct"></div>
          <section class="cu cv cw cx cy">
            <div class="cz ak">

              <!-- <figure class="da cz ak paragraph-image">
                <div class="db dc dd de ak">
                  <div class="dl r dd dm">
                    <div class="dn r">
                      <div class="df dg cp t u dh ak di dj dk"><img class="cp t u dh ak do dp dq"
                          src="https://web.archive.org/web/20200117210221im_/https://miro.medium.com/max/60/1*I26BDuv0_N07S2JD_PZYWA.jpeg?q=20"
                          width="4032" height="3024" role="presentation" /></div><img class="df dg cp t u dh ak dr"
                        width="4032" height="3024" role="presentation" /><noscript><img class="cp t u dh ak"
                          src="https://web.archive.org/web/20200117210221im_/https://miro.medium.com/max/8064/1*I26BDuv0_N07S2JD_PZYWA.jpeg"
                          width="4032" height="3024" role="presentation" /></noscript>
                    </div>
                  </div>
                </div>
                <figcaption class="bo ds dt du dv cn cl cm dw dx bj dy"></figcaption>
              </figure> -->

              <p><img src="https://lupyuen.github.io/images/legacy/d1.jpeg" /></p>
              <p><em>Debugging nRF52 with a Raspberry Pi 4 running
                VSCode and OpenOCD with SWD over SPI at 31 MHz</em></p>

            </div>
            <div class="n p">
              <div class="ac ae af ag ah dz aj ak">
                <div>
                  <div id="2f47" class="ea eb ec bk ed b ee ef eg eh ei ej ek el em en eo">
                    <h1 class="ed b ee ep eg eq ei er ek es em et ec">OpenOCD on Raspberry Pi: Better with SWD on SPI
                    </h1>
                  </div>
                  <div class="eu">
                    <div class="n ev ew ex ey">
                      <div class="o n">
                        <div><a rel="noopener"
                            href="/web/20200117210221/https://medium.com/@ly.lee?source=post_page-----7dea9caeb590----------------------">
                            <div class="dd ez fa">
                              <div class="bs n fb o p cp fc fd fe ff fg ct"></div><img alt="Lup Yuen Lee 李立源" class="r fh fa ez"
                                src="https://web.archive.org/web/20200117210221im_/https://miro.medium.com/fit/c/96/96/1*KGohS3sQaUnr58gc0BIfoQ.jpeg"
                                width="48" height="48" />
                            </div>
                          </a></div>
                        <div class="fi ak r">
                          <div class="n">
                            <div style="flex:1"><span class="bj b bk bl bm bn r ec q">
                                <div class="fj n o fk"><span class="bj dy ds bl di fl fm fn fo fp ec"><a
                                      class="at au av aw ax ay az ba bb bc fq bf bg bh bi" rel="noopener"
                                      href="/web/20200117210221/https://medium.com/@ly.lee?source=post_page-----7dea9caeb590----------------------">Lup
                                      Yuen Lee 李立源</a></span>
                                  <div class="fr r ar h"><button
                                      class="fs ec q by ft fu fv fw bc bh fx fy fz ga gb gc cb bj b bk gd ge bn cc cd ce cf cg bf">Follow</button>
                                  </div>
                                </div>
                              </span></div>
                          </div><span class="bj b bk bl bm bn r bo bp"><span class="bj dy ds bl di fl fm fn fo fp bo">
                              <div><a class="at au av aw ax ay az ba bb bc fq bf bg bh bi" rel="noopener"
                                  href="/web/20200117210221/https://medium.com/@ly.lee/openocd-on-raspberry-pi-better-with-swd-on-spi-7dea9caeb590?source=post_page-----7dea9caeb590----------------------">Jan
                                  17</a> <!-- -->·
                                <!-- -->
                                <!-- -->12
                                <!-- --> min read
                              </div>
                            </span></span>
                        </div>
                      </div>
                      <div class="n gf gg gh gi gj gk gl gm ab">
                        <div class="n o">
                          <div class="gn r ar"><a
                              href="//web.archive.org/web/20200117210221/https://medium.com/p/7dea9caeb590/share/twitter?source=post_actions_header---------------------------"
                              class="at au av aw ax ay az ba bb bc bd be bf bg bh bi" target="_blank"
                              rel="noopener nofollow"></a></div>
                          <div class="gn r ar"><a
                              href="//web.archive.org/web/20200117210221/https://medium.com/p/7dea9caeb590/share/facebook?source=post_actions_header---------------------------"
                              class="at au av aw ax ay az ba bb bc bd be bf bg bh bi" target="_blank"
                              rel="noopener nofollow"></a></div>
                          <div class="go r ao"><a
                              href="https://web.archive.org/web/20200117210221/https://medium.com/m/signin?operation=register&amp;redirect=https%3A%2F%2Fmedium.com%2F%40ly.lee%2Fopenocd-on-raspberry-pi-better-with-swd-on-spi-7dea9caeb590&amp;source=post_actions_header--------------------------bookmark_sidebar-"
                              class="at au av aw ax ay az ba bb bc bd be bf bg bh bi" rel="noopener"></a></div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <p id="03ff" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc"><em class="hd">Sneaky tricks to
                    align stray bits into proper bytes</em></p>
                <p id="8f9a" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc">The setup that we see above…
                  Debugging nRF52 with a Raspberry Pi running <a
                    href="https://web.archive.org/web/20200117210221/https://code.headmelted.com/"
                    class="at cg he hf hg hh" target="_blank" rel="noopener nofollow">VSCode</a> and <a
                    href="https://web.archive.org/web/20200117210221/http://openocd.org/doc/html/About.html#What-is-OpenOCD_003f"
                    class="at cg he hf hg hh" target="_blank" rel="noopener nofollow">OpenOCD</a>… <em class="hd">Was
                    impossible just a week ago!</em></p>
                <p id="7df9" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc">OpenOCD connects to nRF52 for
                  flashing and debugging by running <a
                    href="https://web.archive.org/web/20200117210221/https://github.com/MarkDing/swd_programing_sram"
                    class="at cg he hf hg hh" target="_blank" rel="noopener nofollow">Arm’s SWD protocol</a> over GPIO
                  <a href="https://web.archive.org/web/20200117210221/https://en.wikipedia.org/wiki/Bit_banging"
                    class="at cg he hf hg hh" target="_blank" rel="noopener nofollow">Bit Banging</a>. OpenOCD was
                  sending data to nRF52 one bit at a time… Works fine when OpenOCD is the only task running, <em
                    class="hd">not when it’s sharing the CPU with VSCode and other interactive tasks!</em></p>
                <p id="fb26" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc">That’s because multitasking skews
                  the precise timing that’s needed by OpenOCD to send each bit correctly.</p>
                <p id="f9c9" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc">Instead of sending data over GPIO
                  one bit at a time, <em class="hd">what if we could blast out the data over </em><a
                    href="https://web.archive.org/web/20200117210221/https://www.raspberrypi.org/documentation/hardware/raspberrypi/spi/README.md"
                    class="at cg he hf hg hh" target="_blank" rel="noopener nofollow"><em class="hd">Raspberry Pi’s SPI
                      interface</em></a><em class="hd">?</em></p>
                <p id="72df" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc">SPI is implemented as a <a
                    href="https://web.archive.org/web/20200117210221/https://github.com/raspberrypi/linux/blob/rpi-3.12.y/drivers/spi/spi-bcm2708.c"
                    class="at cg he hf hg hh" target="_blank" rel="noopener nofollow">kernel mode driver</a> with
                  interrupts, so it runs with high CPU priority. Raspberry Pi’s <a
                    href="https://web.archive.org/web/20200117210221/https://www.raspberrypi.org/documentation/hardware/raspberrypi/bcm2835/BCM2835-ARM-Peripherals.pdf"
                    class="at cg he hf hg hh" target="_blank" rel="noopener nofollow">Broadcom microcontroller</a> fully
                  supports Bidirectional SPI with precise clocking and buffering. <em class="hd">Why not use SPI for
                    SWD?</em></p>
                <p id="d4a6" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc">This article explains how we did
                  that… By overcoming some interesting bitwise challenges. First let’s learn the SWD protocol…</p>
              </div>
            </div>
          </section>
          <hr class="hi dy hj hk hl dv hm hn ho hp hq" />
          <section class="cu cv cw cx cy">
            <div class="n p">
              <div class="ac ae af ag ah dz aj ak">
                <h1 id="d19a" class="hr hs ec bk bj ht ee hu eg hv hw hx hy hz ia ib ic">SWD Read Operation</h1>
                <p id="b69d" class="gp gq ec bk gr b gs id gu ie gw if gy ig ha ih hc">For Raspberry Pi to read an SWD
                  Register on nRF52, we perform an SWD Read Operation like this (Raspberry Pi is the host,
                  PineTime/nRF52 is the target)…</p>
              </div>
            </div>
            <div class="cz ak">

              <!-- <figure class="ii ij ik il im cz ak paragraph-image">
                <div class="dl r dd dm">
                  <div class="in r">
                    <div class="df dg cp t u dh ak di dj dk"><img class="cp t u dh ak do dp dq"
                        src="https://web.archive.org/web/20200117210221im_/https://miro.medium.com/max/60/1*vzRJDQaOchn48p1rU5Gleg.png?q=20"
                        width="1841" height="199" role="presentation" /></div><img class="df dg cp t u dh ak dr"
                      width="1841" height="199" role="presentation" /><noscript><img class="cp t u dh ak"
                        src="https://web.archive.org/web/20200117210221im_/https://miro.medium.com/max/3682/1*vzRJDQaOchn48p1rU5Gleg.png"
                        width="1841" height="199" role="presentation" /></noscript>
                  </div>
                </div>
                <figcaption class="bo ds dt du dv cn cl cm dw dx bj dy"></figcaption>
              </figure> -->

              <p><img src="https://lupyuen.github.io/images/legacy/d2.png" /></p>
              <p><em>SWD Read Operation with 2 undefined trailing
                bits. From <a
                  href="https://web.archive.org/web/20200117210221/https://docs.google.com/spreadsheets/d/12oXe1MTTEZVIbdmFXsOgOXVFHCQnYVvIw6fRpIQZybg/edit#gid=0"
                  class="at cg he hf hg hh" target="_blank"
                  rel="noopener nofollow">https://docs.google.com/spreadsheets/d/12oXe1MTTEZVIbdmFXsOgOXVFHCQnYVvIw6fRpIQZybg/edit#gid=0</a>
              </em></p>

            </div>
            <div class="n p">
              <div class="ac ae af ag ah dz aj ak">
                <p id="0038" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc">Here we are reading the <strong
                    class="gr io">IDCODE (Identification Code) Register</strong>, which identifies the Arm Debug
                  Interface (<code class="dm ip iq ir is b">0x2ba01477</code> for nRF52). IDCODE is Register #0 (in Read
                  Mode), so we set <code class="dm ip iq ir is b">A2</code> and <code class="dm ip iq ir is b">A3</code>
                  (bits 2 and 3 of the register number) to <code class="dm ip iq ir is b">0</code>.</p>
                <p id="1f2d" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc"><strong class="gr io"><em
                      class="hd">Pi → nRF52: 8 bits…</em></strong></p>
                <figure class="ii ij ik il im cz cl cm paragraph-image">
                  <div class="db dc dd de ak">
                    <div class="cl cm it">
                      <div class="dl r dd dm">
                        <div class="iu r">
                          <div class="df dg cp t u dh ak di dj dk"><img class="cp t u dh ak do dp dq"
                              src="https://web.archive.org/web/20200117210221im_/https://miro.medium.com/max/60/1*f7T3HilgTJ1f4v772LPUjg.png?q=20"
                              width="725" height="134" role="presentation" /></div><img class="df dg cp t u dh ak dr"
                            width="725" height="134" role="presentation" /><noscript><img class="cp t u dh ak"
                              src="https://web.archive.org/web/20200117210221im_/https://miro.medium.com/max/1450/1*f7T3HilgTJ1f4v772LPUjg.png"
                              width="725" height="134" role="presentation" /></noscript>
                        </div>
                      </div>
                    </div>
                  </div>
                  <figcaption class="bo ds dt du dv cn cl cm dw dx bj dy"></figcaption>
                </figure>

                <p><img src="https://lupyuen.github.io/images/legacy/d3.jpeg" /></p>
                <p><em>From Pi to nRF52</em></p>

                <p id="57c4" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc">Pi sends <code
                    class="dm ip iq ir is b">0xA5</code> (least significant bit first) to nRF52. That’s followed by
                  <code class="dm ip iq ir is b">Trn</code>, the Turnaround Bit. This bit gives 1 clock cycle of
                  breathing space whenever we flip the transmission from Pi to nRF52 and back. The value of <code
                    class="dm ip iq ir is b">Trn</code> doesn’t matter.</p>
                <p id="f84f" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc"><strong class="gr io"><em
                      class="hd">nRF52 → Pi: 38 bits (including turnaround)…</em></strong></p>
              </div>
            </div>
            <div class="cz ak">
              <!-- <figure class="ii ij ik il im cz ak paragraph-image">
                <div class="dl r dd dm">
                  <div class="iv r">
                    <div class="df dg cp t u dh ak di dj dk"><img class="cp t u dh ak do dp dq"
                        src="https://web.archive.org/web/20200117210221im_/https://miro.medium.com/max/60/1*rKTQ1FpshTHYiJ2ojmyowQ.png?q=20"
                        width="1465" height="133" role="presentation" /></div><img class="df dg cp t u dh ak dr"
                      width="1465" height="133" role="presentation" /><noscript><img class="cp t u dh ak"
                        src="https://web.archive.org/web/20200117210221im_/https://miro.medium.com/max/2930/1*rKTQ1FpshTHYiJ2ojmyowQ.png"
                        width="1465" height="133" role="presentation" /></noscript>
                  </div>
                </div>
                <figcaption class="bo ds dt du dv cn cl cm dw dx bj dy"></figcaption>
              </figure> -->

              <p><img src="https://lupyuen.github.io/images/legacy/d4.jpeg" /></p>
              <p><em>From nRF52 to Pi</em></p>

            </div>
            <div class="n p">
              <div class="ac ae af ag ah dz aj ak">
                <p id="2fed" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc">nRF52 responds with the
                  Acknowledgement <code class="dm ip iq ir is b">100</code> (which means OK). Followed by 32 bits of
                  data (the value of Register IDCODE), a Parity bit, and another Turnaround Bit.</p>
                <p id="b426" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc">Now let’s see whether Raspberry
                  Pi’s SPI interface will allow us to send and receive this kind of data.</p>
                <p id="ecb9" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc"><strong class="gr io"><em
                      class="hd">Missing: 2 bits…</em></strong></p>

                <!--
                <figure class="ii ij ik il im cz cl cm paragraph-image">
                  <div class="cl cm iw">
                    <div class="dl r dd dm">
                      <div class="ix r">
                        <div class="df dg cp t u dh ak di dj dk"><img class="cp t u dh ak do dp dq"
                            src="https://web.archive.org/web/20200117210221im_/https://miro.medium.com/max/60/1*jU0y8faClt9ZIU9v27SBjw.png?q=20"
                            width="569" height="133" role="presentation" /></div><img class="df dg cp t u dh ak dr"
                          width="569" height="133" role="presentation" /><noscript><img class="cp t u dh ak"
                            src="https://web.archive.org/web/20200117210221im_/https://miro.medium.com/max/1138/1*jU0y8faClt9ZIU9v27SBjw.png"
                            width="569" height="133" role="presentation" /></noscript>
                      </div>
                    </div>
                  </div>
                  <figcaption class="bo ds dt du dv cn cl cm dw dx bj dy"></figcaption>
                </figure>
                -->

                <p><img src="https://lupyuen.github.io/images/legacy/d5.png" /></p>
                <p><em>From nRF52 to Pi and back</em></p>

                <p id="4545" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc">Count the bits for the entire SWD
                  Read Operation (look at the red blocks)… It has 46 bits, which is <em class="hd">2 bits short of 6
                    whole bytes</em>.</p>
                <p id="730b" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc">Also the <em class="hd">last byte
                    is split across Pi and nRF52</em>… nRF52 sends 5 bits, then Turnaround, then Pi is supposed to send
                  2 bits from the next read/write operation!</p>
                <p id="c399" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc">Since Raspberry Pi’s SPI
                  interface can only send and receive whole bytes (not bits)… <em class="hd">We have a problem with the
                    last 2 stray bits!</em></p>
                <p id="55f6" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc">nRF52 gets utterly confused after
                  the SWD Read Operation. Only way to fix this? <strong class="gr io">Reset the SWD connection and
                    resynchronise by resending the JTAG-To-SWD Sequence.</strong></p>

<!--                   <figure class="ii ij ik il im cz">
                  <div class="dl r dd">
                    <div class="iy r"><iframe
                        src="https://web.archive.org/web/20200117210221if_/https://medium.com/media/f9c5ea7a23dad701b65d7eb9c486b137"
                        allowfullscreen="" frameborder="0" height="0" width="0"
                        title="See https://medium.com/@ly.lee/openocd-on-raspberry-pi-better-with-swd-on-spi-7dea9caeb590"
                        class="cp t u dh ak" scrolling="auto"></iframe></div>
                  </div>
                  <figcaption class="bo ds dt du dv cn cl cm dw dx bj dy">                  </figcaption>
                </figure>
 -->
                <p><img src="https://lupyuen.github.io/images/legacy/d6.png" /></p>
                <p><em>Sending the JTAG-To-SWD Sequence to reset SWD
                  connection. From <a
                    href="https://web.archive.org/web/20200117210221/https://github.com/lupyuen/openocd-spi/blob/master/src/jtag/swd.h"
                    class="at cg he hf hg hh" target="_blank"
                    rel="noopener nofollow">https://github.com/lupyuen/openocd-spi/blob/master/src/jtag/swd.h</a></em></p>

                <p id="05bd" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc">Yes our SWD flashing may slow
                  down when we reset the SWD connection after every SWD Read Operation… But we are now running the SWD
                  connection over SPI at a speedy <strong class="gr io">31 MHz</strong>! This compensates for the reset
                  transmission, so the overall SWD flashing is still fast.</p>

                <!-- <figure class="ii ij ik il im cz">
                  <div class="dl r dd">
                    <div class="iy r"><iframe
                        src="https://web.archive.org/web/20200117210221if_/https://medium.com/media/7512be857515198a9886ce4cab4d6475"
                        allowfullscreen="" frameborder="0" height="0" width="0"
                        title="See https://medium.com/@ly.lee/openocd-on-raspberry-pi-better-with-swd-on-spi-7dea9caeb590"
                        class="cp t u dh ak" scrolling="auto"></iframe></div>
                  </div>
                  <figcaption class="bo ds dt du dv cn cl cm dw dx bj dy">
                  </figcaption>
                </figure> -->

                <p><img src="https://lupyuen.github.io/images/legacy/d7.png" /></p>
                <p><em>After every SWD Read Operation, send the
                  JTAG-To-SWD Sequence to reset SWD connection. From <a
                    href="https://web.archive.org/web/20200117210221/https://github.com/lupyuen/openocd-spi/blob/master/src/jtag/drivers/spi.c"
                    class="at cg he hf hg hh" target="_blank"
                    rel="noopener nofollow">https://github.com/lupyuen/openocd-spi/blob/master/src/jtag/drivers/spi.c</a></em></p>

              </div>
            </div>
          </section>
          <hr class="hi dy hj hk hl dv hm hn ho hp hq" />
          <section class="cu cv cw cx cy">
            <div class="n p">
              <div class="ac ae af ag ah dz aj ak">
                <h1 id="30e6" class="hr hs ec bk bj ht ee hu eg hv hw hx hy hz ia ib ic">Throwaway SWD Read Operation
                </h1>
                <p id="fb58" class="gp gq ec bk gr b gs id gu ie gw if gy ig ha ih hc">For SWD to work over SPI, we need
                  to reset the SWD connection after every SWD Read Operation… Just send the JTAG-To-SWD Sequence! But
                  there’s a catch: <em class="hd">We MUST read IDCODE after sending the JTAG-To-SWD Sequence…</em></p>

                  <!-- <figure class="ii ij ik il im cz cl cm paragraph-image">
                  <div class="db dc dd de ak">
                    <div class="cl cm iz">
                      <div class="dl r dd dm">
                        <div class="ja r">
                          <div class="df dg cp t u dh ak di dj dk"><img class="cp t u dh ak do dp dq"
                              src="https://web.archive.org/web/20200117210221im_/https://miro.medium.com/max/60/1*ySSy6VmrSZKXhu2CQl87ig.png?q=20"
                              width="920" height="397" role="presentation" /></div><img class="df dg cp t u dh ak dr"
                            width="920" height="397" role="presentation" /><noscript><img class="cp t u dh ak"
                              src="https://web.archive.org/web/20200117210221im_/https://miro.medium.com/max/1840/1*ySSy6VmrSZKXhu2CQl87ig.png"
                              width="920" height="397" role="presentation" /></noscript>
                        </div>
                      </div>
                    </div>
                  </div>
                  <figcaption class="bo ds dt du dv cn cl cm dw dx bj dy"></a>
                  </figcaption>
                </figure> -->

                <p><img src="https://lupyuen.github.io/images/legacy/d8.png" /></p>
                <p><em>Resetting the SWD connection. From ARM® Debug
                  Interface v5 Architecture Specification <a
                    href="https://web.archive.org/web/20200117210221/https://github.com/MarkDing/swd_programing_sram/blob/master/Ref/ARM_debug.pdf"
                    class="at cg he hf hg hh" target="_blank"
                    rel="noopener nofollow">https://github.com/MarkDing/swd_programing_sram/blob/master/Ref/ARM_debug.pdf</em></p>

                <p id="d77e" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc"><em class="hd">See the problem
                    here? </em>We need to reset after reading a register… <em class="hd">And yet we need to read a
                    register (IDCODE) after resetting!</em></p>
                <p id="c12a" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc"><em class="hd">The snake eats its
                    own tail! </em>To break the snake, we use a sneaky way to read IDCODE after resetting, the Throwaway
                  Way…</p>
              </div>
            </div>
            <div class="cz ak">
              <!-- <figure class="ii ij ik il im cz ak paragraph-image">
                <div class="dl r dd dm">
                  <div class="jb r">
                    <div class="df dg cp t u dh ak di dj dk"><img class="cp t u dh ak do dp dq"
                        src="https://web.archive.org/web/20200117210221im_/https://miro.medium.com/max/60/1*4PyuAj8bjDm_SJPv_U3vbA.png?q=20"
                        width="1839" height="327" role="presentation" /></div><img class="df dg cp t u dh ak dr"
                      width="1839" height="327" role="presentation" /><noscript><img class="cp t u dh ak"
                        src="https://web.archive.org/web/20200117210221im_/https://miro.medium.com/max/3678/1*4PyuAj8bjDm_SJPv_U3vbA.png"
                        width="1839" height="327" role="presentation" /></noscript>
                  </div>
                </div>
                <figcaption class="bo ds dt du dv cn cl cm dw dx bj dy">                </figcaption>
              </figure> -->

              <p><img src="https://lupyuen.github.io/images/legacy/d9.png" /></p>
              <p><em>SWD Read Operation: Normal version (above) and
                Throwaway version (below). From <a
                  href="https://web.archive.org/web/20200117210221/https://docs.google.com/spreadsheets/d/12oXe1MTTEZVIbdmFXsOgOXVFHCQnYVvIw6fRpIQZybg/edit#gid=0"
                  class="at cg he hf hg hh" target="_blank"
                  rel="noopener nofollow">https://docs.google.com/spreadsheets/d/12oXe1MTTEZVIbdmFXsOgOXVFHCQnYVvIw6fRpIQZybg/edit#gid=0</a></em></p>

            </div>
            <div class="n p">
              <div class="ac ae af ag ah dz aj ak">
                <p id="a7ab" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc">Notice that we <em
                    class="hd">slide the entire Read IDCODE Operation two bits to the right</em>… Inserting two null
                  bits in front.</p>
                <p id="2cc8" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc"><em class="hd">Will nRF52 accept
                    the two null leading bits sent by Pi?</em> Yes because all SWD Read/Write Operations must start with
                  <code class="dm ip iq ir is b">1</code>. So it’s always OK for Pi to send null bits before and after
                  every SWD Read/Write Operation.</p>
                <p id="b4b0" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc">For a normal SWD Read Operation
                  (that’s not byte-aligned and hence problematic)…</p>
                <p id="2d5b" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc"><strong class="gr io"><em
                      class="hd">Pi → nRF52</em></strong>: 8 bits (<code class="dm ip iq ir is b">A5</code>), followed
                  by…<br /><strong class="gr io"><em class="hd">nRF52 → Pi</em></strong>: 38 bits (Data + Parity +
                  Turnaround)</p>
                <p id="b205" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc"><strong class="gr io">Total 46
                    bits</strong>, not byte-aligned, no good. For our special Throwaway version with two prepadded null
                  bits…</p>
                <p id="449e" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc"><strong class="gr io"><em
                      class="hd">Pi → nRF52</em></strong>: 48 bits (<code
                    class="dm ip iq ir is b">94 02 00 00 00 00</code>), followed by…<br /><strong class="gr io"><em
                      class="hd">nRF52 → Pi</em></strong>: 0 bits</p>
                <p id="5182" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc"><strong class="gr io">Total 48
                    bits</strong>, byte-aligned, all good! So the next SWD Read or Write Operation may be sent,
                  perfectly aligned to the byte. (If the next operation is SWD Read, we’ll have to read the register,
                  reset and read IDCODE again)</p>
                <p id="3133" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc">But it sounds like Pi is yakking
                  away over the entire SWD Read Operation, not really listening to nRF52 (and getting the value of
                  IDCODE)?</p>
                <p id="0362" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc">That’s perfectly fine… We don’t
                  really care about the value of IDCODE anyway. We are only reading IDCODE because Arm said so.</p>
                <p id="758a" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc">Thus in the SPI implementation of
                  SWD, we see this special Throwaway Read IDCODE (<code
                    class="dm ip iq ir is b">94 02 00 00 00 00</code>) that’s sent after every SWD connection reset in
                  <code
                    class="dm ip iq ir is b"><a href="https://web.archive.org/web/20200117210221/https://github.com/lupyuen/openocd-spi/blob/master/src/jtag/drivers/spi.c" class="at cg he hf hg hh" target="_blank" rel="noopener nofollow">spi_transmit_resync</a>()</code>.
                  To give sufficient clock cycles for nRF52 to do its job, we insert a null byte before and after the
                  Throwaway Read IDCODE: <code
                    class="dm ip iq ir is b"><strong class="gr io">00</strong> 94 02 00 00 00 00 <strong class="gr io">00</strong></code>
                </p>

                <!-- <figure class="ii ij ik il im cz">
                  <div class="dl r dd">
                    <div class="iy r"><iframe
                        src="https://web.archive.org/web/20200117210221if_/https://medium.com/media/02cb00fb124630dce87c9f3e125505c3"
                        allowfullscreen="" frameborder="0" height="0" width="0"
                        title="See https://medium.com/@ly.lee/openocd-on-raspberry-pi-better-with-swd-on-spi-7dea9caeb590"
                        class="cp t u dh ak" scrolling="auto"></iframe></div>
                  </div>
                  <figcaption class="bo ds dt du dv cn cl cm dw dx bj dy">
                  </figcaption>
                </figure> -->

                <p><img src="https://lupyuen.github.io/images/legacy/d10.png" /></p>
                <p><em>Reset SWD Connection with Throwaway Read
                  IDCODE. From <a
                    href="https://web.archive.org/web/20200117210221/https://github.com/lupyuen/openocd-spi/blob/master/src/jtag/drivers/spi.c"
                    class="at cg he hf hg hh" target="_blank"
                    rel="noopener nofollow">https://github.com/lupyuen/openocd-spi/blob/master/src/jtag/drivers/spi.c</a></em></p>

                <p id="7acf" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc"><em class="hd">What’s the SWD
                    Write ABORT Operation?</em> We’ll learn in a while…</p>
              </div>
            </div>
          </section>
          <hr class="hi dy hj hk hl dv hm hn ho hp hq" />
          <section class="cu cv cw cx cy">
            <div class="n p">
              <div class="ac ae af ag ah dz aj ak">
                <h1 id="81ad" class="hr hs ec bk bj ht ee hu eg hv hw hx hy hz ia ib ic">SWD Write Operation</h1>
                <p id="7a4a" class="gp gq ec bk gr b gs id gu ie gw if gy ig ha ih hc">For Raspberry Pi to write an SWD
                  Register on nRF52, we perform an SWD Write Operation like this (Raspberry Pi is the host,
                  PineTime/nRF52 is the target)…</p>
              </div>
            </div>
            <div class="cz ak">
              <figure class="ii ij ik il im cz ak paragraph-image">
                <div class="dl r dd dm">
                  <div class="jc r">
                    <div class="df dg cp t u dh ak di dj dk"><img class="cp t u dh ak do dp dq"
                        src="https://web.archive.org/web/20200117210221im_/https://miro.medium.com/max/60/1*49lUAkfSVR0aATyuz86N8Q.png?q=20"
                        width="1842" height="199" role="presentation" /></div><img class="df dg cp t u dh ak dr"
                      width="1842" height="199" role="presentation" /><noscript><img class="cp t u dh ak"
                        src="https://web.archive.org/web/20200117210221im_/https://miro.medium.com/max/3684/1*49lUAkfSVR0aATyuz86N8Q.png"
                        width="1842" height="199" role="presentation" /></noscript>
                  </div>
                </div>
                <figcaption class="bo ds dt du dv cn cl cm dw dx bj dy">                </figcaption>
              </figure>

              <p><img src="https://lupyuen.github.io/images/legacy/a2.jpeg" /></p>
              <p><em>SWD Write Operation padded with 2 null bits.
                From <a
                  href="https://web.archive.org/web/20200117210221/https://docs.google.com/spreadsheets/d/12oXe1MTTEZVIbdmFXsOgOXVFHCQnYVvIw6fRpIQZybg/edit#gid=0"
                  class="at cg he hf hg hh" target="_blank"
                  rel="noopener nofollow">https://docs.google.com/spreadsheets/d/12oXe1MTTEZVIbdmFXsOgOXVFHCQnYVvIw6fRpIQZybg/edit#gid=0</a></em></p>

            </div>
            <div class="n p">
              <div class="ac ae af ag ah dz aj ak">
                <p id="31fa" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc">Here we are writing the value
                  <code class="dm ip iq ir is b">0x1E</code> to the <strong class="gr io">ABORT Register</strong>.
                  Whenever a SWD protocol error occurs during transmission (e.g. misaligned bits), we need to clear the
                  error by writing to the ABORT Register.</p>
                <p id="91be" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc">ABORT is Register #0 (in Write
                  Mode), so we set <code class="dm ip iq ir is b">A2</code> and <code class="dm ip iq ir is b">A3</code>
                  (bits 2 and 3 of the register number) to <code class="dm ip iq ir is b">0</code>.</p>
                <p id="cb3f" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc"><strong class="gr io"><em
                      class="hd">Pi → nRF52: 8 bits…</em></strong></p>
                <figure class="ii ij ik il im cz cl cm paragraph-image">
                  <div class="cl cm jd">
                    <div class="dl r dd dm">
                      <div class="je r">
                        <div class="df dg cp t u dh ak di dj dk"><img class="cp t u dh ak do dp dq"
                            src="https://web.archive.org/web/20200117210221im_/https://miro.medium.com/max/60/1*UJjRRCHXBpCrPyy9wtneMg.png?q=20"
                            width="647" height="133" role="presentation" /></div><img class="df dg cp t u dh ak dr"
                          width="647" height="133" role="presentation" /><noscript><img class="cp t u dh ak"
                            src="https://web.archive.org/web/20200117210221im_/https://miro.medium.com/max/1294/1*UJjRRCHXBpCrPyy9wtneMg.png"
                            width="647" height="133" role="presentation" /></noscript>
                      </div>
                    </div>
                  </div>
                  <figcaption class="bo ds dt du dv cn cl cm dw dx bj dy"></figcaption>
                </figure>

                <p><img src="https://lupyuen.github.io/images/legacy/a2.jpeg" /></p>
                <p><em>From Pi to nRF52</em></p>

                <p id="78a0" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc">Pi sends <code
                    class="dm ip iq ir is b">0x81</code> (least significant bit first) to nRF52. That’s followed by
                  <code class="dm ip iq ir is b">Trn</code>, the Turnaround Bit.</p>
                <p id="9139" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc"><strong class="gr io"><em
                      class="hd">nRF52 → Pi: 5 bits (including turnaround)…</em></strong></p>
                <figure class="ii ij ik il im cz cl cm paragraph-image">
                  <div class="cl cm jf">
                    <div class="dl r dd dm">
                      <div class="jg r">
                        <div class="df dg cp t u dh ak di dj dk"><img class="cp t u dh ak do dp dq"
                            src="https://web.archive.org/web/20200117210221im_/https://miro.medium.com/max/60/1*2OHTPpxD-_Qo5bdsWkWt6A.png?q=20"
                            width="507" height="132" role="presentation" /></div><img class="df dg cp t u dh ak dr"
                          width="507" height="132" role="presentation" /><noscript><img class="cp t u dh ak"
                            src="https://web.archive.org/web/20200117210221im_/https://miro.medium.com/max/1014/1*2OHTPpxD-_Qo5bdsWkWt6A.png"
                            width="507" height="132" role="presentation" /></noscript>
                      </div>
                    </div>
                  </div>
                  <figcaption class="bo ds dt du dv cn cl cm dw dx bj dy"></figcaption>
                </figure>

                <p><img src="https://lupyuen.github.io/images/legacy/a2.jpeg" /></p>
                <p><em>From nRF52 to Pi</em></p>

                <p id="59cf" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc">nRF52 responds with the
                  Acknowledgement <code class="dm ip iq ir is b">100</code> (which means OK). and another Turnaround
                  Bit.</p>
                <p id="a1fd" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc"><strong class="gr io"><em
                      class="hd">Pi → nRF52: 33 bits…</em></strong></p>
              </div>
            </div>
            <div class="cz ak">
              <figure class="ii ij ik il im cz ak paragraph-image">
                <div class="dl r dd dm">
                  <div class="jh r">
                    <div class="df dg cp t u dh ak di dj dk"><img class="cp t u dh ak do dp dq"
                        src="https://web.archive.org/web/20200117210221im_/https://miro.medium.com/max/60/1*rQaYOneDe4H71HiBuw6ClQ.png?q=20"
                        width="1319" height="132" role="presentation" /></div><img class="df dg cp t u dh ak dr"
                      width="1319" height="132" role="presentation" /><noscript><img class="cp t u dh ak"
                        src="https://web.archive.org/web/20200117210221im_/https://miro.medium.com/max/2638/1*rQaYOneDe4H71HiBuw6ClQ.png"
                        width="1319" height="132" role="presentation" /></noscript>
                  </div>
                </div>
                <figcaption class="bo ds dt du dv cn cl cm dw dx bj dy"></figcaption>
              </figure>

              <p><img src="https://lupyuen.github.io/images/legacy/a2.jpeg" /></p>
              <p><em>From Pi to nRF52</em></p>

            </div>
            <div class="n p">
              <div class="ac ae af ag ah dz aj ak">
                <p id="c3aa" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc">Pi sends 32 bits of data (the
                  value to be written to Register ABORT) and a Parity bit.</p>
                <p id="b3c1" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc"><strong class="gr io"><em
                      class="hd">Pi → nRF52: 2 bits (padding for byte alignment)…</em></strong></p>
                <figure class="ii ij ik il im cz cl cm paragraph-image">
                  <div class="cl cm ji">
                    <div class="dl r dd dm">
                      <div class="jj r">
                        <div class="df dg cp t u dh ak di dj dk"><img class="cp t u dh ak do dp dq"
                            src="https://web.archive.org/web/20200117210221im_/https://miro.medium.com/max/60/1*RmZomPH4xTbSRHsvy0TUYg.png?q=20"
                            width="407" height="132" role="presentation" /></div><img class="df dg cp t u dh ak dr"
                          width="407" height="132" role="presentation" /><noscript><img class="cp t u dh ak"
                            src="https://web.archive.org/web/20200117210221im_/https://miro.medium.com/max/814/1*RmZomPH4xTbSRHsvy0TUYg.png"
                            width="407" height="132" role="presentation" /></noscript>
                      </div>
                    </div>
                  </div>
                  <figcaption class="bo ds dt du dv cn cl cm dw dx bj dy"></figcaption>
                </figure>

                <p><img src="https://lupyuen.github.io/images/legacy/a2.jpeg" /></p>
                <p><em>From Pi to nRF52</em></p>

                <p id="ea2d" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc">For our SPI implementation, Pi
                  sends an extra 2 null bits to make the entire operation byte-aligned: 6 whole SPI bytes. <em
                    class="hd">(Remember: It’s OK to insert extra null bits before and after SWD Read/Write
                    Operations)</em></p>
                <p id="c4c9" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc">No misaligned bits for SWD Write
                  Operations… <em class="hd">Phew!</em></p>
              </div>
            </div>
          </section>
          <hr class="hi dy hj hk hl dv hm hn ho hp hq" />
          <section class="cu cv cw cx cy">
            <div class="n p">
              <div class="ac ae af ag ah dz aj ak">
                <h1 id="a93c" class="hr hs ec bk bj ht ee hu eg hv hw hx hy hz ia ib ic">A Convenient Write Lie</h1>
                <p id="5a2c" class="gp gq ec bk gr b gs id gu ie gw if gy ig ha ih hc"><em class="hd">Will SWD Write
                    Operations work over SPI?</em> SWD Write Operations are always byte-aligned, because we padded 2
                  null bits. But we have a funny Turnaround situation in the second byte of the SWD Write Operation…</p>
                <figure class="ii ij ik il im cz cl cm paragraph-image">
                  <div class="db dc dd de ak">
                    <div class="cl cm jk">
                      <div class="dl r dd dm">
                        <div class="jl r">
                          <div class="df dg cp t u dh ak di dj dk"><img class="cp t u dh ak do dp dq"
                              src="https://web.archive.org/web/20200117210221im_/https://miro.medium.com/max/60/1*rDDxoGZkjko8cQqQVAYeXw.png?q=20"
                              width="743" height="132" role="presentation" /></div><img class="df dg cp t u dh ak dr"
                            width="743" height="132" role="presentation" /><noscript><img class="cp t u dh ak"
                              src="https://web.archive.org/web/20200117210221im_/https://miro.medium.com/max/1486/1*rDDxoGZkjko8cQqQVAYeXw.png"
                              width="743" height="132" role="presentation" /></noscript>
                        </div>
                      </div>
                    </div>
                  </div>
                  <figcaption class="bo ds dt du dv cn cl cm dw dx bj dy"></figcaption>
                </figure>

                <p><img src="https://lupyuen.github.io/images/legacy/a2.jpeg" /></p>
                <p><em>From Pi to nRF52 and back</em></p>

                <p id="69ee" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc"><em class="hd">There are Two
                    Turnarounds in the same byte!</em></p>
                <p id="d467" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc"><strong class="gr io"><em
                      class="hd">nRF52 → Pi:</em></strong> 3 Acknowledgement Bits + 2 Turnaround Bits, followed by…<em
                    class="hd"><br /></em><strong class="gr io"><em class="hd">Pi → nRF52:</em></strong><em class="hd">
                  </em>3 Data Bits</p>
                <p id="72be" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc">We can’t flip the direction of
                  transmission within a single SPI byte transfer. <em class="hd">So this fails for SPI!</em> Thankfully
                  we have another sneaky solution for this problematic second byte…</p>
                <p id="4c36" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc"><strong class="gr io"><em
                      class="hd">nRF52 → Pi:</em></strong> 0 bits, followed by…<em class="hd"><br /></em><strong
                    class="gr io"><em class="hd">Pi → nRF52:</em></strong><em class="hd"> </em>3 Acknowledgement Bits +
                  2 Turnaround Bits + 3 Data Bits</p>
                <p id="155a" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc"><em class="hd">Look
                    familiar?</em> This is the same trick as the Throwaway SWD Read Operation… <em class="hd">We now
                    throw away the 3 Acknowledgement Bits sent by nRF52 to Pi!</em></p>
                <p id="bde1" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc">Instead of Pi receiving the 3
                  Acknowledgement Bits from nRF52, <em class="hd">Pi now sends 3 bits to nRF52</em>. Doesn’t matter
                  whether they are <code class="dm ip iq ir is b">0</code> or <code class="dm ip iq ir is b">1</code>,
                  as long as it takes 3 clock cycles.</p>
                <p id="2c7d" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc">But that means we won’t know
                  whether the Write Acknowledgement is OK (<code class="dm ip iq ir is b">100</code>)!</p>
                <p id="a5f4" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc"><em class="hd">Think about it… Is
                    this Write Acknowledgement really useful?</em> It happens <em class="hd">before</em> the data is
                  written! Most of the time it’s used to indicate that the Register ID (in <code
                    class="dm ip iq ir is b">A2</code> and <code class="dm ip iq ir is b">A3</code>) is valid.</p>
                <p id="101c" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc">Thus we take a calculated risk
                  and assume that the <strong class="gr io">SWD Write Acknowledgement is always OK</strong>. Our SPI
                  code always lies and returns <code class="dm ip iq ir is b">100</code> to OpenOCD.</p>
                <figure class="ii ij ik il im cz">
                  <div class="dl r dd">
                    <div class="iy r"><iframe
                        src="https://web.archive.org/web/20200117210221if_/https://medium.com/media/98ed286f829bcea91406f6aa3cd79b48"
                        allowfullscreen="" frameborder="0" height="0" width="0"
                        title="See https://medium.com/@ly.lee/openocd-on-raspberry-pi-better-with-swd-on-spi-7dea9caeb590"
                        class="cp t u dh ak" scrolling="auto"></iframe></div>
                  </div>
                  <figcaption class="bo ds dt du dv cn cl cm dw dx bj dy"></a>
                  </figcaption>
                </figure>

                <p><img src="https://lupyuen.github.io/images/legacy/a2.jpeg" /></p>
                <p><em>Our SPI code always returns OK to OpenOCD for
                  SWD Write Acknowledgement. From <a
                    href="https://web.archive.org/web/20200117210221/https://github.com/lupyuen/openocd-spi/blob/master/src/jtag/drivers/spi.c"
                    class="at cg he hf hg hh" target="_blank"
                    rel="noopener nofollow">https://github.com/lupyuen/openocd-spi/blob/master/src/jtag/drivers/spi.c</em></p>

                <p id="eb0b" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc"><em class="hd">Will this cause
                    problems when flashing the ROM of nRF52? Since we’re not checking the SWD Write
                    Acknowledgement?</em></p>
                <p id="749e" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc">Here’s how we mitigate the risk
                  of write failures: <strong class="gr io">We always read and verify the ROM contents after
                    flashing</strong>, like in <a
                    href="https://web.archive.org/web/20200117210221/https://github.com/lupyuen/pinetime-rust-mynewt/blob/master/scripts/nrf52/flash-app.ocd"
                    class="at cg he hf hg hh" target="_blank" rel="noopener nofollow">this OpenOCD script</a>…</p>
                <pre
                  class="ii ij ik il im jm jn jo"><span id="dd35" class="jp hs ec bk is b ds jq jr r js">program bin/targets/nrf52_my_sensor/app/apps/my_sensor_app/my_sensor_app.img verify 0x00008000</span></pre>
                <p id="1afa" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc">When we throw away the SWD Write
                  Acknowledgement, we eliminate all Turnarounds. Our SWD Write Operation becomes really simple… <em
                    class="hd">Just send 8 whole bytes from Pi to nRF52!</em></p>
                <p id="11ed" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc"><em class="hd">Perfect for
                    implementing SWD over SPI!</em></p>
                <p id="ff0e" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc">Hence to write value <code
                    class="dm ip iq ir is b">0x1E</code> to the ABORT Register, Pi only needs to blast out 6 bytes over
                  SPI to nRF52: <code class="dm ip iq ir is b">81 d3 03 00 00 00</code></p>
                <figure class="ii ij ik il im cz">
                  <div class="dl r dd">
                    <div class="iy r"><iframe
                        src="https://web.archive.org/web/20200117210221if_/https://medium.com/media/659648b29c54eebe853501321850e5f9"
                        allowfullscreen="" frameborder="0" height="0" width="0"
                        title="See https://medium.com/@ly.lee/openocd-on-raspberry-pi-better-with-swd-on-spi-7dea9caeb590"
                        class="cp t u dh ak" scrolling="auto"></iframe></div>
                  </div>
                  <figcaption class="bo ds dt du dv cn cl cm dw dx bj dy">                  </figcaption>
                </figure>

                <p><img src="https://lupyuen.github.io/images/legacy/a2.jpeg" /></p>
                <p><em>Sending 8 whole bytes from Pi to nRF52 for an
                  SPI Write Operation. From <a
                    href="https://web.archive.org/web/20200117210221/https://github.com/lupyuen/openocd-spi/blob/master/src/jtag/drivers/spi.c"
                    class="at cg he hf hg hh" target="_blank"
                    rel="noopener nofollow">https://github.com/lupyuen/openocd-spi/blob/master/src/jtag/drivers/spi.c</a>
</em></p>

              </div>
            </div>
          </section>
          <hr class="hi dy hj hk hl dv hm hn ho hp hq" />
          <section class="cu cv cw cx cy">
            <div class="n p">
              <div class="ac ae af ag ah dz aj ak">
                <h1 id="81eb" class="hr hs ec bk bj ht ee hu eg hv hw hx hy hz ia ib ic">Clear the Sticky Error Bits
                </h1>
                <p id="6561" class="gp gq ec bk gr b gs id gu ie gw if gy ig ha ih hc">We added debug logs to the
                  existing OpenOCD code in <code
                    class="dm ip iq ir is b"><a href="https://web.archive.org/web/20200117210221/https://github.com/lupyuen/openocd-spi/blob/master/src/jtag/drivers/bitbang.c#L414-L464" class="at cg he hf hg hh" target="_blank" rel="noopener nofollow">bitbang.c</a></code>
                  to compare the old GPIO and new SPI implementations of the SWD protocol.</p>
                <p id="b1f6" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc">Remember we said earlier that
                  every SWD Read Operation will be followed by an SWD connection reset that transmits two byte sequences
                  to nRF52…</p>
                <ol class="">
                  <li id="3467" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc jt ju jv">JTAG-To-SWD Sequence
                  </li>
                  <li id="01a6" class="gp gq ec bk gr b gs jw gu jx gw jy gy jz ha ka hc jt ju jv">Read IDCODE Sequence,
                    prepadded with two null bits</li>
                </ol>
                <p id="3f64" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc">Here’s what happens when we run
                  OpenOCD with that setup…</p>
                <figure class="ii ij ik il im cz cl cm paragraph-image">
                  <div class="db dc dd de ak">
                    <div class="cl cm kb">
                      <div class="dl r dd dm">
                        <div class="kc r">
                          <div class="df dg cp t u dh ak di dj dk"><img class="cp t u dh ak do dp dq"
                              src="https://web.archive.org/web/20200117210221im_/https://miro.medium.com/max/60/1*NaHaYp3UvNfL1ubNdCOpkA.png?q=20"
                              width="1061" height="788" role="presentation" /></div><img class="df dg cp t u dh ak dr"
                            width="1061" height="788" role="presentation" /><noscript><img class="cp t u dh ak"
                              src="https://web.archive.org/web/20200117210221im_/https://miro.medium.com/max/2122/1*NaHaYp3UvNfL1ubNdCOpkA.png"
                              width="1061" height="788" role="presentation" /></noscript>
                        </div>
                      </div>
                    </div>
                  </div>
                  <figcaption class="bo ds dt du dv cn cl cm dw dx bj dy">
                  </figcaption>
                </figure>

                <p><img src="https://lupyuen.github.io/images/legacy/a2.jpeg" /></p>
                <p><em>Comparing the logs from SWD over GPIO (left)
                  with SWD over SPI (right). From <a
                    href="https://web.archive.org/web/20200117210221/https://docs.google.com/spreadsheets/d/12oXe1MTTEZVIbdmFXsOgOXVFHCQnYVvIw6fRpIQZybg/edit#gid=900511571"
                    class="at cg he hf hg hh" target="_blank"
                    rel="noopener nofollow">https://docs.google.com/spreadsheets/d/12oXe1MTTEZVIbdmFXsOgOXVFHCQnYVvIw6fRpIQZybg/edit#gid=900511571</a></em></p>

                <p id="27f8" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc">Both the GPIO and SPI versions of
                  OpenOCD are reading and writing to the same nRF52 registers: IDCODE, SELECT AP, CTRL/STAT. But the
                  value of the Control/Status Register (CTRL/STAT) is different for SPI: <code
                    class="dm ip iq ir is b">f0000003</code>.</p>
                <p id="6270" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc">What’s <code
                    class="dm ip iq ir is b">f0000003</code>? Let’s key that <a
                    href="https://web.archive.org/web/20200117210221/https://docs.google.com/spreadsheets/d/12oXe1MTTEZVIbdmFXsOgOXVFHCQnYVvIw6fRpIQZybg/edit#gid=2077834467"
                    class="at cg he hf hg hh" target="_blank" rel="noopener nofollow">into this spreadsheet</a> to
                  decode the Control/Status value…</p>
              </div>
            </div>
            <div class="cz ak">
              <figure class="ii ij ik il im cz ak paragraph-image">
                <div class="db dc dd de ak">
                  <div class="dl r dd dm">
                    <div class="kd r">
                      <div class="df dg cp t u dh ak di dj dk"><img class="cp t u dh ak do dp dq"
                          src="https://web.archive.org/web/20200117210221im_/https://miro.medium.com/max/60/1*nXTgKPljszZxZmfxDXlVEQ.png?q=20"
                          width="1572" height="205" role="presentation" /></div><img class="df dg cp t u dh ak dr"
                        width="1572" height="205" role="presentation" /><noscript><img class="cp t u dh ak"
                          src="https://web.archive.org/web/20200117210221im_/https://miro.medium.com/max/3144/1*nXTgKPljszZxZmfxDXlVEQ.png"
                          width="1572" height="205" role="presentation" /></noscript>
                    </div>
                  </div>
                </div>
                <figcaption class="bo ds dt du dv cn cl cm dw dx bj dy">
                </figcaption>
              </figure>

              <p><img src="https://lupyuen.github.io/images/legacy/a2.jpeg" /></p>
              <p><em>Control/Status Register Decoder: <a
                href="https://web.archive.org/web/20200117210221/https://docs.google.com/spreadsheets/d/12oXe1MTTEZVIbdmFXsOgOXVFHCQnYVvIw6fRpIQZybg/edit#gid=2077834467"
                class="at cg he hf hg hh" target="_blank"
                rel="noopener nofollow">https://docs.google.com/spreadsheets/d/12oXe1MTTEZVIbdmFXsOgOXVFHCQnYVvIw6fRpIQZybg/edit#gid=2077834467</a></em></p>

            </div>
            <div class="n p">
              <div class="ac ae af ag ah dz aj ak">
                <p id="a209" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc"><em class="hd">What’s the
                    difference between the GPIO and SPI values for the Control/Status Register?</em> SPI is experiencing
                  the <strong class="gr io">STICKYORUN</strong> error…</p>
                <figure class="ii ij ik il im cz cl cm paragraph-image">
                  <div class="db dc dd de ak">
                    <div class="cl cm ke">
                      <div class="dl r dd dm">
                        <div class="kf r">
                          <div class="df dg cp t u dh ak di dj dk"><img class="cp t u dh ak do dp dq"
                              src="https://web.archive.org/web/20200117210221im_/https://miro.medium.com/max/60/1*e_ynAgJbcP4u8I8SOQytUA.png?q=20"
                              width="866" height="213" role="presentation" /></div><img class="df dg cp t u dh ak dr"
                            width="866" height="213" role="presentation" /><noscript><img class="cp t u dh ak"
                              src="https://web.archive.org/web/20200117210221im_/https://miro.medium.com/max/1732/1*e_ynAgJbcP4u8I8SOQytUA.png"
                              width="866" height="213" role="presentation" /></noscript>
                        </div>
                      </div>
                    </div>
                  </div>
                  <figcaption class="bo ds dt du dv cn cl cm dw dx bj dy">
                  </figcaption>
                </figure>

                <p><img src="https://lupyuen.github.io/images/legacy/a2.jpeg" /></p>
                <p><em>STICKYORUN flag in the Control/Status
                  Register. From ARM® Debug Interface v5 Architecture Specification <a
                    href="https://web.archive.org/web/20200117210221/https://github.com/MarkDing/swd_programing_sram/blob/master/Ref/ARM_debug.pdf"
                    class="at cg he hf hg hh" target="_blank"
                    rel="noopener nofollow">https://github.com/MarkDing/swd_programing_sram/blob/master/Ref/ARM_debug.pdf</a></em></p>

                <p id="528b" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc">This means that nRF52 has <strong
                    class="gr io">detected some overrun garbage on the SWD connection</strong>… <em class="hd">Must be
                    due to our misaligned SWD Read Operations!</em></p>
                <p id="8474" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc">This is a “Sticky” error… It
                  sticks there forever until we do something to clear the error status. <strong class="gr io">If we
                    don’t clear the Sticky error status, all SWD operations will fail.</strong></p>
                <figure class="ii ij ik il im cz cl cm paragraph-image">
                  <div class="db dc dd de ak">
                    <div class="cl cm kg">
                      <div class="dl r dd dm">
                        <div class="kh r">
                          <div class="df dg cp t u dh ak di dj dk"><img class="cp t u dh ak do dp dq"
                              src="https://web.archive.org/web/20200117210221im_/https://miro.medium.com/max/60/1*ci4QCcTcbS98B_FotQqMCw.png?q=20"
                              width="811" height="273" role="presentation" /></div><img class="df dg cp t u dh ak dr"
                            width="811" height="273" role="presentation" /><noscript><img class="cp t u dh ak"
                              src="https://web.archive.org/web/20200117210221im_/https://miro.medium.com/max/1622/1*ci4QCcTcbS98B_FotQqMCw.png"
                              width="811" height="273" role="presentation" /></noscript>
                        </div>
                      </div>
                    </div>
                  </div>
                  <figcaption class="bo ds dt du dv cn cl cm dw dx bj dy">
                  </figcaption>
                </figure>

                <p><img src="https://lupyuen.github.io/images/legacy/a2.jpeg" /></p>
                <p><em>ABORT Register. From ARM® Debug Interface v5
                  Architecture Specification <a
                    href="https://web.archive.org/web/20200117210221/https://github.com/MarkDing/swd_programing_sram/blob/master/Ref/ARM_debug.pdf"
                    class="at cg he hf hg hh" target="_blank"
                    rel="noopener nofollow">https://github.com/MarkDing/swd_programing_sram/blob/master/Ref/ARM_debug.pdf</a></em></p>

                <p id="264e" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc">The solution: We write value
                  <code class="dm ip iq ir is b">0x1E</code> to the ABORT Register. That’s binary <code
                    class="dm ip iq ir is b">11110</code>, which means that we are clearing <em class="hd">all</em> the
                  errors: Overrun Error, Write Data Error, Sticky Error, Sticky Compare Error.</p>
                <p id="b043" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc">In the previous section we have
                  learnt how to write value <code class="dm ip iq ir is b">0x1E</code> to the ABORT Register: By
                  blasting out over SPI <code class="dm ip iq ir is b">81 d3 03 00 00 00</code></p>
                <p id="8206" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc"><em class="hd">When shall we
                    write to the ABORT Register to clear the errors?</em></p>
                <p id="1b5f" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc">Remember that Pi has become
                  extremely negligent to nRF52… <em class="hd">Pi has thrown away so much feedback and acknowledgement
                    from nRF52!</em> We don’t know exactly when nRF52 is having issues. But since…</p>
                <ol class="">
                  <li id="0b29" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc jt ju jv">The errors are caused
                    by the misaligned SWD Read Operation</li>
                  <li id="0da2" class="gp gq ec bk gr b gs jw gu jx gw jy gy jz ha ka hc jt ju jv">And we always reset
                    the SWD connection after every SWD Read Operation (except the Throwaway Read IDCODE)…</li>
                </ol>
                <p id="f7cb" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc">Let’s write to the ABORT Register
                  and <strong class="gr io">clear the errors at every SWD connection reset</strong>.</p>
                <figure class="ii ij ik il im cz">
                  <div class="dl r dd">
                    <div class="iy r"><iframe
                        src="https://web.archive.org/web/20200117210221if_/https://medium.com/media/42f36e51a7e025e13dddb9ce07b7d6e9"
                        allowfullscreen="" frameborder="0" height="0" width="0"
                        title="See https://medium.com/@ly.lee/openocd-on-raspberry-pi-better-with-swd-on-spi-7dea9caeb590"
                        class="cp t u dh ak" scrolling="auto"></iframe></div>
                  </div>
                  <figcaption class="bo ds dt du dv cn cl cm dw dx bj dy">
                  </figcaption>
                </figure>

                <p><img src="https://lupyuen.github.io/images/legacy/a2.jpeg" /></p>
                <p><em>Clearing the errors at every SWD connect reset
                  by writing to ABORT. From <a
                    href="https://web.archive.org/web/20200117210221/https://github.com/lupyuen/openocd-spi/blob/master/src/jtag/drivers/spi.c"
                    class="at cg he hf hg hh" target="_blank"
                    rel="noopener nofollow">https://github.com/lupyuen/openocd-spi/blob/master/src/jtag/drivers/spi.c</a></em></p>

                <p id="6702" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc"><em class="hd">With this fix, SWD
                    over SPI works perfectly!</em></p>
              </div>
            </div>
          </section>
          <hr class="hi dy hj hk hl dv hm hn ho hp hq" />
          <section class="cu cv cw cx cy">
            <div class="n p">
              <div class="ac ae af ag ah dz aj ak">
                <h1 id="6258" class="hr hs ec bk bj ht ee hu eg hv hw hx hy hz ia ib ic">Inject SPI into OpenOCD Bit
                  Bang</h1>
                <p id="2886" class="gp gq ec bk gr b gs id gu ie gw if gy ig ha ih hc">We have SWD Read and Write
                  Operations working fine over SPI, and we have forcibly fixed all the SWD errors indirectly caused by
                  SPI. Now let’s inject this SPI code into the OpenOCD code.</p>
                <p id="8ac8" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc">OpenOCD calls <code
                    class="dm ip iq ir is b">bitbang_exchange()</code> in <code
                    class="dm ip iq ir is b"><a href="https://web.archive.org/web/20200117210221/https://github.com/lupyuen/openocd-spi/blob/master/src/jtag/drivers/bitbang.c#L414-L464" class="at cg he hf hg hh" target="_blank" rel="noopener nofollow">bitbang.c</a></code>
                  whenever it needs to transmit or receive a chunk of bits in a fixed direction. OpenOCD calls <code
                    class="dm ip iq ir is b">bitbang_exchange()</code> two times for every SWD Read, three times for
                  every SWD Write…</p>
              </div>
            </div>
            <div class="cz">
              <div class="n p">
                <div class="ki kj kk kl km kn ag ko ah kp aj ak">
                  <figure class="ii ij ik il im cz kr ks paragraph-image">
                    <div class="db dc dd de ak">
                      <div class="cl cm kq">
                        <div class="dl r dd dm">
                          <div class="kt r">
                            <div class="df dg cp t u dh ak di dj dk"><img class="cp t u dh ak do dp dq"
                                src="https://web.archive.org/web/20200117210221im_/https://miro.medium.com/max/60/1*QbftBI6WVn4pCEgCTV-Rlw.png?q=20"
                                width="1542" height="416" role="presentation" /></div><img class="df dg cp t u dh ak dr"
                              width="1542" height="416" role="presentation" /><noscript><img class="cp t u dh ak"
                                src="https://web.archive.org/web/20200117210221im_/https://miro.medium.com/max/3084/1*QbftBI6WVn4pCEgCTV-Rlw.png"
                                width="1542" height="416" role="presentation" /></noscript>
                          </div>
                        </div>
                      </div>
                    </div>
                    <figcaption class="bo ds dt du dv cn cl cm dw dx bj dy">
                    </figcaption>
                  </figure>

                  <p><img src="https://lupyuen.github.io/images/legacy/a2.jpeg" /></p>
                  <p><em><code
                    class="dm ip iq ir is b">SWD Read: bitbang_exchange()</code> called for two chunks of bits. From
                  <a href="https://web.archive.org/web/20200117210221/https://github.com/MarkDing/swd_programing_sram/blob/master/Ref/ARM_debug.pdf"
                    class="at cg he hf hg hh" target="_blank"
                    rel="noopener nofollow">https://github.com/MarkDing/swd_programing_sram/blob/master/Ref/ARM_debug.pdf</a></em></p>
  
                  <figure class="da cz kr ks paragraph-image">
                    <div class="db dc dd de ak">
                      <div class="cl cm ku">
                        <div class="dl r dd dm">
                          <div class="kv r">
                            <div class="df dg cp t u dh ak di dj dk"><img class="cp t u dh ak do dp dq"
                                src="https://web.archive.org/web/20200117210221im_/https://miro.medium.com/max/60/1*cDrUeL7Xaih_AZ-6LPDIsQ.png?q=20"
                                width="1576" height="462" role="presentation" /></div><img class="df dg cp t u dh ak dr"
                              width="1576" height="462" role="presentation" /><noscript><img class="cp t u dh ak"
                                src="https://web.archive.org/web/20200117210221im_/https://miro.medium.com/max/3152/1*cDrUeL7Xaih_AZ-6LPDIsQ.png"
                                width="1576" height="462" role="presentation" /></noscript>
                          </div>
                        </div>
                      </div>
                    </div>
                    <figcaption class="bo ds dt du dv cn cl cm dw dx bj dy">
                    </figcaption>
                  </figure>

                  <p><img src="https://lupyuen.github.io/images/legacy/a2.jpeg" /></p>
                  <p><em><code
                    class="dm ip iq ir is b">SWD Write: bitbang_exchange()</code> called for three chunks of bits.
                  From <a
                    href="https://web.archive.org/web/20200117210221/https://github.com/MarkDing/swd_programing_sram/blob/master/Ref/ARM_debug.pdf"
                    class="at cg he hf hg hh" target="_blank"
                    rel="noopener nofollow">https://github.com/MarkDing/swd_programing_sram/blob/master/Ref/ARM_debug.pdf</a></em></p>
  
                </div>
              </div>
            </div>
            <div class="n p">
              <div class="ac ae af ag ah dz aj ak">
                <p id="f7dd" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc"><code
                    class="dm ip iq ir is b">bitbang_exchange()</code> is called by OpenOCD like this…</p>
                <figure class="ii ij ik il im cz">
                  <div class="dl r dd">
                    <div class="iy r"><iframe
                        src="https://web.archive.org/web/20200117210221if_/https://medium.com/media/a750ca570ea4253eacb11a57f6b03369"
                        allowfullscreen="" frameborder="0" height="0" width="0"
                        title="See https://medium.com/@ly.lee/openocd-on-raspberry-pi-better-with-swd-on-spi-7dea9caeb590"
                        class="cp t u dh ak" scrolling="auto"></iframe></div>
                  </div>
                </figure>

                <p><img src="https://lupyuen.github.io/images/legacy/a2.jpeg" /></p>
                <p><em></em></p>

                <p id="fb07" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc">Here’s the existing code for
                  <code class="dm ip iq ir is b">bitbang_exchange()</code> that transmits and receives chunks of bits
                  over GPIO…</p>
                <figure class="ii ij ik il im cz">
                  <div class="dl r dd">
                    <div class="iy r"><iframe
                        src="https://web.archive.org/web/20200117210221if_/https://medium.com/media/f7bf6a0ca70f02098fc0f263e5ca2a1c"
                        allowfullscreen="" frameborder="0" height="0" width="0"
                        title="See https://medium.com/@ly.lee/openocd-on-raspberry-pi-better-with-swd-on-spi-7dea9caeb590"
                        class="cp t u dh ak" scrolling="auto"></iframe></div>
                  </div>
                  <figcaption class="bo ds dt du dv cn cl cm dw dx bj dy">
                  </figcaption>
                </figure>

                <p><img src="https://lupyuen.github.io/images/legacy/a2.jpeg" /></p>
                <p><em>From <a
                  href="https://web.archive.org/web/20200117210221/https://github.com/lupyuen/openocd-spi/blob/master/src/jtag/drivers/bitbang.c"
                  class="at cg he hf hg hh" target="_blank"
                  rel="noopener nofollow">https://github.com/lupyuen/openocd-spi/blob/master/src/jtag/drivers/bitbang.c</a></em></p>

                <p id="f2da" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc">And here’s the modification we
                  made for <code class="dm ip iq ir is b">bitbang_exchange()</code> to transmit and receives chunks of
                  bits over SPI…</p>
                <figure class="ii ij ik il im cz">
                  <div class="dl r dd">
                    <div class="iy r"><iframe
                        src="https://web.archive.org/web/20200117210221if_/https://medium.com/media/4d0c6c346c5307e69229059b946786cc"
                        allowfullscreen="" frameborder="0" height="0" width="0"
                        title="See https://medium.com/@ly.lee/openocd-on-raspberry-pi-better-with-swd-on-spi-7dea9caeb590"
                        class="cp t u dh ak" scrolling="auto"></iframe></div>
                  </div>
                  <figcaption class="bo ds dt du dv cn cl cm dw dx bj dy">
                  </figcaption>
                </figure>

                <p><img src="https://lupyuen.github.io/images/legacy/a2.jpeg" /></p>
                <p><em>From <a
                  href="https://web.archive.org/web/20200117210221/https://github.com/lupyuen/openocd-spi/blob/master/src/jtag/drivers/bitbang.c"
                  class="at cg he hf hg hh" target="_blank"
                  rel="noopener nofollow">https://github.com/lupyuen/openocd-spi/blob/master/src/jtag/drivers/bitbang.c</a></em></p>

                <p id="0fd4" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc">Which simply forwards the call to
                  our new function <code class="dm ip iq ir is b">spi_exchange()</code> in <code
                    class="dm ip iq ir is b"><a href="https://web.archive.org/web/20200117210221/https://github.com/lupyuen/openocd-spi/blob/master/src/jtag/drivers/spi.c" class="at cg he hf hg hh" target="_blank" rel="noopener nofollow">spi.c</a></code>.
                </p>
                <figure class="ii ij ik il im cz">
                  <div class="dl r dd">
                    <div class="iy r"><iframe
                        src="https://web.archive.org/web/20200117210221if_/https://medium.com/media/3ebaa39b41a1cbccc562e54c0dc2a456"
                        allowfullscreen="" frameborder="0" height="0" width="0"
                        title="See https://medium.com/@ly.lee/openocd-on-raspberry-pi-better-with-swd-on-spi-7dea9caeb590"
                        class="cp t u dh ak" scrolling="auto"></iframe></div>
                  </div>
                  <figcaption class="bo ds dt du dv cn cl cm dw dx bj dy">
                  </figcaption>
                </figure>

                <p><img src="https://lupyuen.github.io/images/legacy/a2.jpeg" /></p>
                <p><em>From <a
                  href="https://web.archive.org/web/20200117210221/https://github.com/lupyuen/openocd-spi/blob/master/src/jtag/drivers/spi.c"
                  class="at cg he hf hg hh" target="_blank"
                  rel="noopener nofollow">https://github.com/lupyuen/openocd-spi/blob/master/src/jtag/drivers/spi.c</a></em></p>

                <p id="3e6b" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc">Because <code
                    class="dm ip iq ir is b">spi_exchange()</code> is called with chunks of bits, we use the <code
                    class="dm ip iq ir is b">offset</code> and <code class="dm ip iq ir is b">bit_cnt</code> parameters
                  to figure out whether this chunk came from an SWD Read or Write Operation, and which chunk in that
                  operation…</p>
                <figure class="ii ij ik il im cz">
                  <div class="dl r dd">
                    <div class="iy r"><iframe
                        src="https://web.archive.org/web/20200117210221if_/https://medium.com/media/98ed286f829bcea91406f6aa3cd79b48"
                        allowfullscreen="" frameborder="0" height="0" width="0"
                        title="See https://medium.com/@ly.lee/openocd-on-raspberry-pi-better-with-swd-on-spi-7dea9caeb590"
                        class="cp t u dh ak" scrolling="auto"></iframe></div>
                  </div>
                  <figcaption class="bo ds dt du dv cn cl cm dw dx bj dy">
                  </figcaption>
                </figure>

                <p><img src="https://lupyuen.github.io/images/legacy/a2.jpeg" /></p>
                <p><em>Deducing the chunk by offset and bit_cnt. From
                  <a href="https://web.archive.org/web/20200117210221/https://github.com/lupyuen/openocd-spi/blob/master/src/jtag/drivers/spi.c"
                    class="at cg he hf hg hh" target="_blank"
                    rel="noopener nofollow">https://github.com/lupyuen/openocd-spi/blob/master/src/jtag/drivers/spi.c</a></em></p>

                <p id="98d9" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc"><em class="hd">(Yeah this chunk
                    handling smells bad… We should inject the SPI code into </em><code
                    class="dm ip iq ir is b">bitbang_swd_read_reg()</code><em class="hd"> and </em><code
                    class="dm ip iq ir is b">bitbang_swd_write_reg()</code><em class="hd"> in </em><code
                    class="dm ip iq ir is b"><a href="https://web.archive.org/web/20200117210221/https://github.com/lupyuen/openocd-spi/blob/master/src/jtag/drivers/bitbang.c#L414-L464" class="at cg he hf hg hh" target="_blank" rel="noopener nofollow">bitbang.c</a></code><em
                    class="hd"> instead)</em></p>
                <p id="b16e" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc">In Raspberry Pi, all bytes must
                  be sent over SPI in Most Significant Bit format… But OpenOCD uses Least Significant Bit format to
                  manipulate the bytes. So we need to the reverse the bits like this…</p>
                <figure class="ii ij ik il im cz">
                  <div class="dl r dd">
                    <div class="iy r"><iframe
                        src="https://web.archive.org/web/20200117210221if_/https://medium.com/media/186cb60d044f92edb1b7c0d40531f491"
                        allowfullscreen="" frameborder="0" height="0" width="0"
                        title="See https://medium.com/@ly.lee/openocd-on-raspberry-pi-better-with-swd-on-spi-7dea9caeb590"
                        class="cp t u dh ak" scrolling="auto"></iframe></div>
                  </div>
                </figure>

                <p><img src="https://lupyuen.github.io/images/legacy/a2.jpeg" /></p>
                <p><em></em></p>

              </div>
            </div>
          </section>
          <hr class="hi dy hj hk hl dv hm hn ho hp hq" />
          <section class="cu cv cw cx cy">
            <div class="n p">
              <div class="ac ae af ag ah dz aj ak">
                <h1 id="1b10" class="hr hs ec bk bj ht ee hu eg hv hw hx hy hz ia ib ic">SPI Sandbox</h1>
                <p id="20e2" class="gp gq ec bk gr b gs id gu ie gw if gy ig ha ih hc">Before implementing SWD over SPI
                  in OpenOCD, I used a simple C program <code
                    class="dm ip iq ir is b"><a href="https://web.archive.org/web/20200117210221/https://github.com/lupyuen/pi-swd-spi/blob/master/pi-swd-spi.c" class="at cg he hf hg hh" target="_blank" rel="noopener nofollow">pi-swd-spi.c</a></code>
                  to test the individual SWD functions. I hope you’ll do the same when you’re modifying OpenOCD.</p>
                <p id="8f99" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc">The program tests all the
                  functions we have covered: misaligned SWD reads, padded SWD writes, JTAG-To-SWD reset, Throwaway Read
                  IDCODE, Write ABORT, Read CTRL/STAT, …</p>
                <p id="5bed" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc"><a
                    href="https://web.archive.org/web/20200117210221/https://github.com/lupyuen/pi-swd-spi/blob/master/pi-swd-spi.c#L296-L394"
                    class="at cg he hf hg hh" target="_blank" rel="noopener nofollow">Here’s the output from the test
                    program</a>…</p>
                <figure class="ii ij ik il im cz">
                  <div class="dl r dd">
                    <div class="iy r"><iframe
                        src="https://web.archive.org/web/20200117210221if_/https://medium.com/media/758f0754f69c0a5ff0fdfea138f462ca"
                        allowfullscreen="" frameborder="0" height="0" width="0"
                        title="See https://medium.com/@ly.lee/openocd-on-raspberry-pi-better-with-swd-on-spi-7dea9caeb590"
                        class="cp t u dh ak" scrolling="auto"></iframe></div>
                  </div>
                  <figcaption class="bo ds dt du dv cn cl cm dw dx bj dy">
                  </figcaption>
                </figure>

                <p><img src="https://lupyuen.github.io/images/legacy/a2.jpeg" /></p>
                <p><em>SWD SPI Test Log. From <a
                  href="https://web.archive.org/web/20200117210221/https://github.com/lupyuen/pi-swd-spi/blob/master/pi-swd-spi.c#L296-L394"
                  class="at cg he hf hg hh" target="_blank"
                  rel="noopener nofollow">https://github.com/lupyuen/pi-swd-spi/blob/master/pi-swd-spi.c#L296-L394</a></em></p>

              </div>
            </div>
          </section>
          <hr class="hi dy hj hk hl dv hm hn ho hp hq" />
          <section class="cu cv cw cx cy">
            <div class="n p">
              <div class="ac ae af ag ah dz aj ak">
                <h1 id="bda6" class="hr hs ec bk bj ht ee hu eg hv hw hx hy hz ia ib ic">Build and Test OpenOCD with SPI
                </h1>
                <p id="a033" class="gp gq ec bk gr b gs id gu ie gw if gy ig ha ih hc">The modified fork of OpenOCD may
                  be found in this repository…</p>
                <div class="kw kx ky kz la lb"><a
                    href="https://web.archive.org/web/20200117210221/https://github.com/lupyuen/openocd-spi"
                    rel="noopener nofollow">
                    <div class="le n ar">
                      <div class="lf n co p lg lh">
                        <h2 class="bj ht li bl ec">
                          <div class="di lc fm fn ld fp">lupyuen/openocd-spi</div>
                        </h2>
                        <div class="lj r">
                          <h3 class="bj dy ds bl bo">
                            <div class="di lc fm fn ld fp">You can&#x27;t perform that action at this time. You signed
                              in with another tab or window. You signed out in another tab or…</div>
                          </h3>
                        </div>
                        <div class="lk r">
                          <h4 class="bj dy ge bl bo">
                            <div class="di lc fm fn ld fp">github.com</div>
                          </h4>
                        </div>
                      </div>
                      <div class="ll r">
                        <div class="lm r ln lo lp ll lq lr ls"></div>
                      </div>
                    </div>
                  </a></div>
                <p id="6b24" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc">To build and test on Raspberry
                  Pi…</p>
                <p id="a357" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc">1️⃣ Connect PineTime / nRF52 to
                  the SPI port on Raspberry Pi…</p>
                <figure class="ii ij ik il im cz">
                  <div class="dl r dd">
                    <div class="iy r"><iframe
                        src="https://web.archive.org/web/20200117210221if_/https://medium.com/media/ff6891a05d70c0e092241c9d9f5e140a"
                        allowfullscreen="" frameborder="0" height="0" width="0"
                        title="See https://medium.com/@ly.lee/openocd-on-raspberry-pi-better-with-swd-on-spi-7dea9caeb590"
                        class="cp t u dh ak" scrolling="auto"></iframe></div>
                  </div>
                </figure>

                <p><img src="https://lupyuen.github.io/images/legacy/a2.jpeg" /></p>
                <p><em></em></p>

                <p id="bdc9" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc">2️⃣ Enable the SPI interface on
                  Raspberry Pi…</p>
                <pre
                  class="ii ij ik il im jm jn jo"><span id="f7f6" class="jp hs ec bk is b ds jq jr r js">sudo raspi-config</span></pre>
                <p id="ad7b" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc">Select <code
                    class="dm ip iq ir is b">Interfacing Options → SPI → Yes</code></p>
                <p id="d671" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc">3️⃣ Download and build the
                  modified OpenOCD…</p>
                <pre
                  class="ii ij ik il im jm jn jo"><span id="b44b" class="jp hs ec bk is b ds jq jr r js">git clone <a href="https://web.archive.org/web/20200117210221/https://github.com/lupyuen/openocd-spi" class="at cg he hf hg hh" target="_blank" rel="noopener nofollow">https://github.com/lupyuen/openocd-spi</a><br/>cd openocd-spi<br/>./bootstrap<br/>./configure --enable-sysfsgpio --enable-bcm2835gpio --enable-cmsis-dap<br/>make</span></pre>
                <p id="8eda" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc">The modified OpenOCD executable
                  is now at <code class="dm ip iq ir is b">openocd-spi/src/openocd</code></p>
                <p id="5c77" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc">4️⃣ If you’re using <code
                    class="dm ip iq ir is b">pinetime-rust-mynewt</code> downloaded <a class="at cg he hf hg hh"
                    target="_blank" rel="noopener"
                    href="/web/20200117210221/https://medium.com/@ly.lee/build-and-flash-rust-mynewt-firmware-for-pinetime-smart-watch-5e14259c55?source=friends_link&amp;sk=150b2a73b84144e5ef25b985e65aebe9">from
                    this article</a>…</p>
                <p id="e40b" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc">Edit the OpenOCD scripts located
                  at <code class="dm ip iq ir is b">pinetime-rust-mynewt/scripts/nrf52-pi</code>…</p>
                <p id="a482" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc"><code
                    class="dm ip iq ir is b">flash-app.sh, flash-boot.sh, flash-unprotect.sh</code></p>
                <p id="52a7" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc">Change the <code
                    class="dm ip iq ir is b">openocd</code> folder to <code class="dm ip iq ir is b">openocd-spi</code>
                  like this…</p>
                <pre
                  class="ii ij ik il im jm jn jo"><span id="e986" class="jp hs ec bk is b ds jq jr r js">sudo /home/pi/<strong class="is io">openocd-spi</strong>/src/openocd \<br/>    -s /home/pi/<strong class="is io">openocd-spi</strong>/tcl \<br/>    -f scripts/nrf52-pi/swd-pi.ocd \<br/>    -f scripts/nrf52/flash-app.ocd</span></pre>
                <p id="51fd" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc">Run the scripts to unprotect the
                  flash ROM, flash the bootloader and flash the application via SPI…</p>
                <pre
                  class="ii ij ik il im jm jn jo"><span id="f816" class="jp hs ec bk is b ds jq jr r js">cd ~/pinetime-rust-mynewt<br/>scripts/nrf52-pi/flash-unprotect.sh<br/>scripts/nrf52-pi/flash-boot.sh<br/>scripts/nrf52-pi/flash-app.sh</span></pre>
                <p id="002d" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc">5️⃣ If you’re not using <code
                    class="dm ip iq ir is b">pinetime-rust-mynewt</code>…</p>
                <p id="1d6f" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc">Here’s a sample OpenOCD script
                  and shell script that you may adapt for flashing…</p>
                <p id="48f5" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc"><code
                    class="dm ip iq ir is b"><a href="https://web.archive.org/web/20200117210221/https://github.com/lupyuen/pinetime-rust-mynewt/blob/master/scripts/nrf52/flash-boot.ocd" class="at cg he hf hg hh" target="_blank" rel="noopener nofollow">flash-boot.ocd</a></code>
                </p>
                <p id="dad4" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc"><code
                    class="dm ip iq ir is b"><a href="https://web.archive.org/web/20200117210221/https://github.com/lupyuen/pinetime-rust-mynewt/blob/master/scripts/nrf52-pi/flash-boot.sh" class="at cg he hf hg hh" target="_blank" rel="noopener nofollow">flash-boot.sh</a></code>
                </p>
                <p id="f709" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc">In <code
                    class="dm ip iq ir is b">flash-boot.sh</code>, change <code
                    class="dm ip iq ir is b">/home/pi/openocd-spi</code> to the path of your <code
                    class="dm ip iq ir is b">openocd-spi</code> folder, like <code
                    class="dm ip iq ir is b">/home/pi/openocd-spi</code></p>
              </div>
            </div>
          </section>
          <hr class="hi dy hj hk hl dv hm hn ho hp hq" />
          <section class="cu cv cw cx cy">
            <div class="n p">
              <div class="ac ae af ag ah dz aj ak">
                <h1 id="7160" class="hr hs ec bk bj ht ee hu eg hv hw hx hy hz ia ib ic">Bit Banging Is Bad</h1>
                <p id="f168" class="gp gq ec bk gr b gs id gu ie gw if gy ig ha ih hc"><a
                    href="https://web.archive.org/web/20200117210221/https://en.wikipedia.org/wiki/Bit_banging"
                    class="at cg he hf hg hh" target="_blank" rel="noopener nofollow">Bit Banging</a> means sending and
                  receiving data one bit at a time… By looping around, waiting and sending one bit, waiting and sending
                  another bit, …</p>
                <p id="c9a9" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc">When I was teaching IoT with
                  Arduino Uno, I saw plenty of Arduino drivers implemented with Bit Banging. This troubled me because…
                </p>
                <ol class="">
                  <li id="2b33" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc jt ju jv"><strong
                      class="gr io">Hard to reuse the Bit Banging code on other platforms</strong> (from Arduino to
                    Raspberry Pi, STM32, nRF52, RISC-V, …). The timing needs to be adjusted precisely for every
                    platform.</li>
                  <li id="3792" class="gp gq ec bk gr b gs jw gu jx gw jy gy jz ha ka hc jt ju jv"><strong
                      class="gr io">Doesn’t work reliably with Multitasking</strong>, which skews the timing between
                    bits. On a Raspberry Pi graphical desktop, this explains why <strong class="gr io">OpenOCD can’t
                      flash nRF52 reliably with GPIO Bit Banging</strong>… The CPU is just too busy handling interactive
                    tasks.</li>
                  <li id="bfda" class="gp gq ec bk gr b gs jw gu jx gw jy gy jz ha ka hc jt ju jv">It’s 2020. <strong
                      class="gr io">Surely our microcontroller supports interrupt-driven, precisely-clocked SPI and I2C
                      interfaces,</strong> like on Raspberry Pi, STM32, nRF52, RISC-V, … (If you’re still using Arduino
                    Uno… <em class="hd">Why???</em>)</li>
                </ol>
                <p id="2456" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc">Here’s my plea to all Embedded
                  Developers: <strong class="gr io">Please stop using Bit Banging!</strong> I hope this article has
                  given you plenty of reasons. <em class="hd">(And this article has wasted your precious time, since you
                    wouldn’t be reading it if OpenOCD were using SPI already)</em></p>
                <p id="0ba3" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc">If you’re designing a serial
                  protocol like SWD… <strong class="gr io">Please align the bits to whole bytes!</strong> The SWD
                  protocol was designed with plenty of stray bits <em class="hd">(every read/write operation is 46
                    bits)</em>, thus Bit Banging was the natural solution for implementing the SWD protocol.</p>
                <p id="af0f" class="gp gq ec bk gr b gs gt gu gv gw gx gy gz ha hb hc"><em class="hd">If Arm had slipped
                    in two measly bits and rounded up to 48 bits, we would have been using SWD over SPI, reliably and
                    efficiently, a long time ago!</em></p>
              </div>
            </div>
          </section>
          <hr class="hi dy hj hk hl dv hm hn ho hp hq" />
          <section class="cu cv cw cx cy">
            <div class="n p">
              <div class="ac ae af ag ah dz aj ak">
                <h1 id="eb1a" class="hr hs ec bk bj ht ee hu eg hv hw hx hy hz ia ib ic">References</h1>
                <ul class="">
                  <li id="2003" class="gp gq ec bk gr b gs id gu ie gw if gy ig ha ih hc lt ju jv"><a
                      href="https://web.archive.org/web/20200117210221/https://github.com/MarkDing/swd_programing_sram"
                      class="at cg he hf hg hh" target="_blank" rel="noopener nofollow"><em class="hd">Introduction to
                        SWD</em></a></li>
                  <li id="6b0b" class="gp gq ec bk gr b gs jw gu jx gw jy gy jz ha ka hc lt ju jv"><a
                      href="https://web.archive.org/web/20200117210221/https://github.com/MarkDing/swd_programing_sram/blob/master/Ref/ARM_debug.pdf"
                      class="at cg he hf hg hh" target="_blank" rel="noopener nofollow"><em class="hd">ARM® Debug
                        Interface v5 Architecture Specification</em></a></li>
                  <li id="60ea" class="gp gq ec bk gr b gs jw gu jx gw jy gy jz ha ka hc lt ju jv"><a
                      href="https://web.archive.org/web/20200117210221/https://www.raspberrypi.org/documentation/hardware/raspberrypi/spi/README.md"
                      class="at cg he hf hg hh" target="_blank" rel="noopener nofollow"><em class="hd">Raspberry Pi SPI
                        Hardware</em></a></li>
                  <li id="f7ef" class="gp gq ec bk gr b gs jw gu jx gw jy gy jz ha ka hc lt ju jv"><a
                      href="https://web.archive.org/web/20200117210221/https://github.com/raspberrypi/linux/blob/rpi-3.12.y/drivers/spi/spi-bcm2708.c"
                      class="at cg he hf hg hh" target="_blank" rel="noopener nofollow"><em class="hd">Raspberry Pi SPI
                        Kernel Driver</em></a></li>
                  <li id="9a3b" class="gp gq ec bk gr b gs jw gu jx gw jy gy jz ha ka hc lt ju jv"><a
                      href="https://web.archive.org/web/20200117210221/https://www.raspberrypi.org/documentation/hardware/raspberrypi/bcm2835/BCM2835-ARM-Peripherals.pdf"
                      class="at cg he hf hg hh" target="_blank" rel="noopener nofollow"><em class="hd">BCM2835
                        Peripherals Datasheet</em></a></li>
                  <li id="dc67" class="gp gq ec bk gr b gs jw gu jx gw jy gy jz ha ka hc lt ju jv"><a
                      href="https://web.archive.org/web/20200117210221/https://docs.google.com/spreadsheets/d/12oXe1MTTEZVIbdmFXsOgOXVFHCQnYVvIw6fRpIQZybg/edit#gid=0"
                      class="at cg he hf hg hh" target="_blank" rel="noopener nofollow"><em class="hd">SWD mapping to
                        SPI bytes</em></a></li>
                </ul>
              </div>
            </div>
          </section>
        </div>
      </article>
    </div>
  </div>
  </body>
</html>
<!--
     FILE ARCHIVED ON 21:02:21 Jan 17, 2020 AND RETRIEVED FROM THE
     INTERNET ARCHIVE ON 12:16:07 Feb 20, 2021.
     JAVASCRIPT APPENDED BY WAYBACK MACHINE, COPYRIGHT INTERNET ARCHIVE.

     ALL OTHER CONTENT MAY ALSO BE PROTECTED BY COPYRIGHT (17 U.S.C.
     SECTION 108(a)(3)).
-->
<!--
playback timings (ms):
  LoadShardBlock: 67.641 (3)
  PetaboxLoader3.datanode: 89.242 (4)
  RedisCDXSource: 0.942
  exclusion.robots.policy: 0.342
  exclusion.robots: 0.356
  CDXLines.iter: 26.317 (3)
  captures_list: 98.904
  esindex: 0.012
  PetaboxLoader3.resolve: 85.294
  load_resource: 142.424
-->