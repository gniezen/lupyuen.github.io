<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="rustdoc">
    <title>PineDio Stack BL604 runs Apache NuttX RTOS</title>

    
    <!-- Begin scripts/articles/*-header.html: Article Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<meta property="og:title" 
    content="PineDio Stack BL604 runs Apache NuttX RTOS" 
    data-rh="true">
<meta property="og:description" 
    content="Running Apache NuttX RTOS on PineDio Stack BL604 RISC-V board... With ST7789 Display, LVGL Graphics and LoRaWAN"
    data-rh="true">
<meta property="og:image" 
    content="https://lupyuen.github.io/images/pinedio2-title.jpg">
<meta property="og:type" 
    content="article" data-rh="true">
<!-- End scripts/articles/*-header.html -->
<!-- Begin scripts/rustdoc-header.html: Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<link rel="alternate" type="application/rss+xml" title="RSS Feed for lupyuen" href="/rss.xml" />
<link rel="stylesheet" type="text/css" href="../normalize.css">
<link rel="stylesheet" type="text/css" href="../rustdoc.css" id="mainThemeStyle">
<link rel="stylesheet" type="text/css" href="../dark.css">
<link rel="stylesheet" type="text/css" href="../light.css" id="themeStyle">
<link rel="stylesheet" type="text/css" href="../prism.css">
<script src="../storage.js"></script><noscript>
<link rel="stylesheet" href="../noscript.css"></noscript>
<link rel="shortcut icon" href="../favicon.ico">
<style type="text/css">
    #crate-search {
        background-image: url("../down-arrow.svg");
    }
    a {
        color: #77d;
    }
</style>
<!-- End scripts/rustdoc-header.html -->


</head>
<body class="rustdoc">
    <!--[if lte IE 8]>
    <div class="warning">
        This old browser is unsupported and will most likely display funky
        things.
    </div>
    <![endif]-->

        <!-- Begin scripts/rustdoc-before.html: Pre-HTML for Custom Markdown files processed by rustdoc, like chip8.md -->

    <!-- Begin Theme Picker -->
    <div class="theme-picker" style="left: 0"><button id="theme-picker" aria-label="Pick another theme!"><img src="../brush.svg"
        width="18" alt="Pick another theme!"></button>
        <div id="theme-choices"></div>
    </div>
    <script src="../theme.js"></script>
    <script src="../prism.js"></script>
    <!-- Theme Picker -->

    <!-- End scripts/rustdoc-before.html -->
    

    <h1 class="title">PineDio Stack BL604 runs Apache NuttX RTOS</h1>
    <nav id="TOC"><ul>
<li><a href="#what-is-nuttx">1 What is NuttX?</a><ul></ul></li>
<li><a href="#build-nuttx">2 Build NuttX</a><ul></ul></li>
<li><a href="#prepare-pinedio-stack">3 Prepare PineDio Stack</a><ul></ul></li>
<li><a href="#flash-pinedio-stack">4 Flash PineDio Stack</a><ul></ul></li>
<li><a href="#boot-pinedio-stack">5 Boot PineDio Stack</a><ul></ul></li>
<li><a href="#run-nuttx">6 Run NuttX</a><ul></ul></li>
<li><a href="#nuttx-apps">7 NuttX Apps</a><ul></ul></li>
<li><a href="#more-apps">8 More Apps</a><ul></ul></li>
<li><a href="#what-about-lora">9 What About LoRa?</a><ul></ul></li>
<li><a href="#whats-next">10 What‚Äôs Next</a><ul></ul></li>
<li><a href="#notes">11 Notes</a><ul></ul></li>
<li><a href="#appendix-shared-spi-bus">12 Appendix: Shared SPI Bus</a><ul>
<li><a href="#spi-device-id">12.1 SPI Device ID</a><ul></ul></li>
<li><a href="#swap-miso--mosi">12.2 Swap MISO / MOSI</a><ul></ul></li>
<li><a href="#spi-device-table">12.3 SPI Device Table</a><ul></ul></li>
<li><a href="#pin-definitions">12.4 Pin Definitions</a><ul></ul></li>
<li><a href="#select--deselect-spi-device">12.5 Select / Deselect SPI Device</a><ul></ul></li>
<li><a href="#spi-command--data">12.6 SPI Command / Data</a><ul></ul></li>
<li><a href="#deselect-all-spi-devices">12.7 Deselect All SPI Devices</a><ul></ul></li>
<li><a href="#test-shared-spi-bus">12.8 Test Shared SPI Bus</a><ul></ul></li>
<li><a href="#sx1262-chip-select">12.9 SX1262 Chip Select</a><ul></ul></li></ul></li>
<li><a href="#appendix-st7789-display">13 Appendix: ST7789 Display</a><ul>
<li><a href="#spi-mode">13.1 SPI Mode</a><ul></ul></li>
<li><a href="#spi-frequency">13.2 SPI Frequency</a><ul></ul></li></ul></li>
<li><a href="#appendix-sx1262-lora-transceiver">14 Appendix: SX1262 LoRa Transceiver</a><ul>
<li><a href="#test-lora">14.1 Test LoRa</a><ul></ul></li>
<li><a href="#test-lorawan">14.2 Test LoRaWAN</a><ul></ul></li></ul></li>
<li><a href="#appendix-upcoming-features">15 Appendix: Upcoming Features</a><ul>
<li><a href="#touch-panel">15.1 Touch Panel</a><ul></ul></li>
<li><a href="#push-button">15.2 Push Button</a><ul></ul></li>
<li><a href="#accelerometer">15.3 Accelerometer</a><ul></ul></li>
<li><a href="#power-management">15.4 Power Management</a><ul></ul></li>
<li><a href="#spi-flash">15.5 SPI Flash</a><ul></ul></li>
<li><a href="#gps">15.6 GPS</a><ul></ul></li></ul></li></ul></nav><p>üìù <em>12 Apr 2022</em></p>
<p><img src="https://lupyuen.github.io/images/pinedio2-title.jpg" alt="Pine64 PineDio Stack BL604 RISC-V Board" /></p>
<p><em>Pine64 PineDio Stack BL604 RISC-V Board</em></p>
<p><strong>PineDio Stack BL604</strong> is Pine64‚Äôs newest microcontroller board, based on <a href="https://lupyuen.github.io/articles/pinecone"><strong>Bouffalo Lab‚Äôs BL604</strong></a> RISC-V + WiFi + Bluetooth LE SoC.</p>
<p>(Available any day now!)</p>
<p>PineDio Stack is packed <strong>chock-full of features</strong>‚Ä¶</p>
<ul>
<li>
<p>ST7789 <strong>Colour LCD Display</strong></p>
<p>(240 x 240 pixels)</p>
</li>
<li>
<p>CST816S <strong>Touch Panel</strong></p>
<p>(Connected on I2C)</p>
</li>
<li>
<p>Semtech SX1262 <strong>LoRa Transceiver</strong></p>
<p>(Works with LoRaWAN wireless networks)</p>
</li>
<li>
<p>AT6558 <strong>GPS / GNSS Receiver</strong></p>
</li>
<li>
<p>SGM40561 <strong>Power Management Unit</strong></p>
</li>
<li>
<p><strong>Heart Rate Sensor, Accelerometer, Compass, Vibrator</strong></p>
</li>
<li>
<p><strong>SPI Flash, JTAG Debugging Port, Push Button</strong></p>
</li>
<li>
<p><strong>2.4 GHz WiFi, Bluetooth LE</strong></p>
<p>(Thanks to BL604)</p>
</li>
</ul>
<p>Which makes it an awesome gadget for <strong>IoT Education</strong>!</p>
<p>(It looks like a <strong>‚ÄúChonky PineTime‚Äù</strong>‚Ä¶ It has the same display and touch panel as PineTime)</p>
<p>Today we shall build, flash and run the open-source, community-supported <a href="https://lupyuen.github.io/articles/nuttx"><strong>Apache NuttX RTOS</strong></a> (Real-Time Operating System) on PineDio Stack‚Ä¶</p>
<p>And get started on creating <strong>our own IoT Apps</strong>!</p>
<p><img src="https://lupyuen.github.io/images/spi2-pinedio2a.jpg" alt="Pine64 PineDio Stack BL604 RISC-V Board" /></p>
<p><em>Pine64 PineDio Stack BL604 RISC-V Board</em></p>
<h1 id="what-is-nuttx" class="section-header"><a href="#what-is-nuttx">1 What is NuttX?</a></h1>
<p><a href="https://nuttx.apache.org/docs/latest/"><strong>Apache NuttX</strong></a> is a popular Real-Time Operating System (RTOS) for microcontrollers (8-bit to 64-bit). It runs on all kinds of hardware: <strong>Arm, ESP32, RISC-V,</strong> ‚Ä¶ Even <a href="https://docs.px4.io/master/en/"><strong>flying drones</strong></a>!</p>
<p>NuttX feels like a <strong>lighter version of Linux</strong> because it uses familiar functions to access the microcontroller hardware:  <em>open(), read(), write(), ioctl(), ‚Ä¶</em></p>
<p>(NuttX is <a href="https://nuttx.apache.org/docs/latest/introduction/inviolables.html#strict-posix-compliance"><strong>POSIX Compliant</strong></a>)</p>
<p>We‚Äôve done many fun experiments with NuttX on BL602 and BL604: <a href="https://lupyuen.github.io/articles/st7789"><strong>ST7789 Display</strong></a>, <a href="https://lupyuen.github.io/articles/bme280"><strong>BME280 Sensor</strong></a>, <a href="https://lupyuen.github.io/articles/ikea"><strong>IKEA Air Quality Sensor</strong></a>, <a href="https://github.com/lupyuen/bl602_adc_test"><strong>Internal Temperature Sensor</strong></a>, <a href="https://lupyuen.github.io/articles/sx1262"><strong>LoRa</strong></a>, <a href="https://lupyuen.github.io/articles/lorawan3"><strong>LoRaWAN</strong></a>, <a href="https://lupyuen.github.io/articles/rusti2c"><strong>Rust</strong></a>, <a href="https://lupyuen.github.io/articles/nuttx#basic-interpreter"><strong>BASIC</strong></a>, <a href="https://lupyuen.github.io/articles/cbor2"><strong>CBOR</strong></a>, ‚Ä¶ And now PineDio Stack.</p>
<p>The source code for <strong>NuttX on PineDio Stack</strong> is here‚Ä¶</p>
<ul>
<li>
<p><a href="https://github.com/lupyuen/incubator-nuttx/tree/pinedio"><strong>lupyuen/incubator-nuttx</strong> (pinedio branch)</a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/incubator-nuttx-apps/tree/pinedio"><strong>lupyuen/incubator-nuttx-apps</strong> (pinedio branch)</a></p>
<p><a href="https://github.com/apache/incubator-nuttx/pulls?q=is%3Apr+author%3Alupyuen+is%3Aclosed">(Yep I‚Äôm a NuttX Contributor)</a></p>
</li>
</ul>
<p>Let‚Äôs go hands-on with NuttX!</p>
<p><img src="https://lupyuen.github.io/images/nuttx-build2.png" alt="Building NuttX" /></p>
<h1 id="build-nuttx" class="section-header"><a href="#build-nuttx">2 Build NuttX</a></h1>
<p>NuttX builds fine on <strong>Linux</strong> (x64), <strong>macOS</strong> and <strong>Windows Subsystem for Linux</strong> (WSL).</p>
<p>Here are the steps to build NuttX for PineDio Stack‚Ä¶</p>
<ol>
<li>
<p>Install the <strong>build prerequisites</strong>‚Ä¶</p>
<p><a href="https://lupyuen.github.io/articles/nuttx#install-prerequisites"><strong>‚ÄúInstall Prerequisites‚Äù</strong></a></p>
</li>
<li>
<p>Enter these commands to <strong>download, configure and build</strong> NuttX‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>#  Download NuttX for PineDio Stack
mkdir nuttx
cd nuttx
git clone --recursive --branch pinedio https://github.com/lupyuen/incubator-nuttx nuttx
git clone --recursive --branch pinedio https://github.com/lupyuen/incubator-nuttx-apps apps

#  Configure NuttX for PineDio Stack
cd nuttx
./tools/configure.sh bl602evb:pinedio

#  Build NuttX for PineDio Stack
make</code></pre></div></li>
<li>
<p>We should see‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>LD: nuttx
CP: nuttx.hex
CP: nuttx.bin</code></pre></div>
<p>We have successfully built the NuttX Firmware for PineDio Stack!</p>
<p><a href="https://gist.github.com/lupyuen/3ff5b3a5b6c160c76d56e33c35745ef7">(See the Build Log)</a></p>
</li>
<li>
<p><strong>For WSL:</strong> Copy the NuttX Firmware to the <strong>c:\blflash</strong> directory in the Windows File System‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>#  /mnt/c/blflash refers to c:\blflash in Windows
mkdir /mnt/c/blflash
cp nuttx.bin /mnt/c/blflash</code></pre></div>
<p>We‚Äôll flash PineDio Stack with Windows Command Prompt (CMD) because we need the COM port.</p>
</li>
</ol>
<p><em>What‚Äôs ‚Äúbl602evb:pinedio‚Äù?</em></p>
<p>That‚Äôs the <strong>NuttX Build Configuration</strong> for PineDio Stack. It selects the Build Options, NuttX Drivers and NuttX Apps that will run on PineDio Stack.</p>
<p><a href="https://github.com/lupyuen/incubator-nuttx/blob/pinedio/boards/risc-v/bl602/bl602evb/configs/pinedio/defconfig">(See the configuration file)</a></p>
<p><img src="https://lupyuen.github.io/images/pinedio2-test1.jpg" alt="PineDio Stack Self-Test" /></p>
<h1 id="prepare-pinedio-stack" class="section-header"><a href="#prepare-pinedio-stack">3 Prepare PineDio Stack</a></h1>
<p>Let‚Äôs get ready to flash the NuttX Firmware to PineDio Stack!</p>
<ul>
<li>
<p>Connect PineDio Stack to our computer‚Äôs <strong>USB Port</strong>.</p>
<p>The <strong>Self Test</strong> screen appears. (Pic above)</p>
<p><strong>Tap each button</strong> to verify that PineDio Stack is OK.</p>
<p><a href="https://lupyuen.github.io/images/pinedio2-test.jpg">(We should see this)</a></p>
</li>
</ul>
<p><img src="https://lupyuen.github.io/images/pinedio2-back.jpg" alt="PineDio Stack Back Cover" /></p>
<ul>
<li>
<p>Disconnect PineDio Stack from the USB Port.</p>
<p>Carefully open the <strong>Back Cover</strong> of PineDio Stack. (Pic above)</p>
<p>(Don‚Äôt remove the display!)</p>
<p>We‚Äôll see the <strong>PineDio Stack Baseboard</strong>‚Ä¶</p>
</li>
</ul>
<p><img src="https://lupyuen.github.io/images/pinedio2-inside7.jpg" alt="PineDio Stack Baseboard" /></p>
<ul>
<li>
<p>Carefully <strong>remove the PineDio Stack Baseboard</strong>.</p>
<p>We‚Äôll see the <strong>Main Board</strong>‚Ä¶</p>
</li>
</ul>
<p><img src="https://lupyuen.github.io/images/pinedio2-inside5.jpg" alt="Inside PineDio Stack" /></p>
<p><em>What‚Äôs on the Main Board?</em></p>
<ul>
<li>
<p><a href="https://lupyuen.github.io/images/pinedio2-jumper.jpg"><strong>GPIO 8 Jumper</strong></a> (top right): Set PineDio Stack to Flashing Mode or Normal Mode</p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/pinedio#appendix-improvised-reset-button-for-pinedio-stack"><strong>Improvised Reset Button</strong></a> (lower left): We connect a Jumper Cable (to the I2C Port) to restart PineDio Stack during flashing and testing</p>
</li>
<li>
<p><strong>LoRa Antenna</strong> (bottom): Connect an antenna here if we‚Äôre testing LoRa </p>
</li>
<li>
<p><strong>WiFi / Bluetooth LE Antenna</strong> (right): Connect an antenna here if we‚Äôre testing WiFi or Bluetooth LE</p>
</li>
<li>
<p><strong>JTAG Port</strong> (top left): For debugging (but not flashing)</p>
</li>
<li>
<p><strong>GPIO Port</strong> (lower right): Connects the baseboard</p>
</li>
<li>
<p><strong>Push Button</strong> (just below the jumper): Works like a watch button</p>
</li>
</ul>
<p>Check out the <strong>PineDio Stack Schematics</strong>‚Ä¶</p>
<ul>
<li>
<p><a href="https://github.com/lupyuen/pinedio-stack-nuttx/blob/main/pinedio_stack_v1_0-2021_09_15-a.pdf"><strong>PineDio Stack Schematic</strong> (2021-09-15)</a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/pinedio-stack-nuttx/blob/main/PINEDIO_STACK_BASEBOARD_V1_0-SCH-2021-09-27.pdf"><strong>PineDio Stack Baseboard Schematic</strong> (2021-09-27)</a></p>
</li>
</ul>
<p>We‚Äôre ready to flash PineDio Stack!</p>
<p><img src="https://lupyuen.github.io/images/nuttx-flash2.png" alt="Flashing NuttX" /></p>
<p><a href="https://gist.github.com/lupyuen/9c0dbd75bb6b8e810939a36ffb5c399f">(Source)</a></p>
<h1 id="flash-pinedio-stack" class="section-header"><a href="#flash-pinedio-stack">4 Flash PineDio Stack</a></h1>
<p>Let‚Äôs flash the NuttX Firmware to PineDio Stack.  Follow these steps to install <strong>blflash</strong>‚Ä¶</p>
<ul>
<li>
<p><a href="https://lupyuen.github.io/articles/flash#install-rustup"><strong>‚ÄúInstall rustup‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/flash#download-and-build-blflash"><strong>‚ÄúDownload blflash‚Äù</strong></a></p>
</li>
</ul>
<p>Set PineDio Stack to <strong>Flashing Mode</strong> and restart the board‚Ä¶</p>
<ol>
<li>
<p>Set the <strong>GPIO 8 Jumper</strong> to <strong>High</strong> <a href="https://lupyuen.github.io/images/pinedio-high.jpg">(Like this)</a></p>
</li>
<li>
<p>Disconnect the USB cable and reconnect</p>
<p>Or use the Improvised Reset Button <a href="https://lupyuen.github.io/articles/pinedio#appendix-improvised-reset-button-for-pinedio-stack">(Here‚Äôs how)</a></p>
</li>
</ol>
<p>Enter these commands to flash <strong>nuttx.bin</strong> to PineDio Stack‚Ä¶</p>
<p>(<strong>For WSL:</strong> Do this in Windows Command Prompt CMD instead of WSL. blflash needs to access the COM port)</p>
<div class="example-wrap"><pre class="language-bash"><code># For Linux: Change &quot;/dev/ttyUSB0&quot; to the PineDio Stack Serial Port
blflash flash nuttx.bin \
  --port /dev/ttyUSB0 

# For macOS: Change &quot;/dev/tty.usbserial-1410&quot; to the PineDio Stack Serial Port
blflash flash nuttx.bin \
  --port /dev/tty.usbserial-1410 \
  --initial-baud-rate 230400 \
  --baud-rate 230400

# For Windows: Change &quot;COM5&quot; to the PineDio Serial Port
blflash flash c:\blflash\nuttx.bin --port COM5</code></pre></div>
<p>We should see‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>Sending eflash_loader...
Erase flash addr: 10000 size: 565200
Program flash...
Program done 27.434715128s 20.12KiB/s
Success</code></pre></div>
<p><a href="https://gist.github.com/lupyuen/9c0dbd75bb6b8e810939a36ffb5c399f">(See the Flash Log)</a></p>
<p>NuttX has been flashed to PineDio Stack!</p>
<p><em>Will PineDio Stack get bricked if we flash bad firmware?</em></p>
<p>After using BL602 and BL604 for 1.5 years, I‚Äôve never bricked a single BL602 or BL604 board.</p>
<p>So go ahead and create your own PineDio Stack firmware, it‚Äôs all OK!</p>
<p><a href="https://github.com/apache/incubator-nuttx/issues/4336">(Flashing WiFi apps? See this)</a></p>
<p><img src="https://lupyuen.github.io/images/nuttx-boot2.png" alt="Running NuttX" /></p>
<h1 id="boot-pinedio-stack" class="section-header"><a href="#boot-pinedio-stack">5 Boot PineDio Stack</a></h1>
<p>Like Linux, NuttX provides a <strong>Command-Line Interface</strong> for controlling our gadget. This is how we access the <strong>NuttX Shell</strong>‚Ä¶</p>
<p>Set PineDio Stack to <strong>Normal Mode</strong> (Non-Flashing) and restart the board‚Ä¶</p>
<ol>
<li>
<p>Set the <strong>GPIO 8 Jumper</strong> to <strong>Low</strong> <a href="https://lupyuen.github.io/images/pinedio-low.jpg">(Like this)</a></p>
</li>
<li>
<p>Disconnect the USB cable and reconnect</p>
<p>Or use the Improvised Reset Button <a href="https://lupyuen.github.io/articles/pinedio#appendix-improvised-reset-button-for-pinedio-stack">(Here‚Äôs how)</a></p>
</li>
</ol>
<p>After restarting, connect a <strong>Serial Terminal</strong> to PineDio Stack at <strong>2 Mbps</strong>‚Ä¶</p>
<p><strong>For Linux:</strong> Use <strong>screen</strong></p>
<div class="example-wrap"><pre class="language-bash"><code>screen /dev/ttyUSB0 2000000</code></pre></div>
<p><strong>For macOS:</strong> Use CoolTerm <a href="https://lupyuen.github.io/articles/flash#watch-the-firmware-run">(See this)</a></p>
<p><strong>For Windows:</strong> Use putty <a href="https://lupyuen.github.io/articles/flash#watch-the-firmware-run">(See this)</a></p>
<p><strong>Alternatively:</strong> Use the Web Serial Terminal <a href="https://lupyuen.github.io/articles/flash#watch-the-firmware-run">(See this)</a></p>
<p>Press Enter to reveal the <strong>NuttX Shell</strong>‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>NuttShell (NSH) NuttX-10.2.0-RC0
nsh&gt;</code></pre></div>
<p>Congratulations NuttX is now running on PineDio Stack!</p>
<p><img src="https://lupyuen.github.io/images/pinedio2-boot4.jpg" alt="PineDio Stack boots with Pink Screen" /></p>
<h1 id="run-nuttx" class="section-header"><a href="#run-nuttx">6 Run NuttX</a></h1>
<p>NuttX boots with a <a href="https://lupyuen.github.io/articles/st7789#render-pink-screen"><strong>Pink Screen</strong></a>. (Pic above)</p>
<p>In the NuttX Shell, enter this command‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>ls /dev</code></pre></div>
<p>We see a list of <strong>Device Drivers</strong> that were loaded by NuttX. (Pic below)</p>
<p>Now that NuttX is up, let‚Äôs run some NuttX Apps!</p>
<blockquote>
<p><img src="https://lupyuen.github.io/images/pinedio2-run4a.png" alt="Device Drivers loaded by NuttX" /></p>
</blockquote>
<blockquote>
<p><a href="https://gist.github.com/lupyuen/80f3bc431c9e5aa93d429809c9554629">(Source)</a></p>
</blockquote>
<h1 id="nuttx-apps" class="section-header"><a href="#nuttx-apps">7 NuttX Apps</a></h1>
<p>In the NuttX Shell, enter this command‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>help</code></pre></div>
<p>(‚Äú<strong><code>?</code></strong>‚Äù works too)</p>
<p>We see a list of <strong>NuttX Apps</strong> that have been installed‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>Builtin Apps:
  bas             lorawan_test  spi_test2
  bl602_adc_test  lvgltest      sx1262_test
  getprime        nsh           timer
  gpio            sensortest    tinycbor_test
  hello           spi_test
  ikea_air_quality_sensor</code></pre></div>
<p>Enter this to run the <strong>LVGL Test App</strong>‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>lvgltest</code></pre></div>
<p>This appears on the screen: <em>‚ÄúHello PineDio Stack!‚Äù</em> with a funky blue/green box‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/pinedio2-title.jpg" alt="LVGL Test App on PineDio Stack" /></p>
<p><em>Can we render our own text and graphics?</em></p>
<p>Sure can! Below is the code that renders the screen, by calling the <a href="https://docs.lvgl.io/7.11/get-started/quick-overview.html#learn-the-basics"><strong>LVGL Graphics Library</strong></a>‚Ä¶</p>
<div class="example-wrap"><pre class="language-c"><code>//  Create the LVGL Widgets that will be rendered on the display
static void create_widgets(void) {
  //  Get the Active Screen
  lv_obj_t *screen = lv_scr_act();

  //  Create a Label Widget
  lv_obj_t *label = lv_label_create(screen, NULL);

  //  Wrap long lines in the label text
  lv_label_set_long_mode(label, LV_LABEL_LONG_BREAK);

  //  Interpret color codes in the label text
  lv_label_set_recolor(label, true);

  //  Center align the label text
  lv_label_set_align(label, LV_LABEL_ALIGN_CENTER);

  //  Set the label text and colors
  lv_label_set_text(
    label, 
    &quot;#ff0000 HELLO# &quot;    //  Red Text
    &quot;#00ff00 PINEDIO# &quot;  //  Green Text
    &quot;#0000ff STACK!# &quot;   //  Blue Text
  );

  //  Set the label width
  lv_obj_set_width(label, 200);

  //  Align the label to the center of the screen, shift 30 pixels up
  lv_obj_align(label, NULL, LV_ALIGN_CENTER, 0, -30);

  //  Omitted: Render a rounded rectangle with LVGL Canvas</code></pre></div>
<p><a href="https://github.com/lupyuen/lvgltest-nuttx/blob/main/lvgltest.c#L110-L198">(Source)</a></p>
<p>To render our own text and graphics, edit this source file and change the code above‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>apps/examples/lvgltest/lvgltest.c</code></pre></div>
<p>Then rebuild (‚Äú<code>make</code>‚Äù) and reflash (‚Äú<code>blflash</code>‚Äù) NuttX to PineDio Stack.</p>
<p><a href="https://docs.lvgl.io/7.11/get-started/quick-overview.html#learn-the-basics">(More about LVGL)</a></p>
<p><em>Can we touch the screen?</em></p>
<p>Real soon, we‚Äôre porting the <a href="https://codeberg.org/JF002/pinedio-stack-selftest/src/branch/master/drivers/cst816s.c"><strong>Touch Panel I2C Driver</strong></a> to NuttX. Stay Tuned!</p>
<p><img src="https://lupyuen.github.io/images/pinedio2-run5.png" alt="bl602_adc_test: Shows the Internal Temperature of BL604" /></p>
<p><a href="https://gist.github.com/lupyuen/deb752ac79c7b0ad51c6da6889660c27">(Source)</a></p>
<h1 id="more-apps" class="section-header"><a href="#more-apps">8 More Apps</a></h1>
<p><em>What other NuttX Apps can we try?</em></p>
<ul>
<li>
<p><strong>hello</strong>: Prints <em>‚ÄúHello World‚Äù</em></p>
<p><a href="https://github.com/lupyuen/incubator-nuttx-apps/blob/pinedio/examples/hello/hello_main.c">(Source code)</a></p>
</li>
<li>
<p><strong>bl602_adc_test</strong>: Shows the Internal Temperature of BL604</p>
<p><a href="https://github.com/lupyuen/bl602_adc_test">(See this)</a></p>
</li>
<li>
<p><strong>bas</strong>: BASIC Interpreter (Ctrl-D to quit)</p>
<p><a href="https://lupyuen.github.io/articles/nuttx#run-basic">(See this)</a></p>
</li>
</ul>
<p><a href="https://gist.github.com/lupyuen/deb752ac79c7b0ad51c6da6889660c27">(Here‚Äôs a demo of the apps)</a></p>
<p><img src="https://lupyuen.github.io/images/lorawan3-title.jpg" alt="PineDio Stack BL604 RISC-V Board (left) talking LoRaWAN to RAKwireless WisGate LoRaWAN Gateway (right)" /></p>
<p><em>PineDio Stack BL604 RISC-V Board (left) talking LoRaWAN to RAKwireless WisGate LoRaWAN Gateway (right)</em></p>
<h1 id="what-about-lora" class="section-header"><a href="#what-about-lora">9 What About LoRa?</a></h1>
<p>TODO: These apps require a LoRa Antenna to be connected to PineDio Stack‚Ä¶</p>
<ul>
<li>
<p><strong>spi_test2</strong>: TODO</p>
</li>
<li>
<p><strong>sx1262_test</strong>: TODO</p>
</li>
<li>
<p><strong>lorawan_test</strong>: TODO</p>
</li>
<li>
<p><strong>tinycbor_test</strong>: TODO</p>
</li>
</ul>
<h1 id="whats-next" class="section-header"><a href="#whats-next">10 What‚Äôs Next</a></h1>
<p>TODO</p>
<p>Many Thanks to my <a href="https://github.com/sponsors/lupyuen"><strong>GitHub Sponsors</strong></a> for supporting my work! This article wouldn‚Äôt have been possible without your support.</p>
<ul>
<li>
<p><a href="https://github.com/sponsors/lupyuen">Sponsor me a coffee</a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/book">Read ‚ÄúThe RISC-V BL602 / BL604 Book‚Äù</a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io">Check out my articles</a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/rss.xml">RSS Feed</a></p>
</li>
</ul>
<p><em>Got a question, comment or suggestion? Create an Issue or submit a Pull Request here‚Ä¶</em></p>
<p><a href="https://github.com/lupyuen/lupyuen.github.io/blob/master/src/pinedio2.md"><code>lupyuen.github.io/src/pinedio2.md</code></a></p>
<h1 id="notes" class="section-header"><a href="#notes">11 Notes</a></h1>
<ol>
<li>
<p>This article is the expanded version of <a href="https://twitter.com/MisterTechBlog/status/1510406086326513668">this Twitter Thread</a></p>
</li>
<li>
<p>Besides NuttX, there are two other ways to code firmware for PineDio Stack‚Ä¶</p>
<p><a href="https://github.com/bouffalolab/bl_iot_sdk"><strong>BL IoT SDL</strong></a>: Supports WiFi and is based on FreeRTOS</p>
<p><a href="https://github.com/bouffalolab/bl_mcu_sdk"><strong>BL MCU SDK</strong></a>: Doesn‚Äôt support WiFi, also based on FreeRTOS)</p>
</li>
<li>
<p>The PineDio Stack <strong>Self-Test Firmware</strong> was created by JF with BL MCU SDK‚Ä¶</p>
<p><a href="https://codeberg.org/JF002/pinedio-stack-selftest"><strong>JF002/pinedio-stack-selftest</strong></a></p>
</li>
<li>
<p><strong>LVGL Canvas</strong> consumes a lot of RAM! Disable it if we don‚Äôt really need it, we‚Äôll save 7 KB of RAM‚Ä¶</p>
<p>Configure NuttX: <code>make menuconfig</code></p>
<p>Select ‚ÄúApplication Configuration ‚Üí Graphics Support ‚Üí Light and Versatile Graphic Library (LVGL) ‚Üí Object Type Usage Settings‚Äù</p>
<p>Uncheck ‚ÄúCanvas Usage‚Äù</p>
<p>Save and exit menuconfig, then rebuild NuttX (<code>make</code>)</p>
</li>
<li>
<p>BL604 has 32 GPIOs, can we use all of them in NuttX? See this‚Ä¶</p>
<p><a href="https://github.com/apache/incubator-nuttx/issues/5810"><strong>‚ÄúGPIO issues on BL602‚Äù</strong></a></p>
</li>
</ol>
<h1 id="appendix-shared-spi-bus" class="section-header"><a href="#appendix-shared-spi-bus">12 Appendix: Shared SPI Bus</a></h1>
<p>This section explains how we modified NuttX to handle the <strong>Shared SPI Bus</strong> on PineDio Stack BL604.</p>
<p>Acording to the PineDio Stack Schematics‚Ä¶</p>
<ul>
<li>
<p><a href="https://github.com/lupyuen/pinedio-stack-nuttx/blob/main/pinedio_stack_v1_0-2021_09_15-a.pdf"><strong>PineDio Stack Schematic</strong> (2021-09-15)</a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/pinedio-stack-nuttx/blob/main/PINEDIO_STACK_BASEBOARD_V1_0-SCH-2021-09-27.pdf"><strong>PineDio Stack Baseboard Schematic</strong> (2021-09-27)</a></p>
</li>
</ul>
<p>The SPI Bus is shared by‚Ä¶</p>
<ul>
<li>
<p>ST7789 Display Controller</p>
</li>
<li>
<p>Semtech SX1262 LoRa Transceiver</p>
</li>
<li>
<p>SPI Flash</p>
</li>
</ul>
<p><img src="https://lupyuen.github.io/images/pinedio-spi2.jpg" alt="Shared SPI Bus on PineDio Stack BL604" /></p>
<p>Here are the BL604 GPIO Numbers for the shared SPI Bus‚Ä¶</p>
<div><table><thead><tr><th style="text-align: left">Function</th><th style="text-align: center">GPIO</th></tr></thead><tbody>
<tr><td style="text-align: left">SPI MOSI</td><td style="text-align: center">13</td></tr>
<tr><td style="text-align: left">SPI MISO</td><td style="text-align: center">0</td></tr>
<tr><td style="text-align: left">SPI SCK</td><td style="text-align: center">11</td></tr>
<tr><td style="text-align: left">SPI CS <em>(Unused)</em></td><td style="text-align: center">8</td></tr>
</tbody></table>
</div>
<p><a href="https://github.com/lupyuen/incubator-nuttx/blob/pinedio/boards/risc-v/bl602/bl602evb/include/board.h#L99-L105">(Source)</a></p>
<p>To prevent crosstalk, we select each SPI Device by flipping its <strong>Chip Select Pin</strong> from High to Low‚Ä¶</p>
<div><table><thead><tr><th style="text-align: left">SPI Device</th><th style="text-align: center">Device ID</th><th style="text-align: center">Swap MISO/MOSI</th><th style="text-align: center">Chip Select</th></tr></thead><tbody>
<tr><td style="text-align: left">ST7789 Display</td><td style="text-align: center">0x40000</td><td style="text-align: center">No</td><td style="text-align: center">20</td></tr>
<tr><td style="text-align: left">SX1262 Transceiver</td><td style="text-align: center">1</td><td style="text-align: center">Yes</td><td style="text-align: center">15</td></tr>
<tr><td style="text-align: left">SPI Flash</td><td style="text-align: center">2</td><td style="text-align: center">Yes</td><td style="text-align: center">14</td></tr>
<tr><td style="text-align: left"><em>(Default Device)</em></td><td style="text-align: center">-1</td><td style="text-align: center">Yes</td><td style="text-align: center">8 <em>(Unused)</em></td></tr>
</tbody></table>
</div>
<p><a href="https://github.com/lupyuen/incubator-nuttx/blob/pinedio/boards/risc-v/bl602/bl602evb/include/board.h#L106-L127">(Source)</a></p>
<p><em>How is Chip Select implemented in NuttX?</em></p>
<p>To select (or deselect) an SPI Device, NuttX calls these functions provided by the BL602 / BL604 SPI Driver‚Ä¶</p>
<ul>
<li>
<p><a href="https://github.com/lupyuen/incubator-nuttx/blob/pinedio/arch/risc-v/src/bl602/bl602_spi.c#L384-L414"><strong>bl602_spi_lock</strong></a>: Lock (or unlock) the SPI Bus with a Semaphore</p>
</li>
<li>
<p><a href="https://github.com/apache/incubator-nuttx/blob/master/arch/risc-v/src/bl602/bl602_spi.c#L415-L453"><strong>bl602_spi_select</strong></a>: Flip the Chip Select Pin to Low (or High)</p>
</li>
</ul>
<p>However the SPI Driver doesn‚Äôt support multiple Chip Select Pins. <a href="https://github.com/apache/incubator-nuttx/blob/master/arch/risc-v/src/bl602/bl602_spi.c#L415-L453">(See this)</a></p>
<p>Here‚Äôs how we modded the SPI Driver for PineDio Stack‚Ä¶</p>
<h2 id="spi-device-id" class="section-header"><a href="#spi-device-id">12.1 SPI Device ID</a></h2>
<p><em>What‚Äôs the SPI Device ID in the table above?</em></p>
<p>We identify each SPI Device with a unique <strong>SPI Device ID</strong>. </p>
<p>NuttX passes the Device ID when it calls <a href="https://github.com/apache/incubator-nuttx/blob/master/arch/risc-v/src/bl602/bl602_spi.c#L415-L453"><strong>bl602_spi_select</strong></a>. We‚Äôll use this to flip the right Chip Select Pin for the SPI Device.</p>
<p><em>How did we get the SPI Device IDs?</em></p>
<p>NuttX auto-assigns <code>0x40000</code> as the SPI Device ID for the ST7789 Display. <a href="https://github.com/lupyuen/incubator-nuttx/blob/pinedio/include/nuttx/spi/spi.h#L459">(See this)</a></p>
<p>We assigned the other SPI Device IDs ourselves.</p>
<p>Device ID <code>-1</code> is meant as a fallthrough to catch all SPI Devices that don‚Äôt match the Device IDs. This also works for simple SPI setups where the Device ID is not needed.</p>
<h2 id="swap-miso--mosi" class="section-header"><a href="#swap-miso--mosi">12.2 Swap MISO / MOSI</a></h2>
<p><em>What‚Äôs the Swap MISO / MOSI column in the table above?</em></p>
<p>According to the <a href="https://github.com/bouffalolab/bl_docs/blob/main/BL602_RM/en/BL602_BL604_RM_1.2_en.pdf"><strong>BL602 / BL604 Reference Manual</strong></a> (Table 3.1 ‚ÄúPin Description‚Äù, Page 26)‚Ä¶</p>
<ul>
<li>
<p><strong>GPIO 13</strong> is designated as <strong>MOSI</strong></p>
</li>
<li>
<p><strong>GPIO 0</strong> is designed as <strong>MISO</strong></p>
</li>
</ul>
<p>But due to a BL602 / BL604 SPI quirk we need to <strong>swap MISO and MOSI</strong> to get this behaviour. <a href="https://lupyuen.github.io/articles/spi2#appendix-miso-and-mosi-are-swapped">(See this)</a></p>
<p>That‚Äôs why the ‚ÄúSwap MISO / MOSI‚Äù column is marked ‚ÄúYes‚Äù for <strong>SX1262 Transceiver and SPI Flash</strong>.</p>
<p><em>But ST7789 doesn‚Äôt swap MISO and MOSI?</em></p>
<p>The <strong>ST7789 Display Controller</strong> is wired differently on PineDio Stack‚Ä¶</p>
<ul>
<li>
<p>ST7789 receives SPI Data on <strong>GPIO 0</strong></p>
</li>
<li>
<p>ST7789 Data / Command Pin is connected on <strong>GPIO 13</strong></p>
<p>(High for ST7789 Data, Low for ST7789 Commands)</p>
</li>
</ul>
<p>The direction of <strong>SPI Data is flipped for ST7789</strong>.</p>
<p>That‚Äôs why the ‚ÄúSwap MISO / MOSI‚Äù column is marked ‚ÄúNo‚Äù for the ST7789 Display Controller.</p>
<p><em>So we will swap and unswap MISO / MOSI on the fly?</em></p>
<p>Yep since we‚Äôll run the ST7789, SX1262 and SPI Flash drivers concurrently, we‚Äôll need to <strong>swap and unswap MISO / MOSI before every SPI operation</strong>.</p>
<p>We‚Äôll do this in <a href="https://github.com/lupyuen/incubator-nuttx/blob/pinedio/arch/risc-v/src/bl602/bl602_spi.c#L439-L471"><strong>bl602_spi_select</strong></a>.</p>
<h2 id="spi-device-table" class="section-header"><a href="#spi-device-table">12.3 SPI Device Table</a></h2>
<p><em>How do we store the SPI Device Table in NuttX?</em></p>
<p>We represent the above SPI Device Table in NuttX as a <strong>flat <code>int</code> array</strong>‚Ä¶</p>
<div><table><thead><tr><th style="text-align: left">SPI Device</th><th style="text-align: center">Device ID</th><th style="text-align: center">Swap MISO/MOSI</th><th style="text-align: center">Chip Select</th></tr></thead><tbody>
<tr><td style="text-align: left"><em>ST7789 Display</em></td><td style="text-align: center">0x40000</td><td style="text-align: center">0</td><td style="text-align: center">20</td></tr>
<tr><td style="text-align: left"><em>SX1262 Transceiver</em></td><td style="text-align: center">1</td><td style="text-align: center">1</td><td style="text-align: center">15</td></tr>
<tr><td style="text-align: left"><em>SPI Flash</em></td><td style="text-align: center">2</td><td style="text-align: center">1</td><td style="text-align: center">14</td></tr>
<tr><td style="text-align: left"><em>(Default Device)</em></td><td style="text-align: center">-1</td><td style="text-align: center">1</td><td style="text-align: center">8</td></tr>
</tbody></table>
</div>
<p><a href="https://github.com/lupyuen/incubator-nuttx/blob/pinedio/boards/risc-v/bl602/bl602evb/src/bl602_bringup.c#L112-L133">(Source)</a></p>
<p>Here‚Äôs the source code for the <strong>SPI Device Table</strong>‚Ä¶</p>
<div class="example-wrap"><pre class="language-c"><code>#ifdef CONFIG_BL602_SPI0
/* SPI Device Table: SPI Device ID, Swap MISO/MOSI, Chip Select */

static const int32_t bl602_spi_device_table[] =
{
#ifdef BOARD_LCD_DEVID  /* ST7789 Display */
  BOARD_LCD_DEVID, BOARD_LCD_SWAP, BOARD_LCD_CS,
#endif  /* BOARD_LCD_DEVID */

#ifdef BOARD_SX1262_DEVID  /* LoRa SX1262 */
  BOARD_SX1262_DEVID, BOARD_SX1262_SWAP, BOARD_SX1262_CS,
#endif  /* BOARD_SX1262_DEVID */

#ifdef BOARD_FLASH_DEVID  /* SPI Flash */
  BOARD_FLASH_DEVID, BOARD_FLASH_SWAP, BOARD_FLASH_CS,
#endif  /* BOARD_FLASH_DEVID */

  /* Must end with Default SPI Device */

  -1, 1, BOARD_SPI_CS,  /* Swap MISO/MOSI */
};
#endif  /* CONFIG_BL602_SPI0 */</code></pre></div>
<p><a href="https://github.com/lupyuen/incubator-nuttx/blob/pinedio/boards/risc-v/bl602/bl602evb/src/bl602_bringup.c#L112-L133">(Source)</a></p>
<p>The <code>BOARD_*</code> constants will be explained in the next section.</p>
<p>The columns of the SPI Device Table are defined like so‚Ä¶</p>
<div class="example-wrap"><pre class="language-c"><code>/* Columns in the SPI Device Table */

#define DEVID_COL 0  /* SPI Device ID */
#define SWAP_COL  1  /* 1 if MISO/MOSI should be swapped, else 0 */
#define CS_COL    2  /* SPI Chip Select Pin */
#define NUM_COLS  3  /* Number of columns in SPI Device Table */</code></pre></div>
<p><a href="https://github.com/lupyuen/incubator-nuttx/blob/pinedio/boards/risc-v/bl602/bl602evb/include/board.h#L36-L41">(Source)</a></p>
<p>We created these functions for <strong>accessing the SPI Device Table</strong>‚Ä¶</p>
<ul>
<li>
<p><a href="https://github.com/lupyuen/incubator-nuttx/blob/pinedio/boards/risc-v/bl602/bl602evb/src/bl602_bringup.c#L210-L239"><strong>bl602_spi_get_device</strong></a>: Lookup a device in the SPI Device Table</p>
<p>(Called when selecting and deselecting devices)</p>
</li>
<li>
<p><a href="https://github.com/lupyuen/incubator-nuttx/blob/pinedio/boards/risc-v/bl602/bl602evb/src/bl602_bringup.c#L178-L208"><strong>bl602_spi_deselect_devices</strong></a>: Deselect all devices in the SPI Device Table</p>
<p>(Called during startup)</p>
</li>
<li>
<p><a href="https://github.com/lupyuen/incubator-nuttx/blob/pinedio/boards/risc-v/bl602/bl602evb/src/bl602_bringup.c#L140-L176"><strong>bl602_spi_validate_devices</strong></a>: Validate the devices in the SPI Device Table</p>
<p>(In case of coding errors)</p>
</li>
</ul>
<p>Let‚Äôs look at the <code>BOARD_*</code> definitions.</p>
<h2 id="pin-definitions" class="section-header"><a href="#pin-definitions">12.4 Pin Definitions</a></h2>
<p><em>Where are the SPI Pins defined?</em></p>
<p>The SPI Device Table above refers to the following <strong>Pin Definitions</strong>‚Ä¶</p>
<div class="example-wrap"><pre class="language-c"><code>/* SPI for PineDio Stack: Chip Select (unused), MOSI, MISO, SCK */

#define BOARD_SPI_CS   (GPIO_INPUT | GPIO_PULLUP | GPIO_FUNC_SPI | GPIO_PIN8)  /* Unused */
#define BOARD_SPI_MOSI (GPIO_INPUT | GPIO_PULLUP | GPIO_FUNC_SPI | GPIO_PIN13)
#define BOARD_SPI_MISO (GPIO_INPUT | GPIO_PULLUP | GPIO_FUNC_SPI | GPIO_PIN0)
#define BOARD_SPI_CLK  (GPIO_INPUT | GPIO_PULLUP | GPIO_FUNC_SPI | GPIO_PIN11)

#ifdef CONFIG_LCD_ST7789
/* ST7789 for PineDio Stack: Chip Select, Reset and Backlight */

#define BOARD_LCD_DEVID SPIDEV_DISPLAY(0)  /* SPI Device ID: 0x40000 */
#define BOARD_LCD_SWAP  0    /* Don&#39;t swap MISO/MOSI */
#define BOARD_LCD_BL_INVERT  /* Backlight is active when Low */
#define BOARD_LCD_CS  (GPIO_OUTPUT | GPIO_PULLUP | GPIO_FUNC_SWGPIO | GPIO_PIN20)
#define BOARD_LCD_RST (GPIO_OUTPUT | GPIO_PULLUP | GPIO_FUNC_SWGPIO | GPIO_PIN3)
#define BOARD_LCD_BL  (GPIO_OUTPUT | GPIO_PULLUP | GPIO_FUNC_SWGPIO | GPIO_PIN21)
#endif  /* CONFIG_LCD_ST7789 */

/* SX1262 for PineDio Stack: Chip Select */

#define BOARD_SX1262_DEVID 1  /* SPI Device ID */
#define BOARD_SX1262_SWAP  1  /* Swap MISO/MOSI */
#define BOARD_SX1262_CS (GPIO_OUTPUT | GPIO_PULLUP | GPIO_FUNC_SWGPIO | GPIO_PIN15)

/* SPI Flash for PineDio Stack: Chip Select */

#define BOARD_FLASH_DEVID 2  /* SPI Device ID */
#define BOARD_FLASH_SWAP  1  /* Swap MISO/MOSI */
#define BOARD_FLASH_CS (GPIO_OUTPUT | GPIO_PULLUP | GPIO_FUNC_SWGPIO | GPIO_PIN14)</code></pre></div>
<p><a href="https://github.com/lupyuen/incubator-nuttx/blob/pinedio/boards/risc-v/bl602/bl602evb/include/board.h#L99-L128">(Source)</a></p>
<p>Now that we have defined the SPI Device Table in NuttX, let‚Äôs use it.</p>
<h2 id="select--deselect-spi-device" class="section-header"><a href="#select--deselect-spi-device">12.5 Select / Deselect SPI Device</a></h2>
<p>TODO</p>
<p>BL602 NuttX SPI Driver looks up the SPI Device Table to 1Ô∏è‚É£ Swap MISO and MOSI Pins 2Ô∏è‚É£ Flip the Chip Select Pins. This is how we select and deselect each SPI Device‚Ä¶</p>
<div class="example-wrap"><pre class="language-c"><code>//  Enable/disable the SPI chip select
static void bl602_spi_select(struct spi_dev_s *dev, uint32_t devid,
                             bool selected)
{
  const int32_t *spidev;

  spiinfo(&quot;devid: %lu, CS: %s\n&quot;, devid, selected ? &quot;select&quot; : &quot;free&quot;);

  /* get device from SPI Device Table */

  spidev = bl602_spi_get_device(devid);
  DEBUGASSERT(spidev != NULL);

  /* swap MISO and MOSI if needed */

  if (selected)
    {
      bl602_swap_spi_0_mosi_with_miso(spidev[SWAP_COL]);
    }

  /* set Chip Select */

  bl602_gpiowrite(spidev[CS_COL], !selected);

#ifdef CONFIG_SPI_CMDDATA
  /* revert MISO and MOSI from GPIO Pins to SPI Pins */

  if (!selected)
    {
      bl602_configgpio(BOARD_SPI_MISO);
      bl602_configgpio(BOARD_SPI_MOSI);
    }
#endif
}</code></pre></div>
<p><a href="https://github.com/lupyuen/incubator-nuttx/blob/pinedio/arch/risc-v/src/bl602/bl602_spi.c#L439-L471">(Source)</a></p>
<p><code>bl602_spi_select</code> is called after locking the SPI Bus.</p>
<h2 id="spi-command--data" class="section-header"><a href="#spi-command--data">12.6 SPI Command / Data</a></h2>
<p>TODO</p>
<p>NuttX RTOS uses MISO as the ST7789 Data / Command Pin ‚Ä¶ But ST7789 is wired ‚Äúbackwards‚Äù on PineDio Stack BL604! We use MOSI as the ST7789 Data / Command Pin instead.</p>
<p>Here how we flip the ST7789 Data / Command pin depending on MISO / MOSI Swap‚Ä¶</p>
<div class="example-wrap"><pre class="language-c"><code>#ifdef CONFIG_SPI_CMDDATA
static int bl602_spi_cmddata(struct spi_dev_s *dev,
                              uint32_t devid, bool cmd)
{
  spiinfo(&quot;devid: %&quot; PRIu32 &quot; CMD: %s\n&quot;, devid, cmd ? &quot;command&quot; :
          &quot;data&quot;);

  if (devid == SPIDEV_DISPLAY(0))
    {
      const int32_t *spidev;
      gpio_pinset_t dc;
      gpio_pinset_t gpio;
      int ret;

      /* get device from SPI Device Table */

      spidev = bl602_spi_get_device(devid);
      DEBUGASSERT(spidev != NULL);

      /* if MISO/MOSI are swapped, DC is MISO, else MOSI */

      dc = spidev[SWAP_COL] ? BOARD_SPI_MISO : BOARD_SPI_MOSI;

      /* reconfigure DC from SPI Pin to GPIO Pin */

      gpio = (dc &amp; GPIO_PIN_MASK)
             | GPIO_OUTPUT | GPIO_PULLUP | GPIO_FUNC_SWGPIO;
      ret = bl602_configgpio(gpio);
      if (ret &lt; 0)
        {
          spierr(&quot;Failed to configure MISO as GPIO\n&quot;);
          DEBUGPANIC();

          return ret;
        }

      /* set DC to high (data) or low (command) */

      bl602_gpiowrite(gpio, !cmd);

      return OK;
    }

  spierr(&quot;SPI cmddata not supported\n&quot;);
  DEBUGPANIC();

  return -ENODEV;
}
#endif</code></pre></div>
<p><a href="https://github.com/lupyuen/incubator-nuttx/blob/pinedio/arch/risc-v/src/bl602/bl602_spi.c#L726-L774">(Source)</a></p>
<h2 id="deselect-all-spi-devices" class="section-header"><a href="#deselect-all-spi-devices">12.7 Deselect All SPI Devices</a></h2>
<p>TODO</p>
<p>At NuttX Startup, we deselect all SPI Devices ‚Ä¶ By flipping their Chip Select Pins high‚Ä¶</p>
<div class="example-wrap"><pre class="language-c"><code>static void bl602_spi_init(struct spi_dev_s *dev)
{
  struct bl602_spi_priv_s *priv = (struct bl602_spi_priv_s *)dev;
  const struct bl602_spi_config_s *config = priv-&gt;config;

  /* Initialize the SPI semaphore that enforces mutually exclusive access */

  nxsem_init(&amp;priv-&gt;exclsem, 0, 1);

  bl602_configgpio(BOARD_SPI_CS);
  bl602_configgpio(BOARD_SPI_MOSI);
  bl602_configgpio(BOARD_SPI_MISO);
  bl602_configgpio(BOARD_SPI_CLK);

  /* set master mode */

  bl602_set_spi_0_act_mode_sel(1);

  /* swap MOSI with MISO to be consistent with BL602 Reference Manual */

  bl602_swap_spi_0_mosi_with_miso(1);

  /* spi cfg  reg:
   * cr_spi_deg_en 1
   * cr_spi_m_cont_en 0
   * cr_spi_byte_inv 0
   * cr_spi_bit_inv 0
   */

  modifyreg32(BL602_SPI_CFG, SPI_CFG_CR_M_CONT_EN
              | SPI_CFG_CR_BYTE_INV | SPI_CFG_CR_BIT_INV,
              SPI_CFG_CR_DEG_EN);

  /* disable rx ignore */

  modifyreg32(BL602_SPI_CFG, SPI_CFG_CR_RXD_IGNR_EN, 0);

  bl602_spi_setfrequency(dev, config-&gt;clk_freq);
  bl602_spi_setbits(dev, 8);
  bl602_spi_setmode(dev, config-&gt;mode);

  /* spi fifo clear */

  modifyreg32(BL602_SPI_FIFO_CFG_0, SPI_FIFO_CFG_0_RX_CLR
              | SPI_FIFO_CFG_0_TX_CLR, 0);

  /* deselect all spi devices */

  bl602_spi_deselect_devices();
}</code></pre></div>
<p><a href="https://github.com/lupyuen/incubator-nuttx/blob/pinedio/arch/risc-v/src/bl602/bl602_spi.c#L1191-L1240">(Source)</a></p>
<h2 id="test-shared-spi-bus" class="section-header"><a href="#test-shared-spi-bus">12.8 Test Shared SPI Bus</a></h2>
<p>TODO</p>
<p>Will ST7789 Display play nice with LoRa SX1262 on PineDio Stack BL604? Yep SX1262 works OK on the Shared SPI Bus!</p>
<p>PineDio Stack boots and renders a Pink Screen‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>gpio_pin_register: Registering /dev/gpio0
gpio_pin_register: Registering /dev/gpio1
gpint_enable: Disable the interrupt
gpio_pin_register: Registering /dev/gpio2
bl602_gpio_set_intmod: ****gpio_pin=115, int_ctlmod=1, int_trgmod=0
spi_test_driver_register: devpath=/dev/spitest0, spidev=0
st7789_sleep: sleep: 0
st7789_sendcmd: cmd: 0x11
st7789_sendcmd: OK
st7789_bpp: bpp: 16
st7789_sendcmd: cmd: 0x3a
st7789_sendcmd: OK
st7789_setorientation:
st7789_sendcmd: cmd: 0x36
st7789_sendcmd: OK
st7789_display: on: 1
st7789_sendcmd: cmd: 0x29
st7789_sendcmd: OK
st7789_sendcmd: cmd: 0x21
st7789_sendcmd: OK
st7789_fill: color: 0xaaaa
st7789_sendcmd: cmd: 0x2b
st7789_sendcmd: OK
st7789_sendcmd: cmd: 0x2a
st7789_sendcmd: OK
st7789_sendcmd: cmd: 0x2c
st7789_sendcmd: OK
board_lcd_getdev: SPI port 0 bound to LCD 0
st7789_getplaneinfo: planeno: 0 bpp: 16</code></pre></div>
<p>We run the <code>spi_test2</code> app to test SX1262‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>NuttShell (NSH) NuttX-10.2.0-RC0
nsh&gt;
nsh&gt; ?
help usage:  help [-v] [&lt;cmd&gt;]

  ?      cat    help   ls     uname

Builtin Apps:
  tinycbor_test            spi_test                 nsh
  lorawan_test             timer                    sensortest
  sx1262_test              bl602_adc_test           ikea_air_quality_sensor
  bas                      spi_test2                gpio
  sh                       getprime
  lvgldemo                 hello
nsh&gt; spi_test2
spi_test_driver_open:
gpout_write: Writing 0
spi_test_driver_write: buflen=2
spi_test_driver_configspi:
spi_test_driver_read: buflen=256
gpout_write: Writing 1
Get Status: received
  a2 22
SX1262 Status is 2
gpout_write: Writing 0
spi_test_driver_write: buflen=5
spi_test_driver_configspi:
spi_test_driver_read: buflen=256
gpout_write: Writing 1
Read Register 8: received
  a2 a2 a2 a2 80
SX1262 Register 8 is 0x80</code></pre></div>
<p>SX1262 returns Register Value 0x80, which is correct!</p>
<p>Then we run the LVGL Demo App‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>spi_test_driver_close:
nsh&gt; lvgldemo
fbdev_init: Failed to open /dev/fb0: 2
st7789_getvideoinfo: fmt: 11 xres: 240 yres: 240 nplanes: 1
lcddev_init: VideoInfo:
        fmt: 11
        xres: 240
        yres: 240
        nplanes: 1
lcddev_init: PlaneInfo (plane 0):
        bpp: 16
st7789_putarea: row_start: 0 row_end: 19 col_start: 0 col_end: 239
st7789_sendcmd: cmd: 0x2b
st7789_sendcmd: OK
st7789_sendcmd: cmd: 0x2a
st7789_sendcmd: OK
st7789_sendcmd: cmd: 0x2c
st7789_sendcmd: OK
st7789_putarea: row_start: 20 row_end: 39 col_start: 0 col_end: 239
st7789_sendcmd: cmd: 0x2b
st7789_sendcmd: OK
st7789_sendcmd: cmd: 0x2a
st7789_sendcmd: OK
st7789_sendcmd: cmd: 0x2c
st7789_sendcmd: OK
st7789_putarea: row_start: 40 row_end:59 col_start: 0 col_end: 239
st7789_sendcmd: cmd: 0x2b
st7789_sendcmd: OK
st7789_sendcmd: cmd: 0x2a
st7789_sendcmd: OK
st7789_sendcmd: cmd: 0x2c
st7789_sendcmd: OK
st7789_putarea: row_start: 60 row_end: 79 col_start: 0 col_end: 239
st7789_sendcmd: cmd: 0x2b
st7789_sendcmd: OK
st7789_sendcmd: cmd: 0x2a
st7789_sendcmd: OK
st7789_sendcmd: cmd: 0x2c
st7789_sendcmd: OK
st7789_putarea: row_start: 80 row_end: 99 col_start: 0 col_end: 239
st7789_sendcmd: cmd: 0x2b
st7789_sendcmd: OK
st7789_sendcmd: cmd: 0x2a
st7789_sendcmd: OK
st7789_sendcmd: cmd: 0x2c
st7789_sendcmd: OK
st7789_putarea: row_start: 100 row_end: 119 col_start: 0 col_end: 239
st7789_sendcmd: cmd: 0x2b
st7789_sendcmd: OK
st7789_sendcmd: cmd: 0x2a
st7789_sendcmd: OK
st7789_sendcmd: cmd: 0x2c
st7789_sendcmd: OK
st7789_putarea: row_start: 120 row_end: 139 col_start: 0 col_end: 239
st7789_sendcmd: cmd: 0x2b
st7789_sendcmd: OK
st7789_sendcmd: cmd: 0x2a
st7789_sendcmd: OK
st7789_sendcmd: cmd: 0x2c
st7789_sendcmd: OK
st7789_putarea: row_start: 140 row_end: 159 col_start: 0 col_end: 239
st7789_sendcmd: cmd: 0x2b
st7789_sendcmd: OK
st7789_sendcmd: cmd: 0x2a
st7789_sendcmd: OK
st7789_sendcmd: cmd: 0x2c
st7789_sendcmd: OK
st7789_putarea: row_start: 160 row_end: 179 col_start: 0 col_end: 239
st7789_sendcmd: cmd: 0x2b
st7789_sendcmd: OK
st7789_sendcmd: cmd: 0x2a
st7789_sendcmd: OK
st7789_sendcmd: cmd: 0x2c
st7789_sendcmd: OK
st7789_putarea: row_start: 180 row_end: 199 col_start: 0 col_end: 239
st7789_sendcmd: cmd: 0x2b
st7789_sendcmd: OK
st7789_sendcmd: cmd: 0x2a
st7789_sendcmd: OK
st7789_sendcmd: cmd: 0x2c
st7789_sendcmd: OK
st7789_putarea: row_start: 200 row_end: 219 col_start: 0 col_end: 239
st7789_sendcmd: cmd: 0x2b
st7789_sendcmd: OK
st7789_sendcmd: cmd: 0x2a
st7789_sendcmd: OK
st7789_sendcmd: cmd: 0x2c
st7789_sendcmd: OK
st7789_putarea: row_start: 220 row_end: 239 col_start: 0 col_end: 239
st7789_sendcmd: cmd: 0x2b
st7789_sendcmd: OK
st7789_sendcmd: cmd: 0x2a
st7789_sendcmd: OK
st7789_sendcmd: cmd: 0x2c
st7789_sendcmd: OK
monitor_cb: 57600 px refreshed in 1110 ms</code></pre></div>
<p>Which renders the LVGL Demo Screen on ST7789 correctly!</p>
<p><img src="https://lupyuen.github.io/images/pinedio2-dark2.jpg" alt="LVGL Demo App" /></p>
<h2 id="sx1262-chip-select" class="section-header"><a href="#sx1262-chip-select">12.9 SX1262 Chip Select</a></h2>
<p>There‚Äôs a potential Race Condition if we use the SX1262 Driver concurrently with the ST7789 Driver‚Ä¶</p>
<ul>
<li>
<p>During LoRa Transmission, SX1262 Driver calls <code>ioctl()</code> to flip SX1262 Chip Select to Low</p>
<p><a href="https://github.com/lupyuen/lora-sx1262/blob/lorawan/src/sx126x-nuttx.c#L806-L832">(See this)</a></p>
</li>
<li>
<p>SX1262 Driver calls SPI Test Driver <code>/dev/spitest0</code>, which locks (<code>SPI_LOCK</code>) and selects (<code>SPI_SELECT</code>) the SPI Bus (with SPI Device ID 0)</p>
<p><a href="https://github.com/lupyuen/incubator-nuttx/blob/pinedio/drivers/rf/spi_test_driver.c#L161-L208">(See this)</a></p>
</li>
<li>
<p>Note that the calls to <code>ioctl()</code> and <code>SPI_LOCK / SPI_SELECT</code> are NOT Atomic</p>
</li>
<li>
<p>If the ST7789 Driver is active between the calls to <code>ioctl()</code> and <code>SPI_LOCK / SPI_SELECT</code>, both SX1262 Chip Select and ST7789 Chip Select will be flipped to Low</p>
</li>
<li>
<p>This might transmit garbage to SX1262</p>
</li>
</ul>
<p>To solve this problem, we will register a new SPI Test Driver <code>/dev/spitest1</code> with SPI Device ID 1.</p>
<p>The LoRa Driver will then access <code>/dev/spitest1</code>, which will <code>SPI_LOCK</code> and <code>SPI_SELECT</code> the SPI Bus (with SPI Device ID 1).</p>
<p>Since the SPI Device ID is 1, <code>SPI_SELECT</code> will flip the SX1262 Chip Select to Low.</p>
<h1 id="appendix-st7789-display" class="section-header"><a href="#appendix-st7789-display">13 Appendix: ST7789 Display</a></h1>
<p>TODO</p>
<h2 id="spi-mode" class="section-header"><a href="#spi-mode">13.1 SPI Mode</a></h2>
<p>TODO</p>
<p>BL602 / BL604 talks to ST7789 Display at SPI Mode 1 or 3 ‚Ä¶ Depends whether MISO / MOSI are swapped</p>
<div class="example-wrap"><pre class="language-c"><code>#ifdef CONFIG_BL602_SPI0
#include &quot;../boards/risc-v/bl602/bl602evb/include/board.h&quot;
#endif  /* CONFIG_BL602_SPI0 */

#ifdef CONFIG_LCD_ST7789

/****************************************************************************
 * Pre-processor Definitions
 ****************************************************************************/

/* Verify that all configuration requirements have been met */

#ifdef CONFIG_BL602_SPI0
#else
#endif   /* CONFIG_BL602_SPI0 */</code></pre></div>
<p><a href="https://github.com/lupyuen/incubator-nuttx/blob/pinedio/drivers/lcd/st7789.c#L42-L66">(Source)</a></p>
<h2 id="spi-frequency" class="section-header"><a href="#spi-frequency">13.2 SPI Frequency</a></h2>
<p>TODO</p>
<p>ST7789 Display runs OK at SPI Frequency 4 MHz. Maybe we can go higher?</p>
<div class="example-wrap"><pre class="language-text"><code>CONFIG_LCD_ST7789_FREQUENCY=4000000</code></pre></div>
<p><a href="https://github.com/lupyuen/incubator-nuttx/blob/pinedio/boards/risc-v/bl602/bl602evb/configs/pinedio/defconfig#L542">(Source)</a></p>
<p><img src="https://lupyuen.github.io/images/lorawan3-title.jpg" alt="PineDio Stack BL604 RISC-V Board (left) talking LoRaWAN to RAKwireless WisGate LoRaWAN Gateway (right)" /></p>
<p><em>PineDio Stack BL604 RISC-V Board (left) talking LoRaWAN to RAKwireless WisGate LoRaWAN Gateway (right)</em></p>
<h1 id="appendix-sx1262-lora-transceiver" class="section-header"><a href="#appendix-sx1262-lora-transceiver">14 Appendix: SX1262 LoRa Transceiver</a></h1>
<p>TODO</p>
<h2 id="test-lora" class="section-header"><a href="#test-lora">14.1 Test LoRa</a></h2>
<p>TODO</p>
<p>To test LoRa on PineDio Stack, edit <a href="https://github.com/lupyuen/sx1262_test/blob/main/sx1262_test_main.c"><code>sx1262_test_main.c</code></a> at‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>apps/examples/sx1262_test/sx1262_test_main.c</code></pre></div>
<p>And update the LoRa Parameters‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/sx1262#lora-parameters">‚ÄúLoRa Parameters‚Äù</a></li>
</ul>
<h2 id="test-lorawan" class="section-header"><a href="#test-lorawan">14.2 Test LoRaWAN</a></h2>
<p>TODO</p>
<p>LoRaWAN works OK on Shared SPI Bus yay! PineDio Stack connects to LoRaWAN Gateway (ChirpStack) and sends data packets.</p>
<p>(Internal Temperature Sensor on ADC works OK too)</p>
<p>Remember to disable all Info Logging because it affects the LoRaWAN Timers.</p>
<p>Here‚Äôs how we set the LoRaWAN Parameters‚Ä¶</p>
<ul>
<li>
<p><a href="https://lupyuen.github.io/articles/lorawan3#device-eui-join-eui-and-app-key">‚ÄúDevice EUI, Join EUI and App Key‚Äù</a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/lorawan3#lorawan-frequency">‚ÄúLoRaWAN Frequency‚Äù</a></p>
</li>
</ul>
<div class="example-wrap"><pre class="language-text"><code>NuttShell (NSH) NuttX-10.2.0-RC0
nsh&gt; lorawan_test
init_entropy_pool
offset = 2228
temperature = 31.600670 Celsius
offset = 2228
temperature = 31.084742 Celsius
offset = 2228
temperature = 32.890495 Celsius
offset = 2228
temperature = 33.535404 Celsius

##### ===================================== ######

Application name   : lorawan_test
Application version: 1.2.0
GitHub base version: 5.0.0

##### ===================================== ######

init_event_queue
TimerInit:     0x4201c750
callout_handler: lock
TimerInit:     0x4201c76c
TimerInit:     0x4201c788
TimerInit:     0x4201c804
TimerInit:     0x4201c8b8
TimerInit:     0x4201c8d4
TimerInit:     0x4201c8f0
TimerInit:     0x4201c90c
TODO: RtcGetCalendarTime
TODO: SX126xReset
init_gpio
DIO1 pintype before=5
init_gpio: change DIO1 to Trigger GPIO Interrupt on Rising Edge
gpio_ioctl: Requested pintype 8, but actual pintype 5
DIO1 pintype after=5
Starting process_dio1
process_dio1 started
process_dio1: event=0x4201b878
init_spi
SX126xSetTxParams: power=22, rampTime=7
SX126xSetPaConfig: paDutyCycle=4, hpMax=7, deviceSel=0, paLut=1
TimerInit:     0x4201b850
TimerInit:     0x4201b7bc
RadioSetModem
RadioSetModem
RadioSetPublicNetwork: public syncword=3444
RadioSleep
DIO1 add event
TODO: EepromMcuReadBuffer
TODO: EepromMcuReadBuffer
TODO: EepromMcuReadBuffer
TODO: EepromMcuReadBuffer
TODO: EepromMcuReadBuffer
TODO: EepromMcuReadBuffer
TODO: EepromMcuReadBuffer
TODO: EepromMcuReadBuffer
RadioSetModem
RadioSetPublicNetwork: public syncword=3444
DevEui      : 4B-C1-5E-E7-37-7B-B1-5B
JoinEui     : 00-00-00-00-00-00-00-00
Pin         : 00-00-00-00

TimerInit:     0x4201c3a8
TimerInit:     0x4201c3c4
TimerInit:     0x4201c288
TODO: RtcGetCalendarTime
TODO: RtcBkupRead
TODO: RtcBkupRead
RadioSetChannel: freq=923200000
RadioSetTxConfig: modem=1, power=13, fdev=0, bandwidth=0, datarate=10, coderate=      1, preambleLen=8, fixLen=0, crcOn=1, freqHopOn=0, hopPeriod=0, iqInverted=0, tim      eout=4000
RadioSetTxConfig: SpreadingFactor=10, Bandwidth=4, CodingRate=1, LowDatarateOpti      mize=0, PreambleLength=8, HeaderType=0, PayloadLength=255, CrcMode=1, InvertIQ=0
RadioStandby
RadioSetModem
SX126xSetTxParams: power=13, rampTime=7
SX126xSetPaConfig: paDutyCycle=4, hpMax=7, deviceSel=0, paLut=1
SecureElementRandomNumber: 0xa8c2a6e7
RadioSend: size=23
00 00 00 00 00 00 00 00 00 5b b1 7b 37 e7 5e c1 4b e7 a6 80 b1 e0 e4
RadioSend: PreambleLength=8, HeaderType=0, PayloadLength=23, CrcMode=1, InvertIQ      =0
TimerStop:     0x4201b850
TimerStart2:   0x4201b850, 4000 ms
callout_reset: evq=0x42013250, ev=0x4201b850

##### =========== MLME-Request ============ ######
#####               MLME_JOIN               ######
##### ===================================== ######
STATUS      : OK
StartTxProcess
TimerInit:     0x42015b7c
TimerSetValue: 0x42015b7c, 42249 ms
OnTxTimerEvent: timeout in 42249 ms, event=0
TimerStop:     0x42015b7c
TimerSetValue: 0x42015b7c, 42249 ms
TimerStart:    0x42015b7c
TimerStop:     0x42015b7c
TimerStart2:   0x42015b7c, 42249 ms
callout_reset: evq=0x42013250, ev=0x42015b7c
handle_event_queue
handle_event_queue: ev=0x4201b878
RadioOnDioIrq
RadioIrqProcess
RadioOnDioIrq
RadioIrqProcess
DIO1 add event
handle_event_queue: ev=0x4201b878
RadioOnDioIrq
RadioIrqProcess
IRQ_TX_DONE
TimerStop:     0x4201b850
TODO: RtcGetCalendarTime
TODO: RtcBkupRead
RadioOnDioIrq
RadioIrqProcess
RadioSleep
DIO1 add event
TimerSetValue: 0x4201c76c, 4988 ms
TimerStart:    0x4201c76c
TimerStop:     0x4201c76c
TimerStart2:   0x4201c76c, 4988 ms
callout_reset: evq=0x42013250, ev=0x4201c76c
TimerSetValue: 0x4201c788, 5988 ms
TimerStart:    0x4201c788
TimerStop:     0x4201c788
TimerStart2:   0x4201c788, 5988 ms
callout_reset: evq=0x42013250, ev=0x4201c788
TODO: RtcGetCalendarTime
handle_event_queue: ev=0x4201b878
RadioOnDioIrq
RadioIrqProcess
RadioOnDioIrq
RadioIrqProcess
callout_handler: unlock
callout_handler: evq=0x42013250, ev=0x4201c76c
callout_handler: lock
handle_event_queue: ev=0x4201c76c
TimerStop:     0x4201c76c
RadioStandby
RadioSetChannel: freq=923200000
RadioSetRxConfig
RadioStandby
RadioSetModem
RadioSetRxConfig done
RadioRx
TimerStop:     0x4201b7bc
TimerStart2:   0x4201b7bc, 3000 ms
callout_reset: evq=0x42013250, ev=0x4201b7bc
RadioOnDioIrq
RadioIrqProcess
DIO1 add event
handle_event_queue: ev=0x4201b878
RadioOnDioIrq
RadioIrqProcess
IRQ_PREAMBLE_DETECTED
RadioOnDioIrq
RadioIrqProcess
DIO1 add event
handle_event_queue: ev=0x4201b878
RadioOnDioIrq
RadioIrqProcess
IRQ_HEADER_VALID
RadioOnDioIrq
RadioIrqProcess
DIO1 add event
handle_event_queue: ev=0x4201b878
RadioOnDioIrq
RadioIrqProcess
IRQ_RX_DONE
TimerStop:     0x4201b7bc
RadioOnDioIrq
RadioIrqProcess
RadioSleep
DIO1 add event
TimerStop:     0x4201c788
OnTxData

##### =========== MLME-Confirm ============ ######
STATUS      : OK
OnJoinRequest
##### ===========   JOINED     ============ ######

OTAA

DevAddr     :  01097710


DATA RATE   : DR_2

TODO: EepromMcuWriteBuffer
TODO: EepromMcuWriteBuffer
TODO: EepromMcuWriteBuffer
TODO: EepromMcuWriteBuffer
TODO: EepromMcuWriteBuffer
TODO: EepromMcuWriteBuffer
UplinkProcess
PrepareTxFrame: Transmit to LoRaWAN: Hi NuttX (9 bytes)
PrepareTxFrame: status=0, maxSize=11, currentSize=11
LmHandlerSend: Data frame
TODO: RtcGetCalendarTime
TODO: RtcBkupRead
RadioSetChannel: freq=923200000
RadioSetTxConfig: modem=1, power=13, fdev=0, bandwidth=0, datarate=9, coderate=1      , preambleLen=8, fixLen=0, crcOn=1, freqHopOn=0, hopPeriod=0, iqInverted=0, time      out=4000
RadioSetTxConfig: SpreadingFactor=9, Bandwidth=4, CodingRate=1, LowDatarateOptim      ize=0, PreambleLength=8, HeaderType=0, PayloadLength=128, CrcMode=1, InvertIQ=0
RadioStandby
RadioSetModem
SX126xSetTxParams: power=13, rampTime=7
SX126xSetPaConfig: paDutyCycle=4, hpMax=7, deviceSel=0, paLut=1
RadioSend: size=22
40 10 77 09 01 00 01 00 01 a5 12 b3 cc a2 27 27 57 dc c3 a7 eb ae
RadioSend: PreambleLength=8, HeaderType=0, PayloadLength=22, CrcMode=1, InvertIQ      =0
TimerStop:     0x4201b850
TimerStart2:   0x4201b850, 4000 ms
callout_reset: evq=0x42013250, ev=0x4201b850

##### =========== MCPS-Request ============ ######
#####           MCPS_UNCONFIRMED            ######
##### ===================================== ######
STATUS      : OK
PrepareTxFrame: Transmit OK
handle_event_queue: ev=0x4201b878
RadioOnDioIrq
RadioIrqProcess
RadioOnDioIrq
RadioIrqProcess
DIO1 add event
handle_event_queue: ev=0x4201b878
RadioOnDioIrq
RadioIrqProcess
IRQ_TX_DONE
TimerStop:     0x4201b850
TODO: RtcGetCalendarTime
TODO: RtcBkupRead
RadioOnDioIrq
RadioIrqProcess
RadioSleep
DIO1 add event
TimerSetValue: 0x4201c76c, 980 ms
TimerStart:    0x4201c76c
TimerStop:     0x4201c76c
TimerStart2:   0x4201c76c, 980 ms
callout_reset: evq=0x42013250, ev=0x4201c76c
TimerSetValue: 0x4201c788, 1988 ms
TimerStart:    0x4201c788
TimerStop:     0x4201c788
TimerStart2:   0x4201c788, 1988 ms
callout_reset: evq=0x42013250, ev=0x4201c788
TODO: RtcGetCalendarTime
handle_event_queue: ev=0x4201b878
RadioOnDioIrq
RadioIrqProcess
RadioOnDioIrq
RadioIrqProcess
callout_handler: unlock
callout_handler: evq=0x42013250, ev=0x4201c76c
callout_handler: lock
handle_event_queue: ev=0x4201c76c
TimerStop:     0x4201c76c
RadioStandby
RadioSetChannel: freq=923200000
RadioSetRxConfig
RadioStandby
RadioSetModem
RadioSetRxConfig done
RadioRx
TimerStop:     0x4201b7bc
TimerStart2:   0x4201b7bc, 3000 ms
callout_reset: evq=0x42013250, ev=0x4201b7bc
RadioOnDioIrq
RadioIrqProcess
DIO1 add event
handle_event_queue: ev=0x4201b878
RadioOnDioIrq
RadioIrqProcess
IRQ_RX_TX_TIMEOUT
TimerStop:     0x4201b7bc
RadioOnDioIrq
RadioIrqProcess
RadioSleep
DIO1 add event
TimerStop:     0x4201c788
TimerStop:     0x4201c750
OnTxData

##### =========== MCPS-Confirm ============ ######
STATUS      : OK

##### =====   UPLINK FRAME        1   ===== ######

CLASS       : A

TX PORT     : 1
TX DATA     : UNCONFIRMED
48 69 20 4E 75 74 74 58 00

DATA RATE   : DR_3
U/L FREQ    : 923200000
TX POWER    : 0
CHANNEL MASK: 0003

TODO: EepromMcuWriteBuffer
TODO: EepromMcuWriteBuffer
UplinkProcess
handle_event_queue: ev=0x4201b878
RadioOnDioIrq
RadioIrqProcess
RadioOnDioIrq
RadioIrqProcess
UplinkProcess
callout_handler: unlock
callout_handler: evq=0x42013250, ev=0x42015b7c
callout_handler: lock
handle_event_queue: ev=0x42015b7c
OnTxTimerEvent: timeout in 42249 ms, event=0x42015b7c
TimerStop:     0x42015b7c
TimerSetValue: 0x42015b7c, 42249 ms
TimerStart:    0x42015b7c
TimerStop:     0x42015b7c
TimerStart2:   0x42015b7c, 42249 ms
callout_reset: evq=0x42013250, ev=0x42015b7c
RadioOnDioIrq
RadioIrqProcess
UplinkProcess
PrepareTxFrame: Transmit to LoRaWAN: Hi NuttX (9 bytes)
PrepareTxFrame: status=0, maxSize=53, currentSize=53
LmHandlerSend: Data frame
TODO: RtcGetCalendarTime
TODO: RtcBkupRead
RadioSetChannel: freq=923200000
RadioSetTxConfig: modem=1, power=13, fdev=0, bandwidth=0, datarate=9, coderate=1, preambleLen=8, fixLen=0, crcOn=1, freqHopOn=0, hopPeriod=0, iqInverted=0, timeout=4000
RadioSetTxConfig: SpreadingFactor=9, Bandwidth=4, CodingRate=1, LowDatarateOptimize=0, PreambleLength=8, HeaderType=0, PayloadLength=128, CrcMode=1, InvertIQ=0
RadioStandby
RadioSetModem
SX126xSetTxParams: power=13, rampTime=7
SX126xSetPaConfig: paDutyCycle=4, hpMax=7, deviceSel=0, paLut=1
RadioSend: size=22
40 10 77 09 01 00 02 00 01 ad b9 67 e6 1c 34 05 2d f3 d3 b5 c7 16
RadioSend: PreambleLength=8, HeaderType=0, PayloadLength=22, CrcMode=1, InvertIQ=0
TimerStop:     0x4201b850
TimerStart2:   0x4201b850, 4000 ms
callout_reset: evq=0x42013250, ev=0x4201b850

##### =========== MCPS-Request ============ ######
#####           MCPS_UNCONFIRMED            ######
##### ===================================== ######
STATUS      : OK
PrepareTxFrame: Transmit OK
DIO1 add event
handle_event_queue: ev=0x4201b878
RadioOnDioIrq
RadioIrqProcess
IRQ_TX_DONE
TimerStop:     0x4201b850
TODO: RtcGetCalendarTime
TODO: RtcBkupRead
RadioOnDioIrq
RadioIrqProcess
RadioSleep
DIO1 add event
TimerSetValue: 0x4201c76c, 980 ms
TimerStart:    0x4201c76c
TimerStop:     0x4201c76c
TimerStart2:   0x4201c76c, 980 ms
callout_reset: evq=0x42013250, ev=0x4201c76c
TimerSetValue: 0x4201c788, 1988 ms
TimerStart:    0x4201c788
TimerStop:     0x4201c788
TimerStart2:   0x4201c788, 1988 ms
callout_reset: evq=0x42013250, ev=0x4201c788
TODO: RtcGetCalendarTime
handle_event_queue: ev=0x4201b878
RadioOnDioIrq
RadioIrqProcess
RadioOnDioIrq
RadioIrqProcess
callout_handler: unlock
callout_handler: evq=0x42013250, ev=0x4201c76c
callout_handler: lock
handle_event_queue: ev=0x4201c76c
TimerStop:     0x4201c76c
RadioStandby
RadioSetChannel: freq=923200000
RadioSetRxConfig
RadioStandby
RadioSetModem
RadioSetRxConfig done
RadioRx
TimerStop:     0x4201b7bc
TimerStart2:   0x4201b7bc, 3000 ms
callout_reset: evq=0x42013250, ev=0x4201b7bc
RadioOnDioIrq
RadioIrqProcess
DIO1 add event
handle_event_queue: ev=0x4201b878
RadioOnDioIrq
RadioIrqProcess
IRQ_RX_TX_TIMEOUT
TimerStop:     0x4201b7bc
RadioOnDioIrq
RadioIrqProcess
RadioSleep
DIO1 add event
TimerStop:     0x4201c788
TimerStop:     0x4201c750
OnTxData

##### =========== MCPS-Confirm ============ ######
STATUS      : OK

##### =====   UPLINK FRAME        2   ===== ######

CLASS       : A

TX PORT     : 1
TX DATA     : UNCONFIRMED
48 69 20 4E 75 74 74 58 00

DATA RATE   : DR_3
U/L FREQ    : 923200000
TX POWER    : 0
CHANNEL MASK: 0003

TODO: EepromMcuWriteBuffer
TODO: EepromMcuWriteBuffer
UplinkProcess
handle_event_queue: ev=0x4201b878
RadioOnDioIrq
RadioIrqProcess
RadioOnDioIrq
RadioIrqProcess
UplinkProcess</code></pre></div><h1 id="appendix-upcoming-features" class="section-header"><a href="#appendix-upcoming-features">15 Appendix: Upcoming Features</a></h1>
<p>TODO</p>
<h2 id="touch-panel" class="section-header"><a href="#touch-panel">15.1 Touch Panel</a></h2>
<p>TODO: See <a href="https://codeberg.org/JF002/pinedio-stack-selftest/src/branch/master/drivers/cst816s.c">pinedio-stack-selftest/drivers/cst816s.c</a></p>
<p>Use <a href="https://github.com/lupyuen/incubator-nuttx/blob/master/drivers/input/cypress_mbr3108.c"><strong>NuttX Driver for Cypress MBR3108</strong></a> as guide, since it looks quite similar to CST816S.</p>
<h2 id="push-button" class="section-header"><a href="#push-button">15.2 Push Button</a></h2>
<p>TODO: See <a href="https://codeberg.org/JF002/pinedio-stack-selftest/src/branch/master/pushbutton.c">pinedio-stack-selftest/pushbutton.c</a></p>
<h2 id="accelerometer" class="section-header"><a href="#accelerometer">15.3 Accelerometer</a></h2>
<p>TODO: See <a href="https://codeberg.org/JF002/pinedio-stack-selftest/src/branch/master/accelerometer.c">pinedio-stack-selftest/accelerometer.c</a></p>
<h2 id="power-management" class="section-header"><a href="#power-management">15.4 Power Management</a></h2>
<p>TODO: See <a href="https://codeberg.org/JF002/pinedio-stack-selftest/src/branch/master/battery.c">pinedio-stack-selftest/battery.c</a></p>
<h2 id="spi-flash" class="section-header"><a href="#spi-flash">15.5 SPI Flash</a></h2>
<p>TODO</p>
<h2 id="gps" class="section-header"><a href="#gps">15.6 GPS</a></h2>
<p>TODO: NuttX has a GPS Demo App‚Ä¶</p>
<p><a href="https://github.com/lupyuen/incubator-nuttx-apps/blob/pinedio/examples/gps/gps_main.c">apps/examples/gps/gps_main.c</a></p>
<p>And a GPS Parser‚Ä¶</p>
<p><a href="https://github.com/lupyuen/incubator-nuttx-apps/tree/pinedio/gpsutils">apps/gpsutils</a></p>

    
</body>
</html>