<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="rustdoc">
    <title>Visual Programming with Zig and NuttX Sensors</title>

    
    <!-- Begin scripts/articles/*-header.html: Article Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<meta property="og:title" 
    content="Visual Programming with Zig and NuttX Sensors" 
    data-rh="true">
<meta property="og:description" 
    content="What if we could drag-and-drop NuttX Sensors... To create IoT Sensor Apps in Zig? Let's find out!"
    data-rh="true">
<meta property="og:image" 
    content="https://lupyuen.github.io/images/visual-title.jpg">
<meta property="og:type" 
    content="article" data-rh="true">
<!-- End scripts/articles/*-header.html -->
<!-- Begin scripts/rustdoc-header.html: Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<link rel="alternate" type="application/rss+xml" title="RSS Feed for lupyuen" href="/rss.xml" />
<link rel="stylesheet" type="text/css" href="../normalize.css">
<link rel="stylesheet" type="text/css" href="../rustdoc.css" id="mainThemeStyle">
<link rel="stylesheet" type="text/css" href="../dark.css">
<link rel="stylesheet" type="text/css" href="../light.css" id="themeStyle">
<link rel="stylesheet" type="text/css" href="../prism.css">
<script src="../storage.js"></script><noscript>
<link rel="stylesheet" href="../noscript.css"></noscript>
<link rel="shortcut icon" href="../favicon.ico">
<style type="text/css">
    #crate-search {
        background-image: url("../down-arrow.svg");
    }
    a {
        color: #77d;
    }
</style>
<!-- End scripts/rustdoc-header.html -->


</head>
<body class="rustdoc">
    <!--[if lte IE 8]>
    <div class="warning">
        This old browser is unsupported and will most likely display funky
        things.
    </div>
    <![endif]-->

        <!-- Begin scripts/rustdoc-before.html: Pre-HTML for Custom Markdown files processed by rustdoc, like chip8.md -->

    <!-- Begin Theme Picker -->
    <div class="theme-picker" style="left: 0"><button id="theme-picker" aria-label="Pick another theme!"><img src="../brush.svg"
        width="18" alt="Pick another theme!"></button>
        <div id="theme-choices"></div>
    </div>
    <script src="../theme.js"></script>
    <script src="../prism.js"></script>
    <!-- Theme Picker -->

    <!-- End scripts/rustdoc-before.html -->
    

    <h1 class="title">Visual Programming with Zig and NuttX Sensors</h1>
    <nav id="TOC"><ul>
<li><a href="#custom-blocks">1 Custom Blocks</a><ul>
<li><a href="#bme280-sensor-block">1.1 BME280 Sensor Block</a><ul></ul></li>
<li><a href="#compose-message-block">1.2 Compose Message Block</a><ul></ul></li>
<li><a href="#transmit-message-block">1.3 Transmit Message Block</a><ul></ul></li>
<li><a href="#every-block">1.4 Every Block</a><ul></ul></li></ul></li>
<li><a href="#read-sensor-data">2 Read Sensor Data</a><ul></ul></li>
<li><a href="#cbor-encoding">3 CBOR Encoding</a><ul></ul></li>
<li><a href="#custom-block">4 Custom Block</a><ul></ul></li>
<li><a href="#custom-extension">5 Custom Extension</a><ul></ul></li>
<li><a href="#connect-bme280-sensor">6 Connect BME280 Sensor</a><ul></ul></li>
<li><a href="#compile-zig-app">7 Compile Zig App</a><ul></ul></li>
<li><a href="#run-zig-app">8 Run Zig App</a><ul></ul></li>
<li><a href="#whats-next">9 What‚Äôs Next</a><ul></ul></li>
<li><a href="#notes">10 Notes</a><ul></ul></li></ul></nav><p>üìù <em>20 Aug 2022</em></p>
<p><img src="https://lupyuen.github.io/images/visual-title.jpg" alt="Visual Programming with Zig and NuttX Sensors on Blockly" /></p>
<p><em>What if we could drag-and-drop NuttX Sensors‚Ä¶ To create quick prototypes for IoT Sensor Apps?</em></p>
<p>Let‚Äôs do it!</p>
<p>TODO: Pic above, Zig, IoT, encode sensor data, LoRaWAN</p>
<p><em>Why are we doing this?</em></p>
<p>TODO: Boilerplate, error handling, overwhelming for sensor coders, also for folks who need to experiment with various sensors</p>
<p><em>Why Zig?</em></p>
<p>TODO: And we‚Äôll run it on Pine64‚Äôs <a href="https://lupyuen.github.io/articles/pinecone"><strong>PineCone BL602 RISC-V Board</strong></a>.</p>
<ul>
<li>
<p><a href="https://github.com/lupyuen/visual-zig-nuttx"><strong>lupyuen/visual-zig-nuttx</strong></a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen3/blockly-zig-nuttx"><strong>lupyuen3/blockly-zig-nuttx</strong></a></p>
</li>
</ul>
<p>And learn how how we ended up here‚Ä¶</p>
<ul>
<li>
<p><a href="https://lupyuen3.github.io/blockly-zig-nuttx/demos/code/"><strong>Blockly with Zig (Work in Progress)</strong></a></p>
</li>
<li>
<p><a href="https://youtu.be/192ZKA-1OqY"><strong>Watch the Demo on YouTube</strong></a></p>
</li>
</ul>
<h1 id="custom-blocks"><a href="#custom-blocks">1 Custom Blocks</a></h1>
<p>TODO: Interlocking blocks</p>
<h2 id="bme280-sensor-block"><a href="#bme280-sensor-block">1.1 BME280 Sensor Block</a></h2>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/visual-block5.jpg" alt="TODO" /></p>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/visual-block1.jpg" alt="TODO" /></p>
<h2 id="compose-message-block"><a href="#compose-message-block">1.2 Compose Message Block</a></h2>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/visual-block7b.jpg" alt="TODO" /></p>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/visual-block9.jpg" alt="TODO" /></p>
<h2 id="transmit-message-block"><a href="#transmit-message-block">1.3 Transmit Message Block</a></h2>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/visual-block7c.jpg" alt="TODO" /></p>
<h2 id="every-block"><a href="#every-block">1.4 Every Block</a></h2>
<p>TODO</p>
<h1 id="read-sensor-data"><a href="#read-sensor-data">2 Read Sensor Data</a></h1>
<p>TODO</p>
<p>With Zig Generics and <code>comptime</code>, we can greatly simplify the reading of Sensor Data‚Ä¶</p>
<div class="example-wrap"><pre class="language-zig"><code>// Read the Temperature
const temperature = try sen.readSensor(
    c.struct_sensor_baro,       // Sensor Data Struct to be read
    &quot;temperature&quot;,              // Sensor Data Field to be returned
    &quot;/dev/sensor/sensor_baro0&quot;  // Path of Sensor Device
);

// Print the Temperature
debug(&quot;temperature={}&quot;, .{ temperature });</code></pre></div>
<p><a href="https://github.com/lupyuen/visual-zig-nuttx/blob/master/visual.zig#L15-L62">(Source)</a></p>
<p>Here‚Äôs the implementation of <code>readSensor</code>‚Ä¶</p>
<p>https://github.com/lupyuen/visual-zig-nuttx/blob/1bb1c69ea4a9310e42b149e04ac26a7e4a1f4b58/sensor.zig#L34-L108</p>
<p>Note that the Sensor Data Struct Type and the Sensor Data Field are declared as <code>comptime</code>‚Ä¶</p>
<div class="example-wrap"><pre class="language-zig"><code>/// Read a Sensor and return the Sensor Data
pub fn readSensor(
    comptime SensorType: type,        // Sensor Data Struct to be read, like c.struct_sensor_baro
    comptime field_name: []const u8,  // Sensor Data Field to be returned, like &quot;temperature&quot;
    device_path: []const u8           // Path of Sensor Device, like &quot;/dev/sensor/sensor_baro0&quot;
) !f32 { ...</code></pre></div>
<p>Which means that the values will be substituted at Compile-Time. (Works like a C Macro)</p>
<p>We can then refer to the Sensor Data Struct <code>sensor_baro</code> like this‚Ä¶</p>
<div class="example-wrap"><pre class="language-zig"><code>    // Define the Sensor Data Type
    var sensor_data = std.mem.zeroes(
        SensorType
    );</code></pre></div>
<p>And return a field <code>temperature</code> like this‚Ä¶</p>
<div class="example-wrap"><pre class="language-zig"><code>    // Return the Sensor Data Field
    return @field(sensor_data, field_name);</code></pre></div>
<p>Thus this program‚Ä¶</p>
<p>https://github.com/lupyuen/visual-zig-nuttx/blob/a7404eae71dc37850e323848180414aa6ef7e0f7/visual.zig#L27-L61</p>
<p>Produces this output‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>NuttShell (NSH) NuttX-10.3.0
nsh&gt; sensortest visual
Zig Sensor Test
Start main
...
temperature=30.18
pressure=1007.69
humidity=68.67
End main</code></pre></div><h1 id="cbor-encoding"><a href="#cbor-encoding">3 CBOR Encoding</a></h1>
<p>TODO</p>
<p>Blockly will emit the Zig code below for a typical IoT Sensor App: <a href="https://github.com/lupyuen/visual-zig-nuttx/blob/main/visual.zig">visual.zig</a></p>
<div class="example-wrap"><pre class="language-zig"><code>// Read Temperature from BME280 Sensor
const temperature = try sen.readSensor(  // Read BME280 Sensor
    c.struct_sensor_baro,       // Sensor Data Struct
    &quot;temperature&quot;,              // Sensor Data Field
    &quot;/dev/sensor/sensor_baro0&quot;  // Path of Sensor Device
);

// Read Pressure from BME280 Sensor
const pressure = try sen.readSensor(  // Read BME280 Sensor
    c.struct_sensor_baro,       // Sensor Data Struct
    &quot;pressure&quot;,                 // Sensor Data Field
    &quot;/dev/sensor/sensor_baro0&quot;  // Path of Sensor Device
);

// Read Humidity from BME280 Sensor
const humidity = try sen.readSensor(  // Read BME280 Sensor
    c.struct_sensor_humi,       // Sensor Data Struct
    &quot;humidity&quot;,                 // Sensor Data Field
    &quot;/dev/sensor/sensor_humi0&quot;  // Path of Sensor Device
);

// Compose CBOR Message with Temperature, Pressure and Humidity
const msg = try composeCbor(.{
    &quot;t&quot;, temperature,
    &quot;p&quot;, pressure,
    &quot;h&quot;, humidity,
});

// Transmit message to LoRaWAN
try transmitLorawan(msg);</code></pre></div>
<p>This reads the Temperature, Pressure and Humidity from BME280 Sensor, composes a CBOR Message that‚Äôs encoded with the Sensor Data, and transmits the CBOR Message to LoRaWAN.</p>
<p><em><code>composeCbor</code> will work for a variable number of arguments? Strings as well as numbers?</em></p>
<p>Yep, here‚Äôs the implementation of <code>composeCbor</code>: <a href="https://github.com/lupyuen/visual-zig-nuttx/blob/main/visual.zig#L65-L108">visual.zig</a></p>
<div class="example-wrap"><pre class="language-zig"><code>/// TODO: Compose CBOR Message with Key-Value Pairs
/// https://lupyuen.github.io/articles/cbor2
fn composeCbor(args: anytype) !CborMessage {
    debug(&quot;composeCbor&quot;, .{});
    comptime {
        assert(args.len % 2 == 0);  // Missing Key or Value
    }

    // Process each field...
    comptime var i: usize = 0;
    var msg = CborMessage{};
    inline while (i &lt; args.len) : (i += 2) {

        // Get the key and value
        const key   = args[i];
        const value = args[i + 1];

        // Print the key and value
        debug(&quot;  {s}: {}&quot;, .{
            @as([]const u8, key),
            floatToFixed(value)
        });

        // Format the message for testing
        var slice = std.fmt.bufPrint(
            msg.buf[msg.len..], 
            &quot;{s}:{},&quot;,
            .{
                @as([]const u8, key),
                floatToFixed(value)
            }
        ) catch { _ = std.log.err(&quot;Error: buf too small&quot;, .{}); return error.Overflow; };
        msg.len += slice.len;
    }
    debug(&quot;  msg={s}&quot;, .{ msg.buf[0..msg.len] });
    return msg;
}

/// TODO: CBOR Message
/// https://lupyuen.github.io/articles/cbor2
const CborMessage = struct {
    buf: [256]u8 = undefined,  // Limit to 256 chars
    len: usize = 0,
};</code></pre></div>
<p>Note that <code>composeCbor</code> is declared as <code>anytype</code>‚Ä¶</p>
<div class="example-wrap"><pre class="language-zig"><code>fn composeCbor(args: anytype) { ...</code></pre></div>
<p>That‚Äôs why <code>composeCbor</code> accepts a variable number of arguments with different types.</p>
<p>To handle each argument, this <code>inline</code> / <code>comptime</code> loop is unrolled at Compile-Time‚Ä¶</p>
<div class="example-wrap"><pre class="language-zig"><code>    // Process each field...
    comptime var i: usize = 0;
    inline while (i &lt; args.len) : (i += 2) {

        // Get the key and value
        const key   = args[i];
        const value = args[i + 1];

        // Print the key and value
        debug(&quot;  {s}: {}&quot;, .{
            @as([]const u8, key),
            floatToFixed(value)
        });
        ...
    }</code></pre></div>
<p><em>What happens if we omit a Key or a Value when calling <code>composeCbor</code>?</em></p>
<p>This <code>comptime</code> assertion check will fail at Compile-Time‚Ä¶</p>
<div class="example-wrap"><pre class="language-zig"><code>comptime {
    assert(args.len % 2 == 0);  // Missing Key or Value
}</code></pre></div><h1 id="custom-block"><a href="#custom-block">4 Custom Block</a></h1>
<p>TODO</p>
<p>Let‚Äôs create a Custom Block in Blockly for our Bosch BME280 Sensor‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/visual-block1.jpg" alt="BME280 Sensor Block" /></p>
<p>The Blocks above will generate this Zig code to read the Temperature from the BME280 Sensor‚Ä¶</p>
<div class="example-wrap"><pre class="language-zig"><code>// Read the Temperature from BME280 Sensor
const temperature = try sen.readSensor(  // Read BME280 Sensor
  c.struct_sensor_baro,       // Sensor Data Struct
  &quot;temperature&quot;,              // Sensor Data Field
  &quot;/dev/sensor/sensor_baro0&quot;  // Path of Sensor Device
);

// Print the Temperature
debug(&quot;temperature={}&quot;, .{ temperature });</code></pre></div>
<p><a href="https://github.com/lupyuen/visual-zig-nuttx#zig-generics">(<code>readSensor</code> is explained here)</a></p>
<h1 id="custom-extension"><a href="#custom-extension">5 Custom Extension</a></h1>
<p>TODO</p>
<p>To test our Custom Extension for Compose Message, let‚Äôs build a Complex Sensor App that will read Temperature, Pressure and Humidity from BME280 Sensor, and transmit the values to LoRaWAN‚Ä¶</p>
<p><a href="https://lupyuen3.github.io/blockly-zig-nuttx/demos/code/">lupyuen3.github.io/blockly-zig-nuttx/demos/code</a></p>
<p><img src="https://lupyuen.github.io/images/visual-block6.jpg" alt="Complex Sensor App" /></p>
<p>The Blocks above will emit this Zig program‚Ä¶</p>
<div class="example-wrap"><pre class="language-zig"><code>/// Main Function
pub fn main() !void {

  // Every 10 seconds...
  while (true) {
    const temperature = try sen.readSensor(  // Read BME280 Sensor
      c.struct_sensor_baro,       // Sensor Data Struct
      &quot;temperature&quot;,              // Sensor Data Field
      &quot;/dev/sensor/sensor_baro0&quot;  // Path of Sensor Device
    );
    debug(&quot;temperature={}&quot;, .{ temperature });

    const pressure = try sen.readSensor(  // Read BME280 Sensor
      c.struct_sensor_baro,       // Sensor Data Struct
      &quot;pressure&quot;,                 // Sensor Data Field
      &quot;/dev/sensor/sensor_baro0&quot;  // Path of Sensor Device
    );
    debug(&quot;pressure={}&quot;, .{ pressure });

    const humidity = try sen.readSensor(  // Read BME280 Sensor
      c.struct_sensor_humi,       // Sensor Data Struct
      &quot;humidity&quot;,                 // Sensor Data Field
      &quot;/dev/sensor/sensor_humi0&quot;  // Path of Sensor Device
    );
    debug(&quot;humidity={}&quot;, .{ humidity });

    const msg = try composeCbor(.{  // Compose CBOR Message
      &quot;t&quot;, temperature,
      &quot;p&quot;, pressure,
      &quot;h&quot;, humidity,
    });

    // Transmit message to LoRaWAN
    try transmitLorawan(msg);

    // Wait 10 seconds
    _ = c.sleep(10);
  }
}</code></pre></div>
<p><a href="https://github.com/lupyuen/visual-zig-nuttx#cbor-encoding">(<code>composeCbor</code> is explained here)</a></p>
<p>Copy the contents of the Main Function and paste here‚Ä¶</p>
<p><a href="https://github.com/lupyuen/visual-zig-nuttx/blob/main/visual.zig">visual-zig-nuttx/blob/main/visual.zig</a></p>
<p>The generated Zig code should correctly read the Temperature, Pressure and Humidity from BME280 Sensor, and transmit the values to LoRaWAN‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>NuttShell (NSH) NuttX-10.3.0
nsh&gt; sensortest visual
Zig Sensor Test
Start main

temperature=31.05
pressure=1007.44
humidity=71.49
composeCbor
  t: 31.05
  p: 1007.44
  h: 71.49
  msg=t:31.05,p:1007.44,h:71.49,
transmitLorawan
  msg=t:31.05,p:1007.44,h:71.49,

temperature=31.15
pressure=1007.40
humidity=70.86
composeCbor
  t: 31.15
  p: 1007.40
  h: 70.86
  msg=t:31.15,p:1007.40,h:70.86,
transmitLorawan
  msg=t:31.15,p:1007.40,h:70.86,

temperature=31.16
pressure=1007.45
humidity=70.42
composeCbor
  t: 31.16
  p: 1007.45
  h: 70.42
  msg=t:31.16,p:1007.45,h:70.42,
transmitLorawan
  msg=t:31.16,p:1007.45,h:70.42,

temperature=31.16
pressure=1007.47
humidity=70.39
composeCbor
  t: 31.16
  p: 1007.47
  h: 70.39
  msg=t:31.16,p:1007.47,h:70.39,
transmitLorawan
  msg=t:31.16,p:1007.47,h:70.39,

temperature=31.19
pressure=1007.45
humidity=70.35
composeCbor
  t: 31.19
  p: 1007.45
  h: 70.35
  msg=t:31.19,p:1007.45,h:70.35,
transmitLorawan
  msg=t:31.19,p:1007.45,h:70.35,

temperature=31.20
pressure=1007.42
humidity=70.65
composeCbor
  t: 31.20
  p: 1007.42
  h: 70.65
  msg=t:31.20,p:1007.42,h:70.65,
transmitLorawan
  msg=t:31.20,p:1007.42,h:70.65,</code></pre></div>
<p>(Tested with NuttX and BME280 on BL602)</p>
<p><img src="https://lupyuen.github.io/images/sensor-connect.jpg" alt="Pine64 PineCone BL602 RISC-V Board connected to Bosch BME280 Sensor" /></p>
<h1 id="connect-bme280-sensor"><a href="#connect-bme280-sensor">6 Connect BME280 Sensor</a></h1>
<p>TODO</p>
<p>For testing the Zig Sensor App, we connect the BME280 Sensor (I2C) to Pine64‚Äôs <a href="https://lupyuen.github.io/articles/pinecone"><strong>PineCone BL602 Board</strong></a> (pic above)‚Ä¶</p>
<div><table><thead><tr><th style="text-align: center">BL602 Pin</th><th style="text-align: center">BME280 Pin</th><th style="text-align: left">Wire Colour</th></tr></thead><tbody>
<tr><td style="text-align: center"><strong><code>GPIO 1</code></strong></td><td style="text-align: center"><code>SDA</code></td><td style="text-align: left">Green</td></tr>
<tr><td style="text-align: center"><strong><code>GPIO 2</code></strong></td><td style="text-align: center"><code>SCL</code></td><td style="text-align: left">Blue</td></tr>
<tr><td style="text-align: center"><strong><code>3V3</code></strong></td><td style="text-align: center"><code>3.3V</code></td><td style="text-align: left">Red</td></tr>
<tr><td style="text-align: center"><strong><code>GND</code></strong></td><td style="text-align: center"><code>GND</code></td><td style="text-align: left">Black</td></tr>
</tbody></table>
</div>
<p>The <strong>I2C Pins</strong> on BL602 are defined here: <a href="https://github.com/lupyuen/incubator-nuttx/blob/master/boards/risc-v/bl602/bl602evb/include/board.h#L91-L98">board.h</a></p>
<div class="example-wrap"><pre class="language-c"><code>/* I2C Configuration */
#define BOARD_I2C_SCL \
  (GPIO_INPUT | GPIO_PULLUP | GPIO_FUNC_I2C | \
  GPIO_PIN2)
#define BOARD_I2C_SDA \
  (GPIO_INPUT | GPIO_PULLUP | GPIO_FUNC_I2C | \
  GPIO_PIN1)</code></pre></div>
<p><a href="https://lupyuen.github.io/articles/expander#pin-functions">(Which pins can be used? See this)</a></p>
<h1 id="compile-zig-app"><a href="#compile-zig-app">7 Compile Zig App</a></h1>
<p>TODO</p>
<p>Below are the steps to <strong>compile our Zig Sensor App</strong> for Apache NuttX RTOS and BL602 RISC-V SoC.</p>
<p>First we download the latest version of <strong>Zig Compiler</strong> (0.10.0 or later), extract it and add to PATH‚Ä¶</p>
<ul>
<li><a href="https://ziglang.org/download/"><strong>Zig Compiler Downloads</strong></a></li>
</ul>
<p>Then we download and compile <strong>Apache NuttX RTOS</strong> for BL602‚Ä¶</p>
<ul>
<li>
<p><a href="https://lupyuen.github.io/articles/nuttx#install-prerequisites"><strong>‚ÄúInstall Prerequisites‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/nuttx#build-nuttx"><strong>‚ÄúBuild NuttX‚Äù</strong></a></p>
</li>
</ul>
<p>Check that the following have been enabled in the NuttX Build‚Ä¶</p>
<ul>
<li>
<p><a href="https://lupyuen.github.io/articles/bme280#configure-nuttx"><strong>I2C0 Port</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/bme280#configure-nuttx"><strong>I2C Character Driver</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/bme280#configure-nuttx"><strong>BME280 Driver</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/bme280#configure-nuttx"><strong>Sensor Driver Test App</strong></a></p>
</li>
</ul>
<p>Remember to set <a href="https://lupyuen.github.io/articles/bme280#configure-nuttx"><strong>‚ÄúSensor Driver Test Stack Size‚Äù</strong></a> to <strong>4096</strong>.</p>
<p>(Because our Zig App needs additional Stack Space)</p>
<p>After building NuttX, we download and compile our <strong>Zig Sensor App</strong>‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>#  Download our Zig Sensor App for NuttX
git clone --recursive https://github.com/lupyuen/visual-zig-nuttx
cd visual-zig-nuttx

#  Compile the Zig App for BL602
#  (RV32IMACF with Hardware Floating-Point)
#  TODO: Change &quot;$HOME/nuttx&quot; to your NuttX Project Directory
zig build-obj \
  --verbose-cimport \
  -target riscv32-freestanding-none \
  -mcpu=baseline_rv32-d \
  -isystem &quot;$HOME/nuttx/nuttx/include&quot; \
  -I &quot;$HOME/nuttx/apps/include&quot; \
  sensortest.zig</code></pre></div>
<p><a href="https://gist.github.com/lupyuen/8d7a2a360bc4d14264c77f82da58b3dc">(See the Compile Log)</a></p>
<p>Note that <strong>target</strong> and <strong>mcpu</strong> are specific to BL602‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/zig#zig-target"><strong>‚ÄúZig Target‚Äù</strong></a></li>
</ul>
<p><em>How did we get the Compiler Options <code>-isystem</code> and <code>-I</code>?</em></p>
<p>Remember that we‚Äôll link our Compiled Zig App into the NuttX Firmware.</p>
<p>Hence the <strong>Zig Compiler Options must be the same</strong> as the GCC Options used to compile NuttX.</p>
<p><a href="https://github.com/lupyuen/visual-zig-nuttx#sensor-test-app-in-c">(See the GCC Options for NuttX)</a></p>
<p>Next comes a quirk specific to BL602: We must <strong>patch the ELF Header</strong> from Software Floating-Point ABI to Hardware Floating-Point ABI‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>#  Patch the ELF Header of `sensortest.o` from 
#  Soft-Float ABI to Hard-Float ABI
xxd -c 1 sensortest.o \
  | sed &#39;s/00000024: 01/00000024: 03/&#39; \
  | xxd -r -c 1 - sensortest2.o
cp sensortest2.o sensortest.o</code></pre></div>
<p><a href="https://lupyuen.github.io/articles/zig#patch-elf-header">(More about this)</a></p>
<p>Finally we inject our <strong>Compiled Zig App</strong> into the NuttX Project Directory and link it into the <strong>NuttX Firmware</strong>‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>#  Copy the compiled app to NuttX and overwrite `sensortest.o`
#  TODO: Change &quot;$HOME/nuttx&quot; to your NuttX Project Directory
cp sensortest.o $HOME/nuttx/apps/testing/sensortest/sensortest*.o

#  Build NuttX to link the Zig Object from `sensortest.o`
#  TODO: Change &quot;$HOME/nuttx&quot; to your NuttX Project Directory
cd $HOME/nuttx/nuttx
make

#  For WSL: Copy the NuttX Firmware to c:\blflash for flashing
mkdir /mnt/c/blflash
cp nuttx.bin /mnt/c/blflash</code></pre></div>
<p>We‚Äôre ready to run our Zig App!</p>
<p><img src="https://lupyuen.github.io/images/sensor-run1a.png" alt="Zig Sensor App" /></p>
<p><a href="https://github.com/lupyuen/visual-zig-nuttx#read-barometer-sensor">(Source)</a></p>
<h1 id="run-zig-app"><a href="#run-zig-app">8 Run Zig App</a></h1>
<p>TODO</p>
<p>Follow these steps to <strong>flash and boot NuttX</strong> (with our Zig App inside) on BL602‚Ä¶</p>
<ul>
<li>
<p><a href="https://lupyuen.github.io/articles/nuttx#flash-nuttx"><strong>‚ÄúFlash NuttX‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/nuttx#run-nuttx"><strong>‚ÄúRun NuttX‚Äù</strong></a></p>
</li>
</ul>
<p>In the NuttX Shell, enter this command to start our Zig App‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>sensortest test</code></pre></div>
<p>Which reads the <strong>Air Pressure and Temperature</strong> from the BME280 Barometer Sensor‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>nsh&gt; sensortest test
Zig Sensor Test
test_sensor
pressure:1007.66
temperature:27.70</code></pre></div>
<p>This says that the Air Pressure is <strong>1,007.66 millibars</strong> and the Temperature is <strong>27.70 ¬∞C</strong>.</p>
<p>Then enter this‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>sensortest test2</code></pre></div>
<p>Which reads the <strong>Humidity</strong> from the BME280 Humidity Sensor‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>nsh&gt; sensortest test2
Zig Sensor Test
test_sensor2
humidity:78.81</code></pre></div>
<p>This says that the Relative Humidity is <strong>78.81 %</strong>.</p>
<p>Yep our Zig Sensor App reads the Air Pressure, Temperature and Humidity correctly from BME280 Sensor yay!</p>
<p><img src="https://lupyuen.github.io/images/sensor-run2a.png" alt="Multiple Sensors" /></p>
<p><a href="https://github.com/lupyuen/visual-zig-nuttx#clean-up">(Source)</a></p>
<h1 id="whats-next"><a href="#whats-next">9 What‚Äôs Next</a></h1>
<p>TODO</p>
<p>Check out my earlier work on Zig, NuttX, LoRaWAN and LVGL‚Ä¶</p>
<ul>
<li>
<p><a href="https://lupyuen.github.io/articles/zig"><strong>‚ÄúZig on RISC-V BL602: Quick Peek with Apache NuttX RTOS‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/iot"><strong>‚ÄúBuild an IoT App with Zig and LoRaWAN‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/lvgl"><strong>‚ÄúBuild an LVGL Touchscreen App with Zig‚Äù</strong></a></p>
</li>
</ul>
<p>Many Thanks to my <a href="https://github.com/sponsors/lupyuen"><strong>GitHub Sponsors</strong></a> for supporting my work! This article wouldn‚Äôt have been possible without your support.</p>
<ul>
<li>
<p><a href="https://github.com/sponsors/lupyuen"><strong>Sponsor me a coffee</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/book"><strong>Read ‚ÄúThe RISC-V BL602 / BL604 Book‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io"><strong>Check out my articles</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/rss.xml"><strong>RSS Feed</strong></a></p>
</li>
</ul>
<p><em>Got a question, comment or suggestion? Create an Issue or submit a Pull Request here‚Ä¶</em></p>
<p><a href="https://github.com/lupyuen/lupyuen.github.io/blob/master/src/visual.md"><strong>lupyuen.github.io/src/visual.md</strong></a></p>
<h1 id="notes"><a href="#notes">10 Notes</a></h1>
<ol>
<li>This article is the expanded version of <a href="https://twitter.com/MisterTechBlog/status/1557857587667775489"><strong>this Twitter Thread</strong></a></li>
</ol>
<p>TODO2</p>
<p><img src="https://lupyuen.github.io/images/visual-block2.jpg" alt="TODO" /></p>
<p>TODO3</p>
<p><img src="https://lupyuen.github.io/images/visual-block3.jpg" alt="TODO" /></p>
<p>TODO4</p>
<p><img src="https://lupyuen.github.io/images/visual-block4.jpg" alt="TODO" /></p>
<p>TODO6</p>
<p><img src="https://lupyuen.github.io/images/visual-block6.jpg" alt="TODO" /></p>
<p>TODO7</p>
<p><img src="https://lupyuen.github.io/images/visual-block6a.jpg" alt="TODO" /></p>
<p>TODO8</p>
<p><img src="https://lupyuen.github.io/images/visual-block7a.jpg" alt="TODO" /></p>
<p>TODO11</p>
<p><img src="https://lupyuen.github.io/images/visual-block8.jpg" alt="TODO" /></p>

    
</body>
</html>