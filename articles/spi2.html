<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="rustdoc">
    <title>SPI on Apache NuttX OS</title>

    
    <!-- Begin scripts/articles/*-header.html: Article Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<meta property="og:title" 
    content="SPI on Apache NuttX OS" 
    data-rh="true">
<meta property="og:description" 
    content="How we transmit and receive data over SPI on Apache NuttX OS... By coding a NuttX Device Driver"
    data-rh="true">
<meta property="og:image" 
    content="https://lupyuen.github.io/images/spi2-title.jpg">
<meta property="og:type" 
    content="article" data-rh="true">
<!-- End scripts/articles/*-header.html -->
<!-- Begin scripts/rustdoc-header.html: Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<link rel="alternate" type="application/rss+xml" title="RSS Feed for lupyuen" href="/rss.xml" />
<link rel="stylesheet" type="text/css" href="../normalize.css">
<link rel="stylesheet" type="text/css" href="../rustdoc.css" id="mainThemeStyle">
<link rel="stylesheet" type="text/css" href="../dark.css">
<link rel="stylesheet" type="text/css" href="../light.css" id="themeStyle">
<link rel="stylesheet" type="text/css" href="../prism.css">
<script src="../storage.js"></script><noscript>
<link rel="stylesheet" href="../noscript.css"></noscript>
<link rel="shortcut icon" href="../favicon.ico">
<style type="text/css">
    #crate-search {
        background-image: url("../down-arrow.svg");
    }
    a {
        color: #77d;
    }
</style>
<!-- End scripts/rustdoc-header.html -->


</head>
<body class="rustdoc">
    <!--[if lte IE 8]>
    <div class="warning">
        This old browser is unsupported and will most likely display funky
        things.
    </div>
    <![endif]-->

        <!-- Begin scripts/rustdoc-before.html: Pre-HTML for Custom Markdown files processed by rustdoc, like chip8.md -->

    <!-- Begin Theme Picker -->
    <div class="theme-picker" style="left: 0"><button id="theme-picker" aria-label="Pick another theme!"><img src="../brush.svg"
        width="18" alt="Pick another theme!"></button>
        <div id="theme-choices"></div>
    </div>
    <script src="../theme.js"></script>
    <script src="../prism.js"></script>
    <!-- Theme Picker -->

    <!-- End scripts/rustdoc-before.html -->
    

    <h1 class="title">SPI on Apache NuttX OS</h1>
    <nav id="TOC"><ul>
<li><a href="#spi-test-app-and-driver">1 SPI Test App and Driver</a><ul></ul></li>
<li><a href="#create-spi-test-driver">2 Create SPI Test Driver</a><ul></ul></li>
<li><a href="#create-spi-test-app">3 Create SPI Test App</a><ul></ul></li>
<li><a href="#test-with-logic-analyser">4 Test with Logic Analyser</a><ul></ul></li>
<li><a href="#test-with-semtech-sx1262">5 Test with Semtech SX1262</a><ul></ul></li>
<li><a href="#test-with-pinedio-stack">6 Test with PineDio Stack</a><ul></ul></li>
<li><a href="#whats-next">7 What‚Äôs Next</a><ul></ul></li>
<li><a href="#notes">8 Notes</a><ul></ul></li>
<li><a href="#appendix-create-a-nuttx-device-driver">9 Appendix: Create a NuttX Device Driver</a><ul>
<li><a href="#update-makefile-and-kconfig">9.1 Update Makefile and Kconfig</a><ul></ul></li>
<li><a href="#register-device-driver">9.2 Register Device Driver</a><ul></ul></li></ul></li>
<li><a href="#appendix-create-a-nuttx-app">10 Appendix: Create a NuttX App</a><ul></ul></li>
<li><a href="#appendix-build-flash-and-run-nuttx">11 Appendix: Build, Flash and Run Nuttx</a><ul></ul></li>
<li><a href="#appendix-nuttx-spi-interface">12 Appendix: NuttX SPI Interface</a><ul></ul></li>
<li><a href="#appendix-pinedio-stack-bl604">13 Appendix: PineDio Stack BL604</a><ul></ul></li></ul></nav><p>üìù <em>12 Dec 2021</em></p>
<p><img src="https://lupyuen.github.io/images/spi2-title.jpg" alt="PineCone BL602 Board (right) connected to Semtech SX1262 LoRa Transceiver (left)" /></p>
<p><em>PineCone BL602 Board (right) connected to Semtech SX1262 LoRa Transceiver (left)</em></p>
<p>Last article we explored <strong>Apache NuttX OS</strong> and its <strong>GPIO Functions</strong>‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/nuttx"><strong>‚ÄúApache NuttX OS on RISC-V BL602 and BL604‚Äù</strong></a></li>
</ul>
<p>Today we shall venture into the <strong>SPI Functions</strong> and discover‚Ä¶</p>
<ul>
<li>
<p>How to <strong>transmit and receive</strong> data over SPI</p>
</li>
<li>
<p>By coding a simple NuttX <strong>Device Driver</strong></p>
</li>
<li>
<p>And testing with <strong>Semtech SX1262</strong> (LoRa Transceiver)</p>
</li>
<li>
<p>On Bouffalo Lab‚Äôs <strong>BL602 and BL604</strong> RISC-V SoCs</p>
</li>
</ul>
<p>We‚Äôll also study briefly the internals of the <strong>NuttX SPI Driver</strong>, to understand how it works.</p>
<p><em>What about ESP32? NuttX works the same across platforms right?</em></p>
<p>I realise that many of my readers are using ESP32 instead of BL602.</p>
<p>In this article I‚Äôll point out the tweaks needed to <strong>run the code on ESP32</strong>.</p>
<p>(Watch for the <strong>‚ÄúXref‚Äù</strong> tags)</p>
<p><img src="https://lupyuen.github.io/images/spi2-plan.jpg" alt="SPI Test App calls SPI Test Driver to access SPI Driver" /></p>
<h1 id="spi-test-app-and-driver" class="section-header"><a href="#spi-test-app-and-driver">1 SPI Test App and Driver</a></h1>
<p><em>(For BL602 and ESP32)</em></p>
<p>Our plan for today (pic above)‚Ä¶</p>
<ol>
<li>
<p>We create an <strong>SPI Test App</strong> that will transfer data over SPI.</p>
<p>(A tiny program with a few lines of code)</p>
</li>
<li>
<p>We create an <strong>SPI Test Driver</strong> (called by SPI Test App) that will handle the SPI Operations.</p>
<p>(To transmit and receive data over SPI)</p>
</li>
<li>
<p>Our SPI Test Driver exposes a NuttX <a href="https://nuttx.apache.org/docs/latest/components/drivers/character/index.html"><strong>Character Device Interface</strong></a>: open(), write(), read() and close().</p>
<p>(Yep it looks like Linux, because NuttX is POSIX Compliant)</p>
</li>
<li>
<p>Our SPI Test Driver executes the SPI Operations by calling the <strong>BL602 or ESP32 SPI Driver</strong>.</p>
<p>(Which is equivalent to the Hardware Abstraction Layer in other operating systems)</p>
</li>
</ol>
<p><em>This looks complex. Is there a simpler way?</em></p>
<p>Yes we have options for doing <strong>SPI on NuttX</strong>‚Ä¶</p>
<ol>
<li>
<p>If our SPI Device is supported by an <strong>existing NuttX Device Driver</strong>, just go ahead and use the driver!</p>
<p><a href="https://github.com/apache/incubator-nuttx/tree/master/drivers">(Browse the NuttX Device Drivers)</a></p>
</li>
<li>
<p>If we‚Äôre transferring data over SPI <strong>for testing only</strong> (not for a real app), we may call the <a href="https://github.com/apache/incubator-nuttx/blob/master/include/nuttx/spi/spi_transfer.h"><strong>SPI Transfer Interface</strong></a></p>
<p><a href="https://github.com/apache/incubator-nuttx-apps/blob/master/system/spi">(Here‚Äôs how‚Ä¶ It‚Äôs complicated)</a></p>
</li>
<li>
<p>But today we experiment with a <strong>Custom Device Driver</strong> that will talk to our own SPI Device.</p>
<p>That‚Äôs why we‚Äôre building the <strong>SPI Test Driver</strong>.</p>
<p>(Eventually we‚Äôll build a LoRaWAN Driver for Semtech SX1262)</p>
</li>
</ol>
<p><em>Can our app call the BL602 / ESP32 SPI Driver directly?</em></p>
<p>Nope that‚Äôs not supported by NuttX. It might seemingly work on BL602 and ESP32, but it will fail on platforms with <strong>Memory Protection</strong>.</p>
<p>(Imagine a Linux App directly calling a Kernel Driver‚Ä¶ That‚Äôs no-no!)</p>
<p>Later we‚Äôll see the layers of code that abstract the BL602 / ESP32 SPI Driver from our NuttX App.</p>
<p><em>Must everything be done through the read() and write() interfaces?</em></p>
<p>There‚Äôs another POSIX Interface that‚Äôs supported by NuttX: <strong>ioctl()</strong>.</p>
<p>We‚Äôll see this when we cover the NuttX Device Driver for Semtech SX1276.</p>
<h1 id="create-spi-test-driver" class="section-header"><a href="#create-spi-test-driver">2 Create SPI Test Driver</a></h1>
<p><em>(For BL602 and ESP32)</em></p>
<p>TODO</p>
<p>Every #NuttX Device Driver defines the File Operations for the device ‚Ä¶ Here are the open(), close(), read(), write() and ioctl() operations for our SPI Test Driver</p>
<p><a href="https://github.com/lupyuen/incubator-nuttx/blob/spi_test/drivers/rf/spi_test_driver.c#L80-L89">(Source)</a></p>
<p><img src="https://lupyuen.github.io/images/spi2-driver2a.png" alt="" /></p>
<p>TODO23</p>
<p>In the write() operation for our #NuttX SPI Test Driver, we 1Ô∏è‚É£ Lock the SPI Bus 2Ô∏è‚É£ Config the SPI Interface 3Ô∏è‚É£ Select the SPI Device 4Ô∏è‚É£ Transfer SPI Data 5Ô∏è‚É£ Deselect and Unlock</p>
<p><a href="https://github.com/lupyuen/incubator-nuttx/blob/spi_test/drivers/rf/spi_test_driver.c#L182-L239">(Source)</a></p>
<p><img src="https://lupyuen.github.io/images/spi2-driver2.png" alt="" /></p>
<p>TODO24</p>
<p>Here‚Äôs how we configure the #NuttX SPI Interface</p>
<p><a href="https://github.com/lupyuen/incubator-nuttx/blob/spi_test/drivers/rf/spi_test_driver.c#L95-L117">(Source)</a></p>
<p><img src="https://lupyuen.github.io/images/spi2-driver3.png" alt="" /></p>
<h1 id="create-spi-test-app" class="section-header"><a href="#create-spi-test-app">3 Create SPI Test App</a></h1>
<p><em>(For BL602 and ESP32)</em></p>
<p>TODO</p>
<p>Let‚Äôs test the #NuttX SPI Driver for #BL602</p>
<p><a href="https://nuttx.apache.org/docs/latest/components/drivers/special/spi.html">(Source)</a></p>
<p>Back to our #NuttX SPI Test App ‚Ä¶ Here‚Äôs how we open the SPI Test Driver and write data</p>
<p><a href="https://github.com/lupyuen/incubator-nuttx-apps/blob/spi_test/examples/spi_test/spi_test_main.c">(Source)</a></p>
<p><img src="https://lupyuen.github.io/images/spi2-app4.png" alt="" /></p>
<p>TODO19</p>
<p>This appears when we run our #NuttX SPI Test App ‚Ä¶ Let‚Äôs study our SPI Test Driver</p>
<p><a href="https://github.com/lupyuen/incubator-nuttx-apps/blob/spi_test/examples/spi_test/spi_test_main.c">(Source)</a></p>
<p><img src="https://lupyuen.github.io/images/spi2-app2.png" alt="" /></p>
<p>TODO25</p>
<p>To watch what happens inside #NuttX‚Äôs SPI Driver for #BL602 ‚Ä¶ Turn on SPI Debug Logging</p>
<p><a href="https://github.com/lupyuen/incubator-nuttx/blob/spi_test/arch/risc-v/src/bl602/bl602_spi.c">(Source)</a></p>
<p><img src="https://lupyuen.github.io/images/spi2-driver4.png" alt="" /></p>
<p>TODO20</p>
<p>Now we see every byte transferred by #NuttX‚Äôs SPI Driver for #BL602!</p>
<p><a href="https://github.com/lupyuen/incubator-nuttx/blob/spi_test/drivers/rf/spi_test_driver.c">(Source)</a></p>
<p><img src="https://lupyuen.github.io/images/spi2-app3.png" alt="" /></p>
<h1 id="test-with-logic-analyser" class="section-header"><a href="#test-with-logic-analyser">4 Test with Logic Analyser</a></h1>
<p><em>(For BL602 only)</em></p>
<p>TODO</p>
<p>How to verify the #NuttX SPI Output? We sniff the #BL602 SPI Bus with a Logic Analyser</p>
<p><a href="https://lupyuen.github.io/articles/spi#appendix-troubleshoot-bl602-spi-with-logic-analyser">(Source)</a></p>
<p><img src="https://lupyuen.github.io/images/spi2-logic4.jpg" alt="" /></p>
<p>TODO26</p>
<p>In #NuttX the SPI Pins for #BL602 are defined in ‚Äúboard.h‚Äù ‚Ä¶ MOSI is GPIO 1, MISO is GPIO 0</p>
<p><a href="https://github.com/lupyuen/incubator-nuttx/blob/spi_test/boards/risc-v/bl602/bl602evb/include/board.h#L87-L92">(Source)</a></p>
<p><img src="https://lupyuen.github.io/images/spi2-driver5.png" alt="" /></p>
<p>TODO27</p>
<p>#NuttX‚Äôs SPI Pins match the #BL602 Reference Manual: MOSI = GPIO 1, MISO = GPIO 0 ‚Ä¶ But we‚Äôre about to witness a BL602 SPI Quirk</p>
<p><a href="https://github.com/bouffalolab/bl_docs/tree/main/BL602_RM/en">(Source)</a></p>
<p><img src="https://lupyuen.github.io/images/spi2-driver6.png" alt="" /></p>
<p>TODO37</p>
<p>Logic Analyser connected to #BL602 shows that MISO and MOSI are swapped! This happens in BL602 IoT SDK ‚Ä¶ Also in #NuttX!</p>
<p><a href="https://lupyuen.github.io/articles/spi#spi-data-pins-are-flipped">(Source)</a></p>
<p><img src="https://lupyuen.github.io/images/spi2-logic.png" alt="" /></p>
<p>TODO28</p>
<p>We can swap MISO and MOSI on #BL602 by setting a Hardware Register ‚Ä¶ Let‚Äôs do this on #NuttX</p>
<p><a href="https://lupyuen.github.io/articles/pinedio#spi-pins-are-swapped">(Source)</a></p>
<p>Here‚Äôs how we swap #BL602 MOSI and MISO on #NuttX ‚Ä¶ So that the SPI Pins are consistent with the BL602 Reference Manual</p>
<p><a href="https://github.com/lupyuen/incubator-nuttx/blob/swap_miso_mosi/arch/risc-v/src/bl602/bl602_spi.c#L1080-L1140">(Source)</a></p>
<p><img src="https://lupyuen.github.io/images/spi2-driver7.png" alt="" /></p>
<p>TODO38</p>
<p>After swapping #BL602 MISO and MOSI at #NuttX startup ‚Ä¶ Logic Analyser shows that the SPI Pins are now consistent with BL602 Reference Manual! üéâ</p>
<p><a href="https://github.com/lupyuen/incubator-nuttx/blob/swap_miso_mosi/arch/risc-v/src/bl602/bl602_spi.c#L1080-L1140">(Source)</a></p>
<p><img src="https://lupyuen.github.io/images/spi2-logic2.png" alt="" /></p>
<h1 id="test-with-semtech-sx1262" class="section-header"><a href="#test-with-semtech-sx1262">5 Test with Semtech SX1262</a></h1>
<p><em>(For BL602 and ESP32)</em></p>
<p>TODO</p>
<p>Let‚Äôs test #NuttX SPI with #BL602 and Semtech SX1262 LoRa Transceiver</p>
<p><a href="https://www.semtech.com/products/wireless-rf/lora-core/sx1262">(Source)</a></p>
<p><img src="https://lupyuen.github.io/images/spi2-title.jpg" alt="" /></p>
<p>TODO59</p>
<p>We implement the Read Operation for our #NuttX SPI Driver ‚Ä¶ So that we can fetch the SPI Response from SX1262</p>
<p><a href="https://github.com/lupyuen/incubator-nuttx/blob/spi_test/drivers/rf/spi_test_driver.c#L210-L233">(Source)</a></p>
<p><img src="https://lupyuen.github.io/images/spi2-sx3.png" alt="" /></p>
<p>TODO60</p>
<p>Our #NuttX App transmits an SPI Command to SX1262 ‚Ä¶ And reads the SPI Response from SX1262</p>
<p><a href="https://github.com/lupyuen/incubator-nuttx-apps/blob/spi_test/examples/spi_test2/spi_test2_main.c#L54-L84">(Source)</a></p>
<p><img src="https://lupyuen.github.io/images/spi2-sx4.png" alt="" /></p>
<p>TODO39</p>
<p>#BL602 SPI Chip Select has a problem ‚Ä¶ It goes High after EVERY byte ‚Ä¶ Which is no-no for SX1262 ‚Ä¶ Solution: We control Chip Select via GPIO</p>
<p><a href="https://github.com/lupyuen/incubator-nuttx-apps/blob/spi_test/examples/spi_test2/spi_test2_main.c#L42-L74">(Source)</a></p>
<p><img src="https://lupyuen.github.io/images/spi2-logic3.png" alt="" /></p>
<p>TODO61</p>
<p>Here‚Äôs our #NuttX App controlling SPI Chip Select via GPIO</p>
<p><a href="https://github.com/lupyuen/incubator-nuttx-apps/blob/spi_test/examples/spi_test2/spi_test2_main.c#L42-L74">(Source)</a></p>
<p><img src="https://lupyuen.github.io/images/spi2-sx5.png" alt="" /></p>
<p>TODO62</p>
<p>Now our #NuttX App is ready to read an SX1262 Register over SPI!</p>
<p><a href="https://github.com/lupyuen/incubator-nuttx-apps/blob/spi_test/examples/spi_test2/spi_test2_main.c#L90-L119">(Source)</a></p>
<p><img src="https://lupyuen.github.io/images/spi2-sx6.png" alt="" /></p>
<p>TODO58</p>
<p>Our #NuttX App reads an SX1262 Register ‚Ä¶ But it returns garbage! There‚Äôs a workaround for this #BL602 SPI Quirk</p>
<p><a href="https://github.com/lupyuen/incubator-nuttx-apps/blob/spi_test/examples/spi_test2/spi_test2_main.c#L90-L119">(Source)</a></p>
<p><img src="https://lupyuen.github.io/images/spi2-sx2.png" alt="" /></p>
<p>TODO63</p>
<p>#BL602 has an SPI Quirk ‚Ä¶ We must use SPI Mode 1 instead of Mode 0 ‚Ä¶ Let‚Äôs fix this in #NuttX</p>
<p><a href="https://lupyuen.github.io/articles/spi#spi-phase-looks-sus">(Source)</a></p>
<p>For #NuttX on #BL602, we use SPI Mode 1 instead of Mode 0 ‚Ä¶ To work around the SPI Mode Quirk</p>
<p><a href="https://github.com/lupyuen/incubator-nuttx/blob/spi_test/drivers/rf/spi_test_driver.c#L51-L57">(Source)</a></p>
<p><img src="https://lupyuen.github.io/images/spi2-sx7.png" alt="" /></p>
<p>TODO57</p>
<p>Our #NuttX App now reads the SX1262 Register correctly! üéâ</p>
<p><a href="https://github.com/lupyuen/incubator-nuttx-apps/blob/spi_test/examples/spi_test2/spi_test2_main.c">(Source)</a></p>
<p><img src="https://lupyuen.github.io/images/spi2-sx.png" alt="" /></p>
<h1 id="test-with-pinedio-stack" class="section-header"><a href="#test-with-pinedio-stack">6 Test with PineDio Stack</a></h1>
<p><em>(For BL604 only)</em></p>
<p>TODO</p>
<p>Will #NuttX run on #Pine64‚Äôs PineDio Stack BL604 with onboard Semtech SX1262? Let‚Äôs find out!</p>
<p><a href="https://lupyuen.github.io/articles/pinedio">(Source)</a></p>
<p><img src="https://lupyuen.github.io/images/spi2-pinedio.jpg" alt="" /></p>
<p>TODO55</p>
<p>Here‚Äôs how Semtech SX1262 is wired onboard #PineDio Stack #BL604 ‚Ä¶ Let‚Äôs update the Pin Definitions in NuttX</p>
<p><img src="https://lupyuen.github.io/images/spi2-pinedio3.png" alt="" /></p>
<p>TODO53</p>
<p>Here are the #NuttX Pin Definitions for PineDio Stack BL604 with onboard SX1262 ‚Ä¶ As derived from the schematic</p>
<p><a href="https://github.com/lupyuen/incubator-nuttx/blob/pinedio/boards/risc-v/bl602/bl602evb/include/board.h#L42-L95">(Source)</a></p>
<p><img src="https://lupyuen.github.io/images/spi2-pinedio.png" alt="" /></p>
<p>TODO54</p>
<p>Our #NuttX App runs OK on PineDio Stack BL604 with onboard SX1262! üéâ</p>
<p><a href="https://github.com/lupyuen/incubator-nuttx-apps/blob/spi_test/examples/spi_test2/spi_test2_main.c">(Source)</a></p>
<p><img src="https://lupyuen.github.io/images/spi2-pinedio2.png" alt="" /></p>
<h1 id="whats-next" class="section-header"><a href="#whats-next">7 What‚Äôs Next</a></h1>
<p>TODO</p>
<p>I‚Äôm new to NuttX but I had lots of fun experimenting with it. I hope you‚Äôll enjoy NuttX too!</p>
<p>Here are some topics I might explore in future articles, lemme know if I should do these‚Ä¶</p>
<ul>
<li>
<p><strong>SPI Driver</strong>: PineDio Stack BL604 has an onboard LoRa SX1262 Transceiver wired via SPI. Great way to test the NuttX SPI Driver for BL602 / BL604!</p>
<p><a href="https://lupyuen.github.io/articles/lorawan2">(More about PineDio Stack BL604)</a></p>
</li>
<li>
<p><strong>LoRaWAN Driver</strong>: Once we get SX1262 talking OK on SPI, we can port the LoRaWAN Driver to NuttX!</p>
<p><a href="https://lupyuen.github.io/articles/lorawan2">(LoRaWAN on PineDio Stack BL604)</a></p>
</li>
<li>
<p><strong>Rust</strong>: Porting the Embedded Rust HAL to NuttX sounds really interesting. We might start with GPIO and SPI to see whether the concept is feasible.</p>
</li>
</ul>
<p>(BL602 IoT SDK / FreeRTOS is revamping right now to the <a href="https://twitter.com/MisterTechBlog/status/1456259223323508748"><strong>new ‚Äúhosal‚Äù HAL</strong></a>. Terrific time to explore NuttX now!)</p>
<p>Many Thanks to my <a href="https://github.com/sponsors/lupyuen"><strong>GitHub Sponsors</strong></a> for supporting my work! This article wouldn‚Äôt have been possible without your support.</p>
<ul>
<li>
<p><a href="https://github.com/sponsors/lupyuen">Sponsor me a coffee</a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/book">Read ‚ÄúThe RISC-V BL602 / BL604 Book‚Äù</a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io">Check out my articles</a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/rss.xml">RSS Feed</a></p>
</li>
</ul>
<p><em>Got a question, comment or suggestion? Create an Issue or submit a Pull Request here‚Ä¶</em></p>
<p><a href="https://github.com/lupyuen/lupyuen.github.io/blob/master/src/spi2.md"><code>lupyuen.github.io/src/spi2.md</code></a></p>
<h1 id="notes" class="section-header"><a href="#notes">8 Notes</a></h1>
<ol>
<li>This article is the expanded version of <a href="https://twitter.com/MisterTechBlog/status/1464898624026906625">this Twitter Thread</a></li>
</ol>
<h1 id="appendix-create-a-nuttx-device-driver" class="section-header"><a href="#appendix-create-a-nuttx-device-driver">9 Appendix: Create a NuttX Device Driver</a></h1>
<p><em>(For BL602 and ESP32)</em></p>
<p>This section explains the steps to create a <strong>NuttX Device Driver</strong> named <strong>‚Äúspi_test_driver‚Äù</strong>.</p>
<p>(Change ‚Äúspi_test_driver‚Äù to the desired name of our driver)</p>
<ol>
<li>
<p>Browse to the <a href="https://github.com/lupyuen/incubator-nuttx/blob/newdriver/drivers/rf"><strong>‚Äúnuttx/drivers/rf‚Äù</strong></a> folder</p>
</li>
<li>
<p>Copy the file <strong>‚Äúdat-31r5-sp.c‚Äù</strong> and paste it as <strong>‚Äúspi_test_driver.c‚Äù</strong></p>
<p><img src="https://lupyuen.github.io/images/spi2-newdriver.png" alt="Copy ‚Äúdat-31r5-sp.c‚Äù to ‚Äúspi_test_driver.c‚Äù" /></p>
<p><a href="https://github.com/lupyuen/incubator-nuttx/blob/newdriver/drivers/rf/spi_test_driver.c">(Source)</a></p>
</li>
<li>
<p>Inside the <strong>‚Äúspi_test_driver.c‚Äù</strong> file, search and replace all <strong>‚Äúdat31r5sp‚Äù</strong> by <strong>‚Äúspi_test_driver‚Äù</strong></p>
<p>Be sure to <strong>Preserve Case!</strong></p>
<p><img src="https://lupyuen.github.io/images/spi2-newdriver2.png" alt="Change all ‚Äúdat31r5sp‚Äù to ‚Äúspi_test_driver‚Äù" /></p>
<p><a href="https://github.com/lupyuen/incubator-nuttx/commit/8fee69215163180b77dc9d5b9e7449ebe00ac1cc">(Source)</a></p>
</li>
<li>
<p>Browse to the <a href="https://github.com/lupyuen/incubator-nuttx/blob/newdriver/include/nuttx/rf"><strong>‚Äúnuttx/include/nuttx/rf‚Äù</strong></a> folder</p>
</li>
<li>
<p>Copy the file <strong>‚Äúdat-31r5-sp.h‚Äù</strong> and paste it as <strong>‚Äúspi_test_driver.h‚Äù</strong></p>
</li>
<li>
<p>Inside the <strong>‚Äúspi_test_driver.h‚Äù</strong> file, search and replace all <strong>‚Äúdat31r5sp‚Äù</strong> by <strong>‚Äúspi_test_driver‚Äù</strong></p>
<p>Remember to <strong>Preserve Case!</strong></p>
<p>The Header File should look like this‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/spi2-newdriver3.png" alt="spi_test_driver.h" /></p>
<p><a href="https://github.com/lupyuen/incubator-nuttx/blob/newdriver/include/nuttx/rf/spi_test_driver.h">(Source)</a></p>
</li>
</ol>
<h2 id="update-makefile-and-kconfig" class="section-header"><a href="#update-makefile-and-kconfig">9.1 Update Makefile and Kconfig</a></h2>
<p>Now we update the Makefile so that NuttX will build our Device Driver‚Ä¶</p>
<ol>
<li>
<p>Browse to the <a href="https://github.com/lupyuen/incubator-nuttx/blob/newdriver/drivers/rf"><strong>‚Äúnuttx/drivers/rf‚Äù</strong></a> folder</p>
</li>
<li>
<p>Edit the file <strong>‚ÄúMake.defs‚Äù</strong></p>
<p>Insert this section‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>ifeq ($(CONFIG_RF_SPI_TEST_DRIVER),y)
  CSRCS += spi_test_driver.c
  RFDEPPATH = --dep-path rf
  RFVPATH = :rf
endif</code></pre></div>
<p>As shown below‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/spi2-newdriver9.png" alt="Update ‚ÄúMake.defs‚Äù" /></p>
<p><a href="https://github.com/lupyuen/incubator-nuttx/blob/newdriver/drivers/rf/Make.defs#L33-L37">(Source)</a></p>
</li>
<li>
<p>Edit the file <strong>‚ÄúKconfig‚Äù</strong></p>
<p>Insert this section‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>config RF_SPI_TEST_DRIVER
    bool &quot;SPI Test Driver&quot;
    default n
    select SPI
    ---help---
        Enable SPI Test Driver.</code></pre></div>
<p>As shown below‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/spi2-newdriver5.png" alt="Update ‚ÄúKconfig‚Äù" /></p>
<p><a href="https://github.com/lupyuen/incubator-nuttx/blob/newdriver/drivers/rf/Kconfig#L22-L27">(Source)</a></p>
</li>
</ol>
<p>TODO51</p>
<p>Our SPI Test Driver for #NuttX appears in ‚Äúmake menuconfig‚Äù!</p>
<p><img src="https://lupyuen.github.io/images/spi2-newdriver6.png" alt="" /></p>
<p><a href="https://github.com/lupyuen/incubator-nuttx/blob/newdriver/drivers/rf/Kconfig#L22-L27">(Source)</a></p>
<p>TODO6</p>
<p>Remember to enable ‚ÄúSPI0‚Äù and ‚ÄúSPI Character Driver‚Äù in #NuttX ‚Ä¶ Or our SPI Test Driver won‚Äôt start</p>
<p><img src="https://lupyuen.github.io/images/spi2-debug.png" alt="" /></p>
<p><a href="https://github.com/lupyuen/incubator-nuttx/blob/newdriver/drivers/rf/spi_test_driver.c">(Source)</a></p>
<p>TODO22</p>
<p>Here‚Äôs what happens when we make a boo-boo and #NuttX won‚Äôt start</p>
<p><img src="https://lupyuen.github.io/images/spi2-crash2.png" alt="" /></p>
<p><a href="https://gist.github.com/lupyuen/ccfd90125f9a180b4cfb459e8a57b323">(Source)</a></p>
<h2 id="register-device-driver" class="section-header"><a href="#register-device-driver">9.2 Register Device Driver</a></h2>
<ol>
<li>Browse to the <a href="https://github.com/lupyuen/incubator-nuttx/blob/newdriver/boards/risc-v/bl602/bl602evb/src"><strong>‚Äúnuttx/boards/risc-v/bl602/bl602evb‚Äù</strong></a> folder</li>
</ol>
<p>TODO</p>
<p>At #NuttX Startup, register our SPI Test Driver as ‚Äú/dev/spitest0‚Äù</p>
<p><img src="https://lupyuen.github.io/images/spi2-newdriver4.png" alt="" /></p>
<p><a href="https://github.com/lupyuen/incubator-nuttx/blob/newdriver/boards/risc-v/bl602/bl602evb/src/bl602_bringup.c#L599-L617">(Source)</a></p>
<p>TODO47</p>
<p>Build, flash and run #NuttX ‚Ä¶ Our SPI Test Driver appears as ‚Äú/dev/spitest0‚Äù! üéâ</p>
<p><img src="https://lupyuen.github.io/images/spi2-newdriver10.png" alt="" /></p>
<p><a href="https://github.com/lupyuen/incubator-nuttx/blob/newdriver/drivers/rf/spi_test_driver.c">(Source)</a></p>
<p><em>Why did we choose the ‚Äúdat-31r5-sp‚Äù driver for cloning?</em></p>
<p>TODO</p>
<p>We picked the simplest smallest SPI Device Driver: dat-31r5-sp</p>
<p><a href="https://docs.google.com/spreadsheets/d/1MDps5cPe7tIgCL1Cz98iVccJAUJq1lgctpKgg9OwztI/edit#gid=0">(Source)</a></p>
<p><img src="https://lupyuen.github.io/images/spi2-interface7.png" alt="" /></p>
<h1 id="appendix-create-a-nuttx-app" class="section-header"><a href="#appendix-create-a-nuttx-app">10 Appendix: Create a NuttX App</a></h1>
<p><em>(For BL602 and ESP32)</em></p>
<p>This section explains the steps to create a <strong>NuttX App</strong> named <strong>‚Äúspi_test‚Äù</strong>.</p>
<p>(Change ‚Äúspi_test‚Äù to the desired name of our app)</p>
<ol>
<li>
<p>Browse to the <a href="https://github.com/lupyuen/incubator-nuttx-apps/tree/newapp/examples"><strong>‚Äúnuttx/apps/examples‚Äù</strong></a> folder</p>
</li>
<li>
<p>Copy the <strong>‚Äúhello‚Äù</strong> subfolder and paste it as <strong>‚Äúspi_test‚Äù</strong></p>
<p><img src="https://lupyuen.github.io/images/spi2-newapp.png" alt="Copy the ‚Äúhello‚Äù subfolder and paste it as ‚Äúspi_test‚Äù" /></p>
<p><a href="https://github.com/lupyuen/incubator-nuttx-apps/commit/9af4ad6cab225d333ce0dae98c65a2a48621b3b4">(Source)</a></p>
</li>
<li>
<p>Inside the <strong>‚Äúspi_test‚Äù</strong> folder, rename <strong>‚Äúhello_main.c‚Äù</strong> to <strong>‚Äúspi_test_main.c‚Äù</strong></p>
<p><img src="https://lupyuen.github.io/images/spi2-newapp2.png" alt="Rename ‚Äúhello_main.c‚Äù to ‚Äúspi_test_main.c‚Äù" /></p>
<p><a href="https://github.com/lupyuen/incubator-nuttx-apps/commit/a4f884c67dc4c1042831d0554aed1d55a0e28b40">(Source)</a></p>
</li>
<li>
<p>Inside the <strong>‚Äúspi_test‚Äù</strong> folder, search and replace all <strong>‚Äúhello‚Äù</strong> by <strong>‚Äúspi_test‚Äù</strong></p>
<p>Be sure to <strong>Preserve Case!</strong></p>
<p><img src="https://lupyuen.github.io/images/spi2-newapp3.png" alt="Change all ‚Äúhello‚Äù to ‚Äúspi_test‚Äù" /></p>
<p><a href="https://github.com/lupyuen/incubator-nuttx-apps/commit/0e19613b3059882f002eee948c0a79f622eccb74">(Source)</a></p>
<p><a href="https://github.com/lupyuen/incubator-nuttx-apps/tree/newapp/examples/spi_test">(See ‚Äúspi_test‚Äù folder)</a></p>
</li>
<li>
<p>Enter the following‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code># TODO: Change this to the path of our &quot;incubator-nuttx&quot; folder
cd nuttx/nuttx

# Preserve the Build Config
cp .config ../config

# Erase the Build Config and Kconfig files
make distclean

# For BL602: Configure the build for BL602
./tools/configure.sh bl602evb:nsh

# For ESP32: Configure the build for ESP32.
# TODO: Change &quot;esp32-devkitc&quot; to our ESP32 board.
./tools/configure.sh esp32-devkitc:nsh

# Restore the Build Config
cp ../config .config

# Edit the Build Config
make menuconfig </code></pre></div>
<p><img src="https://lupyuen.github.io/images/spi2-newapp4.png" alt="Select ‚Äúspi_test‚Äù in menuconfig" /></p>
</li>
<li>
<p>In <strong>menuconfig</strong>, select <strong>‚ÄúApplication Configuration‚Äù</strong> ‚Üí <strong>‚ÄúExamples‚Äù</strong></p>
<p>Check the box for <strong>‚Äúspi_test‚Äù</strong></p>
<p>Hit <strong>‚ÄúSave‚Äù</strong> then <strong>‚ÄúOK‚Äù</strong> to save the NuttX Configuration to <strong>‚Äú.config‚Äù</strong></p>
<p>Hit <strong>‚ÄúExit‚Äù</strong> until <strong>menuconfig</strong> quits</p>
</li>
<li>
<p>Build (‚Äúmake‚Äù), flash and run the NuttX Firmware on BL602 or ESP32.</p>
<p>In the NuttX Shell, enter‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>spi_test</code></pre></div>
<p>We should see the output below. Congratulations we have created the <strong>‚Äúspi_test‚Äù</strong> app!</p>
<p><img src="https://lupyuen.github.io/images/spi2-newapp5.png" alt="‚Äúspi_test‚Äù running on BL602" /></p>
</li>
</ol>
<h1 id="appendix-build-flash-and-run-nuttx" class="section-header"><a href="#appendix-build-flash-and-run-nuttx">11 Appendix: Build, Flash and Run Nuttx</a></h1>
<p><em>(For BL602 and ESP32)</em></p>
<p>TODO</p>
<p>Build, Flash and Run #NuttX OS on #BL602 ‚Ä¶ Here‚Äôs the script I use for macOS</p>
<p><img src="https://lupyuen.github.io/images/spi2-script.png" alt="" /></p>
<h1 id="appendix-nuttx-spi-interface" class="section-header"><a href="#appendix-nuttx-spi-interface">12 Appendix: NuttX SPI Interface</a></h1>
<p><em>(For BL602 and ESP32)</em></p>
<p>TODO</p>
<p>#NuttX SPI Interface is defined here ‚Ä¶ Let‚Äôs call it from our ‚Äúspi_test‚Äù app</p>
<p><a href="https://github.com/apache/incubator-nuttx/blob/master/include/nuttx/spi/spi.h">(Source)</a></p>
<p><img src="https://lupyuen.github.io/images/spi2-interface.png" alt="" /></p>
<p>TODO30</p>
<p>Can our #NuttX App directly call the SPI Interface? Let‚Äôs find out! ü§î</p>
<p><a href="https://github.com/lupyuen/incubator-nuttx-apps/blob/spi_test/examples/spi_test/spi_test_main.c">(Source)</a></p>
<p><img src="https://lupyuen.github.io/images/spi2-interface2.png" alt="" /></p>
<p>TODO31</p>
<p>#NuttX SPI Interface needs an SPI Device ‚Äúspi_dev_s‚Äù ‚Ä¶ How do we get an SPI Device? ü§î</p>
<p><a href="https://github.com/lupyuen/incubator-nuttx/blob/master/arch/risc-v/src/bl602/bl602_spi.c#L932-L967">(Source)</a></p>
<p><img src="https://lupyuen.github.io/images/spi2-interface3.png" alt="" /></p>
<p>TODO32</p>
<p>Tracing thru #NuttX Virtual File System ‚Ä¶ We see that ioctl() maps the File Descriptor to a File Struct</p>
<p><a href="https://github.com/lupyuen/incubator-nuttx/blob/master/fs/vfs/fs_ioctl.c#L118-L138">(Source)</a></p>
<p><img src="https://lupyuen.github.io/images/spi2-interface4.png" alt="" /></p>
<p>TODO33</p>
<p>#NuttX File Struct contains a Private Pointer to the SPI Driver ‚Äúspi_driver_s‚Äù</p>
<p><a href="https://github.com/lupyuen/incubator-nuttx/blob/master/drivers/spi/spi_driver.c#L112-L147">(Source)</a></p>
<p><img src="https://lupyuen.github.io/images/spi2-interface5.png" alt="" /></p>
<p>TODO34</p>
<p>#NuttX SPI Driver ‚Äúspi_driver_s‚Äù contains the SPI Device ‚Äúspi_dev_s‚Äù ‚Ä¶ That we need for testing the SPI Interface! But the SPI Device is private and hidden from apps üôÅ</p>
<p><a href="https://github.com/lupyuen/incubator-nuttx/blob/master/drivers/spi/spi_driver.c#L55-L65">(Source)</a></p>
<p><img src="https://lupyuen.github.io/images/spi2-interface6.png" alt="" /></p>
<h1 id="appendix-pinedio-stack-bl604" class="section-header"><a href="#appendix-pinedio-stack-bl604">13 Appendix: PineDio Stack BL604</a></h1>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/spi2-pinedio2.jpg" alt="" /></p>
<p>TODO8</p>
<p><img src="https://lupyuen.github.io/images/spi2-pinedio3.jpg" alt="" /></p>
<p>TODO9</p>
<p><img src="https://lupyuen.github.io/images/spi2-pinedio8.jpg" alt="" /></p>
<p>TODO10</p>
<p><img src="https://lupyuen.github.io/images/spi2-pinedio9.jpg" alt="" /></p>
<p>TODO11</p>
<p><img src="https://lupyuen.github.io/images/spi2-pinedio7.jpg" alt="" /></p>
<p>TODO12</p>
<p><img src="https://lupyuen.github.io/images/spi2-pinedio5.jpg" alt="" /></p>
<p>TODO14</p>
<p><img src="https://lupyuen.github.io/images/spi2-pinedio6.jpg" alt="" /></p>
<p>TODO16</p>
<p><img src="https://lupyuen.github.io/images/spi2-pinedio4.jpg" alt="" /></p>
<p>TODO18</p>
<p><img src="https://lupyuen.github.io/images/spi2-pinedio10.jpg" alt="" /></p>

    
</body>
</html>