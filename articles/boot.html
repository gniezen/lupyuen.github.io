<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="rustdoc">
    <title>BL602 Bootloader</title>

    
    <!-- Begin scripts/articles/*-header.html: Article Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<meta property="og:title" 
    content="BL602 Bootloader" 
    data-rh="true">
<meta property="og:description" 
    content="All about the BL602 RISC-V Bootloader... And how it loads the Application Firmware into XIP Flash Memory"
    data-rh="true">
<meta property="og:image" 
    content="https://lupyuen.github.io/images/boot-title.jpg">
<meta property="og:type" 
    content="article" data-rh="true">
<!-- End scripts/articles/*-header.html -->
<!-- Begin scripts/rustdoc-header.html: Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<link rel="alternate" type="application/rss+xml" title="RSS Feed for lupyuen" href="/rss.xml" />
<link rel="stylesheet" type="text/css" href="../normalize.css">
<link rel="stylesheet" type="text/css" href="../rustdoc.css" id="mainThemeStyle">
<link rel="stylesheet" type="text/css" href="../dark.css">
<link rel="stylesheet" type="text/css" href="../light.css" id="themeStyle">
<link rel="stylesheet" type="text/css" href="../prism.css">
<script src="../storage.js"></script><noscript>
<link rel="stylesheet" href="../noscript.css"></noscript>
<link rel="shortcut icon" href="../favicon.ico">
<style type="text/css">
    #crate-search {
        background-image: url("../down-arrow.svg");
    }
    a {
        color: #77d;
    }
</style>
<!-- End scripts/rustdoc-header.html -->


</head>
<body class="rustdoc">
    <!--[if lte IE 8]>
    <div class="warning">
        This old browser is unsupported and will most likely display funky
        things.
    </div>
    <![endif]-->

        <!-- Begin scripts/rustdoc-before.html: Pre-HTML for Custom Markdown files processed by rustdoc, like chip8.md -->

    <!-- Begin Theme Picker -->
    <div class="theme-picker" style="left: 0"><button id="theme-picker" aria-label="Pick another theme!"><img src="../brush.svg"
        width="18" alt="Pick another theme!"></button>
        <div id="theme-choices"></div>
    </div>
    <script src="../theme.js"></script>
    <script src="../prism.js"></script>
    <!-- Theme Picker -->

    <!-- End scripts/rustdoc-before.html -->
    

    <h1 class="title">BL602 Bootloader</h1>
    <nav id="TOC"><ul>
<li><a href="#bl602-boot2-bootloader">1 BL602 Boot2 Bootloader</a><ul></ul></li>
<li><a href="#inside-the-bootloader">2 Inside the Bootloader</a><ul></ul></li>
<li><a href="#install-application-firmware">3 Install Application Firmware</a><ul></ul></li>
<li><a href="#write-firmware-to-xip-flash">4 Write Firmware to XIP Flash</a><ul></ul></li>
<li><a href="#efuse-security">5 EFuse Security</a><ul></ul></li>
<li><a href="#bl602-rom-driver-api">6 BL602 ROM Driver API</a><ul></ul></li>
<li><a href="#bl602-partition-table">7 BL602 Partition Table</a><ul></ul></li>
<li><a href="#bl602-firmware-boot-code">8 BL602 Firmware Boot Code</a><ul></ul></li>
<li><a href="#other-bootloaders">9 Other Bootloaders</a><ul></ul></li>
<li><a href="#whats-next">10 What‚Äôs Next</a><ul></ul></li>
<li><a href="#notes">11 Notes</a><ul></ul></li></ul></nav><p>üìù <em>10 Jun 2021</em></p>
<p><em>How is our firmware loaded into BL602‚Äôs flash memory?</em></p>
<p><em>How does BL602 prevent tampering of firmware?</em></p>
<p>All this and much, much more shall be explained as we learn about the <strong>BL602 Boot2 Bootloader</strong>.</p>
<h1 id="bl602-boot2-bootloader" class="section-header"><a href="#bl602-boot2-bootloader">1 BL602 Boot2 Bootloader</a></h1>
<p>Let‚Äôs ponder what happens when we flash to BL602 the firmware that we have built‚Ä¶</p>
<p>(We‚Äôll call it the <strong>Application Firmware</strong>)</p>
<p><em>Sounds easy! We transfer the Application Firmware from our computer to BL602 (over USB)‚Ä¶</em></p>
<p><em>Then BL602 writes the Application Firmware to flash memory. Right?</em></p>
<p>Not quite. We talked about flashing Application Firmware in the article‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/flash"><strong>‚ÄúFlashing Firmware to PineCone BL602‚Äù</strong></a></li>
</ul>
<p>During flashing, we transfer a <strong>Flashing Image</strong> from our computer to BL602 over USB.</p>
<p>The Flashing Image contains‚Ä¶</p>
<ol>
<li>
<p><strong>Boot2 Bootloader <code>blsp_boot2.bin</code></strong></p>
<p>(Written to the Flashing Image as <code>boot2image.bin</code>)</p>
</li>
<li>
<p><strong>Application Firmware <code>bl602.bin</code></strong></p>
<p>(Written to the Flashing Image as <code>fwimage.bin</code>)</p>
</li>
<li>
<p><strong>Partition Table <code>partition.bin</code></strong> and <strong>Device Tree <code>ro_params.dtb</code></strong></p>
</li>
</ol>
<p>Here‚Äôs how the Flashing Image is constructed‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/boot-title.jpg" alt="Flashing BL602 firmware" /></p>
<p><em>Why is the Boot2 Bootloader transferred to BL602 during flashing?</em></p>
<p>During flashing, our Application Firmware isn‚Äôt written directly to BL602‚Äôs <strong>XIP Flash Memory</strong>.</p>
<p>Instead, <strong>BL602 runs the Boot2 Bootloader</strong> which‚Ä¶</p>
<ol>
<li>
<p><strong>Extracts our Application Firmware</strong> from the transferred Flashing Image</p>
</li>
<li>
<p><strong>Writes our Application Firmware</strong> to XIP Flash Memory at address <strong><code>0x2300 0000</code></strong>.</p>
</li>
</ol>
<p>(XIP means ‚ÄúExecute In Place‚Äù, it refers to the BL602 Flash Memory that will store our executable firmware code)</p>
<p><em>Where is the Boot2 Bootloader located?</em></p>
<p>BL602 runs the Boot2 Bootloader from XIP Flash Memory at address <strong><code>0x2300 0000</code></strong>.</p>
<p>Yep it‚Äôs the <strong>same address as our Application Firmware</strong>!</p>
<p><em>So the Bootloader overwrites itself by our Application Firmware?</em></p>
<p>Yes indeed. We‚Äôll learn later how the <strong>Boot2 Bootloader overwrites itself</strong> by the Application Firmware.</p>
<p><em>Is Boot2 really a Bootloader?</em></p>
<p>On other microcontrollers, the Bootloader is the first thing that runs when powered on. (Before jumping to the Application Firmware)</p>
<p>On BL602, the Boot2 Bootloader <strong>runs only when we flash new Application Firmware</strong>. (So that the Application Firmware may be loaded into XIP Flash Memory)</p>
<p>So the Bootloader concept is a little different for BL602‚Ä¶ It‚Äôs more like an <strong>‚ÄúApplication Firmware Loader‚Äù</strong></p>
<p><em>Why so complicated?</em></p>
<p>BL602‚Äôs Boot2 Bootloader allows Application Firmware to be <strong>flashed securely</strong> to XIP Flash Memory‚Ä¶</p>
<ol>
<li>
<p>Boot2 Bootloader supports <strong>flashing of AES-Encrypted Application Firmware</strong></p>
<p>(So it‚Äôs possible to push encrypted firmware updates over-the-air)</p>
</li>
<li>
<p>Boot2 Bootloader can use <strong>Digital Signatures</strong> to verify that the Application Firmware is authentic</p>
<p>(Prevents tampering of firmware updates)</p>
</li>
</ol>
<p>We‚Äôll learn more about firmware security.</p>
<p><img src="https://lupyuen.github.io/images/boot-loader.png" alt="BL602 Boot2 Bootloader runs at address 0x2300 0000" /></p>
<p><em>BL602 Boot2 Bootloader runs at address <code>0x2300 0000</code></em></p>
<h1 id="inside-the-bootloader" class="section-header"><a href="#inside-the-bootloader">2 Inside the Bootloader</a></h1>
<p>To understand the BL602 Bootloader, let‚Äôs look at the code inside‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/boot-main.png" alt="Bootloader Main Function" /></p>
<p>From <a href="https://github.com/lupyuen/bl_iot_sdk/blob/master/customer_app/bl602_boot2/bl602_boot2/blsp_boot2.c#L389-L571"><code>bl602_boot2/blsp_boot2.c</code></a></p>
<ol>
<li>
<p>The Bootloader starts by fetching the <strong>Clock Configuration and SPI Flash Configuration</strong> from the Flashing Image <a href="https://lupyuen.github.io/articles/flash#appendix-bl602-efuse-configuration">(See this)</a></p>
<pre><code class="language-c">//  SPI Flash Configuration
SPI_Flash_Cfg_Type flashCfg;

//  EFuse Hardware Configuration
Boot_Efuse_HW_Config efuseCfg;

int main(void) {
    ...
    //  It's better not enable interrupt
    //  BLSP_Boot2_Init_Timer();

    //  Set RAM Max size
    BLSP_Boot2_Disable_Other_Cache();

    //  Flush cache to get parameter
    BLSP_Boot2_Flush_XIP_Cache();

    Boot_Clk_Config clkCfg;  //  Clock Configuration
    ret = BLSP_Boot2_Get_Clk_Cfg(&amp;clkCfg);

    ret |= SF_Cfg_Get_Flash_Cfg_Need_Lock(0, &amp;flashCfg);
    BLSP_Boot2_Flush_XIP_Cache();
</code></pre>
</li>
<li>
<p>Next the Bootloader <strong>initialises the Hardware Platform</strong>‚Ä¶</p>
<pre><code class="language-c">    bflb_platform_print_set(BLSP_Boot2_Get_Log_Disable_Flag());

    bflb_platform_init(BLSP_Boot2_Get_Baudrate());

    bflb_platform_deinit_time();
</code></pre>
</li>
<li>
<p>We fetch the <strong>EFuse Configuration</strong> (for decrypting the Application Firmware and for verifying the firmware signature)</p>
<pre><code class="language-c">    MSG_DBG(&quot;Get efuse config\r\n&quot;);
    BLSP_Boot2_Get_Efuse_Cfg(&amp;efuseCfg);
</code></pre>
</li>
<li>
<p>We <strong>reset the Security Engine</strong> (for AES Encryption operations)</p>
<pre><code class="language-c">    //  Reset Sec_Eng for using
    BLSP_Boot2_Reset_Sec_Eng();
</code></pre>
</li>
<li>
<p>The Bootloader supports <strong>multicore CPUs</strong>.  (Each core will start the Application Firmware with different parameters)</p>
<p>BL602 is a single-core CPU, so the <strong>CPU Count</strong> will be set to 1‚Ä¶</p>
<pre><code class="language-c">    if (BLSP_Boot2_Get_Feature_Flag() != BLSP_BOOT2_SP_FLAG) {
        //  Get CPU count info
        cpuCount = BLSP_Boot2_Get_CPU_Count();
    } else {
        cpuCount = 1;
    }
</code></pre>
</li>
<li>
<p>We <strong>fetch the Application Firmware Name</strong> from the Flashing Image.</p>
<p>Our Application Firmware is always named <strong><code>&quot;FW&quot;</code></strong> <a href="https://lupyuen.github.io/articles/flash#appendix-bl602-partition-table">(See this)</a></p>
<pre><code class="language-c">    //  Get power save mode
    psMode = BLSP_Read_Power_Save_Mode();

    //  Get User specified FW
    uint8_t userFwName[9] = {0};  //  Firmware Name
    ARCH_MemCpy_Fast(
        userFwName,
        BLSP_Get_User_Specified_Fw(),
        4);
</code></pre>
</li>
<li>
<p>We register the functions that will be called to <strong>Erase, Write and Read the Partition Table</strong>‚Ä¶</p>
<pre><code class="language-c">    if (BLSP_Boot2_8M_Support_Flag()) {
        //  Set flash operation function, read via sbus
        PtTable_Set_Flash_Operation(PtTable_Flash_Erase,
            PtTable_Flash_Write, PtTable_Flash_Read);
    } else {
        //  Set flash operation function, read via xip
        PtTable_Set_Flash_Operation(PtTable_Flash_Erase,
            PtTable_Flash_Write, PtTable_Flash_Read);
    }
</code></pre>
<p>(Yes the parameters for both calls of <code>PtTable_Set_Flash_Operation</code> are identical)</p>
</li>
<li>
<p>TODO</p>
<pre><code class="language-c">    while (1) {
        tempMode = 0;
        do {
            activeID = PtTable_Get_Active_Partition_Need_Lock(ptTableStuff);
            if (PT_TABLE_ID_INVALID==activeID){ BLSP_Boot2_On_Error(&quot;No valid PT\r\n&quot;); }

            BLSP_Boot2_Get_MFG_StartReq(
                activeID,
                &amp;ptTableStuff[activeID], 
                &amp;ptEntry[0],
                userFwName);

            //  Get entry and boot
            if (userFwName[0] == '0') {
                ptParsed = BLSP_Boot2_Deal_One_FW(
                    activeID,
                    &amp;ptTableStuff[activeID],
                    &amp;ptEntry[0],
                    &amp;userFwName[1],
                    PT_ENTRY_FW_CPU0);
                if (ptParsed == 0) {
                    continue;
                } else {
                    BLSP_Clr_User_Specified_Fw();
                }
                tempMode = 1;
                userFwName[0] = 0;
            } else if (userFwName[0] == '1' &amp;&amp; cpuCount &gt; 1) {
                ptParsed = BLSP_Boot2_Deal_One_FW(
                    activeID,
                    &amp;ptTableStuff[activeID],
                    &amp;ptEntry[1],
                    &amp;userFwName[1],
                    PT_ENTRY_FW_CPU1);
                if (ptParsed == 0) {
                    continue;
                } else {
                    BLSP_Clr_User_Specified_Fw();
                }
                tempMode = 1;
                userFwName[0] = 0;
            } else {
                ptParsed = BLSP_Boot2_Deal_One_FW(
                    activeID,
                    &amp;ptTableStuff[activeID],
                    &amp;ptEntry[0],
                    NULL,
                    PT_ENTRY_FW_CPU0);
                if (ptParsed == 0) {
                    continue;
                }
                if (cpuCount &gt; 1) {
                    ptParsed = BLSP_Boot2_Deal_One_FW(
                        activeID,
                        &amp;ptTableStuff[activeID],
                        &amp;ptEntry[1],
                        NULL,
                        PT_ENTRY_FW_CPU1);
                    if (ptParsed == 0) {
                        continue;
                    }
                }
            }
            ptParsed = 1;
        } while (ptParsed == 0);
</code></pre>
</li>
<li>
<p>TODO</p>
<pre><code class="language-c">        //  Pass data to App
        BLSP_Boot2_Pass_Parameter(NULL, 0);

        //  Pass active partition table ID
        BLSP_Boot2_Pass_Parameter(&amp;activeID, 4);

        //  Pass active partition table content: table header + entries + crc32
        BLSP_Boot2_Pass_Parameter(
            &amp;ptTableStuff[activeID],
            sizeof(PtTable_Config) + 4
                + ptTableStuff[activeID].ptTable.entryCnt
                    * sizeof(PtTable_Entry_Config));
</code></pre>
</li>
<li>
<p>TODO</p>
<pre><code class="language-c">        //  Pass flash config
        if (ptEntry[0].Address[ptEntry[0].activeIndex] != 0) {
            XIP_SFlash_Read_Via_Cache_Need_Lock(
                BLSP_BOOT2_XIP_BASE+ptEntry[0].Address[ptEntry[0].activeIndex] + 8,
                flashCfgBuf,
                sizeof(flashCfgBuf));

            //  Include magic and CRC32
            BLSP_Boot2_Pass_Parameter(
                flashCfgBuf,
                sizeof(flashCfgBuf));
        }
</code></pre>
</li>
<li>
<p>TODO</p>
<pre><code class="language-c">        MSG_DBG(&quot;Boot start\r\n&quot;);
        for (i = 0; i &lt; cpuCount; i++) {
            bootHeaderAddr[i] = ptEntry[i].Address[ptEntry[i].activeIndex];
        }
</code></pre>
</li>
<li>
<p>TODO</p>
<pre><code class="language-c">#ifdef BLSP_BOOT2_ROLLBACK
        /* Test mode is not need roll back */
        if (rollBacked == 0 &amp;&amp; tempMode == 0) {
            ret = BLSP_MediaBoot_Main(bootHeaderAddr, bootRollback, 1);
        } else {
            ret = BLSP_MediaBoot_Main(bootHeaderAddr, bootRollback, 0);
        }
#else
        ret = BLSP_MediaBoot_Main(bootHeaderAddr, bootRollback, 0);
#endif
</code></pre>
</li>
<li>
<p>TODO</p>
<pre><code class="language-c">        //  Fail in temp mode, continue to boot normal image
        if (tempMode == 1) { continue; }
</code></pre>
</li>
<li>
<p>TODO</p>
<pre><code class="language-c">#ifdef BLSP_BOOT2_ROLLBACK
        //  If rollback is done, we still fail, break
        if (rollBacked) { break; }
        MSG_DBG(&quot;Boot return %d\r\n&quot;,ret);
        MSG_WAR(&quot;Check Rollback\r\n&quot;);
        for (i = 0; i &lt; cpuCount; i++) {
            if (bootRollback[i] != 0){
                MSG_WAR(&quot;Rollback %d\r\n&quot;,i);
                if (BFLB_BOOT2_SUCCESS == BLSP_Boot2_Rollback_PtEntry(
                    activeID, &amp;ptTableStuff[activeID], &amp;ptEntry[i])) {
                    rollBacked = 1;
                }
            }
        }
        //  If need no rollback, boot fail due to other reseaon instead of imgae issue, break
        if (rollBacked == 0) { break; }
#else
        break;
#endif
    }
</code></pre>
</li>
<li>
<p>TODO</p>
<pre><code class="language-c">    //  We should never get here unless boot fail
    MSG_ERR(&quot;Media boot return %d\r\n&quot;,ret);
    while (1) {
        MSG_ERR(&quot;BLSP boot2 fail\r\n&quot;);
        ARCH_Delay_MS(500);
    }
}
</code></pre>
</li>
</ol>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/boot-main2.png" alt="Bootloader Main Function" /></p>
<h1 id="install-application-firmware" class="section-header"><a href="#install-application-firmware">3 Install Application Firmware</a></h1>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/boot-install.png" alt="" /></p>
<p>TODO</p>
<h1 id="write-firmware-to-xip-flash" class="section-header"><a href="#write-firmware-to-xip-flash">4 Write Firmware to XIP Flash</a></h1>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/boot-write.png" alt="" /></p>
<p>TODO</p>
<h1 id="efuse-security" class="section-header"><a href="#efuse-security">5 EFuse Security</a></h1>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/boot-efuse.png" alt="" /></p>
<p>TODO</p>
<h1 id="bl602-rom-driver-api" class="section-header"><a href="#bl602-rom-driver-api">6 BL602 ROM Driver API</a></h1>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/boot-driver.png" alt="" /></p>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/boot-driver2.png" alt="" /></p>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/boot-driver3.png" alt="" /></p>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/boot-driver4.png" alt="" /></p>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/boot-driver5.png" alt="" /></p>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/boot-rust.png" alt="" /></p>
<p>TODO</p>
<p><a href="https://en.wikipedia.org/wiki/Unified_Extensible_Firmware_Interface">Unified Extensible Firmware Interface</a></p>
<h1 id="bl602-partition-table" class="section-header"><a href="#bl602-partition-table">7 BL602 Partition Table</a></h1>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/boot-partition.png" alt="" /></p>
<p>TODO</p>
<h1 id="bl602-firmware-boot-code" class="section-header"><a href="#bl602-firmware-boot-code">8 BL602 Firmware Boot Code</a></h1>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/boot-code.png" alt="" /></p>
<p>TODO</p>
<h1 id="other-bootloaders" class="section-header"><a href="#other-bootloaders">9 Other Bootloaders</a></h1>
<p>TODO</p>
<h1 id="whats-next" class="section-header"><a href="#whats-next">10 What‚Äôs Next</a></h1>
<p>TODO</p>
<ul>
<li>
<p><a href="https://github.com/sponsors/lupyuen">Sponsor me a coffee</a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/book">Read ‚ÄúThe RISC-V BL602 Book‚Äù</a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io">Check out my articles</a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/rss.xml">RSS Feed</a></p>
</li>
</ul>
<p><em>Got a question, comment or suggestion? Create an Issue or submit a Pull Request here‚Ä¶</em></p>
<p><a href="https://github.com/lupyuen/lupyuen.github.io/blob/master/src/boot.md"><code>lupyuen.github.io/src/boot.md</code></a></p>
<h1 id="notes" class="section-header"><a href="#notes">11 Notes</a></h1>
<ol>
<li>
<p>This article is the expanded version of <a href="https://twitter.com/MisterTechBlog/status/1398855867030593538">this Twitter Thread</a></p>
</li>
<li>
<p>Checking the bootloader</p>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/boot-compare.png" alt="" /></p>
<p>TODO</p>
</li>
</ol>

    
</body>
</html>