# BL602 EFlash Loader: Reverse Engineered with Ghidra

üìù _5 Feb 2022_

![Pine64 PineDio Stack BL604 RISC-V Board](https://lupyuen.github.io/images/loader-title.jpg)

[_Pine64 PineDio Stack BL604 RISC-V Board_](https://lupyuen.github.io/articles/pinedio)

Something special happens when we __flash firmware__ to [__BL602 and BL604__](https://lupyuen.github.io/articles/pinecone) RISC-V boards...

It starts a tiny program __inside the board__ to make flashing possible: The __EFlash Loader__.

Step by step we shall __uncover what's inside__ EFlash Loader, thanks to [__Ghidra__](https://ghidra-sre.org/) the popular tool for Software Reverse Engineering.

_Why are we doing this?_

1.  EFlash Loader is a critical part of the __Flashing Process__

    (Good to understand how it works)

1.  __No Source Code__ is available for EFlash Loader

    [(According to GitHub Code Search)](https://github.com/search?q=bflb_eflash_loader_cmd_write_flash&type=code)

1.  EFlash Loader is __small__ (37 KB) and __self-contained__

    [(32-bit RISC-V, specifically RV32IMACF)](https://en.wikipedia.org/wiki/RISC-V#ISA_base_and_extensions)

1.  EFlash Loader gets __updated occasionally__, so it's good for us to understand what's changed

This is my first time using Ghidra so this might be a fun and educational exercise!

(But please bear with my ignorance üôè)

![Pine64 PineCone BL602 RISC-V Board](https://lupyuen.github.io/images/pinecone-jumperh.jpg)

[_Pine64 PineCone BL602 RISC-V Board_](https://lupyuen.github.io/articles/pinecone)

# What's Next

TODO

Many Thanks to my [__GitHub Sponsors__](https://github.com/sponsors/lupyuen) for supporting my work! This article wouldn't have been possible without your support.

-   [Sponsor me a coffee](https://github.com/sponsors/lupyuen)

-   [Read "The RISC-V BL602 / BL604 Book"](https://lupyuen.github.io/articles/book)

-   [Check out my articles](https://lupyuen.github.io)

-   [RSS Feed](https://lupyuen.github.io/rss.xml)

_Got a question, comment or suggestion? Create an Issue or submit a Pull Request here..._

[`lupyuen.github.io/src/loader.md`](https://github.com/lupyuen/lupyuen.github.io/blob/master/src/loader.md)

# Notes

1.  This article is the expanded version of [this Twitter Thread](https://twitter.com/MisterTechBlog/status/1486187004232867842)

TODO

Decompiled the new #BL602 EFlash Loader with #Ghidra ü§î

TODO17

![](https://lupyuen.github.io/images/loader-ghidra.png)

[(Source)](https://github.com/bouffalolab/bl_iot_sdk/blob/master/flash_tool/chips/bl602/eflash_loader/eflash_loader.elf)



EFlash Loader is the program that runs on #BL602 to flash all firmware ... The ELF was uploaded recently (no source available) ... Let's look inside with Ghidra

TODO14

![](https://lupyuen.github.io/images/loader-files.png)

[(Source)](https://github.com/bouffalolab/bl_iot_sdk/tree/master/flash_tool/chips/bl602/eflash_loader)



Here's how we decompile a #BL602 #RISCV ELF with #Ghidra

[__Watch the video on YouTube__](https://youtu.be/3Ikn8Y775Lk)



Decompiled #BL602 EFlash Loader is here ... 10,000 lines of C to skim for goodies üëç

[(Source)](https://github.com/lupyuen/bl602-eflash-loader/blob/main/eflash_loader.c)



More about #BL602 EFlash Loader

[(Source)](https://lupyuen.github.io/articles/flash#flash-the-firmware)



#BL602 EFlash Loader's Main Function is surprisingly readable ... Decompiled from ELF by Ghidra

TODO5

![](https://lupyuen.github.io/images/loader-code.png)

[(Source)](https://github.com/lupyuen/bl602-eflash-loader/blob/main/eflash_loader.c#L2803-L2863)



Here's the #BL602 EFlash Loader's Main Loop that executes Flashing Commands

TODO6

![](https://lupyuen.github.io/images/loader-code2.png)

[(Source)](https://github.com/lupyuen/bl602-eflash-loader/blob/main/eflash_loader.c#L4031-L4108)



What are the Flash Commands executed by the #BL602 EFlash Loader? ü§î

TODO7

![](https://lupyuen.github.io/images/loader-code3.png)

[(Source)](https://github.com/lupyuen/bl602-eflash-loader/blob/main/eflash_loader.c#L3814-L3844)



Call Graph for #BL602 EFlash Loader ... Generated by #Ghidra

TODO4

![](https://lupyuen.github.io/images/loader-call.png)

[(Source)](https://github.com/lupyuen/bl602-eflash-loader)



#Ghidra says that #BL602 EFlash Loader supports 24 Flashing Commands ... Let's decipher them ü§î

TODO11

![](https://lupyuen.github.io/images/loader-commands2.png)

[(Source)](https://github.com/lupyuen/bl602-eflash-loader)



#Ghidra reveals the 24 Flashing Commands supported by #BL602 EFlash Loader  ... Very nice! üëç

TODO12

![](https://lupyuen.github.io/images/loader-commands3.png)

[(Source)](https://github.com/lupyuen/bl602-eflash-loader)


Here are the 24 Flashing Commands supported by the #BL602 EFlash Loader ... Thanks to Ghidra üéâ

[(Source)](https://github.com/lupyuen/bl602-eflash-loader#flashing-commands)


So cute that the #BL602 Flashing Commands are all ASCII ... Perfect for UART! üëç

TODO10

![](https://lupyuen.github.io/images/loader-commands.png)

[(Source)](https://github.com/lupyuen/bl602-eflash-loader#flashing-commands)



You can't tell which way the train went by looking at the tracks ... So let's study the #BL602 Firmware Flasher ... And see what Flashing Commands it sends to the EFlash Loader

TODO16

![](https://lupyuen.github.io/images/loader-flasher2.png)

[(Source)](https://github.com/bouffalolab/BLOpenFlasher)



#BL602 Firmware Flasher works like a State Machine ... Each Flashing State triggers a Flashing Command ... Let's trace the Flashing States

TODO15

![](https://lupyuen.github.io/images/loader-flasher.png)

[(Source)](https://github.com/bouffalolab/BLOpenFlasher/blob/main/utils/util_program.go#L195-L245)



Here are the #BL602 Flashing States and Flashing Command IDs derived from the BL602 Firmware Flasher (BLOpenFlasher)

[(Source)](https://github.com/lupyuen/bl602-eflash-loader#flashing-states)


Now we can match the #BL602 Flashing States ... With the Flashing Commands reversed from the EFlash Loader

TODO20

![](https://lupyuen.github.io/images/loader-match2.png)

[(Source)](https://github.com/lupyuen/bl602-eflash-loader)



Here are 5 #BL602 Flashing Commands from EFlash Loader that we can probe further ... Let's dive into "Flash Program"

TODO19

![](https://lupyuen.github.io/images/loader-match.png)

[(Source)](https://github.com/lupyuen/bl602-eflash-loader#matching-flashing-states-and-commands)



Here's the decompiled function in #BL602 EFlash Loader that writes the firmware to flash ... Let's probe deeper

TODO8

![](https://lupyuen.github.io/images/loader-code4.png)

[(Source)](https://github.com/lupyuen/bl602-eflash-loader/blob/main/eflash_loader.c#L3258-L3300)



#BL602 EFlash Loader calls SFlash_Program to write to flash ... SFlash_Program is defined in the BL602 ROM ... Thanks to the decompiled code we now know how EFlash Loader works! üëç

TODO9

![](https://lupyuen.github.io/images/loader-code5.png)

[(Source)](https://github.com/lupyuen/bl602-eflash-loader/blob/main/eflash_loader.c#L4901-L4910)

[(Source)](https://github.com/bouffalolab/bl_iot_sdk/blob/master/components/platform/soc/bl602/bl602_std/bl602_std/StdDriver/Src/bl602_romapi.c#L539-L542)



Export to C

TODO13

![](https://lupyuen.github.io/images/loader-export.png)
