# BL602 EFlash Loader: Reverse Engineered with Ghidra

üìù _5 Feb 2022_

![Pine64 PineDio Stack BL604 RISC-V Board](https://lupyuen.github.io/images/loader-title.jpg)

[_Pine64 PineDio Stack BL604 RISC-V Board_](https://lupyuen.github.io/articles/pinedio)

Something special happens when we __flash firmware__ to [__BL602 and BL604__](https://lupyuen.github.io/articles/pinecone) RISC-V boards...

It starts a tiny program __inside the board__ to make flashing possible: The __EFlash Loader__.

Step by step we shall __uncover what's inside__ EFlash Loader, thanks to [__Ghidra__](https://ghidra-sre.org/) the popular tool for Software Reverse Engineering.

_Why are we doing this?_

-   EFlash Loader is a critical part of the __Flashing Process__

    (Good to understand how it works)

-   __No Source Code__ is available for EFlash Loader

    [(According to GitHub Code Search)](https://github.com/search?q=bflb_eflash_loader_cmd_write_flash&type=code)

-   EFlash Loader is __small__ (37 KB) and __self-contained__

    [(32-bit RISC-V, specifically RV32IMACF)](https://en.wikipedia.org/wiki/RISC-V#ISA_base_and_extensions)

-   EFlash Loader gets __updated occasionally__, so it's good for us to see what's changed

This is my first time using Ghidra so this might be a fun and educational exercise!

(But please bear with my ignorance üôè)

![Pine64 PineCone BL602 RISC-V Board](https://lupyuen.github.io/images/pinecone-jumperh.jpg)

[_Pine64 PineCone BL602 RISC-V Board_](https://lupyuen.github.io/articles/pinecone)

# About EFlash Loader

TODO

EFlash Loader is the program that runs on #BL602 to flash all firmware ... The ELF was uploaded recently (no source available) ... Let's look inside with Ghidra

TODO14

![](https://lupyuen.github.io/images/loader-files.png)

[(Source)](https://github.com/bouffalolab/bl_iot_sdk/tree/master/flash_tool/chips/bl602/eflash_loader)

More about #BL602 EFlash Loader

[(Source)](https://lupyuen.github.io/articles/flash#flash-the-firmware)

# Decompile with Ghidra

TODO

Decompiled the new #BL602 EFlash Loader with #Ghidra ü§î

TODO17

![](https://lupyuen.github.io/images/loader-ghidra.png)

[(Source)](https://github.com/bouffalolab/bl_iot_sdk/blob/master/flash_tool/chips/bl602/eflash_loader/eflash_loader.elf)


Here's how we decompile a #BL602 #RISCV ELF with #Ghidra

[__Watch the video on YouTube__](https://youtu.be/3Ikn8Y775Lk)


Decompiled #BL602 EFlash Loader is here ... 10,000 lines of C to skim for goodies üëç

[(Source)](https://github.com/lupyuen/bl602-eflash-loader/blob/main/eflash_loader.c)


Export to C

TODO13

![](https://lupyuen.github.io/images/loader-export.png)

# Decompiled Main Function

TODO

#BL602 EFlash Loader's Main Function is surprisingly readable ... Decompiled from ELF by Ghidra

TODO5

![](https://lupyuen.github.io/images/loader-code.png)

[(Source)](https://github.com/lupyuen/bl602-eflash-loader/blob/main/eflash_loader.c#L2803-L2863)


Call Graph for #BL602 EFlash Loader ... Generated by #Ghidra

TODO4

![](https://lupyuen.github.io/images/loader-call.png)

[(Source)](https://github.com/lupyuen/bl602-eflash-loader)

# Decompiled Main Loop

TODO

Here's the #BL602 EFlash Loader's Main Loop that executes Flashing Commands

TODO6

![](https://lupyuen.github.io/images/loader-code2.png)

[(Source)](https://github.com/lupyuen/bl602-eflash-loader/blob/main/eflash_loader.c#L4031-L4108)


What are the Flashing Commands executed by the #BL602 EFlash Loader? ü§î

TODO7

![](https://lupyuen.github.io/images/loader-code3.png)

[(Source)](https://github.com/lupyuen/bl602-eflash-loader/blob/main/eflash_loader.c#L3814-L3844)

# Decipher Flashing Commands

TODO

#Ghidra says that #BL602 EFlash Loader supports 24 Flashing Commands ... Let's decipher them ü§î

TODO11

![](https://lupyuen.github.io/images/loader-commands2.png)

[(Source)](https://github.com/lupyuen/bl602-eflash-loader)



#Ghidra reveals the 24 Flashing Commands supported by #BL602 EFlash Loader  ... Very nice! üëç

TODO12

![](https://lupyuen.github.io/images/loader-commands3.png)

[(Source)](https://github.com/lupyuen/bl602-eflash-loader)


Here are the 24 Flashing Commands supported by the #BL602 EFlash Loader ... Thanks to Ghidra üéâ

[(Source)](https://github.com/lupyuen/bl602-eflash-loader#flashing-commands)


So cute that the #BL602 Flashing Commands are all ASCII ... Perfect for UART! üëç

TODO10

![](https://lupyuen.github.io/images/loader-commands.png)

[(Source)](https://github.com/lupyuen/bl602-eflash-loader#flashing-commands)

Here are the 24 Flashing Commands supported by the BL602 EFlash Loader, as decoded by Ghidra from `eflash_loader_cmds`...

| ID | ASCII | Flashing Command
| :--: | :--: | --- 
| 10 | LF | [*_get_bootinfo](https://github.com/lupyuen/bl602-eflash-loader/blob/main/eflash_loader.c#L2867-L2879)
| 21 | ! | [*_reset](https://github.com/lupyuen/bl602-eflash-loader/blob/main/eflash_loader.c#L2939-L2950)
| 30 | 0 | [*_erase_flash](https://github.com/lupyuen/bl602-eflash-loader/blob/main/eflash_loader.c#L3133-L3194)
| 31 | 1 | [*_write_flash](https://github.com/lupyuen/bl602-eflash-loader/blob/main/eflash_loader.c#L3258-L3300)
| 3F | ? | [*_write_flash_with_decompress](https://github.com/lupyuen/bl602-eflash-loader/blob/main/eflash_loader.c#L3693-L3798)
| 32 | 2 | [*_read_flash](https://github.com/lupyuen/bl602-eflash-loader/blob/main/eflash_loader.c#L3374-L3427)
| 34 | 4 | [*_xip_read_flash](https://github.com/lupyuen/bl602-eflash-loader/blob/main/eflash_loader.c#L3434-L3487)
| 3A | : | [*_write_flash_check](https://github.com/lupyuen/bl602-eflash-loader/blob/main/eflash_loader.c#L3001-L3008)
| 3B | ; | [*_set_flash_para](https://github.com/lupyuen/bl602-eflash-loader/blob/main/eflash_loader.c#L3635-L3689)
| 3C | < | [*_flash_chip_erase](https://github.com/lupyuen/bl602-eflash-loader/blob/main/eflash_loader.c#L3113-L3129)
| 3D | = | [*_readSha_flash](https://github.com/lupyuen/bl602-eflash-loader/blob/main/eflash_loader.c#L3491-L3544)
| 3E | > | [*_xip_readSha_flash](https://github.com/lupyuen/bl602-eflash-loader/blob/main/eflash_loader.c#L3548-L3601)
| 40 | @ | [*_write_efuse](https://github.com/lupyuen/bl602-eflash-loader/blob/main/eflash_loader.c#L3065-L3109)
| 41 | A | [*_read_efuse](https://github.com/lupyuen/bl602-eflash-loader/blob/main/eflash_loader.c#L3014-L3058)
| 42 | B | [*_read_mac_addr](https://github.com/lupyuen/bl602-eflash-loader/blob/main/eflash_loader.c#L3605-L3629)
| 50 | P | [*_write_mem](https://github.com/lupyuen/bl602-eflash-loader/blob/main/eflash_loader.c#L2975-L2997)
| 51 | Q | [*_read_mem](https://github.com/lupyuen/bl602-eflash-loader/blob/main/eflash_loader.c#L3213-L3254)
| 71 | q | [*_read_log](https://github.com/lupyuen/bl602-eflash-loader/blob/main/eflash_loader.c#L2897-L2909)
| 60 | ` | [*_xip_read_flash_start](https://github.com/lupyuen/bl602-eflash-loader/blob/main/eflash_loader.c#L2913-L2922)
| 61 | a | [*_xip_read_flash_finish](https://github.com/lupyuen/bl602-eflash-loader/blob/main/eflash_loader.c#L2926-L2935)
| 36 | 6 | [*_read_jedec_id](https://github.com/lupyuen/bl602-eflash-loader/blob/main/eflash_loader.c#L2883-L2893)
| 37 | 7 | [*_read_status_register](https://github.com/lupyuen/bl602-eflash-loader/blob/main/eflash_loader.c#L3339-L3367)
| 38 | 8 | [*_write_status_register](https://github.com/lupyuen/bl602-eflash-loader/blob/main/eflash_loader.c#L3306-L3335)
| 33 | 3 | [*_flash_boot](https://github.com/lupyuen/bl602-eflash-loader/blob/main/eflash_loader.c#L3198-L3209)

__`*`__ denotes __bflb_eflash_loader_cmd__

7 of the above Flashing Commands are documented in the [BL602 ISP Protocol](https://github.com/bouffalolab/bl_docs/tree/main/BL602_ISP/en)...

-   `10` - Get Boot Info
-   `3C` - Chip Erase
-   `30` - Flash Erase
-   `31` - Flash Program
-   `3A` - Flash Program Check
-   `32` - Flash Read
-   `3D` - SHA256 Read

The other 17 Flashing Commands are undocumented.

# Flashing States

TODO

You can't tell which way the train went by looking at the tracks ... So let's study the #BL602 Firmware Flasher ... And see what Flashing Commands it sends to the EFlash Loader

TODO16

![](https://lupyuen.github.io/images/loader-flasher2.png)

[(Source)](https://github.com/bouffalolab/BLOpenFlasher)


#BL602 Firmware Flasher works like a State Machine ... Each Flashing State triggers a Flashing Command ... Let's trace the Flashing States

TODO15

![](https://lupyuen.github.io/images/loader-flasher.png)

[(Source)](https://github.com/bouffalolab/BLOpenFlasher/blob/main/utils/util_program.go#L195-L245)


Here are the #BL602 Flashing States and Flashing Command IDs derived from the BL602 Firmware Flasher (BLOpenFlasher)

[(Source)](https://github.com/lupyuen/bl602-eflash-loader#flashing-states)

BL602 Firmware Flasher works like a State Machine. Each Flashing State triggers a Flashing Command. Here are the Flashing States and Flashing Command IDs derived from [`BLOpenFlasher/utils/util_program.go`](https://github.com/bouffalolab/BLOpenFlasher/blob/main/utils/util_program.go)...

| State | ID | On Success | On Error |
| :--- | :--- | :--- | :--- |
| [ConfigReset](https://github.com/bouffalolab/BLOpenFlasher/blob/main/utils/util_program.go#L118-L133) | | *Reset | ErrorLoaderBin
| [*Reset](https://github.com/bouffalolab/BLOpenFlasher/blob/main/utils/util_program.go#L135-L193) | | *ShakeHand | ErrorShakeHand
| [*ShakeHand](https://github.com/bouffalolab/BLOpenFlasher/blob/main/utils/util_program.go#L195-L206) | 55 | *BootInfo | *Reset
| [*BootInfo](https://github.com/bouffalolab/BLOpenFlasher/blob/main/utils/util_program.go#L208-L215) | 10 | *BootHeader | *Reset
| [*BootHeader](https://github.com/bouffalolab/BLOpenFlasher/blob/main/utils/util_program.go#L217-L230) | 11 | *SegHeader | ConfigReset
| [*SegHeader](https://github.com/bouffalolab/BLOpenFlasher/blob/main/utils/util_program.go#L232-L245) | 17 | *SegData | ConfigReset
| [*SegData](https://github.com/bouffalolab/BLOpenFlasher/blob/main/utils/util_program.go#L247-L264) | 18 | *CheckImage | ConfigReset
| [*CheckImage](https://github.com/bouffalolab/BLOpenFlasher/blob/main/utils/util_program.go#L266-L274) | 19 | *RunImage | ConfigReset
| [*RunImage](https://github.com/bouffalolab/BLOpenFlasher/blob/main/utils/util_program.go#L276-L284) | 1A | *Reshake | ConfigReset
| [*Reshake](https://github.com/bouffalolab/BLOpenFlasher/blob/main/utils/util_program.go#L286-L300) | 55 | *LoadFile | ConfigReset
| [*LoadFile](https://github.com/bouffalolab/BLOpenFlasher/blob/main/utils/util_program.go#L302-L344) |  | *EraseFlash^ | ErrorOpenFile^
| [*EraseFlash](https://github.com/bouffalolab/BLOpenFlasher/blob/main/utils/util_program.go#L353-L378) | 30 | *ProgramFlash | ErrorEraseFlash
| [*ProgramFlash](https://github.com/bouffalolab/BLOpenFlasher/blob/main/utils/util_program.go#L380-L408) | 31 | *ProgramOK^ | ErrorProgramFLash
| [*ProgramOK](https://github.com/bouffalolab/BLOpenFlasher/blob/main/utils/util_program.go#L410-L418) | 3A | *Sha256 | ErrorProgramOK
| [*Sha256](https://github.com/bouffalolab/BLOpenFlasher/blob/main/utils/util_program.go#L420-L449) | 3D | *LoadFile | ErrorVerifySha256^
| [*ProgramFinish](https://github.com/bouffalolab/BLOpenFlasher/blob/main/utils/util_program.go#L451-L468) | 55 | *ProgramFinish | *ProgramFinish

__`*`__ denotes __Cmd__ (like __CmdReset__)

__`^`__ denotes multiple states

The Flashing Process is documented in the [BL602 ISP Protocol](https://github.com/bouffalolab/bl_docs/tree/main/BL602_ISP/en).

# Match Flashing States and Commands

TODO

Now we can match the #BL602 Flashing States ... With the Flashing Commands reversed from the EFlash Loader

TODO20

![](https://lupyuen.github.io/images/loader-match2.png)

[(Source)](https://github.com/lupyuen/bl602-eflash-loader)


Here are 5 #BL602 Flashing Commands from EFlash Loader that we can probe further ... Let's dive into "Flash Program"

TODO19

![](https://lupyuen.github.io/images/loader-match.png)

[(Source)](https://github.com/lupyuen/bl602-eflash-loader#matching-flashing-states-and-commands)

By matching the Flashing States and the Flashing Commands above, we identify 5 commands that we can probe further...

| ID | ASCII | Flashing Command
| :--: | :--: | --- 
| 10 | LF | Get Boot Info<br>[bflb_eflash_loader_cmd_get_bootinfo](https://github.com/lupyuen/bl602-eflash-loader/blob/main/eflash_loader.c#L2867-L2879)
| 30 | 0 | Flash Erase<br>[bflb_eflash_loader_cmd_erase_flash](https://github.com/lupyuen/bl602-eflash-loader/blob/main/eflash_loader.c#L3133-L3194)
| 31 | 1 | Flash Program<br>[bflb_eflash_loader_cmd_write_flash](https://github.com/lupyuen/bl602-eflash-loader/blob/main/eflash_loader.c#L3258-L3300)
| 3A | : | Flash Program Check<br>[bflb_eflash_loader_cmd_write_flash_check](https://github.com/lupyuen/bl602-eflash-loader/blob/main/eflash_loader.c#L3001-L3008)
| 3D | = | SHA256 Read<br>[bflb_eflash_loader_cmd_readSha_flash](https://github.com/lupyuen/bl602-eflash-loader/blob/main/eflash_loader.c#L3491-L3544)

(`3C` Chip Erase and `32` Flash Read aren't used while flashing BL602, according to BLOpenFlasher)

# Flash Program

TODO

Here's the decompiled function in #BL602 EFlash Loader that writes the firmware to flash ... Let's probe deeper

TODO8

![](https://lupyuen.github.io/images/loader-code4.png)

[(Source)](https://github.com/lupyuen/bl602-eflash-loader/blob/main/eflash_loader.c#L3258-L3300)


#BL602 EFlash Loader calls SFlash_Program to write to flash ... SFlash_Program is defined in the BL602 ROM ... Thanks to the decompiled code we now know how EFlash Loader works! üëç

TODO9

![](https://lupyuen.github.io/images/loader-code5.png)

[(Source)](https://github.com/lupyuen/bl602-eflash-loader/blob/main/eflash_loader.c#L4901-L4910)

[(Source)](https://github.com/bouffalolab/bl_iot_sdk/blob/master/components/platform/soc/bl602/bl602_std/bl602_std/StdDriver/Src/bl602_romapi.c#L539-L542)

# What's Next

TODO

Many Thanks to my [__GitHub Sponsors__](https://github.com/sponsors/lupyuen) for supporting my work! This article wouldn't have been possible without your support.

-   [Sponsor me a coffee](https://github.com/sponsors/lupyuen)

-   [Read "The RISC-V BL602 / BL604 Book"](https://lupyuen.github.io/articles/book)

-   [Check out my articles](https://lupyuen.github.io)

-   [RSS Feed](https://lupyuen.github.io/rss.xml)

_Got a question, comment or suggestion? Create an Issue or submit a Pull Request here..._

[`lupyuen.github.io/src/loader.md`](https://github.com/lupyuen/lupyuen.github.io/blob/master/src/loader.md)

# Notes

1.  This article is the expanded version of [this Twitter Thread](https://twitter.com/MisterTechBlog/status/1486187004232867842)
