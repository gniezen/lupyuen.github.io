# Zig Visual Programming with Blockly

üìù _11 Aug 2022_

![Zig Visual Programming with Blockly](https://lupyuen.github.io/images/blockly-title.jpg)

_Can we create a Zig program visually... The Drag-n-Drop way?_

Let's find out! Today we shall explore [__Blockly__](https://developers.google.com/blockly), the Scratch-like browser-based coding toolkit...

And how we might customise Blockly to __create Zig programs__ visually.

_Will it work for any Zig program?_

We're not quite done yet. We hit some __interesting challenges__, like Blockly's "Typelessness".

But it might work for creating __IoT Sensor Apps__ for Embedded Platforms. (Like Apache NuttX RTOS)

(More about this below)

Let's head down into our experiment with Blocky...

-   [__lupyuen3/blockly-zig-nuttx__](https://github.com/lupyuen3/blockly-zig-nuttx)

And learn how how we ended up here...

-   [__Blockly with Zig (Work in Progress)__](https://lupyuen3.github.io/blockly-zig-nuttx/demos/code/)

# Add a Zig Tab

TODO

Blockly is bundled with a list of Demos...

[lupyuen3.github.io/blockly-zig-nuttx/demos](https://lupyuen3.github.io/blockly-zig-nuttx/demos/)

There's a Code Generation Demo that shows the code generated by Blockly for JavaScript, Python, Dart, ...

[lupyuen3.github.io/blockly-zig-nuttx/demos/code](https://lupyuen3.github.io/blockly-zig-nuttx/demos/code/)

Let's add a tab that will show the Zig code generated by Blockly: [demos/code/index.html](https://github.com/lupyuen3/blockly-zig-nuttx/blob/master/demos/code/index.html)

```html
<!--  Inserted this to Load Messages: (Not sure why)  -->
<script src="../../msg/messages.js"></script>
...
<tr id="tabRow" height="1em">
  <td id="tab_blocks" class="tabon">...</td>
  <td class="tabmin tab_collapse">&nbsp;</td>
  <!-- Inserted these two lines: -->
  <td id="tab_zig" class="taboff tab_collapse">Zig</td>
  <td class="tabmin tab_collapse">&nbsp;</td>
...
<div id="content_blocks" class="content"></div>
<!-- Inserted this line: -->
<pre id="content_zig" class="content prettyprint lang-zig"></pre>
```

[(See the changes)](https://github.com/lupyuen3/blockly-zig-nuttx/pull/1/files#diff-dcf2ffe98d7d8b4a0dd7b9f769557dbe8c9e0e726236ef229def25c956a43d8f)

We'll see the Zig Tab like this...

[lupyuen3.github.io/blockly-zig-nuttx/demos/code](https://lupyuen3.github.io/blockly-zig-nuttx/demos/code/)

![Zig Tab in Blockly](https://lupyuen.github.io/images/blockly-run3a.png)

# Zig Code Generator

TODO

Blockly comes bundled with Code Generators for JavaScript, Python, Dart, ...

Let's create a Code Generator for Zig, by copying from the Dart Code Generator.

Copy [generators/dart.js](https://github.com/lupyuen3/blockly-zig-nuttx/blob/master/generators/dart.js) to [generators/zig.js](https://github.com/lupyuen3/blockly-zig-nuttx/blob/master/generators/zig.js)

Copy all files from [generators/dart](https://github.com/lupyuen3/blockly-zig-nuttx/blob/master/generators/dart) to [generators/zig](https://github.com/lupyuen3/blockly-zig-nuttx/blob/master/generators/zig)...

```text
all.js
colour.js
lists.js
logic.js
loops.js
math.js
procedures.js
text.js
variables.js  
variables_dynamic.js
```

[(See the copied files)](https://github.com/lupyuen3/blockly-zig-nuttx/commit/ba968942c6ee55937ca554e1d290d8d563fa0b78)

Edit [generators/zig.js](https://github.com/lupyuen3/blockly-zig-nuttx/blob/master/generators/dart.js) and all files in [generators/zig](https://github.com/lupyuen3/blockly-zig-nuttx/blob/master/generators/zig).

Change all `Dart` to `Zig`, preserve case.

[(See the changes)](https://github.com/lupyuen3/blockly-zig-nuttx/commit/efe185d6cac4306dcdc6b6a5f261b331bb992976)

# Load Code Generator

TODO

Let's load our Zig Code Generator in Blockly...

Add the Zig Code Generator to [demos/code/index.html](https://github.com/lupyuen3/blockly-zig-nuttx/blob/master/demos/code/index.html)...

```html
<!--  Load Zig Code Generator  -->
<script src="../../zig_compressed.js"></script>
```

[(See the changes)](https://github.com/lupyuen3/blockly-zig-nuttx/pull/1/files#diff-dcf2ffe98d7d8b4a0dd7b9f769557dbe8c9e0e726236ef229def25c956a43d8f)

Enable the Zig Code Generator in [demos/code/code.js](https://github.com/lupyuen3/blockly-zig-nuttx/blob/master/demos/code/code.js)...

```javascript
// Inserted `zig`...
Code.TABS_ = [
  'blocks', 'zig', 'javascript', 'php', 'python', 'dart', 'lua', 'xml', 'json'
];
...
// Inserted `Zig`...
Code.TABS_DISPLAY_ = [
  'Blocks', 'Zig', 'JavaScript', 'PHP', 'Python', 'Dart', 'Lua', 'XML', 'JSON'
];
...
Code.renderContent = function() {
  ...
  } else if (content.id === 'content_json') {
    var jsonTextarea = document.getElementById('content_json');
    jsonTextarea.value = JSON.stringify(
        Blockly.serialization.workspaces.save(Code.workspace), null, 2);
    jsonTextarea.focus();
  // Inserted this...
  } else if (content.id == 'content_zig') {
    Code.attemptCodeGeneration(Blockly.Zig);
```

[(See the changes)](https://github.com/lupyuen3/blockly-zig-nuttx/pull/1/files#diff-d72873b861dee958e5d443c919726dd856de594bd56b1e73d8948a7719163553)

Add our Code Generator to the Build Task: [scripts/gulpfiles/build_tasks.js](https://github.com/lupyuen3/blockly-zig-nuttx/blob/master/scripts/gulpfiles/build_tasks.js#L98-L139)

```javascript
 const chunks = [
   // Added this...
   {
      name: 'zig',
      entry: 'generators/zig/all.js',
      reexport: 'Blockly.Zig',
   }
 ];
```

[(See the changes)](https://github.com/lupyuen3/blockly-zig-nuttx/pull/1/files#diff-a9a5784f43ce15ca76bb3e99eb6625c3ea15381e20eac6f7527ecbcb2945ac14)

Now we compile our Zig Code Generator.

# Build Blockly

TODO

Blockly builds fine with Linux, macOS and WSL. (But not plain old Windows CMD)

To build Blockly with the Zig Code Generator...

```bash
git clone --recursive https://github.com/lupyuen3/blockly-zig-nuttx
cd blockly-zig-nuttx
npm install

## Run these steps when we change the Zig Code Generator
npm run build
npm run publish

## When prompted "Is this the correct branch?",
## press N

## Instead of "npm run publish" (which can be slow), we may do this...
## cp build/*compressed* .

## For WSL: We can copy the generated files to c:\blockly-zig-nuttx for testing on Windows
## cp *compressed* /mnt/c/blockly-zig-nuttx
```

This compiles and updates the Zig Code Generator in [zig_compressed.js](https://github.com/lupyuen3/blockly-zig-nuttx/blob/master/zig_compressed.js) and [zig_compressed.js.map](https://github.com/lupyuen3/blockly-zig-nuttx/blob/master/zig_compressed.js.map)

If we're using VSCode, here's the Build Task: [.vscode/tasks.json](https://github.com/lupyuen3/blockly-zig-nuttx/blob/master/.vscode/tasks.json)

# Test Blockly

TODO

Browse to `blockly-zig-nuttx/demos/code` with a Local Web Server. [(Like Web Server for Chrome)](https://chrome.google.com/webstore/detail/web-server-for-chrome/ofhbbkphhbklhfoeikjpcbhemlocgigb/)

We should see this...

[lupyuen3.github.io/blockly-zig-nuttx/demos/code](https://lupyuen3.github.io/blockly-zig-nuttx/demos/code/)

![Zig Tab in Blockly](https://lupyuen.github.io/images/blockly-run3a.png)

Blockly will NOT render correctly with `file://...`, it must be `http://localhost:port/...`

Drag-and-drop some Blocks and click the Zig Tab.

The Zig Tab now shows the generated code in Dart (because we copied the Dart Code Generator).

(In case of problems, check the JavaScript Console. Ignore the `storage.js` error)

Now we modify our Code Generator to generate Zig code.

# Set Variable

TODO

Let's generate the Zig code for setting a variable...

![Set Variable](https://lupyuen.github.io/images/blockly-run5.png)

For simplicity we'll treat variables as constants...

```zig
const a: f32 = 123.45;
```

This is how we generate the above code in the Zig Code Generator for Blockly (coded in JavaScript): [generators/zig/variables.js](https://github.com/lupyuen3/blockly-zig-nuttx/blob/master/generators/zig/variables.js#L25-L32)

```javascript
Zig['variables_set'] = function(block) {
  // Variable setter.
  ...
  return `const ${varName}: f32 = ${argument0};\n`;
};
```

# Print Expression

TODO

To print the value of an expression...

![Print Expression](https://lupyuen.github.io/images/blockly-run6.png)

We'll generate this Zig code...

```zig
debug("a={}", .{ a });
```

Here's how we implement this in the Zig Code Generator for Blockly: [generators/zig/text.js](https://github.com/lupyuen3/blockly-zig-nuttx/blob/master/generators/zig/text.js#L268-L272)

```javascript
Zig['text_print'] = function(block) {
  // Print statement.
  ...
  return `debug("${msg}={}", .{ ${msg} });\n`;
};
```

# Repeat Loop

TODO

To run a repeating loop...

![Repeat Loop](https://lupyuen.github.io/images/blockly-run4.png)

We'll generate this Zig code...

```zig
var count: usize = 0;
while (count < 10) : (count += 1) {
  ...
}
```

With this Zig Code Generator in Blockly: [generators/zig/loops.js](https://github.com/lupyuen3/blockly-zig-nuttx/blob/master/generators/zig/loops.js#L19-L45)

```javascript
Zig['controls_repeat_ext'] = function(block) {
  // Repeat n times.
  ...
  code += [
    `var ${loopVar}: usize = 0;\n`,
    `while (${loopVar} < ${endVar}) : (${loopVar} += 1) {\n`,
    branch,
    '}\n'
  ].join('');
  return code;
};
```

_What happens if we have 2 repeat loops? Won't `count` clash?_

Blockly will automatically generate another counter...

```zig
var count2: usize = 0;
while (count2 < 10) : (count2 += 1) {
  ...
}
```

(Try it out!)

# Main Function

TODO

The generated Zig code needs to be wrapped like this, to become a valid Zig program...

```zig
/// Import Standard Library
const std = @import("std");

/// Main Function
pub fn main() !void {
  // TODO: Generated Zig Code here
  ...
}

/// Aliases for Standard Library
const assert = std.debug.assert;
const debug  = std.log.debug;
```

We do this in the Zig Code Generator for Blockly: [generators/zig.js](https://github.com/lupyuen3/blockly-zig-nuttx/blob/master/generators/zig.js#L132-L193)

```javascript
Zig.finish = function(code) {
  ...
  // Main Function
  code = [
    '/// Main Function\n',
    'pub fn main() !void {\n',
    code,
    '}',
  ].join('');
 
  // Convert the definitions dictionary into a list.
  ...

  // Compose Zig Header
  const header = [
    '/// Import Standard Library\n',
    'const std = @import("std");\n',
  ].join('');

  // Compose Zig Trailer
  const trailer = [
    '/// Aliases for Standard Library\n',
    'const assert = std.debug.assert;\n',
    'const debug  = std.log.debug;\n',
  ].join('');

  // Combine Header, Definitions, Code and Trailer
  return [
    header,
    '\n',
    // For Zig: No need to declare variables
    // allDefs.replace(/\n\n+/g, '\n\n').replace(/\n*$/, '\n\n\n'),
    code,
    '\n\n',
    trailer,
  ].join('');
};
```

We're ready to test our Zig Code Generator!

# Run the Generated Code

TODO

Follow the steps described earlier to build Blockly.

We browse to our local Blockly site...

[lupyuen3.github.io/blockly-zig-nuttx/demos/code](https://lupyuen3.github.io/blockly-zig-nuttx/demos/code/)

Then drag-and-drop the Blocks to create this Visual Program...

![Blockly Visual Program](https://lupyuen.github.io/images/blockly-run1.png)

Click the Zig Tab to see the generated code...

![Zig Code generated by Blocky](https://lupyuen.github.io/images/blockly-run2.png)

Our Code Generator in Blockly generates this Zig code...

```zig
/// Import Standard Library
const std = @import("std");

/// Main Function
pub fn main() !void {
  var count: usize = 0;
  while (count < 10) : (count += 1) {
    const a: f32 = 123.45;
    debug("a={}", .{ a });
  }
}

/// Aliases for Standard Library
const assert = std.debug.assert;
const debug  = std.log.debug;
```

Which runs perfectly OK with Zig! üéâ

```bash
$ zig run a.zig
debug: 1.23449996e+02
debug: 1.23449996e+02
debug: 1.23449996e+02
debug: 1.23449996e+02
debug: 1.23449996e+02
debug: 1.23449996e+02
debug: 1.23449996e+02
debug: 1.23449996e+02
debug: 1.23449996e+02
debug: 1.23449996e+02
```

# Blockly on Mobile

TODO

Blockly works OK with Mobile Web Browsers too...

[lupyuen3.github.io/blockly-zig-nuttx/demos/code](https://lupyuen3.github.io/blockly-zig-nuttx/demos/code/)

![Blocky on Mobile Web Browser](https://lupyuen.github.io/images/blockly-mobile.jpg)

# Why Float?

TODO

# Blockly Is Typeless

TODO

# IoT Sensor Apps

TODO

_Why limit to IoT Sensor Apps?_

-   Types are simpler: Only floating-point numbers will be supported, no strings needed

-   Blockly is Typeless. With Zig we can use Type Inference to deduce the missing types

-   Make it easier to experiment with various IoT Sensors: Temperature, Humidity, Air Pressure, ...

# Apache NuttX RTOS

TODO: mobile, vscode extension, tauri

# What's Next

TODO

See my earlier work on Zig, NuttX, LoRaWAN and LVGL...

-   [__"Zig on RISC-V BL602: Quick Peek with Apache NuttX RTOS"__](https://lupyuen.github.io/articles/zig)

-   [__"Build an IoT App with Zig and LoRaWAN"__](https://lupyuen.github.io/articles/iot)

-   [__"Build an LVGL Touchscreen App with Zig"__](https://lupyuen.github.io/articles/lvgl)

Many Thanks to my [__GitHub Sponsors__](https://github.com/sponsors/lupyuen) for supporting my work! This article wouldn't have been possible without your support.

-   [__Sponsor me a coffee__](https://github.com/sponsors/lupyuen)

-   [__Read "The RISC-V BL602 / BL604 Book"__](https://lupyuen.github.io/articles/book)

-   [__Check out my articles__](https://lupyuen.github.io)

-   [__RSS Feed__](https://lupyuen.github.io/rss.xml)

_Got a question, comment or suggestion? Create an Issue or submit a Pull Request here..._

[__lupyuen.github.io/src/blockly.md__](https://github.com/lupyuen/lupyuen.github.io/blob/master/src/blockly.md)

# Notes

1.  This article is the expanded version of [__this Twitter Thread__](https://twitter.com/MisterTechBlog/status/1554650482240397312)
