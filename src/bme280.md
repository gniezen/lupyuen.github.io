# Apache NuttX Driver for BME280 Sensor: Ported from Zephyr OS

üìù _3 Mar 2022_

![Bosch BME280 Sensor connected to Pine64 PineCone BL602 RISC-V Board](https://lupyuen.github.io/images/bme280-title.jpg)

_"Will [__Apache NuttX OS__](https://lupyuen.github.io/articles/nuttx) talk I2C with [__Bosch BME280 Sensor__](https://www.bosch-sensortec.com/products/environmental-sensors/humidity-sensors-bme280/)... On the [__BL602 RISC-V SoC__](https://lupyuen.github.io/articles/pinecone)?"_

...A friend and I pondered (8,000 miles apart) while working on the [__Temperature + Humidity + Air Pressure__](https://learn.sparkfun.com/tutorials/sparkfun-bme280-breakout-hookup-guide) combo sensor.

Sounds like a fun challenge...

-   NuttX __doesn't have a driver__ for the BME280 Sensor

    (Though it supports BMP280)

-   Can we port the BME280 Driver from __Zephyr OS__ with a few tweaks?

    (Spoiler: Yes we can!)

-   What's inside a __NuttX Sensor Driver__ anyway?

    (How to build our own driver)

-   NuttX on BL602 is __kinda new-ish__

    (Some features might not work the way we expect)

-   BL602's I2C Port has __interesting quirks__. Will it work?

    (Specifically: I2C Sub Address)

Read on to find out how we solved the challenge and created this driver...

-   [__lupyuen/bme280-nuttx__](https://github.com/lupyuen/bme280-nuttx)

# What's Next

TODO

Many Thanks to my [__GitHub Sponsors__](https://github.com/sponsors/lupyuen) for supporting my work! This article wouldn't have been possible without your support.

-   [Sponsor me a coffee](https://github.com/sponsors/lupyuen)

-   [Read "The RISC-V BL602 / BL604 Book"](https://lupyuen.github.io/articles/book)

-   [Check out my articles](https://lupyuen.github.io)

-   [RSS Feed](https://lupyuen.github.io/rss.xml)

_Got a question, comment or suggestion? Create an Issue or submit a Pull Request here..._

[`lupyuen.github.io/src/bme280.md`](https://github.com/lupyuen/lupyuen.github.io/blob/master/src/bme280.md)

# Notes

1.  This article is the expanded version of [this Twitter Thread](https://twitter.com/MisterTechBlog/status/1494301654186823683)



Will Apache #NuttX OS talk I2C with Bosch BME280 Sensor? (Temperature + Humidity + Air Pressure) ... Let's find out!

https://github.com/lupyuen/bme280-nuttx


Verify with Bus Pirate that our BME280 works OK ... Despite my horrid soldering üòÇ

https://github.com/lupyuen/bme280-nuttx#test-with-bus-pirate


Connect BME280 to #RISCV PineCone #BL602 @PINE64 ... Preferably not on a cooking pot üòÇ

https://github.com/lupyuen/bme280-nuttx#connect-bme280

TODO24

![](https://lupyuen.github.io/images/bme280-pot.jpg)


Enable the I2C Port and I2C Character Driver on Apache #NuttX OS ... So it will talk with BME280

https://github.com/lupyuen/bme280-nuttx#configure-nuttx

TODO19

![](https://lupyuen.github.io/images/bme280-config1.png)



Apache #NuttX OS doesn't have a BME280 Driver ... Let's test the BMP280 Driver instead (Air Pressure only)

https://github.com/lupyuen/bme280-nuttx#configure-nuttx

TODO21

![](https://lupyuen.github.io/images/bme280-config3.png)



We patch the I2C Address and Device ID in the #NuttX BMP280 Driver ... So it will work with BME280

https://github.com/lupyuen/bme280-nuttx#change-i2c-address-and-device-id

TODO1

![](https://lupyuen.github.io/images/bme280-code1.png)


Here's how we register the BMP280 Driver at #NuttX Startup

https://github.com/lupyuen/bme280-nuttx#register-bmp280-driver

TODO2

![](https://lupyuen.github.io/images/bme280-code2a.png)


#NuttX BMP280 Driver fails because the detected Device ID is 0 ... Let's find out why ü§î

https://github.com/lupyuen/bme280-nuttx#invalid-device-id

TODO25

![](https://lupyuen.github.io/images/bme280-run1.png)


Logic Analyser shows that #BL602 sent the wrong Register ID to BME280 ... Let's fix this ü§î

https://github.com/lupyuen/bme280-nuttx#invalid-register-id

TODO23

![](https://lupyuen.github.io/images/bme280-logic1.png)


Here's how we connected our Logic Analyser to PineCone #BL602 ... For testing the #NuttX BMP280 Driver

https://github.com/lupyuen/bme280-nuttx/blob/main/README.md#invalid-register-id

TODO50

![](https://lupyuen.github.io/images/bme280-logic2.jpg)



#BL602 #NuttX I2C Driver doesn't log the data transferred ... Let's log ourselves

https://github.com/lupyuen/bme280-nuttx#log-i2c-transfers

TODO3

![](https://lupyuen.github.io/images/bme280-code3a.png)


#BL602 has a peculiar I2C Port ... We need to send the I2C Sub Address (Register ID) separately from the I2C Data ... This might cause the BMP280 Driver to fail

https://github.com/lupyuen/bme280-nuttx#set-i2c-sub-address

TODO34

![](https://lupyuen.github.io/images/bme280-subaddress.png)



#BL602 #NuttX I2C Driver expects us to provide the I2C Sub Address ... Let's patch the BMP280 Driver to pass the Register ID as I2C Sub Address

https://github.com/lupyuen/bme280-nuttx#set-i2c-sub-address

TODO4

![](https://lupyuen.github.io/images/bme280-code4a.png)


Here's how we patch the #NuttX BMP280 Driver to send the Register ID as I2C Sub Address (instead of I2C Data)

https://github.com/lupyuen/bme280-nuttx#set-i2c-sub-address

TODO5

![](https://lupyuen.github.io/images/bme280-code5a.png)



#NuttX BMP280 Driver loads OK on #BL602 ... After setting the Register ID as I2C Sub Address! üéâ

https://github.com/lupyuen/bme280-nuttx#bmp280-driver-loads-ok

TODO27

![](https://lupyuen.github.io/images/bme280-run2a.png)



#NuttX BMP280 Driver appears as "/dev/sensor/baro0" ... Let's read the device

https://github.com/lupyuen/bme280-nuttx#bmp280-driver-loads-ok

TODO29

![](https://lupyuen.github.io/images/bme280-run4a.png)



We enable the #NuttX Sensor Test App ... To test the BMP280 Driver

https://github.com/lupyuen/bme280-nuttx#run-sensor-test-app

TODO22

![](https://lupyuen.github.io/images/bme280-config4a.png)



#NuttX BMP280 Driver says it's 29 ¬∞C with air pressure 1,006 millibars ... Yep looks right for Sunny Singapore by the Seaside üëç

https://github.com/lupyuen/bme280-nuttx#run-sensor-test-app

TODO30

![](https://lupyuen.github.io/images/bme280-run5a.png)


#NuttX BMP280 Driver works OK with our BME280 Sensor ... But we're missing one thing: Humidity ... Can we port the BME280 Driver from Zephyr OS? ü§î

https://github.com/lupyuen/bme280-nuttx#port-bme280-driver-from-zephyr-os

TODO35

![](https://lupyuen.github.io/images/bme280-zephyr1.png)


Zephyr BME280 Driver looks similar to #NuttX BMP280 Driver ... So porting Zephyr BME280 Driver to NuttX might not be so hard ü§î

https://github.com/lupyuen/bme280-nuttx#port-bme280-driver-from-zephyr-os

TODO6

![](https://lupyuen.github.io/images/bme280-code6a.png)



Zephyr BME280 Driver builds OK on #NuttX (with a few tweaks) üéâ ... Now we wrap the Zephyr Driver as a NuttX Driver

https://github.com/lupyuen/bme280-nuttx#wrap-zephyr-driver-as-nuttx-driver

TODO7

![](https://lupyuen.github.io/images/bme280-code7a.png)



Our #NuttX Driver Wrapper wraps around the Zephyr BME280 Driver ... So it works like a NuttX Driver

https://github.com/lupyuen/bme280-nuttx#wrap-zephyr-driver-as-nuttx-driver

TODO8

![](https://lupyuen.github.io/images/bme280-code8a.png)



Our #NuttX BME280 Driver reads the Sensor Data from Zephyr Driver in two steps: 1Ô∏è‚É£ Fetch the sensor sample 2Ô∏è‚É£ Get the channel data

https://github.com/lupyuen/bme280-nuttx#read-sensor-data-from-zephyr-driver

TODO9

![](https://lupyuen.github.io/images/bme280-code9a.png)



Power Management works a little differently in #NuttX vs Zephyr ... Here's how our NuttX BME280 Driver calls the Zephyr Driver to do Power Management

https://github.com/lupyuen/bme280-nuttx#power-management

TODO10

![](https://lupyuen.github.io/images/bme280-code10.png)



BME280 Standby Duration is static in Zephyr but configured at runtime in #NuttX ... So we set it in our NuttX BME280 Driver

https://github.com/lupyuen/bme280-nuttx#standby-duration

TODO11

![](https://lupyuen.github.io/images/bme280-code11.png)


Zephyr BME280 Driver ported to Apache #NuttX OS ... Works great on NuttX! üéâ


https://github.com/lupyuen/bme280-nuttx#output-log

TODO32

![](https://lupyuen.github.io/images/bme280-run6a.png)


We made minimal changes to Zephyr BME280 Driver while porting to #NuttX OS

https://github.com/lupyuen/bme280-nuttx#zephyr-driver-modified-for-nuttx

TODO12

![](https://lupyuen.github.io/images/bme280-code12.png)


#NuttX doesn't have a Sensor Type that supports BME280 Temperature + Humidity + Pressure ... So our NuttX BME280 Driver combines 2 Sensor Types: 1Ô∏è‚É£ Barometer Sensor (Pressure + Temperature) 2Ô∏è‚É£ Humidity Sensor

https://github.com/lupyuen/bme280-nuttx#combined-barometer-and-humidity-sensor

TODO14

![](https://lupyuen.github.io/images/bme280-combine1.png)


Each #NuttX Sensor defines its operations for 1Ô∏è‚É£ Activating the sensor 2Ô∏è‚É£ Fetching sensor data 3Ô∏è‚É£ Setting the standby interval

https://github.com/lupyuen/bme280-nuttx#combined-barometer-and-humidity-sensor

TODO16

![](https://lupyuen.github.io/images/bme280-combine2a.png)


At #NuttX Startup we register both BME280 sensors: Barometer Sensor and Humidity Sensor

https://github.com/lupyuen/bme280-nuttx#combined-barometer-and-humidity-sensor

TODO17

![](https://lupyuen.github.io/images/bme280-combine3.png)


Our #NuttX BME280 Driver appears as 2 sensors: 1Ô∏è‚É£ "/dev/sensor/baro0" (Barometer Sensor) 2Ô∏è‚É£ "/dev/sensor/humi0" (Humidity Sensor)

https://github.com/lupyuen/bme280-nuttx#combined-barometer-and-humidity-sensor

