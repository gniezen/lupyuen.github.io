# ST7789 Display with LVGL Graphics on Apache NuttX RTOS

üìù _3 Apr 2022_

![ST7789 SPI Display connected to Pine64 PineCone BL602 RISC-V Board](https://lupyuen.github.io/images/st7789-title.jpg)

_ST7789 SPI Display connected to [Pine64 PineCone BL602 RISC-V Board](https://lupyuen.github.io/articles/pinecone)_

__Sitronix ST7789__ is an SPI Display Controller that's found in many gadgets. (Like [__PineTime Smartwatch__](https://lupyuen.github.io/articles/sneak-peek-of-pinetime-smart-watch-and-why-its-perfect-for-teaching-iot))

[__LVGL__](https://docs.lvgl.io/master/index.html) is a popular Open-Source Library that renders text and graphics on Embedded Devices.

Today we shall run ST7789 Display and LVGL Library on [__Apache NuttX RTOS__](https://lupyuen.github.io/articles/nuttx) (Real-Time Operating System).

NuttX supports ST7789 and LVGL right __out of the box__. (Batteries all included!) So this tutorial should be breezy squeezy peasy.

We'll run this tutorial on the [__BL602 RISC-V SoC__](https://lupyuen.github.io/articles/pinecone) and fix some issues specific to BL602...

-   __SPI Send__ didn't work correctly on BL602

-   ST7789 __Data / Command Pin__ wasn't implemented on BL602

-   BL602 only talks __SPI Mode 3__ to ST7789

The same steps should work on __ESP32 and other NuttX Platforms__. (Without the BL602 quirks)

![Connect BL602 to ST7789](https://lupyuen.github.io/images/st7789-connect.jpg)

# Connect ST7789 Display

We connect the ST7789 SPI Display to BL602 as follows (pic above)...

| BL602 Pin     | ST7789 SPI          | Wire Colour 
|:--------------|:--------------------|:-------------------
| __`GPIO 0`__  | `DC`  _(MISO)_      | Blue
| __`GPIO 2`__  | Unused _(CS)_
| __`GPIO 1`__  | `SDA` _(MOSI)_      | Yellow
| __`GPIO 3`__  | `SCL` _(SCK)_       | Green
| __`GPIO 4`__  | `RST` _(Reset)_     | Black
| __`GPIO 5`__  | `BLK` _(Backlight)_ | Orange
| __`3V3`__     | `3.3V`              | Red
| __`GND`__     | `GND`               | Grey

The BL602 pins for ST7789 are defined in [board.h](https://github.com/lupyuen/incubator-nuttx/blob/st7789/boards/risc-v/bl602/bl602evb/include/board.h#L92-L104)

```c
/* SPI Configuration: For PineCone BL602 */

#define BOARD_SPI_CS   (GPIO_INPUT | GPIO_PULLUP | GPIO_FUNC_SPI | GPIO_PIN2)
#define BOARD_SPI_MOSI (GPIO_INPUT | GPIO_PULLUP | GPIO_FUNC_SPI | GPIO_PIN1)
#define BOARD_SPI_MISO (GPIO_INPUT | GPIO_PULLUP | GPIO_FUNC_SPI | GPIO_PIN0)
#define BOARD_SPI_CLK  (GPIO_INPUT | GPIO_PULLUP | GPIO_FUNC_SPI | GPIO_PIN3)

#ifdef CONFIG_LCD_ST7789
/* ST7789 Configuration: Reset and Backlight Pins */

#define BOARD_LCD_RST (GPIO_OUTPUT | GPIO_PULLUP | GPIO_FUNC_SWGPIO | GPIO_PIN4)
#define BOARD_LCD_BL  (GPIO_OUTPUT | GPIO_PULLUP | GPIO_FUNC_SWGPIO | GPIO_PIN5)
#endif  /* CONFIG_LCD_ST7789 */
```

[(Which pins can be used? See Table 3.1 "Pin Description", Page 26)](https://github.com/bouffalolab/bl_docs/blob/main/BL602_RM/en/BL602_BL604_RM_1.2_en.pdf)

_What if we're connecting to ESP32-C3?_

__For ESP32-C3:__ The SPI Pins are defined in [Kconfig](https://github.com/lupyuen/incubator-nuttx/blob/st7789/arch/risc-v/src/esp32c3/Kconfig#L467-L485) and menuconfig...

```text
config ESP32C3_SPI2_CSPIN
	default 10

config ESP32C3_SPI2_CLKPIN
	default 6

config ESP32C3_SPI2_MOSIPIN
	default 7

config ESP32C3_SPI2_MISOPIN
	default 2
```

The Reset and Backlight Pins are also defined in [Kconfig](https://github.com/lupyuen/incubator-nuttx/blob/st7789/boards/risc-v/esp32c3/esp32c3-devkit/Kconfig#L119-L129) and menuconfig...

```text
config ESP32C3_LCD_RSTPIN
	int "LCD reset pin"
	default 9

config ESP32C3_LCD_BLPIN
	int "LCD backlight pin"
	default 18
```

[(ESP32-C3 pins are referenced here)](https://github.com/lupyuen/incubator-nuttx/blob/st7789/boards/risc-v/esp32c3/esp32c3-devkit/src/esp32c3_st7789.c#L45-L48)

# Download Source Code

To run ST7789 Display and LVGL Library on NuttX, download the modified source code for __NuttX OS and NuttX Apps__...

```bash
mkdir nuttx
cd nuttx
git clone --recursive --branch st7789 https://github.com/lupyuen/incubator-nuttx nuttx
git clone --recursive --branch st7789 https://github.com/lupyuen/incubator-nuttx-apps apps
```

(We'll cover the modifications in the following sections)

Or if we have an __existing NuttX Project,__ apply the following patches for ST7789 Display...

-   [__"Fix SPI Poll Send"__ (BL602)](https://github.com/apache/incubator-nuttx/pull/5869)

-   [__"Remove Check for LCD Driver"__ (BL602)](https://github.com/apache/incubator-nuttx/pull/5907)

-   [__"Implement SPI Cmd/Data"__ (BL602)](https://github.com/apache/incubator-nuttx/pull/5898)

-   Edit [boards/risc-v/bl602/bl602evb/include/board.h](https://github.com/lupyuen/incubator-nuttx/blob/st7789/boards/risc-v/bl602/bl602evb/include/board.h#L92-L104) and define the ST7789 pins...

    [__"Connect ST7789 Display"__](https://lupyuen.github.io/articles/st7789#connect-st7789-display)

-   Edit [boards/risc-v/bl602/bl602evb/src/bl602_bringup.c](https://github.com/lupyuen/incubator-nuttx/blob/st7789/boards/risc-v/bl602/bl602evb/src/bl602_bringup.c#L676-L696) and load the LCD Driver and the ST7789 Driver...

    [__"Load ST7789 Driver"__](https://lupyuen.github.io/articles/st7789#load-st7789-driver)

-   Edit [drivers/lcd/st7789.c](https://github.com/lupyuen/incubator-nuttx/blob/st7789/drivers/lcd/st7789.c#L50-L57) and configure ST7789 for SPI Mode 3...

    [__"SPI Mode 3"__](https://lupyuen.github.io/articles/st7789#spi-mode-3)

(We'll cover the patches in the following sections)

# ST7789 Data / Command Pin

_What's the DC Pin on ST7789?_

That's the __Data / Command Pin__ that tells ST7789 whether we're sending data or commands to the display.

The Data / Command Pin __goes Low__ when we're sending __ST7789 Commands__...

![MISO goes Low when transmitting ST7789 Commands](https://lupyuen.github.io/images/st7789-logic1.png)

And __goes High__ when we're sending __ST7789 Data__...

![MISO goes High when transmitting ST7789 Data](https://lupyuen.github.io/images/st7789-logic2a.png)

_So MISO talks to the Data / Command Pin?_

Yep NuttX uses the __SPI MISO Pin__ to control the ST7789 Data / Command Pin, as seen in the __SPI Driver__ for ESP32-C3...

![SPI Driver for ESP32-C3 uses the SPI MISO Pin to control the ST7789 Data / Command Pin](https://lupyuen.github.io/images/st7789-dc3a.png)

[(Source)](https://github.com/lupyuen/incubator-nuttx/blob/st7789/boards/risc-v/esp32c3/esp32c3-devkit/src/esp32c3_board_spi.c#L58-L86)

It flips the MISO Pin __as though it was a GPIO Pin!__

_Can we do the same on BL602?_

Yes but we need to __reconfigure the SPI MISO Pin__ as a GPIO Pin, on the fly, before flipping it as a GPIO Pin...

![Reconfigure the SPI MISO Pin as a GPIO Pin](https://lupyuen.github.io/images/st7789-dc4a.png)

[(Source)](https://github.com/lupyuen/incubator-nuttx/blob/st7789/arch/risc-v/src/bl602/bl602_spi.c#L679-L748)

After sending ST7789 Command or Data, we __revert the pin back from GPIO Pin__ to SPI MISO Pin...

![Revert the pin back from GPIO Pin to SPI MISO Pin](https://lupyuen.github.io/images/st7789-dc2a.png)

[(Source)](https://github.com/lupyuen/incubator-nuttx/blob/st7789/arch/risc-v/src/bl602/bl602_spi.c#L415-L453)

_Why must we revert the pin from GPIO back to SPI?_

We must revert because the SPI Bus may be __shared by other SPI Drivers__ that expect a functioning SPI MISO Pin.

(Like the Semtech SX1262 Driver on PineDio Stack BL604)

This nifty implementation of the Data / Command Pin has been __merged into NuttX Mainline__. [(See this)](https://github.com/apache/incubator-nuttx/pull/5898)

[(For implementation details, see the Appendix)](https://lupyuen.github.io/articles/st7789#appendix-spi-cmddata-on-bl602)

# Fix SPI Send

While testing the ST7789 Driver, we hit a strange problem...

Our BL602 device would __hang when sending anything__ over SPI to ST7789!

Can you spot the bug in __bl602_spi_poll_send__?

![BL602 hangs when sending anything over SPI to ST7789](https://lupyuen.github.io/images/st7789-spi1.png)

[(Source)](https://github.com/apache/incubator-nuttx/blob/54e630e14d7e32d6f81ae79d4e5df3d2fa787ef0/arch/risc-v/src/bl602/bl602_spi.c#L779-L803)

__Answer:__ If we call __SPI Poll Send__ _(bl602_spi_poll_send)_ directly instead of __SPI Poll Exchange__ _(bl602_spi_poll_exchange)_...

The SPI Port __won't get configured correctly__!

("SPI Enable Master" and "SPI FIFO Clear" are skipped)

And __it hangs__!

(Looping forever waiting for SPI FIFO)

![SPI Port won't get configured correctly if we call SPI Poll Send](https://lupyuen.github.io/images/st7789-spi2a.png)

[(Source)](https://github.com/apache/incubator-nuttx/blob/54e630e14d7e32d6f81ae79d4e5df3d2fa787ef0/arch/risc-v/src/bl602/bl602_spi.c#L779-L803)

We fix this problem by __moving the code that configures the SPI Port__ from SPI Poll Exchange to SPI Poll Send...

(Note that SPI Poll Exchange calls SPI Poll Send)

```c
//  SPI Poll Send: Send the byte or word to the SPI Port
static uint32_t bl602_spi_poll_send(struct bl602_spi_priv_s *priv, uint32_t wd) {

  //  Enable SPI Master (moved from SPI Poll Exchange)
  modifyreg32(BL602_SPI_CFG, SPI_CFG_CR_S_EN, SPI_CFG_CR_M_EN);

  //  Clear SPI FIFO (moved from SPI Poll Exchange)
  modifyreg32(BL602_SPI_FIFO_CFG_0, SPI_FIFO_CFG_0_RX_CLR | SPI_FIFO_CFG_0_TX_CLR, 0);

  //  Rest of the function is the same...
  //  Write data to Transmit FIFO
  putreg32(wd, BL602_SPI_FIFO_WDATA);

  //  Wait for Receive FIFO and receive data
  while (0 == tmp_val) { ... }
```

[(Source)](https://github.com/lupyuen/incubator-nuttx/blob/st7789/arch/risc-v/src/bl602/bl602_spi.c#L806-L839)

After fixing, we verify with a __Logic Analyser__ that SPI Poll Send transmits data correctly to ST7789...

![SPI Poll Send transmits SPI Data correctly](https://lupyuen.github.io/images/st7789-logic3.png)

SPI Poll Send has been __fixed in NuttX Mainline__. [(See this)](https://github.com/apache/incubator-nuttx/pull/5869)

[(For details of the fix, see the Appendix)](https://lupyuen.github.io/articles/st7789#appendix-fix-spi-send-on-bl602)

# SPI Mode 3

For some unknown reason, BL602 talks to ST7789 __only in SPI Mode 3__.

We hardcode SPI Mode 3 in the __ST7789 Driver__: [st7789.c](https://github.com/lupyuen/incubator-nuttx/blob/st7789/drivers/lcd/st7789.c#L50-L57)

```c
//  If this is BL602...
#ifdef CONFIG_BL602_SPI0
  //  Use SPI Mode 3 as workaround for BL602
  #warning Using SPI Mode 3 for ST7789 on BL602
  #define CONFIG_LCD_ST7789_SPIMODE SPIDEV_MODE3

//  If not BL602...
#else
  //  Use SPI Mode 0 or from menuconfig
  #ifndef CONFIG_LCD_ST7789_SPIMODE
  #define CONFIG_LCD_ST7789_SPIMODE SPIDEV_MODE0
  #endif  //  CONFIG_LCD_ST7789_SPIMODE
#endif    //  CONFIG_BL602_SPI0
```

We've seen this behaviour with ST7789 and BL602 IoT SDK, so it's probably a __quirk in BL602's SPI Port__, not in the ST7789 Driver.

[(More about this)](https://lupyuen.github.io/articles/display#initialise-spi-port)

![BL602 talks to ST7789 only in SPI Mode 3](https://lupyuen.github.io/images/st7789-code4.png)

# Load ST7789 Driver

We fixed the SPI issues on BL602... Now we can __load the ST7789 Driver__ at startup!

We do this in 2 steps...

-   We load the __LCD Driver "/dev/lcd0"__

-   Then we load the __ST7789 Driver__

    (Which will be exposed to apps through the LCD Driver)

## LCD Driver

This is how we load the __LCD Driver__ at startup: [bl602_bringup.c](https://github.com/lupyuen/incubator-nuttx/blob/st7789/boards/risc-v/bl602/bl602evb/src/bl602_bringup.c#L676-L696)

```c
#ifdef CONFIG_LCD_DEV
#include <nuttx/board.h>
#include <nuttx/lcd/lcd_dev.h>
#endif  //  CONFIG_LCD_DEV

#ifdef CONFIG_LCD_ST7789
#include <nuttx/lcd/st7789.h>
#include "../boards/risc-v/bl602/bl602evb/include/board.h"
#include "riscv_internal.h"
#endif  //  CONFIG_LCD_ST7789
...
//  Called during NuttX startup to load drivers
int bl602_bringup(void) {
  ...
#ifdef CONFIG_LCD_DEV
  //  Initialize the LCD driver
  ret = board_lcd_initialize();
  if (ret < 0) {
    _err("ERROR: board_lcd_initialize() failed: %d\n", ret);
  }

  //  Register the LCD driver
  ret = lcddev_register(0);
  if (ret < 0) {
    _err("ERROR: lcddev_register() failed: %d\n", ret);
  }
#endif  //  CONFIG_LCD_DEV
  return ret;
}
```

__bl602_bringup__ is called by NuttX during startup to load NuttX Drivers...

-   We call __board_lcd_initialize__ to initialise the LCD Driver

    (We'll see this in a while)

-   Then we call __lcddev_register__ to register the LCD Driver as "__/dev/lcd0__"

    [(__lcddev_register__ is defined here)](https://github.com/lupyuen/incubator-nuttx/blob/st7789/drivers/lcd/lcd_dev.c#L305-L353)

-   Which calls __board_lcd_getdev__ to load the ST7789 Driver

Let's study __board_lcd_initialize__ and __board_lcd_getdev__

## ST7789 Driver

__board_lcd_initialize__ initialises the LCD Driver at startup:  [bl602_bringup.c](https://github.com/lupyuen/incubator-nuttx/blob/st7789/boards/risc-v/bl602/bl602evb/src/bl602_bringup.c#L698-L742)

```c
#ifdef CONFIG_LCD_ST7789

//  SPI Port Number for LCD
#define LCD_SPI_PORTNO 0

//  SPI Bus for LCD
static struct spi_dev_s *st7789_spi_bus;

//  LCD Device
static struct lcd_dev_s *g_lcd = NULL;

//  Called by bl602_bringup during NuttX startup 
//  to init the LCD Driver
int board_lcd_initialize(void) {
  //  Fetch the SPI Bus for the LCD Driver
  st7789_spi_bus = bl602_spibus_initialize(LCD_SPI_PORTNO);
  if (!st7789_spi_bus) {
    lcderr("ERROR: Failed to initialize SPI port %d for LCD\n", LCD_SPI_PORTNO);
    return -ENODEV;
  }

  //  Pull Reset Pin high to reset ST7789
  bl602_configgpio(BOARD_LCD_RST);        //  Configure Reset as GPIO Pin
  bl602_gpiowrite(BOARD_LCD_RST, false);  //  Set to Low
  up_mdelay(1);                           //  Wait 1 millisecond
  bl602_gpiowrite(BOARD_LCD_RST, true);   //  Set to High
  up_mdelay(10);                          //  Wait 10 milliseconds

  //  Set Backlight to full brightness
  bl602_configgpio(BOARD_LCD_BL);       //  Configure Backlight as GPIO Pin
  bl602_gpiowrite(BOARD_LCD_BL, true);  //  Set to High
  return OK;
}
```

Inside this function we...

-   __Fetch the SPI Bus__ from NuttX

    (Will be used by ST7789 Driver)

-   __Pull the Reset Pin__ Low then High

    (To reset the ST7789 Display)

-   Switch on the __Backlight__

    (So we can see things on the screen)

Finally we __load the ST7789 Driver__: [bl602_bringup.c](https://github.com/lupyuen/incubator-nuttx/blob/st7789/boards/risc-v/bl602/bl602evb/src/bl602_bringup.c#L744-L769)

```c
//  Called by lcddev_register during NuttX startup
//  to load the ST7789 Driver
FAR struct lcd_dev_s *board_lcd_getdev(int devno) {
  //  Init the ST7789 driver
  g_lcd = st7789_lcdinitialize(st7789_spi_bus);

  //  Return the ST7789 driver
  if (!g_lcd) {
    lcderr("ERROR: Failed to bind SPI port %d to LCD %d\n", LCD_SPI_PORTNO,
      devno);
  } else {
    lcdinfo("SPI port %d bound to LCD %d\n", LCD_SPI_PORTNO, devno);
    return g_lcd;
  }
  return NULL;
}
#endif  //  CONFIG_LCD_ST7789
```

(We'll see __st7789_lcdinitialize__ later)

We __initialise the ST7789 Driver__ and return it to [__lcddev_register__](https://github.com/lupyuen/incubator-nuttx/blob/st7789/drivers/lcd/lcd_dev.c#L305-L353)...

Which will __wrap the ST7789 Driver__ inside our LCD Driver "__/dev/lcd0__".

That's how we load the LCD Driver and ST7789 Driver on NuttX!

_What about ESP32-C3?_

__For ESP32-C3:__ This is how we load the LCD Driver and ST7789 Driver at startup...

-   [__Load LCD Driver__ (ESP32-C3)](https://github.com/lupyuen/incubator-nuttx/blob/st7789/boards/risc-v/esp32c3/esp32c3-devkit/src/esp32c3_bringup.c#L196-L210)

-   [__Load ST7789 Driver__ (ESP32-C3)](https://github.com/lupyuen/incubator-nuttx/blob/st7789/boards/risc-v/esp32c3/esp32c3-devkit/src/esp32c3_st7789.c)

# Render Pink Screen

In a while we'll boot NuttX to load the ST7789 Driver but...

_How will we know if the ST7789 Driver is really working?_

Here's an idea... Let's __render a Pink Screen__ at startup! 

This is how we do it: [st7789.c](https://github.com/lupyuen/incubator-nuttx/blob/st7789/drivers/lcd/st7789.c#L752-L777)

```c
//  Called by board_lcd_getdev during NuttX startup
//  to init the ST7789 driver
FAR struct lcd_dev_s *st7789_lcdinitialize(FAR struct spi_dev_s *spi) {
  ...
  //  Disable sleep mode
  st7789_sleep(priv, false);

  //  Set to 16-bit colour
  st7789_bpp(priv, ST7789_BPP);

  //  Set display orientation
  st7789_setorientation(priv);

  //  Enable display
  st7789_display(priv, true);
  
  //  Fill the screen with pink
  st7789_fill(priv, 0xAAAA);

  //  Previously: Fill the screen with white
  //  st7789_fill(priv, 0xFFFF);
```

Recalls that __st7789_lcdinitialize__ is called by [__board_lcd_getdev__](https://lupyuen.github.io/articles/st7789#st7789-driver) during NuttX startup.

This function initialises the ST7789 Display. We changed the last line so that it __fills the screen with pink__. (Colour value AAAA)

Let's talk about AAAA...

![AAAA in RGB565 is pink](https://lupyuen.github.io/images/st7789-rgb565.jpg)

## RGB565 Colour Encoding

_Why is AAAA pink?_

That's because ST7789 encodes colours in __16 bits as RGB565__...

-   5 bits for __Red__

-   6 bits for __Green__

-   5 bits for __Blue__

The pic above shows that AAAA broken down into __RGB565__ is...

-   __66%__ Red

-   __33%__ Green

-   __32%__ Blue

Which is a reddish hue of white: __pink!__

# Run NuttX

TODO

After fixing SPI Send and SPI Cmd/Data, the ST7789 Driver should start properly without hanging...

```text
gpio_pin_register: Registering /dev/gpio0
gpio_pin_register: Registering /dev/gpio1
gpint_enable: Disable the interrupt
gpio_pin_register: Registering /dev/gpio2
bl602_gpio_set_intmod: ****gpio_pin=115, int_ctlmod=1, int_trgmod=0
bl602_spi_setfrequency: frequency=400000, actual=0
bl602_spi_setbits: nbits=8
bl602_spi_setmode: mode=0
spi_test_driver_register: devpath=/dev/spitest0, spidev=0
bl602_spi_select: devid: 0, CS: free
st7789_sleep: sleep: 0
st7789_sendcmd: cmd: 0x11
bl602_spi_select: devid: 262144, CS: select
bl602_spi_setmode: mode=3
bl602_spi_setbits: nbits=8
bl602_spi_setfrequency: frequency=1000000, actual=0
bl602_spi_cmddata: devid: 262144 CMD: command
bl602_spi_poll_send: send=11 and recv=0
bl602_spi_cmddata: devid: 262144 CMD: data
bl602_spi_select: devid: 262144, CS: free
st7789_sendcmd: OK
st7789_bpp: bpp: 16
st7789_sendcmd: cmd: 0x3a
bl602_spi_select: devid: 262144, CS: select
bl602_spi_setmode: mode=3
bl602_spi_setbits: nbits=8
bl602_spi_cmddata: devid: 262144 CMD: command
bl602_spi_poll_send: send=3a and recv=0
bl602_spi_cmddata: devid: 262144 CMD: data
bl602_spi_select: devid: 262144, CS: free
st7789_sendcmd: OK
bl602_spi_select: devid: 262144, CS: select
bl602_spi_setmode: mode=3
bl602_spi_setbits: nbits=8
bl602_spi_poll_send: send=5 and recv=ff
bl602_spi_select: devid: 262144, CS: free
st7789_setorientation:
st7789_sendcmd: cmd: 0x36
bl602_spi_select: devid: 262144, CS: select
bl602_spi_setmode: mode=3
bl602_spi_setbits: nbits=8
bl602_spi_cmddata: devid: 262144 CMD: command
bl602_spi_poll_send: send=36 and recv=0
bl602_spi_cmddata: devid: 262144 CMD: data
bl602_spi_select: devid: 262144, CS: free
st7789_sendcmd: OK
bl602_spi_select: devid: 262144, CS: select
bl602_spi_setmode: mode=3
bl602_spi_setbits: nbits=8
bl602_spi_poll_send: send=70 and recv=ff
bl602_spi_select: devid: 262144, CS: free
st7789_display: on: 1
st7789_sendcmd: cmd: 0x29
bl602_spi_select: devid: 262144, CS: select
bl602_spi_setmode: mode=3
bl602_spi_setbits: nbits=8
bl602_spi_cmddata: devid: 262144 CMD: command
bl602_spi_poll_send: send=29 and recv=0
bl602_spi_cmddata: devid: 262144 CMD: data
bl602_spi_select: devid: 262144, CS: free
st7789_sendcmd: OK
st7789_sendcmd: cmd: 0x21
bl602_spi_select: devid: 262144, CS: select
bl602_spi_setmode: mode=3
bl602_spi_setbits: nbits=8
bl602_spi_cmddata: devid: 262144 CMD: command
bl602_spi_poll_send: send=21 and recv=0
bl602_spi_cmddata: devid: 262144 CMD: data
bl602_spi_select: devid: 262144, CS: free
st7789_sendcmd: OK
board_lcd_getdev: SPI port 0 bound to LCD 0
st7789_getplaneinfo: planeno: 0 bpp: 16

(...Screen fill omitted...)

NuttShell (NSH) NuttX-10.2.0-RC0
nsh> ls /dev
/dev:
 console
 gpio0
 gpio1
 gpio2
 lcd0
 null
 spi0
 spitest0
 timer0
 urandom
 zero
```

[(See the complete log)](https://github.com/lupyuen/st7789-nuttx#boot-nuttx)

Note that our ST7789 Display appears as "__/dev/lcd0__". This will be used by the LVGL Library.

When NuttX boots, we should see a pink screen. The screen refresh looks laggy, hopefully we'll fix this with SPI DMA.

[(Watch the demo on YouTube)](https://youtu.be/iaDYjO1rCmY)

![When NuttX boots, we should see a pink screen](https://lupyuen.github.io/images/st7789-boot.jpg)

TODO8

![](https://lupyuen.github.io/images/st7789-code3.png)

# LVGL Demo App

TODO

Let's run the LVGL Demo App bundled with NuttX.  The app initialises the display, renders some widgets and handles LVGL events: [lvgldemo.c](https://github.com/lupyuen/incubator-nuttx-apps/blob/st7789/examples/lvgldemo/lvgldemo.c#L109-L238)

```c
int main(int argc, FAR char *argv[])
{
  lv_disp_drv_t disp_drv;
  lv_disp_buf_t disp_buf;

  ...

  /* LVGL initialization */

  lv_init();

  /* Basic LVGL display driver initialization */

  lv_disp_buf_init(&disp_buf, buffer1, buffer2, DISPLAY_BUFFER_SIZE);
  lv_disp_drv_init(&disp_drv);
  disp_drv.buffer = &disp_buf;
  disp_drv.monitor_cb = monitor_cb;

  /* Display interface initialization */

  if (fbdev_init(&disp_drv) != EXIT_SUCCESS)
    {
      /* Failed to use framebuffer falling back to lcd driver */

      if (lcddev_init(&disp_drv) != EXIT_SUCCESS)
        {
          /* No possible drivers left, fail */

          return EXIT_FAILURE;
        }
    }

  lv_disp_drv_register(&disp_drv);

  ...

  lv_demo_widgets();

  ...

  /* Handle LVGL tasks */

  while (1)
    {
      lv_task_handler();
      usleep(10000);
    }

  return EXIT_SUCCESS;
}
```

__lv_demo_widgets__ comes from the LVGL Source Code.

TODO11

![](https://lupyuen.github.io/images/st7789-code5a.png)

# Run LVGL Demo

TODO

We run the LVGL Demo App `lvgldemo` with ST7789...

```text
‚ñígpio_pin_register: Registering /dev/gpio0
gpio_pin_register: Registering /dev/gpio1
gpint_enable: Disable the interrupt
gpio_pin_register: Registering /dev/gpio2
bl602_gpio_set_intmod: ****gpio_pin=115, int_ctlmod=1, int_trgmod=0
spi_test_driver_register: devpath=/dev/spitest0, spidev=0
st7789_sleep: sleep: 0
st7789_sendcmd: cmd: 0x11
st7789_sendcmd: OK
st7789_bpp: bpp: 16
st7789_sendcmd: cmd: 0x3a
st7789_sendcmd: OK
st7789_setorientation:
st7789_sendcmd: cmd: 0x36
st7789_sendcmd: OK
st7789_display: on: 1
st7789_sendcmd: cmd: 0x29
st7789_sendcmd: OK
st7789_sendcmd: cmd: 0x21
st7789_sendcmd: OK
st7789_fill: color: 0xaaaa
st7789_sendcmd: cmd: 0x2b
st7789_sendcmd: OK
st7789_sendcmd: cmd: 0x2a
st7789_sendcmd: OK
st7789_sendcmd: cmd: 0x2c
st7789_sendcmd: OK
board_lcd_getdev: SPI port 0 bound to LCD 0
st7789_getplaneinfo: planeno: 0 bpp: 16

NuttShell (NSH) NuttX-10.2.0-RC0
nsh> ?
help usage:  help [-v] [<cmd>]

  ?      cat    help   ls     uname

Builtin Apps:
  tinycbor_test            spi_test                 nsh
  lorawan_test             timer                    sensortest
  sx1262_test              bl602_adc_test           ikea_air_quality_sensor
  bas                      spi_test2                gpio
  sh                       getprime
  lvgldemo                 hello
nsh> lvgldemo
fbdev_init: Failed to open /dev/fb0: 2
st7789_getvideoinfo: fmt: 11 xres: 240 yres: 240 nplanes: 1
lcddev_init: VideoInfo:
        fmt: 11
        xres: 240
        yres: 240
        nplanes: 1
lcddev_init: PlaneInfo (plane 0):
        bpp: 16
st7789_putarea: row_start: 0 row_end: 19 col_start: 0 col_end: 239
st7789_sendcmd: cmd: 0x2b
st7789_sendcmd: OK
st7789_sendcmd: cmd: 0x2a
st7789_sendcmd: OK
st7789_sendcmd: cmd: 0x2c
st7789_sendcmd: OK
st7789_putarea: row_start: 20 row_end: 39 col_start: 0 col_end: 239
st7789_sendcmd: cmd: 0x2b
st7789_sendcmd: OK
st7789_sendcmd: cmd: 0x2a
st7789_sendcmd: OK
st7789_sendcmd: cmd: 0x2c
st7789_sendcmd: OK
st7789_putarea: row_start: 40 row_end: 59 col_start: 0 col_end: 239
st7789_sendcmd: cmd: 0x2b
st7789_sendcmd: OK
st7789_sendcmd: cmd: 0x2a
st7789_sendcmd: OK
st7789_sendcmd: cmd: 0x2c
st7789_sendcmd: OK
st7789_putarea: row_start: 60 row_end: 79 col_start: 0 col_end: 239
st7789_sendcmd: cmd: 0x2b
st7789_sendcmd: OK
st7789_sendcmd: cmd: 0x2a
st7789_sendcmd: OK
st7789_sendcmd: cmd: 0x2c
st7789_sendcmd: OK
st7789_putarea: row_start: 80 row_end: 99 col_start: 0 col_end: 239
st7789_sendcmd: cmd: 0x2b
st7789_sendcmd: OK
st7789_sendcmd: cmd: 0x2a
st7789_sendcmd: OK
st7789_sendcmd: cmd: 0x2c
st7789_sendcmd: OK
st7789_putarea: row_start: 100 row_end: 119 col_start: 0 col_end: 239
st7789_sendcmd: cmd: 0x2b
st7789_sendcmd: OK
st7789_sendcmd: cmd: 0x2a
st7789_sendcmd: OK
st7789_sendcmd: cmd: 0x2c
st7789_sendcmd: OK
st7789_putarea: row_start: 120 row_end: 139 col_start: 0 col_end: 239
st7789_sendcmd: cmd: 0x2b
st7789_sendcmd: OK
st7789_sendcmd: cmd: 0x2a
st7789_sendcmd: OK
st7789_sendcmd: cmd: 0x2c
st7789_sendcmd: OK
st7789_putarea: row_start: 140 row_end: 159 col_start: 0 col_end: 239
st7789_sendcmd: cmd: 0x2b
st7789_sendcmd: OK
st7789_sendcmd: cmd: 0x2a
st7789_sendcmd: OK
st7789_sendcmd: cmd: 0x2c
st7789_sendcmd: OK
st7789_putarea: row_start: 160 row_end: 179 col_start: 0 col_end: 239
st7789_sendcmd: cmd: 0x2b
st7789_sendcmd: OK
st7789_sendcmd: cmd: 0x2a
st7789_sendcmd: OK
st7789_sendcmd: cmd: 0x2c
st7789_sendcmd: OK
st7789_putarea: row_start: 180 row_end: 199 col_start: 0 col_end: 239
st7789_sendcmd: cmd: 0x2b
st7789_sendcmd: OK
st7789_sendcmd: cmd: 0x2a
st7789_sendcmd: OK
st7789_sendcmd: cmd: 0x2c
st7789_sendcmd: OK
st7789_putarea: row_start: 200 row_end: 219 col_start: 0 col_end: 239
st7789_sendcmd: cmd: 0x2b
st7789_sendcmd: OK
st7789_sendcmd: cmd: 0x2a
st7789_sendcmd: OK
st7789_sendcmd: cmd: 0x2c
st7789_sendcmd: OK
st7789_putarea: row_start: 220 row_end: 239 col_start: 0 col_end: 239
st7789_sendcmd: cmd: 0x2b
st7789_sendcmd: OK
st7789_sendcmd: cmd: 0x2a
st7789_sendcmd: OK
st7789_sendcmd: cmd: 0x2c
st7789_sendcmd: OK
monitor_cb: 57600 px refreshed in 1100 ms
```

The LVGL Demo Screen appears on ST7789 yay! The demo source code is here: [lvgldemo.c](https://github.com/lupyuen/incubator-nuttx-apps/blob/st7789/examples/lvgldemo/lvgldemo.c)

![LVGL Demo Screen appears on ST7789](https://lupyuen.github.io/images/st7789-lvgl.jpg)

# LVGL Version

TODO

We can specify the LVGL Version in menuconfig:

- Application Configuration ‚Üí Graphics Support ‚Üí Light and Versatile Graphic Library (LVGL) ‚Üí LVGL Version  

After setting the LVGL Version, be sure to delete all downloaded versions of LVGL before building NuttX:

```bash
## TODO: Change this to the path of our "incubator-nuttx" folder
cd nuttx/nuttx

## Preserve the Build Config
cp .config ../config

## Erase the build files
make clean

## Erase the Build Config and Kconfig files
make distclean

## For BL602: Configure the build for BL602
./tools/configure.sh bl602evb:nsh

## For ESP32: Configure the build for ESP32.
## TODO: Change "esp32-devkitc" to our ESP32 board.
./tools/configure.sh esp32-devkitc:nsh

## Restore the Build Config
cp ../config .config

## Erase all downloaded versions of LVGL
rm ../apps/graphics/lvgl/v7*.zip
rm ../apps/graphics/lvgl/v8*.zip

## Build NuttX
make
```

Note that NuttX builds with LVGL version 7.3.0. The current version of LVGL is 8.2.0.

LVGL 8 is NOT backward compatible with LVGL 7. See the breaking changes...

- [LVGL 8.0.0 Release Notes](https://github.com/lvgl/lvgl/blob/master/docs/CHANGELOG.md#v800-01062021)

Should we migrate to LVGL 8? Or upgrade to LVGL 7.11.0?

_What happens if we switch to LVGL 7.11.0?_

NuttX Build fails when we switch to LVGL 7.11.0...

```text
/home/user/nuttx/apps/graphics/lvgl/lv_conf.h:86:50: error: incompatible types when initializing type 'short unsigned int' using type 'lv_color_t' {aka 'union <anonymous>'}
 #define LV_COLOR_TRANSP    ((lv_color_t){.full = (CONFIG_LV_COLOR_TRANSP)})
                                                  ^
/home/user/nuttx/apps/graphics/lvgl/lvgl/src/lv_core/../lv_draw/lv_img_buf.h:351:25: note: in expansion of macro 'LV_COLOR_TRANSP'
         lv_color_t ct = LV_COLOR_TRANSP;
```

It seems the demo source code needs to be updated for 7.11.0: [lvgldemo.c](https://github.com/lupyuen/incubator-nuttx-apps/blob/st7789/examples/lvgldemo/lvgldemo.c)

_What happens if we switch to LVGL 8.2.0?_

NuttX Build fails when downloading the LVGL Source Code...

```text
make[3]: Entering directory '/home/user/nuttx/apps/examples/lvgldemo'
Downloading: v8.2.0.zip
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100   118  100   118    0     0    361      0 --:--:-- --:--:-- --:--:--   360
100    14  100    14    0     0     12      0  0:00:01  0:00:01 --:--:--     0
Unpacking: v8.2.0.zip -> lv_demos
Archive:  v8.2.0.zip
  End-of-central-directory signature not found.  Either this file is not
  a zipfile, or it constitutes one disk of a multi-part archive.  In the
  latter case the central directory and zipfile comment will be found on
  the last disk(s) of this archive.
unzip:  cannot find zipfile directory in one of v8.2.0.zip or
        v8.2.0.zip.zip, and cannot find v8.2.0.zip.ZIP, period.
```

Seems the NuttX Makefiles need to be fixed to support LVGL 8. 

Also the demo source code needs to be updated for LVGL 8, which is not compatible with LVGL 7: [lvgldemo.c](https://github.com/lupyuen/incubator-nuttx-apps/blob/st7789/examples/lvgldemo/lvgldemo.c)

# Sharing SPI Bus

TODO

PineDio Stack BL604 connects multiple SPI Devices to the same SPI Bus: ST7789 Display, SX1262 LoRa Transceiver, SPI Flash.

How to share the same SPI Bus for multiple SPI Devices? How do we control the Chip Select Pins for each SPI Device?

TODO

![](https://lupyuen.github.io/images/st7789-connect2.jpg)

# What's Next

TODO

Many Thanks to my [__GitHub Sponsors__](https://github.com/sponsors/lupyuen) for supporting my work! This article wouldn't have been possible without your support.

-   [Sponsor me a coffee](https://github.com/sponsors/lupyuen)

-   [Read "The RISC-V BL602 / BL604 Book"](https://lupyuen.github.io/articles/book)

-   [Check out my articles](https://lupyuen.github.io)

-   [RSS Feed](https://lupyuen.github.io/rss.xml)

_Got a question, comment or suggestion? Create an Issue or submit a Pull Request here..._

[`lupyuen.github.io/src/st7789.md`](https://github.com/lupyuen/lupyuen.github.io/blob/master/src/st7789.md)

# Notes

1.  This article is the expanded version of [this Twitter Thread](https://twitter.com/MisterTechBlog/status/1507854679241199616)

# Appendix: SPI Cmd/Data on BL602

This section explains how we implemented the __ST7789 Data / Command Pin__ on BL602 NuttX...

To control the Data / Command Pin on ST7789 SPI Display, the SPI Driver flips the MISO Pin as though it was a GPIO. Here's the existing implementation for ESP32-C3: [esp32c3_board_spi.c](https://github.com/lupyuen/incubator-nuttx/blob/st7789/boards/risc-v/esp32c3/esp32c3-devkit/src/esp32c3_board_spi.c#L58-L86)

```c
#if defined(CONFIG_ESP32C3_SPI2) && defined(CONFIG_SPI_CMDDATA)

int esp32c3_spi2_cmddata(FAR struct spi_dev_s *dev, uint32_t devid, bool cmd)
{
#if defined(CONFIG_LCD_ST7735) || defined(CONFIG_LCD_ST7789) || \
    defined(CONFIG_LCD_GC9A01)
  if (devid == SPIDEV_DISPLAY(0))
    {
      /*  This is the Data/Command control pad which determines whether the
       *  data bits are data or a command.
       */

      esp32c3_gpiowrite(CONFIG_ESP32C3_SPI2_MISOPIN, !cmd);

      return OK;
    }

#endif
  spiinfo("devid: %" PRIu32 " CMD: %s\n", devid, cmd ? "command" :
          "data");

  return -ENODEV;
}

#endif
```

To implement this on BL602, we reconfigure MISO from SPI Pin to GPIO Pin on the fly: [bl602_spi.c](https://github.com/lupyuen/incubator-nuttx/blob/st7789/arch/risc-v/src/bl602/bl602_spi.c#L679-L748)

```c
#ifdef CONFIG_SPI_CMDDATA
static int bl602_spi_cmddata(struct spi_dev_s *dev,
                              uint32_t devid, bool cmd)
{
  spiinfo("devid: %" PRIu32 " CMD: %s\n", devid, cmd ? "command" :
          "data");

#if defined(CONFIG_LCD_ST7735) || defined(CONFIG_LCD_ST7789) || \
    defined(CONFIG_LCD_GC9A01)
  if (devid == SPIDEV_DISPLAY(0))
    {
      gpio_pinset_t gpio;
      int ret;

      /* reconfigure MISO from SPI Pin to GPIO Pin */

      gpio = (BOARD_SPI_MISO & GPIO_PIN_MASK)
            | GPIO_OUTPUT | GPIO_PULLUP | GPIO_FUNC_SWGPIO;
      ret = bl602_configgpio(gpio);
      if (ret < 0)
        {
          spierr("Failed to configure MISO as GPIO\n");
          DEBUGPANIC();

          return ret;
        }

      /* set MISO to high (data) or low (command) */

      bl602_gpiowrite(gpio, !cmd);

      return OK;
    }
#endif

  spierr("SPI cmddata not supported\n");
  DEBUGPANIC();

  return -ENODEV;
}
#endif
```

Note that `BOARD_SPI_MISO & GPIO_PIN_MASK` preserves the MISO GPIO Number when reconfiguring from SPI Pin to GPIO Pin.

When the SPI Port is deselected (after the SPI operation), we revert MISO back from GPIO Pin to SPI Pin: [bl602_spi.c](https://github.com/lupyuen/incubator-nuttx/blob/st7789/arch/risc-v/src/bl602/bl602_spi.c#L415-L453)

```c
static void bl602_spi_select(struct spi_dev_s *dev, uint32_t devid, bool selected) {
  ...
#ifdef CONFIG_SPI_CMDDATA
  /* revert MISO from GPIO Pin to SPI Pin */

  if (!selected)
    {
      bl602_configgpio(BOARD_SPI_MISO);
    }
#endif
}
```

We must revert because the SPI Bus may be shared by other SPI Drivers. (Like the Semtech SX1262 Driver on PineDio Stack BL604)

We tested this implementation of SPI Cmd/Data with NuttX ST7789 Driver and a Logic Analyser on PineCone BL602. Logic Analyser shows that MISO goes Low when transmitting ST7789 Commands...

![MISO goes Low when transmitting ST7789 Commands](https://lupyuen.github.io/images/st7789-logic1.png)

And MISO goes High when transmitting ST7789 Data...

![MISO goes High when transmitting ST7789 Data](https://lupyuen.github.io/images/st7789-logic2a.png)

We also tested LVGL with ST7789 on PineCone BL602:

-   [Testing with LVGL](https://github.com/lupyuen/st7789-nuttx#run-lvgl-demo)

As for regular SPI Devices that don't require SPI Cmd/Data, we tested `CONFIG_SPI_CMDDATA=y` with Semtech SX1262 SPI Transceiver on PineCone BL602:

-   [Testing Cmd/Data](https://github.com/lupyuen/incubator-nuttx/releases/tag/release-2022-03-29)

[(Our implementation of SPI Cmd/Data has been merged into NuttX)](https://github.com/apache/incubator-nuttx/pull/5898)

TODO24

![](https://lupyuen.github.io/images/st7789-dc1.png)

TODO25

![](https://lupyuen.github.io/images/st7789-dc2a.png)

TODO26

![](https://lupyuen.github.io/images/st7789-dc3a.png)

TODO27

![](https://lupyuen.github.io/images/st7789-dc4a.png)

# Appendix: Fix SPI Send on BL602

This section explains how we __fixed SPI Send__ on BL602 NuttX...

On BL602, SPI Poll Send `bl602_spi_poll_send()` doesn't send any data because it doesn't enable SPI Master and it doesn't clear the SPI FIFO.

SPI Poll Send also hangs because it loops forever waiting for the SPI FIFO: [bl602_spi.c](https://github.com/apache/incubator-nuttx/blob/master/arch/risc-v/src/bl602/bl602_spi.c#L779-L803)

```c
static uint32_t bl602_spi_poll_send(struct bl602_spi_priv_s *priv, uint32_t wd)
{
  uint32_t val;
  uint32_t tmp_val = 0;

  /* write data to tx fifo */

  putreg32(wd, BL602_SPI_FIFO_WDATA);
  
  /* This loop hangs because SPI Master is not enabled and SPI FIFO is not cleared */
  
  while (0 == tmp_val)
    {
      /* get data from rx fifo */

      tmp_val = getreg32(BL602_SPI_FIFO_CFG_1);
      tmp_val = (tmp_val & SPI_FIFO_CFG_1_RX_CNT_MASK)
                >> SPI_FIFO_CFG_1_RX_CNT_SHIFT;
    }
```

This problem affects the NuttX ST7789 Driver because the ST7789 Driver calls SPI Poll Send via `SPI_SEND()` and `bl602_spi_send()`.

We fix this problem by moving the code that enables SPI Master and clears the FIFO, from SPI Poll Exchange `bl602_spi_poll_exchange()` to SPI Poll Send. (Note that SPI Poll Exchange calls SPI Poll Send)

Before fixing, SPI Poll Send looks like this: [bl602_spi.c](https://github.com/apache/incubator-nuttx/blob/master/arch/risc-v/src/bl602/bl602_spi.c#L779-L803)

```c
static uint32_t bl602_spi_poll_send(struct bl602_spi_priv_s *priv, uint32_t wd)
{
  uint32_t val;
  uint32_t tmp_val = 0;

  /* write data to tx fifo */

  putreg32(wd, BL602_SPI_FIFO_WDATA);

  while (0 == tmp_val)
    {
      /* get data from rx fifo */
      ...
```

After fixing, SPI Poll Send enables SPI Master and clears SPI FIFO: [bl602_spi.c](https://github.com/lupyuen/incubator-nuttx/blob/st7789/arch/risc-v/src/bl602/bl602_spi.c#L806-L839)

```c
static uint32_t bl602_spi_poll_send(struct bl602_spi_priv_s *priv, uint32_t wd)
{
  uint32_t val;
  uint32_t tmp_val = 0;

  /* spi enable master */

  modifyreg32(BL602_SPI_CFG, SPI_CFG_CR_S_EN, SPI_CFG_CR_M_EN);

  /* spi fifo clear  */

  modifyreg32(BL602_SPI_FIFO_CFG_0, SPI_FIFO_CFG_0_RX_CLR
              | SPI_FIFO_CFG_0_TX_CLR, 0);

  /* write data to tx fifo */

  putreg32(wd, BL602_SPI_FIFO_WDATA);

  while (0 == tmp_val)
    {
      /* get data from rx fifo */
      ...
```

Logic Analyser shows that SPI Poll Send now transmits SPI Data correctly:

![SPI Poll Send transmits SPI Data correctly](https://lupyuen.github.io/images/st7789-logic3.png)

Note that the MOSI Pin shows the correct data. Before fixing, the data was missing.

As for the modified SPI Poll Exchange, we tested it with Semtech SX1262 SPI Transceiver on PineCone BL602: [release-2022-03-28](https://github.com/lupyuen/incubator-nuttx/releases/tag/release-2022-03-28)

[(Our fix for SPI Poll Send has been merged into NuttX)](https://github.com/apache/incubator-nuttx/pull/5869)

TODO38

![](https://lupyuen.github.io/images/st7789-spi1.png)

TODO40

![](https://lupyuen.github.io/images/st7789-spi2a.png)

# Appendix: Build, Flash and Run NuttX

_(For BL602, BL604 and ESP32)_

Below are the steps to build, flash and run NuttX on BL602, BL604 and ESP32.

The instructions below will work on __Linux (Ubuntu)__, __WSL (Ubuntu)__ and __macOS__.

[(Instructions for other platforms)](https://nuttx.apache.org/docs/latest/quickstart/install.html)

[(See this for Arch Linux)](https://popolon.org/gblog3/?p=1977&lang=en)

## Download NuttX

TODO

Download the modified source code for __NuttX OS and NuttX Apps__...

```bash
mkdir nuttx
cd nuttx
git clone --recursive --branch st7789 https://github.com/lupyuen/incubator-nuttx nuttx
git clone --recursive --branch st7789 https://github.com/lupyuen/incubator-nuttx-apps apps
```

Or we may use an existing NuttX Project.

## Configure NuttX

Now we configure our NuttX project...

1.  Install the build prerequisites...

    [__"Install Prerequisites"__](https://lupyuen.github.io/articles/nuttx#install-prerequisites)

1.  Configure the build...

    ```bash
    cd nuttx

    ## For BL602 / BL604: Configure the build for BL602 / BL604
    ./tools/configure.sh bl602evb:nsh

    ## For ESP32: Configure the build for ESP32.
    ## TODO: Change "esp32-devkitc" to our ESP32 board.
    ./tools/configure.sh esp32-devkitc:nsh

    ## Edit the Build Config
    make menuconfig 
    ```

1.  TODO: Enable SPI Port:
    - System Type ‚Üí BL602 Peripheral Support ‚Üí SPI0

1.  TODO: Enable SPI CMD/DATA:
    - Device Drivers ‚Üí SPI Driver Support
    - SPI Exchange
    - SPI CMD/DATA
    - SPI Character Driver

1.  TODO: Enable ST7789 Driver:
    - Device Drivers ‚Üí LCD Driver Support ‚Üí Graphic LCD Driver Support ‚Üí LCD driver selection ‚Üí Sitronix ST7789 TFT Controller 
    - X Resolution: Set to 240
    - Y Resolution: Set to 240
    - SPI Mode: See below

1.  TODO: Enable LCD Character Device:
    - Device Drivers ‚Üí LCD Driver Support ‚Üí Graphic LCD Driver Support LCD ‚Üí character device   

1.  TODO: Enable LVGL Library:
    - Application Configuration ‚Üí Graphics Support ‚Üí Light and Versatile Graphic Library (LVGL)
    - Graphics Settings ‚Üí Horizontal Resolution: Set to 240
    - Graphics Settings ‚Üí Vertical Resolution: Set to 240

1.  TODO: Enable LVGL Demo App:
    - Application Configuration ‚Üí Examples ‚Üí LVGL Demo

1.  TODO: Enable Logging:
    - Build Setup ‚Üí Debug Options 
    - Select:
    - Graphics Debug Features
    - Graphics Error Output
    - Graphics Warnings Output
    - Graphics Informational Output  
    - Low-level LCD Debug Features
    - LCD Driver Error Output
    - LCD Driver Warnings Output
    - LCD Driver Informational Output

1.  Enable __ls__ command...

    Select __"Application Configuration"__ ‚Üí __"NSH Library"__ ‚Üí __"Disable Individual commands"__
    
    Uncheck __"Disable ls"__

    Hit __"Exit"__ until the Top Menu appears. ("NuttX/x64_64 Configuration")

1.  TODO

    Enable __Logging and Assertion Checks__...

    Select __"Build Setup"__ ‚Üí __"Debug Options"__

    Check the boxes for the following...

    ```text
    Enable Debug Features
    Enable Error Output
    Enable Warnings Output
    Enable Debug Assertions
    ```

    Hit __"Exit"__ until the Top Menu appears. ("NuttX/x64_64 Configuration")

1.  Save the configuration and exit menuconfig

    [(See the .config for BL602 and BL604)](https://gist.github.com/lupyuen/a7fc921531c1d14e8d336fba0cdb1c83)

The ST7789 Display will be connected to NuttX at __/dev/lcd0__

## Build NuttX

Follow these steps to build NuttX for BL602, BL604 or ESP32...

1.  To build NuttX, enter this command...

    ```bash
    make
    ```

1.  We should see...

    ```text
    LD: nuttx
    CP: nuttx.hex
    CP: nuttx.bin
    ```

    [(See the complete log for BL602 / BL604)](https://gist.github.com/lupyuen/8f725c278c25e209c1654469a2855746)

1.  __For WSL:__ Copy the __NuttX Firmware__ to the __c:\blflash__ directory in the Windows File System...

    ```bash
    ##  /mnt/c/blflash refers to c:\blflash in Windows
    mkdir /mnt/c/blflash
    cp nuttx.bin /mnt/c/blflash
    ```

    For WSL we need to run __blflash__ under plain old Windows CMD (not WSL) because it needs to access the COM port.

1.  In case of problems, refer to the __NuttX Docs__...

    [__"BL602 / BL604 NuttX"__](https://nuttx.apache.org/docs/latest/platforms/risc-v/bl602/index.html)

    [__"ESP32 NuttX"__](https://nuttx.apache.org/docs/latest/platforms/xtensa/esp32/index.html)

    [__"Installing NuttX"__](https://nuttx.apache.org/docs/latest/quickstart/install.html)

> ![Building NuttX](https://lupyuen.github.io/images/nuttx-build2.png)

## Flash NuttX

__For ESP32:__ [__See instructions here__](https://nuttx.apache.org/docs/latest/platforms/xtensa/esp32/index.html#flashing) [(Also check out this article)](https://popolon.org/gblog3/?p=1977&lang=en)

__For BL602 / BL604:__ Follow these steps to install __blflash__...

1.  [__"Install rustup"__](https://lupyuen.github.io/articles/flash#install-rustup)

1.  [__"Download and build blflash"__](https://lupyuen.github.io/articles/flash#download-and-build-blflash)

We assume that our Firmware Binary File __nuttx.bin__ has been copied to the __blflash__ folder.

Set BL602 / BL604 to __Flashing Mode__ and restart the board...

__For PineDio Stack BL604:__

1.  Set the __GPIO 8 Jumper__ to __High__ [(Like this)](https://lupyuen.github.io/images/pinedio-high.jpg)

1.  Disconnect the USB cable and reconnect

    Or use the Improvised Reset Button [(Here's how)](https://lupyuen.github.io/articles/pinedio#appendix-improvised-reset-button-for-pinedio-stack)

__For PineCone BL602:__

1.  Set the __PineCone Jumper (IO 8)__ to the __`H` Position__ [(Like this)](https://lupyuen.github.io/images/pinecone-jumperh.jpg)

1.  Press the Reset Button

__For BL10:__

1.  Connect BL10 to the USB port

1.  Press and hold the __D8 Button (GPIO 8)__

1.  Press and release the __EN Button (Reset)__

1.  Release the D8 Button

__For Pinenut and MagicHome BL602:__

1.  Disconnect the board from the USB Port

1.  Connect __GPIO 8__ to __3.3V__

1.  Reconnect the board to the USB port

Enter these commands to flash __nuttx.bin__ to BL602 / BL604 over UART...

```bash
## For Linux: Change "/dev/ttyUSB0" to the BL602 / BL604 Serial Port
blflash flash nuttx.bin \
  --port /dev/ttyUSB0 

## For macOS: Change "/dev/tty.usbserial-1410" to the BL602 / BL604 Serial Port
blflash flash nuttx.bin \
  --port /dev/tty.usbserial-1410 \
  --initial-baud-rate 230400 \
  --baud-rate 230400

## For Windows: Change "COM5" to the BL602 / BL604 Serial Port
blflash flash c:\blflash\nuttx.bin --port COM5
```

[(See the Output Log)](https://gist.github.com/lupyuen/9c0dbd75bb6b8e810939a36ffb5c399f)

For WSL: Do this under plain old Windows CMD (not WSL) because __blflash__ needs to access the COM port.

[(Flashing WiFi apps to BL602 / BL604? Remember to use __bl_rfbin__)](https://github.com/apache/incubator-nuttx/issues/4336)

[(More details on flashing firmware)](https://lupyuen.github.io/articles/flash#flash-the-firmware)

![Flashing NuttX](https://lupyuen.github.io/images/nuttx-flash2.png)

## Run NuttX

__For ESP32:__ Use Picocom to connect to ESP32 over UART...

```bash
picocom -b 115200 /dev/ttyUSB0
```

[(More about this)](https://popolon.org/gblog3/?p=1977&lang=en)

__For BL602 / BL604:__ Set BL602 / BL604 to __Normal Mode__ (Non-Flashing) and restart the board...

__For PineDio Stack BL604:__

1.  Set the __GPIO 8 Jumper__ to __Low__ [(Like this)](https://lupyuen.github.io/images/pinedio-low.jpg)

1.  Disconnect the USB cable and reconnect

    Or use the Improvised Reset Button [(Here's how)](https://lupyuen.github.io/articles/pinedio#appendix-improvised-reset-button-for-pinedio-stack)

__For PineCone BL602:__

1.  Set the __PineCone Jumper (IO 8)__ to the __`L` Position__ [(Like this)](https://lupyuen.github.io/images/pinecone-jumperl.jpg)

1.  Press the Reset Button

__For BL10:__

1.  Press and release the __EN Button (Reset)__

__For Pinenut and MagicHome BL602:__

1.  Disconnect the board from the USB Port

1.  Connect __GPIO 8__ to __GND__

1.  Reconnect the board to the USB port

After restarting, connect to BL602 / BL604's UART Port at 2 Mbps like so...

__For Linux:__

```bash
screen /dev/ttyUSB0 2000000
```

__For macOS:__ Use CoolTerm ([See this](https://lupyuen.github.io/articles/flash#watch-the-firmware-run))

__For Windows:__ Use `putty` ([See this](https://lupyuen.github.io/articles/flash#watch-the-firmware-run))

__Alternatively:__ Use the Web Serial Terminal ([See this](https://lupyuen.github.io/articles/flash#watch-the-firmware-run))

Press Enter to reveal the __NuttX Shell__...

```text
NuttShell (NSH) NuttX-10.2.0-RC0
nsh>
```

Congratulations NuttX is now running on BL602 / BL604!

[(More details on connecting to BL602 / BL604)](https://lupyuen.github.io/articles/flash#watch-the-firmware-run)

![Running NuttX](https://lupyuen.github.io/images/nuttx-boot2.png)

__macOS Tip:__ Here's the script I use to build, flash and run NuttX on macOS, all in a single step: [run.sh](https://gist.github.com/lupyuen/cc21385ecc66b5c02d15affd776a64af)

![Script to build, flash and run NuttX on macOS](https://lupyuen.github.io/images/spi2-script.png)

[(Source)](https://gist.github.com/lupyuen/cc21385ecc66b5c02d15affd776a64af)

TODO13

![](https://lupyuen.github.io/images/st7789-config1.png)

TODO14

![](https://lupyuen.github.io/images/st7789-config2a.png)

TODO15

![](https://lupyuen.github.io/images/st7789-config3a.png)

TODO17

![](https://lupyuen.github.io/images/st7789-config5.png)

TODO18

![](https://lupyuen.github.io/images/st7789-config6.png)

TODO20

![](https://lupyuen.github.io/images/st7789-config8a.png)

TODO35

![](https://lupyuen.github.io/images/st7789-probe.jpg)

TODO41

![](https://lupyuen.github.io/images/st7789-title2.jpg)
